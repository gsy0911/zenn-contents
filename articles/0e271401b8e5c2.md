---
title: "ã€NextAuth.jsã€‘cognitoã§ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹"
emoji: "ğŸ’«"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextauth", "nextjs", "cognito", "awscdk"]
published: false
---

# ã¯ã˜ã‚ã«

ã¿ãªã•ã‚“ã€Cognitoã¯ä½¿ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ
Cognitoã¯ä¾¿åˆ©ãªã®ã§ã™ãŒã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢å‘¨ã‚ŠãŒã¡ã‚‡ã£ã¨å¤§å¤‰ã§ã™ã‚ˆã­ãƒ»ãƒ»ãƒ»ã€‚
ç‰¹ã«Cognitoã®ã€Œãƒ›ã‚¹ãƒˆã•ã‚ŒãŸã®UIã€ã®è¦‹ãŸç›®ã‚ˆããªã„ã®ã§ã€ã‚«ã‚¹ã‚¿ãƒ ã—ãŸã„ã§ã™ã‚ˆã­ã€‚

https://zenn.dev/ryuji_cre8ive/articles/d4b905651fcaec


ä»¥å‰ã€Amplifyã‚’ä½¿ã£ãŸåŒã˜ã‚ˆã†ãªè¨˜äº‹ã‚’æ›¸ã„ãŸã®ã§ã™ãŒã€
ä»Šå¾Œæ¨™æº–ã«ãªã‚Šãã†ãª`NextAuth.js`ã‚’ä½¿ã„ãŸããªã‚Šã¾ã—ãŸã€‚

https://zenn.dev/gsy0911/articles/aceb830e4c1e6e

å¤‰æ›´ç‚¹ã¨ã—ã¦ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

- UIãƒ©ã‚¤ãƒ–ãƒ©ãƒª
  - å‰ä½œï¼šMUI
  - ä»Šä½œï¼šMantine
- Cognitoã‚µã‚¤ãƒ³ã‚¤ãƒ³ã«åˆ©ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
  - å‰ä½œï¼šAmplify
  - ä»Šä½œï¼šAWS SDK V3 + NextAuth.js

:::message
Auth.jsã‚‚è©¦ã—ãŸã®ã§ã™ãŒã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã¾ã æ•´ã£ã¦ã„ãªã„ã‚ˆã†ã«è¦‹ãˆãŸã®ã§ã‚„ã‚ã¾ã—ãŸã€‚
:::

## ã‚„ã‚ŠãŸã„ã“ã¨

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®UIã‚’ä½¿ã£ãŸãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ã¯è‰²ã€…ãªè¨˜äº‹ã§ã‚‚ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ãŒã€
ã‚«ã‚¹ã‚¿ãƒ ã—ã¦`NextAuth.js`ã®`CredentialsProvider`ã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã‚’ã—ã¾ã™ã€‚
ã“ã®æ™‚ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³å‡¦ç†ã¯ãƒ•ãƒ­ãƒ³ãƒˆã§ã—ã¦ã„ã¾ã™ã€‚

:::message
ãªãŠã€NextAuth.jsçš„ã«ã¯`CredentialProvider`ã®åˆ©ç”¨ã¯ã‚ã¾ã‚ŠãŠå‹§ã‚ã—ã¦ãªã„ã‚‰ã—ã„ã§ã™ã€‚
ã©ã†ã—ã¦ã‚‚Cognitoã‚„å¾“æ¥ã®ID/Passwordèªè¨¼ã‚’ä½¿ã„ãŸã„å ´åˆã®ã¿ã«ã—ã¾ã—ã‚‡ã†ã€‚
:::


## å¯¾è±¡èª­è€…

- `NextAuth.js`ï¼ˆ or `Auth.js`ï¼‰ã‚’ä½¿ã£ã¦ã„ã‚‹
- Cognitoã‚’ä½¿ã£ã¦ã„ã‚‹
  - ã€Œãƒ›ã‚¹ãƒˆã•ã‚ŒãŸUIã€ã§ã¯ãªãã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã„
- [Mantine](https://mantine.dev/)ã‚’ä½¿ã£ã¦ã„ã‚‹
- ãƒ­ã‚°ã‚¤ãƒ³ã®æ©Ÿèƒ½ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã¯ãªããƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã§å®Ÿæ–½ã™ã‚‹
  - `Amplify.js`ã§ã¯ãªãã€`aws-sdk`ã‚’åˆ©ç”¨ã™ã‚‹
- `AWS CDK`ã‚’ä½¿ã£ã¦ã„ã‚‹

## ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ

- macOS: 13.5
- Next.js: 13.4
- Mantine: 6.0.20
- AWS CDK: 2.96.2

## å‹•ä½œã‚¤ãƒ¡ãƒ¼ã‚¸

ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ãŒå‡ºã¦ãã¾ã™ã€‚

![](/images/nextjs_nextauthjs_cognito_1/nextjs_nextauthjs_cognito_1_2.png =600x)
*ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢*


![](/images/nextjs_nextauthjs_cognito_1/nextjs_nextauthjs_cognito_1_1.png =600x)
*ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ã‚ã‚Šï¼‰*

ãƒ­ã‚°ã‚¤ãƒ³ãŒæˆåŠŸã™ã‚‹ã¨ã€`idToken`ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

![](/images/nextjs_nextauthjs_cognito_1/nextjs_nextauthjs_cognito_1_7.png =600x)
*ç”»é¢ã«è¡¨ç¤ºã•ã‚ŒãŸidToken*


# ã‚³ãƒ¼ãƒ‰

ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã„ã¦ã‚ã‚Šã¾ã™ã€‚é©å®œå‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

https://github.com/gsy0911/zenn-nextjs-authjs-cognito

## ã‚¤ãƒ³ãƒ•ãƒ©

ã“ã“ã§ã¯ã€Cognitoã‚’ä½œæˆã—ã¾ã™ã€‚
ã™ã§ã«CognitoãŒå­˜åœ¨ã—ã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚‚ã‚‰ã£ã¦å¤§ä¸ˆå¤«ã§ã™ã€‚

### Cognitoã®ãƒ‡ãƒ—ãƒ­ã‚¤

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§Cognitoã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚
ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã€ã‚¢ãƒ—ãƒªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯`private-client`ã®ã¿ã‚’ä½œæˆã—ã¦ã„ã‚‹ç‚¹ã§ã™ã€‚

:::message
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³å‡¦ç†ã‚’ã™ã‚‹å ´åˆã€
ä¸€èˆ¬çš„ã«ã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆ©ç”¨ã™ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒå­˜åœ¨ã™ã‚‹ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚‚å¤§ä¸ˆå¤«ãªç†ç”±ã¯ã€
Next.jsã®API Routesï¼ˆ/pages/apiä»¥ä¸‹ï¼‰ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã§ã™ã€‚

ã“ã®API Routesã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚µãƒ¼ãƒãƒ¼çš„ãªå‹•ãã‚’ã—ã€
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«ãƒ‡ãƒ¼ã‚¿ãŒæ¸¡ã‚‰ãªã„ãŸã‚ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å¤§ä¸ˆå¤«ã§ã™ã€‚
:::

```typescript: infrastructure/lib/Cognito.ts
import {
  Duration,
  Stack,
  StackProps,
  RemovalPolicy,
  aws_cognito,
} from "aws-cdk-lib";
import { Construct } from "constructs";
import { prefix } from "./constants";

interface ICognitoStack {
  domainPrefix: string;
  callbackUrls: string[];
  logoutUrls: string[];
}
export const paramsCognito: ICognitoStack = {
  domainPrefix: "gsy0911-zenn-example",
  callbackUrls: ["http://localhost:3000"],
  logoutUrls: ["http://localhost:3000"],
};

export class Cognito extends Stack {
  constructor(
    scope: Construct,
    id: string,
    params: ICognitoStack,
    props?: StackProps,
  ) {
    super(scope, id, props);

    /** USER POOL */
    const userPool = new aws_cognito.UserPool(this, "user-pool", {
      userPoolName: `${prefix}-user-pool`,
      // sign-up
      selfSignUpEnabled: false,
      // sign-in
      signInAliases: {
        username: true,
        email: true,
      },
      // user attributes
      standardAttributes: {
        email: {
          required: true,
          mutable: true,
        },
      },
      mfa: aws_cognito.Mfa.OPTIONAL,
      mfaSecondFactor: {
        sms: true,
        otp: true,
      },
      passwordPolicy: {
        minLength: 8,
        requireLowercase: true,
        requireUppercase: true,
        requireDigits: true,
        requireSymbols: true,
        tempPasswordValidity: Duration.days(3),
      },
      // emails, by default `no-reply@verificationemail.com` used
      accountRecovery: aws_cognito.AccountRecovery.EMAIL_ONLY,
      removalPolicy: RemovalPolicy.DESTROY,
    });

    // App Clients
    userPool.addClient("private-client", {
      userPoolClientName: "private-client",
      generateSecret: true,
      authFlows: {
        userPassword: true,
        userSrp: true,
        adminUserPassword: true,
      },
      oAuth: {
        callbackUrls: params.callbackUrls,
        logoutUrls: params.logoutUrls,
        flows: {
          authorizationCodeGrant: true,
        },
        scopes: [aws_cognito.OAuthScope.OPENID, aws_cognito.OAuthScope.EMAIL],
      },
    });

    userPool.addDomain("cognito-domain", {
      cognitoDomain: {
        domainPrefix: params.domainPrefix,
      },
    });
  }
}
```

Cognitoã‚’ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
5åˆ†ã‚‚ã‹ã‹ã‚‰ãšã«CognitoãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

```shell
# at ./infrastructure
$ cdk deploy
```

ã“ã‚Œã§ã‚¤ãƒ³ãƒ•ãƒ©å´ã®è¨­å®šã¯å®Œäº†ã—ã¾ã—ãŸã€‚

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

æ¬¡ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®èª¬æ˜ã‚’ã—ã¾ã™ã€‚
å¿…è¦ã«å¿œã˜ã¦æ¬¡ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚

```shell
# cognitoã®èªè¨¼ã«å¿…è¦
$ npm install @aws-sdk/client-cognito-identity-provider \
  jwt-decode \
  next-auth
# å¿…é ˆã§ã¯ãªã„ã§ã™ã€‚Mantineã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚
$ npm install @mantine/core \
  @mantine/form \
  @mantine/hooks \
  @mantine/next
```



:::message
`JavaScript aws sdk`ãªã©ã§èª¿ã¹ã‚‹ã¨ã€V2ã®ã‚³ãƒ¼ãƒ‰ãŒå‡ºã¦ãã¾ã™ã€‚
V2ã§ã¯ãªãV3ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚
https://docs.aws.amazon.com/ja_jp/sdk-for-javascript/v3/developer-guide/migrating-to-v3.html
:::

### ç’°å¢ƒå¤‰æ•°

ç’°å¢ƒå¤‰æ•°ã‚’å‚ç…§ã—ãŸæ™‚ã«`string | null`ã«ãªã‚‰ãªã„ã‚ˆã†ã«ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```typescript: frontend/zenn/globals.d.ts
declare namespace NodeJS {
  interface ProcessEnv {
    // next-auth.js
    readonly NEXTAUTH_SECRET: string;
    readonly NEXTAUTH_URL: string;
    // cognito
    readonly COGNITO_REGION: string;
    readonly COGNITO_USER_POOL_ID: string;
    readonly COGNITO_CLIENT_ID: string;
    readonly COGNITO_CLIENT_SECRET: string;
    readonly COGNITO_ISSUER: string;
  }
}
```

ãã—ã¦ã€`.env.local`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦å…ˆã»ã©ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸCognitoã®å€¤ã‚’è¨­å®šã—ã¦ã„ãã¾ã™ã€‚

```text: .env.local
# common
NEXTAUTH_SECRET=$(openssl rand -base64 32)
NEXTAUTH_URL=http://localhost:3000

# common in cognito
COGNITO_REGION=ap-northeast-1
COGNITO_USER_POOL_ID=none
COGNITO_ISSUER=https://cognito-idp.ap-northeast-1.amazonaws.com/none
# private-client
COGNITO_CLIENT_ID=none
COGNITO_CLIENT_SECRET=none
```

### `next-auth`ã®å‹ã®æ‹¡å¼µ

`next-auth`ã§æ—¢ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹`User`ã‚„`Session`ã®å‹ã‚’æ‹¡å¼µã—ã¾ã™ã€‚
ã“ã†ã™ã‚‹ã“ã¨ã§ã€å®‰å…¨ã«`idToken`ã‚„`accessToken`ã‚’ä¿æŒãƒ»å‚ç…§ã§ãã¾ã™ã€‚

```typescript: frontend/zenn/common/next-auth.d.ts
import { NextPage } from "next";
import { DefaultSession } from "next-auth";

interface UserWithId extends DefaultSession["user"] {
  idToken?: string;
  id?: string;
  email: string;
}

declare module "next-auth/jwt" {
  interface JWT {
    idToken?: string;
    accessToken?: string;
    accessTokenExpires?: number;
    refreshToken?: string;
    error?: string;
  }
}

declare module "next-auth" {
  interface Session {
    accessToken?: string;
    user: UserWithId;
    error?: string;
  }

  interface User {
    idToken?: string;
    refreshToken?: string;
    accessToken?: string;
    accessTokenExpires?: number;
  }

  interface Account {
    expires_at;
  }
}
```

### `[...nextauth].ts`ã«ã¤ã„ã¦

`next-auth`ã§å¤§äº‹ãªãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚
å…¨ã¦ã®ã‚³ãƒ¼ãƒ‰ã‚’ä¸€åº¦ã«è¼‰ã›ã‚‹ã®ã¯é›£ã—ã„ã®ã§é©å®œåˆ‡ã‚Šå–ã‚Šã¤ã¤èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’è¦‹ãŸã„å ´åˆã«ã¯ã€[GitHub](https://github.com/gsy0911/zenn-nextjs-authjs-cognito)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

```typescript: frontend/zenn/pages/api/auth/[...nextauth].tsï¼ˆä¸€éƒ¨ï¼‰
import NextAuth, { Session, AuthOptions, User } from "next-auth";
import { JWT } from "next-auth/jwt";
import CognitoProvider from "next-auth/providers/cognito";
import CredentialsProvider from "next-auth/providers/credentials";
import { Issuer } from "openid-client";
import * as crypto from "crypto";
import {
  AdminInitiateAuthCommandInput,
  AdminInitiateAuthCommand,
  CognitoIdentityProviderClient,
} from "@aws-sdk/client-cognito-identity-provider";
import jwt_decode from "jwt-decode";
```

`cognitoProvider`ã¯æ­£ç¢ºã«ã¯ä½œæˆã—ãªãã¦ã‚‚è‰¯ã„ã®ã§ã™ãŒã€
ä½œæˆã—ã¦ãŠãã¨ã€å¾Œç¶šã®å‡¦ç†ãŒå°‘ã—æ¥½ã«ãªã‚‹ã®ã§ä½œæˆã—ã¦ã„ã¾ã™ã€‚

```typescript: frontend/zenn/pages/api/auth/[...nextauth].tsï¼ˆä¸€éƒ¨ï¼‰
const cognitoProvider = CognitoProvider({
  id: "cognito",
  clientId: process.env.COGNITO_CLIENT_ID,
  clientSecret: process.env.COGNITO_CLIENT_SECRET,
  issuer: process.env.COGNITO_ISSUER,
  checks: "nonce",
});
```


ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°ã«ã¯ã€ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

https://mseeeen.msen.jp/nextauth-cognito-token-refresh/

```typescript: frontend/zenn/pages/api/auth/[...nextauth].tsï¼ˆä¸€éƒ¨ï¼‰
async function refreshAccessToken(token: any): Promise<JWT> {
  ï¼ˆçœç•¥ï¼‰
}
```

ä»¥ä¸‹ã®signIné–¢æ•°ãŒæœ¬è¨˜äº‹ã§ã‚‚å¤§äº‹ãªç®‡æ‰€ã«ãªã‚Šã¾ã™ã€‚
`aws-sdk`ã‚’åˆ©ç”¨ã—ã¦ã€signInã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

```typescript: frontend/zenn/pages/api/auth/[...nextauth].tsï¼ˆä¸€éƒ¨ï¼‰
const signIn = async (username: string, password: string) => {
  const client = new CognitoIdentityProviderClient({
    region: process.env.COGNITO_REGION,
  });
  const secretHash = crypto
    .createHmac("sha256", process.env.COGNITO_CLIENT_SECRET)
    .update(username + process.env.COGNITO_CLIENT_ID)
    .digest("base64");
  try {
    const adminInput: AdminInitiateAuthCommandInput = {
      ClientId: process.env.COGNITO_CLIENT_ID,
      UserPoolId: process.env.COGNITO_USER_POOL_ID,
      AuthFlow: "ADMIN_USER_PASSWORD_AUTH",
      AuthParameters: {
        USERNAME: username,
        PASSWORD: password,
        SECRET_HASH: secretHash,
      },
    };

    const user = await client.send(new AdminInitiateAuthCommand(adminInput));
    const expiresIn = user.AuthenticationResult?.ExpiresIn || 3600;
    const accessTokenExpires = Math.floor(Date.now() / 1000) + expiresIn;
    if (user.AuthenticationResult?.IdToken) {
      const decodedIdToken = get_jwt_decoded(
        user.AuthenticationResult?.IdToken,
      );
      return {
        id: decodedIdToken.sub || "",
        name: decodedIdToken.email || "",
        email: decodedIdToken.email || "",
        idToken: user.AuthenticationResult?.IdToken,
        refreshToken: user.AuthenticationResult?.RefreshToken,
        accessToken: user.AuthenticationResult?.AccessToken,
        accessTokenExpires: accessTokenExpires,
      };
    }
  } catch (err) {
    console.log(JSON.stringify(err));
  }
};
```

`authrize`ã®å‡¦ç†ã§ã€ä¸Šã§å®šç¾©ã—ãŸ`signIn`é–¢æ•°ã‚’åˆ©ç”¨ã—ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚


`redirect`ã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã¯ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã®å‡¦ç†ã§ã€ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚

https://mseeeen.msen.jp/logout-cognito-session-with-nextauth/

`async session`ã‚„`async jwt`ã®ã¨ã“ã‚ã§ã€idTokenã®ä¿æŒã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚


```typescript: frontend/zenn/pages/api/auth/[...nextauth].tsï¼ˆä¸€éƒ¨ï¼‰
export const authOptions: AuthOptions = {
  providers: [
    // usernameã§ã®ãƒ­ã‚°ã‚¤ãƒ³
    CredentialsProvider({
      credentials: {
        username: {
          label: "ãƒ¦ãƒ¼ã‚¶ãƒ¼å",
          type: "text",
          placeholder: "ãƒ¦ãƒ¼ã‚¶ãƒ¼å",
        },
        password: { label: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", type: "password" },
      },
      authorize: async (credentials, req) => {
        const user = await signIn(
          credentials?.username || "",
          credentials?.password || "",
        );

        if (user) {
          // è¿”ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã™ã¹ã¦ã€JWTã® `user` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
          return user;
        } else {
          // ã‚‚ã—ã€NULLã‚’è¿”ã—ãŸå ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è©³ç´°ã‚’ç¢ºèªã™ã‚‹ã‚ˆã†ä¿ƒã™ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          return null;
          // ã¾ãŸã€ã“ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ã‚¨ãƒ©ãƒ¼ã§æ‹’å¦ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã“ã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æŒã¤ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã«é€ã‚‰ã‚Œã¾ã™ã€‚
        }
      },
    }),
  ],
  secret: process.env.NEXTAUTH_SECRET,
  session: {
    strategy: "jwt",
    maxAge: 30 * 24 * 60 * 60,
  },
  callbacks: {
    redirect({ url, baseUrl }) {
      ï¼ˆä¸­ç•¥ï¼šã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã®å‚è€ƒè¨˜äº‹ã®å†…å®¹ã®ãŸã‚ï¼‰
    },
    async session({
      session,
      token,
    }: {
      session: Session;
      token: JWT;
      user: User;
    }): Promise<Session> {
      if (token.idToken) {
        session.user.idToken = token.idToken;
      }
      return session;
    },
    async jwt({ token, user, account }) {
      // Credentialsãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ: userã«æƒ…å ±ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹
      if (account && user) {
        console.log(`user: ${JSON.stringify(user)}`);
        console.log(`account: ${JSON.stringify(account)}`);
        token.idToken = account.id_token || user.idToken;
        token.accessToken = account.access_token || user.accessToken;
        token.accessTokenExpires =
          account.expires_at || user.accessTokenExpires;
        token.refreshToken = account.refresh_token || user.refreshToken;
        return token;
      }
      ï¼ˆä¸­ç•¥ï¼šãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã®å‚è€ƒè¨˜äº‹ã®å†…å®¹ã®ãŸã‚ï¼‰
    },
  },
  pages: {
    signIn: "/auth/signin",
    signOut: "/auth/signin",
  },
};

export default NextAuth(authOptions);
```

ã“ã‚Œã§èªè¨¼ã¾ã‚ã‚Šã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚

## Mantineã®è¨­å®š

æ¬¡ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ã‚’ä»¥ä¸‹ã‚’å‚è€ƒã«ä½œæˆã—ã¾ã™ã€‚
Mantineã‚’åˆ©ç”¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚‚ã‚‰ã£ã¦å¤§ä¸ˆå¤«ã§ã™ã€‚

https://ui.mantine.dev/category/authentication

ã«ã‚ã‚‹å†…å®¹ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€`@mantine/hook`ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ã¦ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ã«ã€åˆæœŸå€¤ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Inputã«å¯¾ã—ã¦è¨­å®šã§ãã¾ã™ã€‚

```typescript jsx
ï¼ˆå‰ç•¥ï¼‰
import { useForm } from "@mantine/form";
// see: https://ui.mantine.dev/category/authentication

export const SignInPage = () => {
  const form = useForm({
    initialValues: {
      email: "",
      password: "",
    },
    // validateInputOnChange: true,
    validateInputOnBlur: true,
    validate: {
      email: (value) =>
        /^\S+@\S+$/.test(value) ? null : "ä¸æ­£ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ã€‚",
      password: (value) =>
        value.length < 8
          ? "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
          : !value.match(/[0-9]/)
          ? "æ•°å­—ã‚’å«ã‚ã¦ãã ã•ã„"
          : !value.match(/[a-z]/)
          ? "è‹±èªã®å°æ–‡å­—ã‚’å«ã‚ã¦ãã ã•ã„"
          : !value.match(/[A-Z]/)
          ? "è‹±èªã®å¤§æ–‡å­—ã‚’å«ã‚ã¦ãã ã•ã„"
          : !value.match(/[$&+,:;=?@#|'<>.^*()%!-]/)
          ? "è¨˜å·ã‚’å«ã‚ã¦ãã ã•ã„"
          : null,
    },
  });
ï¼ˆå¾Œç•¥ï¼‰
```

ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã™ã‚‹ã¨ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ã§å…¥åŠ›ã—ãŸéš›ã«

![](/images/nextjs_nextauthjs_cognito_1/nextjs_nextauthjs_cognito_1_2.png =600x)
*å†æ²ï¼šã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢*

ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»–ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãªã©ã‚‚ã‚ã‚‹ã®ã§å…¬å¼ã‚µã‚¤ãƒˆã‚’è¦‹ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

![](/images/nextjs_nextauthjs_cognito_1/nextjs_nextauthjs_cognito_1_1.png =600x)
*å†æ²ï¼šã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ã‚ã‚Šï¼‰*



## å‹•ä½œç¢ºèª

å‹•ä½œç¢ºèªã‚’ã™ã‚‹ãŸã‚ã«ã€ã¾ãšã¯cognitoã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

:::message
ä»Šå›ã¯Cognitoã‚’ä½œæˆã™ã‚‹ã¨ãã«`self-signup`ã‚’falseã«ã—ã¦ã„ã‚‹ãŸã‚ã€
ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚
:::

![](/images/nextjs_nextauthjs_cognito_1/nextjs_nextauthjs_cognito_1_3.png =600x)
*ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ*

![](/images/nextjs_nextauthjs_cognito_1/nextjs_nextauthjs_cognito_1_4.png =600x)
*ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ãƒ›ã‚¹ãƒˆã•ã‚ŒãŸUIã‚’ä½¿ã£ã¦åˆæœŸã‚µã‚¤ãƒ³ã‚¤ãƒ³*

![](/images/nextjs_nextauthjs_cognito_1/nextjs_nextauthjs_cognito_1_5.png =600x)
*ãƒ›ã‚¹ãƒˆã•ã‚ŒãŸUIã‚’ä½¿ã£ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å†è¨­å®š*

ã“ã®ã€ŒSendã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã™ã‚‹ã¨ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®Next.jsã‚¢ãƒ—ãƒªã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚

![](/images/nextjs_nextauthjs_cognito_1/nextjs_nextauthjs_cognito_1_6.png =600x)
*ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³*

ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒæˆåŠŸã™ã‚‹ã¨ã€ç”»é¢ã«`idToken`ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![](/images/nextjs_nextauthjs_cognito_1/nextjs_nextauthjs_cognito_1_7.png =600x)
*å†æ²ï¼šç”»é¢ã«è¡¨ç¤ºã•ã‚ŒãŸidToken*

ã“ã‚Œã§cognitoã®CredentialProviderã‚’ä½¿ã£ãŸã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒã§ãã¾ã—ãŸã€‚

## æ³¨æ„ç‚¹ãƒ»ãã®ä»–

ãªã›ã‹ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ†ã‚¹ãƒˆã™ã‚‹éš›ã«ã¯ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã˜ã‚ƒãªã„ã¨å‹•ã‹ãªã„ã§ã™ã€‚
è§£æ±ºç­–ãŒã‚ã‹ã‚‹æ–¹ãŒã„ã‚‰ã—ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ã‘ã‚‹ã¨å–œã³ã¾ã™ï¼

# ãŠã‚ã‚Šã«

`NextAuth.js` + `AWS SDK V3`ã§Cognitoã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã—ãŸã€‚
ã¾ã ã€è¶³ã‚Šã¦ã„ãªã„ãƒšãƒ¼ã‚¸ã¯ã‚ã‚‹ã®ã§ä»Šå¾Œä½œã£ã¦ã„ããŸã„ã§ã™ã€‚

èª°ã‹ã®å‚è€ƒã«ãªã‚Œã°å¬‰ã—ã„ã§ã™ã€‚

# ãã®ã»ã‹ã®å‚è€ƒè¨˜äº‹

https://note.com/lizefield/n/n0a8c613d8064#a5cb68c6-17e1-4cb4-9101-892e0ed77b74
