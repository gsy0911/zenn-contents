---
title: "CDKã‚’ä½¿ã£ã¦Next.jsã‚’S3+CloudFrontã®æ§‹æˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹"
emoji: "ğŸ§€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Nextjs", "AWSCDK", "CloudFront"]
published: true
---

# ã¯ã˜ã‚ã«

CloudFrontã‚’ä½¿ã£ã¦Next.jsãªã©ã§ãƒ“ãƒ«ãƒ‰ã•ã‚Œã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ä¿¡ã™ã‚‹ã¨ãã«ã€
S3ã®ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šã‚’ã€Œå…¬é–‹ã€ã«ã—ãŸããªã„æ™‚ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
ï¼ˆS3ã®å…¬é–‹è¨­å®šã®å›³ã‚’æ·»ä»˜ï¼‰


ã„ãã¤ã‹ã®è¨˜äº‹ã§ã‚‚è¨€åŠã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€CloudFront + S3ã§Next.jsãªã©ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ä¿¡ã™ã‚‹éš›ã«ã¯ã„ãã¤ã‹ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

1. S3ã‚’ã€Œé™çš„Webã‚µãƒ¼ãƒãƒ¼ãƒ»å…¨ä¸–ç•Œã«å…¬é–‹ã€ã«è¨­å®šã—ã¦ã€CloudFrontå´ã§ã¯ç‰¹ã«æ°—ã«ã›ãšã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹
2. S3ã®è¨­å®šã¯ç‰¹ã«å¤‰ãˆãšã«ã€CloudFrontã®å‰ã«Lambda@Edgeãªã©ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹éƒ¨åˆ†ã‚’å¤‰æ›´ã™ã‚‹

ä»Šå›ã¯2ã®æ–¹æ³•ã‚’æ¡ç”¨ã—ã¤ã¤ã€ãã‚Œã‚’CDKã§è¨˜è¿°ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
åŠ ãˆã¦ã€CloudFrontã¸è¨­å®šã‚’å°‘ã—åŠ ãˆã¦ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚‚å°‘ã—æ„è­˜ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

# ã‚„ã‚ŠãŸã„ã“ã¨ãƒ»å¯¾è±¡èª­è€…ãƒ»æ§‹æˆãƒ»æ–™é‡‘

## ã‚„ã‚ŠãŸã„ã“ã¨

å‰è¿°ã®é€šã‚Šã‚„ã‚ŠãŸã„ã“ã¨ã¯ã€ã€ŒCloudFrontçµŒç”±ã§Next.jsã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ä¿¡ã™ã‚‹ã“ã¨ã€ã§ã™ã€‚
åŠ ãˆã¦ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚‚é«˜ã‚ã¤ã¤é…ä¿¡ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

## å¯¾è±¡èª­è€…

ä»¥ä¸‹ã®å†…å®¹ã‚’å®Ÿè¡Œã—ãŸã„äººã«ãŠã™ã™ã‚ã§ã™ã€‚

- CDKã‚’ä½¿ã£ã¦CloudFront + Next.jsã®æ§‹æˆã‚’ä½œã‚ŠãŸã„
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚‚é«˜ã‚ã¤ã¤CloudFrontã§ã®é…ä¿¡ã‚’å®Ÿæ–½ã—ãŸã„

## æ§‹æˆ

- æ§‹æˆå›³1: Lambda@Edgeã®æŒ™å‹•

ã“ã®æ§‹æˆã®ç†ç”±ã€‚

- æ§‹æˆå›³2:ResponseHeadersã®æŒ™å‹•
  - Overrideã¨ã‹ã‚‚æ°—ã«ãªã‚‹ã®ã§æŒ™å‹•ã‚’ã¿ã¦ã¿ã‚‹

## æ–™é‡‘

ä»Šå›åˆ©ç”¨ã™ã‚‹AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

- Lambda@Edge
- CloudFront
- S3
- Route53
- ACM

# ã‚³ãƒ¼ãƒ‰

[ã“ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/gsy0911/zenn-cloudfront-oai)ã«ã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¦ã„ã¾ã™ã€‚
å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆã¯ã€ç´°ã‹ã„ã‚³ãƒ¼ãƒ‰ãªã©ã¯ãã¡ã‚‰ã§ç¢ºèªã‚’ã—ã¦ãã ã•ã„ã€‚
ã¾ãŸã€æœ¬è¨˜äº‹ã§ã‚‚CloudFrontã®éƒ¨åˆ†ã¨Lambda@Edgeã®æŒ™å‹•ã«é–¢ã—ã¦å°‘ã—è§£èª¬ã—ã¾ã™ã€‚

## Lambda@Edgeã®ã‚³ãƒ¼ãƒ‰ã‚’JavaScriptã§å®Ÿè£…ã™ã‚‹

JavaScriptã§ä½œæˆã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã®Lambda@Edgeã‚’ä½œæˆã™ã‚Œã°å®Ÿç¾ã§ãã¾ã™ã€‚
ã“ã®æ–¹æ³•ã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«æ‰‹é–“ãŒå°‘ãªã„ãŸã‚ã€ã™ãå®Ÿè£…ã—ãŸã„æ™‚ã¯ã“ã¡ã‚‰ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

```javascript:infrastructure/lib/lambda/js_edge/rewrite-trailing-slash/index.js
exports.handler = (event, context, callback) => {
  const request = event.Records[0].cf.request;
  const uri = request.uri;
  // ãƒ•ã‚¡ã‚¤ãƒ«å ("/" ã§åŒºåˆ‡ã‚‰ã‚ŒãŸãƒ‘ã‚¹ã®æœ€å¾Œ) ã‚’å–å¾—
  const filename = request.uri.split("/").pop();

  if (uri.endsWith("/")) {
    request.uri = request.uri.concat("index.html");
  } else if (filename) {
    if (!filename.includes(".")) {
      // ãƒ•ã‚¡ã‚¤ãƒ«åã«æ‹¡å¼µå­ãŒã¤ã„ã¦ã„ãªã„å ´åˆã€ "/index.html" ã‚’ã¤ã‘ã‚‹
      request.uri = request.uri.concat("/index.html");
    }
  }
  console.log(`uri: ${uri} -> ${request.uri}`)
  callback(null, request);
}
```

JavaScriptã®å ´åˆã¯ã€ä»¥ä¸‹ã®CDKã®ã‚³ãƒ¼ãƒ‰ã§Lambda@Edgeã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript:infrastructure/lib/CloudFrontOaiStack.ts
// ~~å‰ç•¥~~

    const dir = path.resolve(__dirname, 'lambda', 'js_edge', 'rewrite-trailing-slash')
    const rewriteTrailingSlashVersion = new aws_cloudfront.experimental.EdgeFunction(this, "edge-origin-request", {
      code: aws_lambda.Code.fromAsset(dir),
      functionName: "origin-request",
      handler: `index.handler`,
      runtime: aws_lambda.Runtime.NODEJS_16_X,
      memorySize: 512,
      timeout: Duration.seconds(5),
      architecture: aws_lambda.Architecture.X86_64,
    })

// ~~å¾Œç•¥~~
```

## Lambda@Edgeã®ã‚³ãƒ¼ãƒ‰ã‚’TypeScriptã§å®Ÿè£…ã™ã‚‹

ä¸€æ–¹ã§TypeScriptã§ä½œæˆã—ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§å®Ÿç¾ã§ãã¾ã™ã€‚
ï¼ˆå½“ç„¶ãªãŒã‚‰ã‚³ãƒ¼ãƒ‰ãã®ã‚‚ã®ã¯ã€JavaScriptã¨ã»ã¨ã‚“ã©å·®ã¯ãªã„ã§ã™ã€‚ï¼‰
ãŸã ã€ã“ã®å ´åˆã¯äº‹å‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã«ãªã‚Šã¾ã™ï¼ˆè©³ç´°ã¯å¾Œè¿°ï¼‰ã€‚


```typescript:infrastructure/lib/lambda/ts_edge/rewrite-trailing-slash/index.ts
import {CloudFrontRequestHandler} from "aws-lambda";

export const handler: CloudFrontRequestHandler = async (event) => {
  const request = event.Records[0].cf.request;
  const uri = request.uri;
  // ãƒ•ã‚¡ã‚¤ãƒ«å ("/" ã§åŒºåˆ‡ã‚‰ã‚ŒãŸãƒ‘ã‚¹ã®æœ€å¾Œ) ã‚’å–å¾—
  const filename = uri.split("/").pop();

  if (uri.endsWith("/")) {
    request.uri = request.uri.concat("index.html");
  } else if (filename) {
    if (!filename.includes(".")) {
      // ãƒ•ã‚¡ã‚¤ãƒ«åã«æ‹¡å¼µå­ãŒã¤ã„ã¦ã„ãªã„å ´åˆã€ "/index.html" ã‚’ã¤ã‘ã‚‹
      request.uri = request.uri.concat("/index.html");
    }
  }
  return request
}
```

TypeScriptã®å ´åˆã¯ã€ä»¥ä¸‹ã®CDKã®ã‚³ãƒ¼ãƒ‰ã§Lambda@Edgeã‚’å‚ç…§ã—ã¦ã„ã¾ã™ã€‚
ä¸€è¦‹ã€JavaScriptã®å ´åˆã¨æ¯”ã¹ã‚‹ã¨çŸ­ãæ¥½ã«è¦‹ãˆã¾ã™ãŒã€
SSMã‹ã‚‰Lambdaã®ARNã‚’èª­ã¿å–ã‚‹ãŸã‚ã«ã€äº‹å‰ã«åˆ¥Stackã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹åˆ¥Stackã®è©³ç´°ã¯[ã“ã®è¨˜äº‹](https://zenn.dev/gsy0911/articles/820313c08a545922733f)ã‚’ã”è¦§ãã ã•ã„ã€‚

```typescript:infrastructure/lib/CloudFrontOaiStack.ts
// ~~å‰ç•¥~~

    // Lambda@Edge
    const rewriteTrailingSlashParam = aws_ssm.StringParameter.fromStringParameterAttributes(this, 'rewriteTrailingSlashParam', {
      parameterName: `/${prefix}/${params.environment}/${params.lambdaEdgeStackId}/rewriteTrailingSlash`,
    }).stringValue;
    const rewriteTrailingSlashVersion = aws_lambda.Version.fromVersionArn(this, "rewriteTrailingSlashVersion", rewriteTrailingSlashParam)

// ~~å¾Œç•¥~~
```

# ãƒ‡ãƒ—ãƒ­ã‚¤

ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜ãŒçµ‚ã‚ã£ãŸã®ã§ã€å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¦æŒ™å‹•ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚
JavaScriptã¨TypeScriptã¨ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã®æ‰‹é †ãŒå°‘ã—ç•°ãªã‚Šã¾ã™ã€‚
ã“ã“ã§ã¯ã€ç°¡å˜ãªJavaScriptã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¾ã™ã€‚

## 1. Nextã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

ã¾ãšã¯ã€Nextã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚
ãƒ“ãƒ«ãƒ‰ã™ã‚‹å‰ã«ã€`trailingSlash: true`ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```diff javascript:next.config.js
const nextConfig = {
  reactStrictMode: true,
  swcMinify: true,
+ trailingSlash: true,
}

module.exports = nextConfig
```

`package.json`ã«ä»¥ä¸‹ã®å¤‰æ›´ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```diff json:package.json
{
  "name": "frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
+   "export": "NODE_ENV=production next build && next export -o build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@types/node": "18.11.9",
    "@types/react": "18.0.25",
    "@types/react-dom": "18.0.9",
    "eslint": "8.28.0",
    "eslint-config-next": "13.0.5",
    "next": "13.0.5",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "typescript": "4.9.3"
  }
}
```


ãã‚ŒãŒçµ‚ã‚ã£ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦`build`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```shell
# `frontend/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
$ npm run export
```

nextã®ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›å¾Œã«ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§S3ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

```shell
# `frontend/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
$ aws s3 sync build s3://{YOUR_BUCKET_NAME}
```

## 2. Route53ãªã©ã®è¨­å®š

Route53ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã—ã¦ã€ACMã§è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ã¦ãŠãã¾ã™ã€‚
å¿…è¦ãªã®ã¯ã€Route53ã®ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã¨ã€CloudFrontã«è¨­å®šã—ãŸã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¯¾ã™ã‚‹è¨¼æ˜æ›¸ã§ã™ã€‚
è©³ç´°ã¯[ã“ã®è¨˜äº‹](https://zenn.dev/gsy0911/articles/da47b660b7dd2b7d1ae7#%E6%BA%96%E5%82%99)ã‚’ã”è¦§ãã ã•ã„ã€‚


## 3. CDKã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

Lambda@EdgeãŒJavaScriptã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹Stackã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚

```shell
# `infrastructure/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
$ cdk deploy example-cloudfront-oai-js
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰1ã¤ã§`us-east-1`ã¨`ap-northeast-1`ã®2ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚
ãã®ãŸã‚ã€2å›ãƒ‡ãƒ—ãƒ­ã‚¤æ‰¿èªãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚

# æŒ™å‹•ã®ç¢ºèª

å®Ÿéš›ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ç¢ºèªã™ã‚‹ã€‚

mdnã®ã‚µã‚¤ãƒˆã«ã¦å®‰å…¨æ€§ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã‚’å®Ÿæ–½ã™ã‚‹

# ãŠã‚ã‚Šã«

CDKã‚’ä½¿ã£ã¦Next.jsã‚’S3+CloudFrontã®æ§‹æˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã—ãŸã€‚
ã“ã®æ§‹æˆã‚’åˆ©ç”¨ã™ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¬‰ã—ã„ã§ã™ã€‚

# å‚è€ƒ

