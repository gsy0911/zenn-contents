---
title: "CDKã‚’ä½¿ã£ã¦Next.jsã‚’S3+CloudFrontã®æ§‹æˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹"
emoji: "ğŸ§€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Next.js", "AWSCDK", "CloudFront"]
published: true
---

# ã¯ã˜ã‚ã«

CloudFrontã‚’ä½¿ã£ã¦Next.jsãªã©ã§ãƒ“ãƒ«ãƒ‰ã•ã‚Œã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ä¿¡ã™ã‚‹ã¨ãã«ã€
S3ã®ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šã‚’ã€Œå…¬é–‹ã€ã«ã—ãŸããªã„æ™‚ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
ï¼ˆå…¬é–‹è¨­å®šã®å›³ã‚’æ·»ä»˜ï¼‰
åŠ ãˆã¦ã€CDKã§AWSã®æ§‹æˆã‚’ç®¡ç†ã—ã¦ã„ã‚‹å ´åˆã«ã€ä¸Šè¨˜ã®ã‚ˆã†ãªå†…å®¹ã‚’æ›¸ããŸã„ã¨ãã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
ãã†ã„ã£ãŸå ´åˆã®æ™‚ã«ã€å½¹ç«‹ã¡ã¾ã™ã€‚

ã„ãã¤ã‹ã®è¨˜äº‹ã§ã‚‚è¨€åŠã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€CloudFront + S3ã§Next.jsãªã©ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ä¿¡ã™ã‚‹éš›ã«ã¯ã„ãã¤ã‹ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

1. S3ã‚’ã€Œé™çš„Webã‚µãƒ¼ãƒãƒ¼ãƒ»å…¨ä¸–ç•Œã«å…¬é–‹ã€ã«è¨­å®šã—ã¦ã€CloudFrontå´ã§ã¯ç‰¹ã«æ°—ã«ã›ãšã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã ã‘
2. S3ã®è¨­å®šã¯ç‰¹ã«å¤‰ãˆãšã«ã€CloudFrontã®å‰ã«Lambda@Edgeãªã©ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹éƒ¨åˆ†ã‚’å¤‰æ›´ã™ã‚‹

ä»Šå›ã¯2ã®æ–¹æ³•ã‚’æ¡ç”¨ã—ã¤ã¤ã€ãã‚Œã‚’CDKã§è¨˜è¿°ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
åŠ ãˆã¦ã€CloudFrontã®`responseHeadersPolicy`ã«é–¢ã—ã¦ã‚‚è¨˜è¿°ã‚’å°‘ã—åŠ ãˆã¦ã€æœ€ä½é™ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ã‹ã‘ã¦ãŠãã¾ã™ã€‚

# ã‚„ã‚ŠãŸã„ã“ã¨ãƒ»å¯¾è±¡èª­è€…ãƒ»æ§‹æˆãƒ»æ–™é‡‘

## ã‚„ã‚ŠãŸã„ã“ã¨

å‰è¿°ã®é€šã‚Šã‚„ã‚ŠãŸã„ã“ã¨ã¯ã€ã€ŒCloudFrontçµŒç”±ã§Next.jsã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ä¿¡ã™ã‚‹ã“ã¨ã€ã§ã™ã€‚
åŠ ãˆã¦ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã‚‚æœ€ä½é™æ„è­˜ã—ã¤ã¤é…ä¿¡ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

## å¯¾è±¡èª­è€…

ä»¥ä¸‹ã®å†…å®¹ã‚’å®Ÿè¡Œã—ãŸã„äººã«ãŠã™ã™ã‚ã§ã™ã€‚

- CDKã‚’ä½¿ã£ã¦CloudFront + Next.jsã®æ§‹æˆã‚’ä½œã‚ŠãŸã„
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’æ„è­˜ã—ã¤ã¤CloudFrontã§ã®é…ä¿¡ã‚’å®Ÿæ–½ã—ãŸã„

## æ§‹æˆ

- æ§‹æˆå›³1: Lambda@Edgeã®æŒ™å‹•

ã“ã®æ§‹æˆã®ç†ç”±ã€‚

- æ§‹æˆå›³2:ResponseHeadersã®æŒ™å‹•
  - Overrideã¨ã‹ã‚‚æ°—ã«ãªã‚‹ã®ã§æŒ™å‹•ã‚’ã¿ã¦ã¿ã‚‹

## æ–™é‡‘

ä»Šå›åˆ©ç”¨ã™ã‚‹AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

- Lambda@Edge
- CloudFront
- S3
- Route53
- ACM

# ã‚³ãƒ¼ãƒ‰

[ã“ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/gsy0911/zenn-cloudfront-oai)ã«ã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¦ã„ã¾ã™ã€‚
å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆã¯ã€ç´°ã‹ã„ã‚³ãƒ¼ãƒ‰ãªã©ã¯ãã¡ã‚‰ã§ç¢ºèªã‚’ã—ã¦ãã ã•ã„ã€‚
ã¾ãŸã€æœ¬è¨˜äº‹ã§ã‚‚CloudFrontã®éƒ¨åˆ†ã¨Lambda@Edgeã®æŒ™å‹•ã«é–¢ã—ã¦å°‘ã—è§£èª¬ã—ã¾ã™ã€‚

## Lambda@Edgeã®ã‚³ãƒ¼ãƒ‰ã‚’JavaScriptã§å®Ÿè£…ã™ã‚‹

ç°¡å˜ã«JavaScriptã§ä½œæˆã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã®Lambda@Edgeã‚’ä½œæˆã™ã‚Œã°å®Ÿç¾ã§ãã¾ã™ã€‚

```javascript
exports.handler = (event, context, callback) => {
  const request = event.Records[0].cf.request;
  const uri = request.uri;
  // ãƒ•ã‚¡ã‚¤ãƒ«å ("/" ã§åŒºåˆ‡ã‚‰ã‚ŒãŸãƒ‘ã‚¹ã®æœ€å¾Œ) ã‚’å–å¾—
  const filename = request.uri.split("/").pop();

  if (uri.endsWith("/")) {
    request.uri = request.uri.concat("index.html");
  } else if (filename) {
    if (!filename.includes(".")) {
      // ãƒ•ã‚¡ã‚¤ãƒ«åã«æ‹¡å¼µå­ãŒã¤ã„ã¦ã„ãªã„å ´åˆã€ "/index.html" ã‚’ã¤ã‘ã‚‹
      request.uri = request.uri.concat("/index.html");
    }
  }
  console.log(`uri: ${uri} -> ${request.uri}`)
  callback(null, request);
}
```

JavaScriptã®å ´åˆã¯ã€ä»¥ä¸‹ã®CDKã®ã‚³ãƒ¼ãƒ‰ã§Lambda@Edgeã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript:CloudFrontOaiStack.ts
// ~~å‰ç•¥~~

    const dir = path.resolve(__dirname, 'lambda', 'js_edge', 'rewrite-trailing-slash')
    const rewriteTrailingSlashVersion = new aws_cloudfront.experimental.EdgeFunction(this, "edge-origin-request", {
      code: aws_lambda.Code.fromAsset(dir),
      functionName: "origin-request",
      handler: `index.handler`,
      runtime: aws_lambda.Runtime.NODEJS_16_X,
      memorySize: 512,
      timeout: Duration.seconds(5),
      architecture: aws_lambda.Architecture.X86_64,
    })

// ~~å¾Œç•¥~~
```

## Lambda@Edgeã®ã‚³ãƒ¼ãƒ‰ã‚’TypeScriptã§å®Ÿè£…ã™ã‚‹

ä¸€æ–¹ã§TypeScriptã§ä½œæˆã—ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§å®Ÿç¾ã§ãã¾ã™ã€‚
ï¼ˆå½“ç„¶ãªãŒã‚‰ã‚³ãƒ¼ãƒ‰ãã®ã‚‚ã®ã¯ã€JavaScriptã¨ã»ã¨ã‚“ã©å·®ã¯ãªã„ã§ã™ã€‚ï¼‰
ãŸã ã€ã“ã®å ´åˆã¯äº‹å‰æº–å‚™ãŒå¿…è¦ãªãŸã‚äº‹å‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
æº–å‚™ã®è©³ç´°ã¯[ã“ã®è¨˜äº‹](https://zenn.dev/gsy0911/articles/820313c08a545922733f)ã‚’ã”è¦§ãã ã•ã„ã€‚


```typescript
import {CloudFrontRequestHandler} from "aws-lambda";

export const handler: CloudFrontRequestHandler = async (event) => {
  const request = event.Records[0].cf.request;
  const uri = request.uri;
  // ãƒ•ã‚¡ã‚¤ãƒ«å ("/" ã§åŒºåˆ‡ã‚‰ã‚ŒãŸãƒ‘ã‚¹ã®æœ€å¾Œ) ã‚’å–å¾—
  const filename = uri.split("/").pop();

  if (uri.endsWith("/")) {
    request.uri = request.uri.concat("index.html");
  } else if (filename) {
    if (!filename.includes(".")) {
      // ãƒ•ã‚¡ã‚¤ãƒ«åã«æ‹¡å¼µå­ãŒã¤ã„ã¦ã„ãªã„å ´åˆã€ "/index.html" ã‚’ã¤ã‘ã‚‹
      request.uri = request.uri.concat("/index.html");
    }
  }
  return request
}
```

TypeScriptã®å ´åˆã¯ã€ä»¥ä¸‹ã®CDKã®ã‚³ãƒ¼ãƒ‰ã§Lambda@Edgeã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä¸€è¦‹ã€JavaScriptã®å ´åˆã¨æ¯”ã¹ã‚‹ã¨çŸ­ãã†ã«è¦‹ãˆã¾ã™ãŒã€
äº‹å‰ã«åˆ¥Stackã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã—ã¦ã€SSMã‹ã‚‰Lambdaã®ARNã‚’èª­ã¿å–ã‚‹ã¨ã„ã†æº–å‚™ãŒå¿…è¦ã¨ãªã£ã¦ã„ã¾ã™ã€‚

```typescript:CloudFrontOaiStack.ts
// ~~å‰ç•¥~~

    // Lambda@Edge
    const rewriteTrailingSlashParam = aws_ssm.StringParameter.fromStringParameterAttributes(this, 'rewriteTrailingSlashParam', {
      parameterName: `/${prefix}/${params.environment}/${params.lambdaEdgeStackId}/rewriteTrailingSlash`,
    }).stringValue;
    const rewriteTrailingSlashVersion = aws_lambda.Version.fromVersionArn(this, "rewriteTrailingSlashVersion", rewriteTrailingSlashParam)

// ~~å¾Œç•¥~~
```

# ãƒ‡ãƒ—ãƒ­ã‚¤

ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜ãŒçµ‚ã‚ã£ãŸã®ã§ã€å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¦æŒ™å‹•ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚
JavaScriptã¨TypeScriptã¨ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã®æ‰‹é †ãŒå°‘ã—ç•°ãªã‚Šã¾ã™ã€‚
ã“ã“ã§ã¯ã€ç°¡å˜ãªJavaScriptã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¾ã™ã€‚

Nextã‚’ãƒ“ãƒ«ãƒ‰
S3ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
Route53ãªã©äº‹å‰æº–å‚™
CDKã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

# æŒ™å‹•ã®ç¢ºèª

å®Ÿéš›ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ç¢ºèªã™ã‚‹ã€‚

mdnã®ã‚µã‚¤ãƒˆã«ã¦å®‰å…¨æ€§ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã‚’å®Ÿæ–½ã™ã‚‹

# ãŠã‚ã‚Šã«

CDKã‚’ä½¿ã£ã¦Next.jsã‚’S3+CloudFrontã®æ§‹æˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã—ãŸã€‚
ã“ã®æ§‹æˆã‚’åˆ©ç”¨ã™ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¬‰ã—ã„ã§ã™ã€‚

# å‚è€ƒ

