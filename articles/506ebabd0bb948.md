---
title: "Caddyã«ãŠã‘ã‚‹CORSï¼ˆFastAPIã¨Next.jsã‚’æ·»ãˆã¦ï¼‰"
emoji: "ğŸŒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["caddy", "fastapi", "nextjs"]
published: true
---

# ã¯ã˜ã‚ã«

æœ€è¿‘æµè¡Œã‚Šå§‹ã‚ãã†ãªWebã‚µãƒ¼ãƒãƒ¼ã®Caddyã‚’ä½¿ã£ã¦ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ã®ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã«ã¤ã„ã¦ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚Caddyã¨ã¯Goã§æ›¸ã‹ã‚ŒãŸWebã‚µãƒ¼ãƒãƒ¼ã§ã€`Caddyfile`ã‚’æ›¸ãã“ã¨ã§ã‚µãƒ¼ãƒãƒ¼ã®è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://caddyserver.com/

åŠ ãˆã¦ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®CORSã«ã¤ã„ã¦ã‚‚ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚CORSã¨ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦ã‚µãƒ¼ãƒãƒ¼ãŒè¨±å¯ã‚’ã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã§ã™ã€‚Caddyã§ã®CORSã«é–¢ã™ã‚‹è¨­å®šã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/HTTP/CORS

# ç’°å¢ƒ

ä»Šå›ã®ç’°å¢ƒã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- macOS: 14.5
- Python: 3.12.4
- Node.js: v20.15.1
- Next.js: 14.2.5
- Docker Desktop: 4.32.0 (157355)

# äº‹å‰æº–å‚™

Caddyã®å‹•ä½œç¢ºèªã‚’ã™ã‚‹ãŸã‚ã«ã€ç°¡å˜ãªãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒå¿…è¦ãªã®ã§ãã‚Œãã‚ŒNext.jsã¨FastAPIã§æº–å‚™ã—ã¦ã„ãã¾ã™ã€‚

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆFastAPIï¼‰ã®æº–å‚™

ä»Šå›ã¯poetryã§ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚ä»¥ä¸‹ã®`pyproject.toml`ã¨`Dockerfile`ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```toml: pyproject.toml
[tool.poetry]
name = "caddy-fastapi-nextjs"
version = "0.1.0"
description = ""
authors = [""]

[tool.poetry.dependencies]
python = ">=3.10,<3.13"
mangum = "^0.17.0"
fastapi = "^0.111.1"
uvicorn = {extras = ["standard"], version = "^0.30.3"}
gunicorn = "^22.0.0"
sse-starlette = "^2.1.2"
```

Dockerfileã¯`poetry`ã‹ã‚‰`requirements.txt`ã‚’ç”Ÿæˆã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚srcãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã®ã§ã“ã“ã§COPYã¯ã—ãªã„ã§ã™ã€‚

```Dockerfile: /backend/Dockerfile
FROM python:3.12 as local

WORKDIR /opt/app/src
RUN pip install -U pip poetry==1.8.3
COPY pyproject.toml .
COPY poetry.lock .

RUN poetry export --without-hashes --only main --output requirements.txt
RUN pip install -r requirements.txt

CMD ["uvicorn", "main:app", "--reload", "--host=0.0.0.0", "--port=8080"]
```

æ¬¡ã«ã€GET / POST / PATCHãŒã§ãã‚‹ã‚ˆã†ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚æœ€å¾Œã®è¡Œã§`prefix="/api/v1"`ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã®ã¯ã€å¾Œè¿°ã™ã‚‹caddyã§ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’ã™ã‚‹éš›ã«`/api`ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã§ã™ã€‚

```python: /backend/src/main.py
from logging import INFO, getLogger
import os

from fastapi import APIRouter, FastAPI, Header

app = FastAPI()
api_router = APIRouter()

logger = getLogger()
logger.setLevel(INFO)

__all__ = ["app"]


@api_router.get("/user")
def get_user():
    return {"status": "success"}


@api_router.post("/user")
def post_user():
    return {"status": "success"}


@api_router.patch("/user")
def patch_user():
    return {"status": "success"}
    

app.include_router(router=api_router, prefix="/api/v1")
```

æœ€å¾Œã«`compose.yaml`ã‚’ä½œæˆã—ã¾ã™ã€‚FastAPIã§ã€ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ãŒåŠ¹ãã‚ˆã†ã«volumesã‚’`"./backend/src:/opt/app/src"`ã§ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚åŠ ãˆã¦ã€ä»Šå›ã¯M1 Macã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ã€`platform: linux/amd64`ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚`ports`ã¯ç‰¹ã«ç†ç”±ã¯ãªã„ã§ã™ãŒã€next.jsãŒ`3000`ã§å‹•ãã®ã§åŒã˜`3000`å°ã®HTTPã¨ã„ã†æ„å‘³ã‚’ã“ã‚ã¦`3080`ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

```yaml: /compose.yaml
services:

  backend:
    build:
      context: .
      dockerfile: ./backend/Dockerfile
      target: local
    container_name: backend
    platform: linux/amd64
    tty: true
    ports:
      - "3080:8080"
    volumes:
      - "./backend/src:/opt/app/src"

```

ä½œæˆã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å©ã„ã¦ã€ä»¥ä¸‹ã®çµæœãŒè¿”ã£ã¦ããŸã‚‰ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æº–å‚™ã¯å®Œäº†ã§ã™ã€‚

```shell: ç¢ºèª
$ curl -X GET http://localhost:3080/api/v1/user
{"status":"success"}

$ curl -X POST http://localhost:3080/api/v1/user
{"status":"success"}

$ curl -X PATCH http://localhost:3080/api/v1/user
{"status":"success"}
```

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆNext.jsï¼‰ã®æº–å‚™

ãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹ã«ã¦ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å©ã„ã¦`frontend`ã¨ã„ã†ã‚¢ãƒ—ãƒªåã§åˆæœŸåŒ–ã‚’é€²ã‚ã¾ã™ã€‚

```shell
$ npx create-next-app@latest
What is your project named? frontend
ï¼ˆçœç•¥ï¼‰
```

ã¾ãšæœ€åˆã«ã€`/frontend/app/globals.css`ã®ä¸­èº«ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã€‚
æ¬¡ã«`/frontend/app/page.tsx`ã‚’æ¬¡ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```typescript jsx: /frontend/app/page.tsx
import { ClientComponent } from "./client-component";

export default function Home() {
  return (
    <main>
      <h1>test</h1>
      <ClientComponent />
    </main>
  );
}
```

ãã—ã¦ã€`/frontend/app/client-component.tsx`ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®æ“ä½œã‚’å—ã‘ä»˜ã‘ã‚‹ãƒœã‚¿ãƒ³ãªã©ã‚’å®Ÿè£…ã—ã¾ã™ã€‚`button`ã¨FastAPIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°ã®ã¿å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

```typescript jsx: /frontend/app/client-component.tsx
"use client"

export const ClientComponent = () => {
  const getHandler = async () => {
    const response = await fetch("http://localhost:3080/api/v1/user", {
      method: "GET",
    })
    console.log(response)
  }
  const postHandler = async () => {
    const response = await fetch("http://localhost:3080/api/v1/user", {
      method: "POST",
    })
    console.log(response)
  }
  const patchHandler = async () => {
    const response = await fetch("http://localhost:3080/api/v1/user", {
      method: "PATCH",
    })
    console.log(response)
  }
  return (
    <>
      <button onClick={getHandler}>GET</button>
      <button onClick={postHandler}>POST</button>
      <button onClick={patchHandler}>PATCH</button>
    </>
  )
}
```

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’httpsã§èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«`package.json`ã‚’ä¸€éƒ¨ä¿®æ­£ã—ã¾ã™ã€‚


```diff json: package.json
{
  "name": "frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
-   "dev": "next dev",
+   "dev": "next dev --experimental-https",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  ï¼ˆå¾Œç•¥ï¼‰
}
```

`/frontend`ã«ã¦ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‚‰ã€`https://localhost:3000/` ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

```shell: ç¢ºèª
$ npm run dev
```

ä»¥ä¸‹ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æº–å‚™ã¯å®Œäº†ãªã®ã§ã€ã“ã‚Œã‹ã‚‰ãƒ†ã‚¹ãƒˆã—ã¦ã„ãã¾ã™ã€‚

![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_01.png =600x)
*ä½œæˆã—ãŸãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ç”»é¢*

æ¬¡ã«ä½œæˆã—ãŸãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã¦æŒ™å‹•ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚æœ€åˆã«GETãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœã«ãªã‚Šã¾ã™ã€‚

![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_02_http_get.png =600x)
*GETãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*

GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚‚CORSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«`Same Origin Policy`ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€`Preflight Request`ã¯ç™ºç”Ÿã›ãšã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚

https://zenn.dev/tm35/articles/ad05d8605588bd
https://developer.mozilla.org/ja/docs/Web/HTTP/CORS
https://developer.mozilla.org/ja/docs/Web/Security/Same-origin_policy

ã¾ãŸã€POSTã§ã‚‚åŒæ§˜ã«`Preflight Request`ã¯ç™ºç”Ÿã›ãšã«`Same Origin Policy`ã§ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¾ã™ã€‚

![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_02_http_post.png =600x)
*POSTãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*

ãŸã ã€PATCHã®å ´åˆã¯`Preflight Request`ãŒç™ºç”Ÿã—ã¦ã€ã„ã‚ã‚†ã‚‹`CORS`ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦å¤±æ•—ã—ã¦ã„ã¾ã™ã€‚

![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_02_http_patch.png =600x)
*PATCHãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*


ç‰¹ã«ä½•ã‚‚è¨­å®šã‚’ã—ã¦ã„ãªã„ã¨`Same Origin Policy`ã‚¨ãƒ©ãƒ¼ãŠã‚ˆã³`CORS`ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚ã“ã“ã‹ã‚‰ã¯ã€Caddyã‚’è¨­å®šã—ã¦ã‚ªãƒªã‚¸ãƒ³ãŒç•°ãªã‚‹ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç–é€šãŒã§ãã‚ˆã†ã«ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚

# Caddyã®è¨­å®šï¼šãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·


`/caddy`ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ–°è¦ã«ä½œæˆã—ã¦ã€Caddyã®è¨­å®šã‚’ã—ã¦ã„ãã¾ã™ã€‚

https://dev.classmethod.jp/articles/tried-https-access-with-mkcert-x-nextjs/

æœ€åˆã«Caddyã¸httpsã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«è¨¼æ˜æ›¸ã‚’ä½œæˆã—ã¾ã™ã€‚mkcertãŒãªã„å ´åˆã¯é©å®œã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚

```shell: è¨¼æ˜æ›¸ã®ä½œæˆ
# /caddyãƒ•ã‚©ãƒ«ãƒ€ä»¥ä¸‹ã«ã¦å®Ÿè¡Œ
$ mkcert "localhost"
```

æ¬¡ã«`Caddyfile`ã‚’ä½œæˆã—ã¾ã™ã€‚`{$CADDY_HOSTING_SITE_ADDRESS}`ã¯CaddyãŒç¨¼åƒã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆï¼ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰ã‚’æŒ‡å®šã—ã€`${API_SERVER_SITE_ADDRESS}`ã¯ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã§é€šã™å…ˆã‚’æŒ‡å®šã—ã¾ã™ã€‚ãƒ‘ã‚¹åãŒ`/api/*`ä»¥ä¸‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’FastAPIå´ã«æµã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ä»Šå›ã¯ãã‚Œãã‚Œä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

* `CADDY_HOSTING_SITE_ADDRESS=https://localhost:3443`: Caddyã®ã‚¢ãƒ‰ãƒ¬ã‚¹
* `API_SERVER_SITE_ADDRESS=backend:8080`: `compose.yaml`ã§ã®FastAPIã®ã‚³ãƒ³ãƒ†ãƒŠåã¨ãƒãƒ¼ãƒˆ


```txt: /caddy/Caddifile
{$CADDY_HOSTING_SITE_ADDRESS} {
    tls ./localhost.pem ./localhost-key.pem
    reverse_proxy /api/* {$API_SERVER_SITE_ADDRESS}
}
```

æ¬¡ã«Caddyã®Dockerfileã‚’ä½œæˆã—ã¾ã™ã€‚

```Dockerfile: /caddy/Dockerfile
FROM caddy:latest

COPY localhost.pem .
COPY localhost-key.pem .
CMD ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--watch"]
```

ä¸Šè¨˜ã®Dockerfileã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã«ã€`compose.yaml`ã‚’æ¬¡ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚environmentã«ä¸Šè¨˜ã§`Caddyfile`ã§æŒ‡å®šã—ãŸç’°å¢ƒå¤‰æ•°ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€`Caddyfile`ã¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã“ã¨ã§ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ãŒåŠ¹ãã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```diff yaml: compose.yaml
services:

+ caddy:
+   container_name: caddy
+   build:
+     context: ./caddy
+   restart: unless-stopped
+   environment:
+     CADDY_HOSTING_SITE_ADDRESS: "https://localhost:3443"
+     API_SERVER_SITE_ADDRESS: "backend:8080"
+   volumes:
+     - "./caddy/Caddyfile:/etc/caddy/Caddyfile:ro"
+   ports:
+     - "3443:3443"
  backend:
    build:
      context: .
      dockerfile: ./backend/Dockerfile
      target: local
    container_name: backend
    platform: linux/amd64
    tty: true
    ports:
      - "3080:8080"
    volumes:
      - "./backend/src:/opt/app/src"
```

ä¸Šè¨˜ã®è¨­å®šãŒçµ‚ã‚ã£ãŸã‚‰ã€å†ã³Dockerã‚’èµ·å‹•ã—ã¦ç–é€šç¢ºèªã‚’ã—ã¾ã™ã€‚caddyã§è¨­å®šã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹`https://localhost:3443/` ã‚’æŒ‡å®šã—ã€`/api/*`ä»¥ä¸‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãŸã‚FastAPIå´ã«æµã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚FastAPIã§ã¯`/api/v1/user`ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¦ã„ã‚‹ãŸã‚ã€å‡¦ç†ãŒå®Ÿè¡Œã§ãã¾ã™ã€‚

ä¸Šè¨˜ã®çŠ¶æ…‹ã§å†ã³curlã‚’è©¦ã—ã¦ã¿ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«å„ç¨®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè¡Œã—ã¦çµæœãŒè¿”ã£ã¦ããŸã‚‰æˆåŠŸã§ã™ã€‚

```shell: ç¢ºèª
$ curl -X GET https://localhost:3443/api/v1/user
{"status":"success"}

$ curl -X POST https://localhost:3443/api/v1/user
{"status":"success"}

$ curl -X PATCH https://localhost:3443/api/v1/user
{"status":"success"}
```

curlã§ã®ç–é€šç¢ºèªãŒçµ‚ã‚ã£ãŸã‚‰ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«URLã‚’æ›¸ãæ›ãˆã¦å®Ÿè¡Œã—ã¾ã™ã€‚

```diff typescript jsx: /frontend/app/client-component.tsx
"use client"

export const ClientComponent = () => {
  const getHandler = async () => {
-   const response = await fetch("http://localhost:3080/api/v1/user", { 
+   const response = await fetch("https://localhost:3443/api/v1/user", {
      method: "GET",
    })
    console.log(response)
  }
  const postHandler = async () => {
-   const response = await fetch("http://localhost:3080/api/v1/user", {
+   const response = await fetch("https://localhost:3443/api/v1/user", {
      method: "POST",
    })
    console.log(response)
  }
  const patchHandler = async () => {
-   const response = await fetch("http://localhost:3080/api/v1/user", {
+   const response = await fetch("https://localhost:3443/api/v1/user", {
      method: "PATCH",
    })
    console.log(response)
  }
  return (
    <>
      <button onClick={getHandler}>GET</button>
      <button onClick={postHandler}>POST</button>
    </>
  )
}
```

ã™ã‚‹ã¨å†ã³`Same Origin Policy`ã‚¨ãƒ©ãƒ¼ã§å¤±æ•—ã—ã¦ã—ã¾ã„ã¾ã™ã€‚å…ˆã»ã©ã¨åŒæ§˜ã«GETã¨POSTã®ã©ã¡ã‚‰ã¨ã‚‚`Preflight Request`ã¯é£›ã‚“ã§ã„ã¾ã›ã‚“ã€‚å¤‰ã‚ã£ãŸã¨ã“ã‚ã¯ã‚¹ã‚­ãƒ¼ãƒãŒ`http`ã‹ã‚‰`https`ã«ãªã£ãŸã ã‘ãªã®ã§ã€å½“ç„¶ã¨è¨€ãˆã°ãã†ãªã®ã§ã™ãŒãƒ»ãƒ»ãƒ»ã€‚

![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_03_https_get.png =600x)
*å¤‰æ›´å¾Œã®GETãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*

![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_03_https_post.png =600x)
*å¤‰æ›´å¾Œã®POSTãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*

PATCHã®å ´åˆã¯ã€`Preflight Request`ã‚‚é£›ã‚“ã§ã€ã„ã‚ã‚†ã‚‹`CORS`ã§ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã„ã¾ã™ã€‚

![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_03_http_patch.png =600x)
*PATCHãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*

æ¬¡ã‹ã‚‰ã‚ˆã†ã‚„ãCORSã®è¨­å®šã‚’Caddyã§ã—ã¾ã™ã€‚

# Caddyã®è¨­å®šï¼šCORSã‚’é€šã™

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ç•°ãªã‚‹ã‚ªãƒªã‚¸ãƒ³ã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‹ã‘ã‚‹å ´åˆã«ã¯CORSã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®Gistã«Caddyã§ã®å®Ÿè£…ä¾‹ãŒã‚ã‚Šã¾ã™ãŒã€æœ€æ–°ã®Caddyã ã¨å‹•ã‹ãªã„ã®ã§ä¿®æ­£ã—ã¾ã™ã€‚

https://gist.github.com/ryanburnette/d13575c9ced201e73f8169d3a793c1a3

Caddyã«ã¯snippetsã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚Šã€`import {ã‚¹ãƒ‹ãƒšãƒƒãƒˆå} {...å¼•æ•°}`ã¨ã„ã†å½¢ã§å‘¼ã³å‡ºã™ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ä»Šå›ã¯ã€`(cors_preflight)`ã¨`(cors)`ã¨ã„ã†ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚ãã‚Œãã‚Œã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã®å¼•æ•°`https://localhost:3000`ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ƒã®Next.jsã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ã„ã¦ãŠãã¾ã™ã€‚

```diff txt: Caddyfile
+(cors_preflight) {
+       @cors_preflight{args[0]} method OPTIONS
+       handle @cors_preflight{args[0]} {
+               header {
+                       Access-Control-Allow-Credentials "true"
+                       Access-Control-Allow-Origin "{args[0]}"
+                       Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
+                       Access-Control-Allow-Headers "Origin, Referer, User-Agent, Authorization, Accept, Content-Type, Access-Control-Request-Methods, Access-Control-Request-Origin"
+                       Access-Control-Max-Age "1800"
+                       defer
+               }
+               respond "" 204
+       }
+}
+
+(cors) {
+       @cors{args[0]} header Origin {args[0]}
+
+       handle @cors{args[0]} {
+               header {
+                       Access-Control-Allow-Credentials "true"
+                       Access-Control-Allow-Origin "{args[0]}"
+                       Access-Control-Allow-Headers "Origin, Referer, User-Agent, Authorization, Accept, Content-Type, Access-Control-Request-Methods, Access-Control-Request-Origin"
+                       defer
+               }
+       }
+}

{$CADDY_HOSTING_SITE_ADDRESS} {
    tls ./localhost.pem ./localhost-key.pem
+   import cors_preflight https://localhost:3000
+   import cors https://localhost:3000
    reverse_proxy /api/* {$API_SERVER_SITE_ADDRESS}
}
```

ä¸Šè¨˜ã®Caddyãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¦å†åº¦å®Ÿè¡Œã™ã‚‹ã¨æˆåŠŸã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_04_cors_get.png =600x)
*CORSè¨­å®šå¾Œã«GETãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*


![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_04_cors_post.png =600x)
*CORSè¨­å®šå¾Œã«POSTãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*

PATCHã‚’å®Ÿè¡Œã—ãŸæ™‚ã®ã¿ã€`preflight request`ã®OPTIONSãŒé£›ã‚“ã§ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_04_cors_patch.png =600x)
*CORSè¨­å®šå¾Œã«PATCHãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*

:::message
ä¸€åº¦OPTIONSãŒé€šã‚‹ã¨ãƒªãƒ­ãƒ¼ãƒ‰ãªã©ã‚’ã—ãªã„é™ã‚Šã€2åº¦ç›®ã®OPTIONSã¯é£›ã°ãªã„ã®ã§Caddyã®è¨­å®šãªã©ã‚’å¤‰æ›´ã—ã¦è©¦ã™å ´åˆã«ã¯ã”æ³¨æ„ãã ã•ã„ã€‚
:::

# ãŠã‚ã‚Šã«

æœ¬è¨˜äº‹ã§ã¯ã€ŒCaddyã‚’è»½ãè§¦ã£ã¦ã¿ãŸã„ã€ã¨ã„ã†å†…å®¹ã‹ã‚‰CORSã®ç¢ºèªã‚’ã—ã¾ã—ãŸã€‚ä»Šã¾ã§CORSã¯ãµã‚“ã‚ã‚Šã¨ç†è§£ã—ã¦ã„ãŸã®ã§ã™ãŒã€æ”¹ã‚ã¦ã“ã†ã—ã¦ã¾ã¨ã‚ã‚‹ã¨çŸ¥ã‚‰ãªã„æ¦‚å¿µãŒã‚ã£ãŸã‚Šã¨å­¦ã³ãŒã‚ã‚Šã¾ã—ãŸã€‚

# ãã®ä»–ã®å‚è€ƒ

https://medium.com/@devahmedshendy/traditional-setup-run-local-development-over-https-using-caddy-964884e75232


