---
title: "CDKã§AWS Batchç’°å¢ƒã‚’ä½œæˆã™ã‚‹"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS", "AWSCDK", "TypeScript", "awsbatch"]
published: true
---

::: message
AWS Batchã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ç¾åœ¨ã‚¢ãƒ«ãƒ•ã‚¡ç‰ˆã§ã€
å°†æ¥ä»•æ§˜ãŒå¤§ããå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

åŸ·ç­†æ™‚ã®`@aws-cdk/aws-batch-alpha`ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯`2.87.0-alpha.0`ã§ã™ãŒ
`BUG FIX`ã®æ›´æ–°ãŒé »ç¹ã«ã•ã‚Œã¦ãŠã‚Šã€ã™ãã«ä»•æ§˜ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
è©³ç´°ã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-batch-alpha-readme.html)ã‚’ç¢ºèªãã ã•ã„ã€‚
:::


# ã¯ã˜ã‚ã«

ä¹…ã—ã¶ã‚Šã«`AWS Batch`ã‚’CDKã§æ›¸ã“ã†ã¨ã—ãŸã‚‰ã€éå»ã®ã‚½ãƒ¼ã‚¹ãŒå‹•ã‹ãªããªã£ã¦ã„ã¾ã—ãŸã€‚
ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ã¿ãŸã¨ã“ã‚ã€`v2.74.0`ã«ã¦
`ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç’°å¢ƒ`ã¨`ã‚¸ãƒ§ãƒ–å®šç¾©`ã®2ã¤ã®å®šç¾©æ–¹æ³•ãŒå¤‰ã‚ã£ãŸã¿ãŸã„ã§ã™ã€‚

https://github.com/aws/aws-cdk/releases/tag/v2.74.0

> `ComputeEnvironment` has been removed and replaced by `ManagedEc2EcsComputeEnvironment`, `ManagedEc2EksComputeEnvironment`, and `UnmanagedComputeEnvironment`.
`JobDefinition` has been removed and replaced by `EcsJobDefinition`, `EksJobDefinition`, and `MultiNodeJobDefinition`

ECSã¨EKSã¨ãã‚Œä»¥å¤–ã‚’åŸºæº–ã«åˆ†ã‹ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ä¾¿åˆ©ã«ãªã£ãŸã®ã‹ãªã¨æ€ã„ã¾ã™ã€‚
ï¼ˆECSä»¥å¤–ã§ã®ç’°å¢ƒã§AWS Batchã‚’åˆ©ç”¨ã—ãŸã“ã¨ã¯ãªã„ã§ã™ãŒãƒ»ãƒ»ãƒ»ã€‚ï¼‰

`2.87.0-alpha.0`æ™‚ç‚¹ã§ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¤ã¤å¤‰æ›´ã‚’ã—ã¦ã„ãŸã®ã§ã™ãŒã€
ã¡ã‚‰ã»ã‚‰ã¨ãƒãƒã£ãŸã®ã§å…¨ä½“çš„ãªæ§‹æˆã‚’å…±æœ‰ã—ã¾ã™ã€‚
EC2ã¨ECSã‚’åˆ©ç”¨ã—ã¦ã®AWS Batchç’°å¢ƒã«ãªã£ã¦ã„ã¾ã™ã€‚

::: message
AWS Batchã®å®Ÿè¡Œç’°å¢ƒãŒ`PUBLIC Subnet`ã«ãªã£ã¦ã„ã¾ã™ãŒã€
æ°—ã«ãªã‚‹å ´åˆã¯`PRIVATE Subnet`ãªã©ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
:::



# `2.74.0-alpha.0`ä»¥é™ã®æ›¸ãæ–¹

```typescript :BatchStack.ts
import {
  App,
  Size,
  Stack,
  StackProps,
  aws_ec2,
  aws_ecr,
  aws_ecs,
  aws_iam,
  Duration,
} from 'aws-cdk-lib';
import * as aws_batch_alpha from '@aws-cdk/aws-batch-alpha';

const prefix = "zenn-example"
const ecrTag = "v0.1.0"

interface IParameters {
  vpcId: `vpc-${string}`
  ecrRepositoryArn: string
}

export class BatchStack extends Stack {
  constructor(scope: App, id: string, params: IParameters, props?: StackProps) {
    super(scope, id, props);

    const vpc = aws_ec2.Vpc.fromLookup(this, "vpc", {
      vpcId: params.vpcId
    })

    const securityGroup = new aws_ec2.SecurityGroup(this, "security-group", {
      vpc,
      securityGroupName: `${prefix}-security-group`,
      allowAllOutbound: true,
    })

    const instanceRole = new aws_iam.Role(this, "instance-role", {
      roleName: `${prefix}-instance-role`,
      assumedBy: new aws_iam.ServicePrincipal('ec2.amazonaws.com'),
      managedPolicies: [
        aws_iam.ManagedPolicy.fromManagedPolicyArn(
          this, `AmazonEC2ContainerServiceforEC2Role-batch`, "arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role"
        ),
        aws_iam.ManagedPolicy.fromManagedPolicyArn(
          this, `CloudWatchLogsFullAccess-batch`, "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess"
        )
      ]
    })
    const instanceProfile = new aws_iam.CfnInstanceProfile(this, "instance-profile", {
      instanceProfileName: `${prefix}-instance-profile`,
      roles: [instanceRole.roleName]
    })

    const batchComputeEnvironment = new aws_batch_alpha.ManagedEc2EcsComputeEnvironment(this, "batch-environment", {
      vpc,
      securityGroups: [securityGroup],
      maxvCpus: 16,
      minvCpus: 0,
      instanceRole: instanceRole,
      vpcSubnets: {
        subnetType: aws_ec2.SubnetType.PUBLIC,
      },
      computeEnvironmentName: `${prefix}-compute-environment`,
      spot: true,
      useOptimalInstanceClasses: false,
      instanceTypes: [
        new aws_ec2.InstanceType("c6i.2xlarge"),
      ],
    })

    const containerImage = aws_ecs.ContainerImage.fromEcrRepository(
      aws_ecr.Repository.fromRepositoryArn(this, "ecr", params.ecrRepositoryArn), ecrTag
    )
    const jobRole = new aws_iam.Role(this, `batch-job-role`, {
      roleName: `${prefix}-batch-job-role`,
      assumedBy: new aws_iam.ServicePrincipal('ecs-tasks.amazonaws.com'),
      managedPolicies: [
        aws_iam.ManagedPolicy.fromManagedPolicyArn(
          this, "AmazonECSTaskExecutionRolePolicy-job", "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
        ),
        aws_iam.ManagedPolicy.fromManagedPolicyArn(
          this, "CloudWatchLogsFullAccess-job", "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess"
        )
      ]
    })

    const batchJobQueue = new aws_batch_alpha.JobQueue(this, "batch-job-queue", {
      jobQueueName: `${prefix}-job-queue`,
      computeEnvironments: [
        {
          computeEnvironment: batchComputeEnvironment,
          order: 1
        }
      ],
      priority: 1
    })

    const batchJobDefinition = new aws_batch_alpha.EcsJobDefinition(this, "batch-job-definition", {
      jobDefinitionName: `${prefix}-job-def`,
      timeout: Duration.hours(2),
      container: new aws_batch_alpha.EcsEc2ContainerDefinition(this, 'containerDefn', {
        image: containerImage,
        memory: Size.gibibytes(15),
        cpu: 8,
        readonlyRootFilesystem: true,
        privileged: false,
        user: "user",
        jobRole,
        logging: new aws_ecs.AwsLogDriver({streamPrefix: prefix})
      }),
    })
  }
}
```

ä¸€å¿œä»¥ä¸‹ã«`2.73.0-alpha.0`ä»¥å‰ã®æ›¸ãæ–¹ã‚‚æ®‹ã—ã¦ãŠãã¾ã™ã€‚

::::details ä»¥å‰ã®æ›¸ãæ–¹

```typescript :BatchStack.ts
import {
  App,
  Stack,
  StackProps,
  aws_ec2,
  aws_ecr,
  aws_ecs,
  aws_iam,
} from 'aws-cdk-lib';
import * as aws_batch_alpha from '@aws-cdk/aws-batch-alpha';

const prefix = "zenn-example"
const ecrTag = "v0.1.0"

interface IParameters {
  vpcId: `vpc-${string}`
  ecrRepositoryArn: string
}

export class BatchStack extends Stack {
  constructor(scope: App, id: string, params: IParameters, props?: StackProps) {
    super(scope, id, props);

    const vpc = aws_ec2.Vpc.fromLookup(this, "vpc", {
      vpcId: params.vpcId
    })

    const securityGroup = new aws_ec2.SecurityGroup(this, "security-group", {
      vpc: vpc,
      securityGroupName: `${prefix}-security-group`,
      allowAllOutbound: true
    })

    const instanceRole = new aws_iam.Role(this, "instance-role", {
      roleName: `${prefix}-instance-role`,
      assumedBy: new aws_iam.ServicePrincipal('ec2.amazonaws.com'),
      managedPolicies: [
        aws_iam.ManagedPolicy.fromManagedPolicyArn(
          this, `AmazonEC2ContainerServiceforEC2Role-batch`, "arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role"
        ),
        aws_iam.ManagedPolicy.fromManagedPolicyArn(
          this, `CloudWatchLogsFullAccess-batch`, "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess"
        )
      ]
    })
    const instanceProfile = new aws_iam.CfnInstanceProfile(this, "instance-profile", {
      instanceProfileName: `${prefix}-instance-profile`,
      roles: [instanceRole.roleName]
    })

    const containerImage = aws_ecs.ContainerImage.fromEcrRepository(
      aws_ecr.Repository.fromRepositoryArn(this, "ecr", params.ecrRepositoryArn), ecrTag
    )

    const batchComputeEnvironment = new aws_batch_alpha.ComputeEnvironment(this, "batch-environment", {
      computeEnvironmentName: `${prefix}-compute-environment`,
      computeResources: {
        vpc: vpc,
        maxvCpus: 16,
        minvCpus: 0,
        securityGroups: [securityGroup],
        instanceRole: instanceProfile.attrArn,
        type: aws_batch_alpha.ComputeResourceType.SPOT,
        instanceTypes: [
        	new aws_ec2.InstanceType("c6i.2xlarge")
        ]
      }
    })

    const jobRole = new aws_iam.Role(this, `batch-job-role`, {
      roleName: `${prefix}-batch-job-role`,
      assumedBy: new aws_iam.ServicePrincipal('ecs-tasks.amazonaws.com'),
      managedPolicies: [
        aws_iam.ManagedPolicy.fromManagedPolicyArn(
          this, "AmazonECSTaskExecutionRolePolicy-job", "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
        ),
        aws_iam.ManagedPolicy.fromManagedPolicyArn(
          this, "CloudWatchLogsFullAccess-job", "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess"
        )
      ]
    })

    const batchJobQueue = new aws_batch_alpha.JobQueue(this, "batch-job-queue", {
      jobQueueName: `${prefix}-job-queue`,
      computeEnvironments: [
        {
          computeEnvironment: batchComputeEnvironment,
          order: 1
        }
      ],
      priority: 1
    })

    const batchJobDefinition = new aws_batch_alpha.JobDefinition(this, "batch-job-definition", {
      jobDefinitionName: `${prefix}-job-def`,
      container: {
        image: containerImage,
        jobRole: jobRole,
        vcpus: 8,
        memoryLimitMiB: 14000,
        logConfiguration: {
          logDriver: aws_batch_alpha.LogDriver.AWSLOGS
        },
        readOnly: true,
        privileged: false,
        user: "user"
      }
    })
  }
}
```

::::

# ãŠã‚ã‚Šã«

å…ƒã€…`@aws-cdk/aws-batch-alpha`ã¯alphaç‰ˆãªã®ã§å¤§ããªå¤‰æ›´ã¯å…¥ã‚‹ã‹ãªã¨æ€ã£ã¦ã„ã¾ã—ãŸãŒã€
å®Ÿéš›ã«å¤‰æ›´ãŒå…¥ã‚‹ã¨ã³ã£ãã‚Šã—ã¾ã—ãŸã€‚
