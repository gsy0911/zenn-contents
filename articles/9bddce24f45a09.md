---
title: "ã€NextAuth.jsã€‘Next.jsã®Pages Routerã‚’CloudFrontã¨API Gatewayã§ç¨¼åƒã•ã›ã‚‹"
emoji: "ğŸ’¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextauth", "nextjs", "cloudfront", "apigateway", "awscdk"]
published: false
---

## ã¯ã˜ã‚ã« / ã‚„ã‚ŠãŸã„ã“ã¨

Next.js(Pages Router)ã§NextAuth.jsã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ãŒã§ãã‚‹ã‚¢ãƒ—ãƒªã‚’ã€
CloudFrontã¨API Gatewayä¸Šã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

Pages Routerã§ã¯ã€å‹•çš„å‡¦ç†ã‚’æä¾›ã™ã‚‹API Routesã¯`/api`ä»¥ä¸‹ã§å‹•ãã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
`/api`ä»¥å¤–ã®ãƒšãƒ¼ã‚¸ã‚„ã€`SSR`ã‚’ã—ãªã„å ´åˆã¯ã€é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

ãã®ãŸã‚é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’CloudFrontã§é…ä¿¡ã—ã¦ã€
å‹•çš„éƒ¨åˆ†ã®`/api`ä»¥ä¸‹ã‚’API Gateway + Lambdaã‚’ä½¿ã£ã¦ç¨¼åƒã•ã›ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

å‚è€ƒã«ã—ãŸã®ã¯ä»¥ä¸‹ã®è¨˜äº‹ã§ã™ã€‚
å‚è€ƒè¨˜äº‹ä¸­ã§ã¯ã€å‹•çš„éƒ¨åˆ†ã‚’AppRunnerã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒã‚„ã‚ŠãŸã„ã“ã¨ã¯åŒã˜ã§ã™ã€‚

https://dev.classmethod.jp/articles/nextjs-static-cache/

:::message
è¨˜äº‹ã‚’æ›¸ã„ã¦ãŠã„ã¦ãªã‚“ã§ã™ãŒã€ã“ã“ã¾ã§ã‚´ãƒ‹ãƒ§ã‚´ãƒ‹ãƒ§ã™ã‚‹ãªã‚‰ã€
Amplifyã¨ã‹ã‚’ä½¿ã£ãŸã»ã†ãŒå¹¸ã›ã«ãªã‚Œã‚‹æ°—ã‚‚ã—ã¾ã™ãƒ»ãƒ»ãƒ»ï¼
:::

:::message
ãªãŠApp Routerã§ã‚‚åŒã˜ã“ã¨ã‚’è©¦ã—ãŸã®ã§ã™ãŒç¾æ™‚ç‚¹ã§ã¯å‹•ä½œç¢ºèªã¨ã‚Œã¦ãªã„ã§ã™ã€‚
:::

## å¯¾è±¡èª­è€…

- Next.jsã®Pages Routerã‚’ä½¿ã£ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’æ§‹ç¯‰ã—ã¦ã„ã‚‹
- Vercelã‚„Netfilyã§ã¯ãªãAWSã®CloudFrontãªã©ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ¤œè¨ã—ã¦ã„ã‚‹
- NextAuth.jsã‚„ã€`/pages/api`ä»¥ä¸‹ã®é ˜åŸŸã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹

## æ§‹æˆ

ä»¥ä¸‹ãŒä»Šå›ä½œæˆã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®æ§‹æˆå›³ã§ã™ã€‚

![](/images/nextjs_nextauthjs_cognito_4/nextjs_nextauthjs_cognito_4_1.png =600x)

ä¸Šè¿°ã®ã‚ˆã†ã«ã€å‹•çš„å‡¦ç†ã‚’ã™ã‚‹`/api/*`ä»¥ä¸‹ã¯API Gatewayã«å‡¦ç†ã‚’æµã—ã¦ã€
ãã‚Œä»¥å¤–ã®é™çš„ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯S3ã‹ã‚‰CloudFrontã‚’çµŒç”±ã—ã¦é…ä¿¡ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

## ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ

- macOS: 14.1
- Next.js: 13.4
- Node.js: 18.16
- AWS CDK: 2.105.0
- Mantine: 6.0.20

# ã‚³ãƒ¼ãƒ‰

ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ãŠã„ã¦ã‚ã‚Šã¾ã™ã€‚
æœ¬è¨˜äº‹ã§ã¯ç´¹ä»‹ã§ããªã„ç®‡æ‰€ã‚‚ã‚ã‚‹ã®ã§ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã«ã¯ãœã²ã”è¦§ãã ã•ã„ã€‚

https://github.com/gsy0911/zenn-nextjs-authjs-cognito/tree/v4.0

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æº–å‚™

å‹•çš„å‡¦ç†ã¨é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ“ãƒ«ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

```json: package.json
  "scripts": {
    "build:standalone": "ENV=production OUTPUT=standalone next build",
    "build:export": "ENV=production OUTPUT=export next build",
  },
```

```js: next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  trailingSlash: true,
  output: process.env.OUTPUT
}

module.exports = nextConfig
```

ã“ã†ã—ã¦ãŠãã“ã¨ã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å‹•çš„å‡¦ç†ã«å¯¾å¿œã—ãŸãƒ“ãƒ«ãƒ‰ã‚’ã€

```shell
$ npm run build:standalone
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å‡ºåŠ›ã™ã‚‹ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

```shell
$ npm run build:export
```


### å‹•çš„å‡¦ç†ã®ãŸã‚ã®Dockerä½œæˆ

ã¾ãšã¯API Gateway + Lambdaã§å‹•ã‹ã™ãŸã‚ã«Dockerfileã‚’ä½œæˆã—ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆã‚’å‚è€ƒã«Lambdaã§å‹•ãã‚ˆã†ã«ã—ã¾ã™ã€‚

https://qiita.com/Nozomuts/items/b3a4fd57d0413d5d3437

```Dockerfile
# ref: https://qiita.com/Nozomuts/items/b3a4fd57d0413d5d3437
FROM node:18 AS builder

WORKDIR /app

COPY ./frontend/zenn/package.json ./
COPY ./frontend/zenn/package-lock.json ./
RUN npm ci
COPY ./frontend/zenn ./
RUN npm run build:standalone

FROM node:18-slim AS runner
# ã“ã‚Œã‚’æŒŸã‚€ã“ã¨ã§Lambdaã§å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
COPY --from=public.ecr.aws/awsguru/aws-lambda-adapter:0.7.1 /lambda-adapter /opt/extensions/lambda-adapter
# ã“ã®å€¤ã¯Dockerãªã‚‰å¿…é ˆã®ãŸã‚ã“ã“ã§å›ºå®š
ENV PORT=3000
WORKDIR /app

# public ã¨ .next/static ã¯ nextjs ã® standalone ã‚’ä½¿ã†å ´åˆã«å«ã¾ã‚Œãªã„ãŸã‚ã€ã‚³ãƒ”ãƒ¼ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
# https://nextjs.org/docs/advanced-features/output-file-tracing#automatically-copying-traced-files
# builderã‹ã‚‰å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã‚³ãƒ”ãƒ¼ã™ã‚‹
COPY --from=builder /app/next.config.js ./
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/.next/standalone ./

# `next start` ã®ä»£ã‚ã‚Šã« `node server.js` ã‚’ä½¿ç”¨
# https://nextjs.org/docs/advanced-features/output-file-tracing#automatically-copying-traced-files
CMD ["node", "server.js"]
```

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ƒã«ã€Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ECRã¸pushã—ã¦ãŠãã¾ã™ã€‚

### é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤

é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ãƒ“ãƒ«ãƒ‰å¾Œã«S3ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

```shell
# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯/frontend/zennä»¥ä¸‹
$ aws s3 sync out s3://{S3_BUCKET_NAME}
```

ã“ã‚Œã§å‰æº–å‚™ã¯å®Œäº†ã§ã™ã€‚

## ã‚¤ãƒ³ãƒ•ãƒ©ã®æ§‹ç¯‰

ä»Šå›ã‚‚CDKã‚’ä½¿ã£ã¦ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚


# ãŠã‚ã‚Šã«

