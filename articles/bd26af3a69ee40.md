---
title: "ã€NextAuth.js/èªå¯ã€‘S3ãƒã‚±ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’IdTokenã§åˆ¶é™ã™ã‚‹"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextauth", "nextjs", "cognito", "awscdk"]
published: true
---


# ã¯ã˜ã‚ã«

ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®AWSãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã—ãŸã„æ™‚ã«ã€IAM Roleã§åˆ¶å¾¡ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ç°¡å˜ã«ã¾ã¨ã‚ã¾ã™ã€‚

æœ¬è¨˜äº‹ã¯ã€ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«AWS CDKã§æ§‹ç¯‰ã—ãŸã‚‚ã®ã§ã™ã€‚

https://dev.classmethod.jp/articles/cognito-trigger-allow-access-per-identity-id/

ãªãŠã€æœ¬è¨˜äº‹ã®Cognitoã®IDãƒ—ãƒ¼ãƒ«ã®è¨­å®šã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’ãƒ™ãƒ¼ã‚¹ã«æ›¸ã„ã¦ã„ã¾ã™ã€‚
äº‹å‰ã«èª­ã‚“ã§ãŠãã¨ã‚ˆã‚Šç†è§£ãŒã—ã‚„ã™ã„ã¯ãšã§ã™ã€‚

https://zenn.dev/gsy0911/articles/5f3290ca3a54ce

## ã‚„ã‚ŠãŸã„ã“ã¨

åŸºæœ¬çš„ãªIAM Roleã®å–å¾—ã¨ä¸€æ™‚ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚­ãƒ¼ã®å–å¾—ã®æ¦‚å¿µã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰€å±ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã«S3ã¸ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªæ¨©é™ãŒä»˜ä¸ã•ã‚Œã¦ãŠã‚Šã€
ãã®ãŸã‚ã€ä¸€æ™‚ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚­ãƒ¼ã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒS3ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

![](/images/nextjs_nextauthjs_cognito_3/nextjs_nextauthjs_cognito_3_1.png =600x)
*S3ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªä¸€æ™‚ã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹*


S3ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚’Lambdaã«è¨­å®šã§ãã¾ã™ã€‚
IDãƒ—ãƒ¼ãƒ«ã‹ã‚‰ã¯`IdentityId`ã¨ã„ã†IDãŒç™ºè¡Œã•ã‚Œã€IAM Roleã‹ã‚‰å‚ç…§å¯èƒ½ã§ã™ã€‚
ãã®ãŸã‚ã€S3ã®ãƒ‘ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã¨ã—ã¦è¨­å®šã§ãã¾ã™ã€‚

ä¾‹ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã«ã¯`ap-northeast-1:aaaa0001`ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã«`ap-northeast-1:bbbb0002`ã¨ã„ã†`IdentityId`ãŒç™ºè¡Œã•ã‚ŒãŸã¨ã—ã¾ã™ã€‚
ãã—ã¦ã€IAM Roleã§ã¯ã€S3ã®ãƒ‘ã‚¹ã®ã†ã¡`s3://zenn-example/cognito-test/{IdentityId}`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿è¨±å¯ã™ã‚‹è¨­å®šã«ã—ã¦ãŠãã¾ã™ã€‚
ãã®IAM Roleã‚’ä»‹ã—ã¦Lambdaã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã¯`s3://zenn-example/cognito-test/ap-northeast-1:aaaa0001`ã®ãƒ‘ã‚¹ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
å¯¾ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã®ãƒ‘ã‚¹ã¨ã—ã¦ã„ã‚‹`s3://zenn-example/cognito-test/ap-northeast-1:bbbb0002`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã§ããªã„ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](/images/nextjs_nextauthjs_cognito_3/nextjs_nextauthjs_cognito_3_2.png)
*S3ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªä¸€æ™‚ã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹*


## å¯¾è±¡èª­è€…

- Cognitoã‚’ä½¿ã£ã¦ã„ã‚‹
- ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«æ¨©é™ã‚’ä»˜ä¸ã—ãŸã„
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ç‰¹å®šã®S3ã®ãƒ‘ã‚¹ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã€IAM Roleã§åˆ¶é™ã—ãŸã„


## ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ

- macOS: 13.5
- AWS CDK: 2.96.2

# ã‚³ãƒ¼ãƒ‰

ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ãŠã„ã¦ã‚ã‚Šã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯ç´¹ä»‹ã—ãªã„ã€API Gatewayã®æ§‹ç¯‰ãªã©ã‚‚ã§ãã¾ã™ã€‚

https://github.com/gsy0911/zenn-nextjs-authjs-cognito/tree/v3

:::message
ãªãŠã€æœ¬è¨˜äº‹ã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ã€`admin`ã¨`user`ã®2ç¨®é¡ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã¯ã€[å‰å›ã®è¨˜äº‹](https://zenn.dev/gsy0911/articles/5f3290ca3a54ce)ã§åˆ©ç”¨ã—ãŸã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãã®ã¾ã¾ä½¿ã£ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚
ã“ã®è¨˜äº‹ã§ã¯ã©ã¡ã‚‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚åŒæ§˜ã®æ¨©é™ã‚’è¨­å®šå¯èƒ½ãªã®ã§`admin`ã«çµã£ã¦èª¬æ˜ã—ã¾ã™ã€‚
:::

## ã‚¤ãƒ³ãƒ•ãƒ©

`PolicyStatement`ã§IDãƒ—ãƒ¼ãƒ«ã‹ã‚‰ç™ºè¡Œã•ã‚Œã‚‹`IdentityId`ã‚’å—ã‘å–ã‚‹å½¢ã§
S3ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚’è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚
`${cognito-identity.amazonaws.com:sub}`ã§`IdentityId`ã‚’å—ã‘å–ã£ã¦ã„ã¾ã™ã€‚

```diff typescript: infrastructure/lib/Cognito.tsï¼ˆä¸€éƒ¨ï¼‰
ï¼ˆå‰ç•¥ï¼‰
    // IdentityPoolã‹ã‚‰assumeã§ãã‚‹IAM Role
    const federatedPrincipal = new aws_iam.FederatedPrincipal(
      "cognito-identity.amazonaws.com",
      {
        StringEquals: {
          "cognito-identity.amazonaws.com:aud": params.idPool.idPoolId,
        },
        "ForAnyValue:StringLike": {
          "cognito-identity.amazonaws.com:amr": "authenticated",
        },
      },
      "sts:AssumeRoleWithWebIdentity",
    );

    const adminRole = new aws_iam.Role(this, "admin-role", {
      roleName: `${prefix}-api-gateway-admin-role`,
      assumedBy: federatedPrincipal,
      inlinePolicies: {
        executeApi: new aws_iam.PolicyDocument({
          statements: [
            new aws_iam.PolicyStatement({
              effect: aws_iam.Effect.ALLOW,
              resources: adminOnlyApiGwResource(
                accountId,
                params.idPool.apigwRestApiId,
              ),
              actions: ["execute-api:Invoke"],
            }),
+           new aws_iam.PolicyStatement({
+             effect: aws_iam.Effect.ALLOW,
+             actions: ["s3:ListBucket"],
+             resources: [`arn:aws:s3:::${params.s3Bucket}`],
+             conditions: { StringLike: { "s3:prefix": ["cognito-test"] } },
+           }),
+           new aws_iam.PolicyStatement({
+             effect: aws_iam.Effect.ALLOW,
+             resources: [
+               `arn:aws:s3:::${params.s3Bucket}/cognito-test/\${cognito-identity.amazonaws.com:sub}`,
+               `arn:aws:s3:::${params.s3Bucket}/cognito-test/\${cognito-identity.amazonaws.com:sub}/*`,
+             ],
+             actions: ["s3:GetObject", "s3:PutObject", "s3:DeleteObject"],
+           }),
          ],
        }),
      },
    });
ï¼ˆå¾Œç•¥ï¼‰
```

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

Lambdaã§å®Ÿè¡Œã™ã‚‹å‡¦ç†ã®èª¬æ˜ã‚’ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®é–¢æ•°ã§IdTokenã‹ã‚‰AWSã®ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’å–å¾—ã—ã¾ã™ã€‚

```python: backend/src/lambda_handlers.pyï¼ˆä¸€éƒ¨ï¼‰
import jwt
import boto3
import s3fs
import os


client = boto3.client("cognito-identity", region_name="ap-northeast-1")
idp = boto3.client("cognito-idp", region_name="ap-northeast-1")

REGION = "ap-northeast-1"
ACCOUNT_ID = os.environ["ACCOUNT_ID"]
USER_POOL_ID = os.environ["USER_POOL_ID"]
IDENTITY_POOL_ID = os.environ["IDENTITY_POOL_ID"]
S3_BUCKET = os.environ["S3_BUCKET"]


def _get_credentials_from_id_token(id_token: str) -> dict:
    logins = {f"cognito-idp.{REGION}.amazonaws.com/{USER_POOL_ID}": id_token}
    decode_jwt = jwt.decode(id_token, options={"verify_signature": False})
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ã®ç¢ºèª
    # å­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
    user_info = idp.admin_get_user(UserPoolId=USER_POOL_ID, Username=decode_jwt["cognito:username"])
    print(f"{user_info=}")

    # identity-poolã‹ã‚‰idã‚’å–å¾—ã™ã‚‹
    cognito_identity_id = client.get_id(
        AccountId=ACCOUNT_ID, IdentityPoolId=IDENTITY_POOL_ID, Logins=logins
    )
    # get ACCESS_KEY, SECRET_KEY, etc...
    credentials = client.get_credentials_for_identity(
        IdentityId=cognito_identity_id["IdentityId"], Logins=logins
    )
    return credentials

ï¼ˆå¾Œç•¥ï¼‰
```

:::message
ä»Šå›ã¯APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦API Gateway + Lambdaã®å½¢ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€
Lambdaã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ãŒã€IdTokenã‚’å–å¾—ã§ãã‚‹ãªã‚‰ã©ã“ã§ã‚‚åŒã˜ã“ã¨ãŒã§ãã¾ã™ã€‚
:::

ä»¥ä¸‹ãŒ`GET /read-file`ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…ã§ã™ã€‚
`id_token`ã‹ã‚‰ä¸€æ™‚ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ã€ãã‚Œã‚’ä½¿ã£ã¦S3ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ã€‚

```python: backend/src/lambda_handlers.pyï¼ˆä¸€éƒ¨ï¼‰
ï¼ˆå‰ç•¥ï¼‰

@api_router.get("/read-file")
def read_file(request: Request):
    lambda_event = request.scope["aws.event"]
    print(f"{lambda_event=}")
    id_token = lambda_event["headers"]["idToken"]
    credentials = _get_credentials_from_id_token(id_token=id_token)
    fs = s3fs.S3FileSystem(
        anon=False,
        key=credentials["Credentials"]["AccessKeyId"],
        secret=credentials["Credentials"]["SecretKey"],
        token=credentials["Credentials"]["SessionToken"],
    )
    with fs.open(f"s3://{S3_BUCKET}/cognito-test/{credentials['IdentityId']}/data.txt", "r") as f:
        data = f.readline()
    return {"status": "success", "type": "common", "data": data}
```

:::message
é€šå¸¸ã®å‹•ä½œã§ã¯`s3fs`ã‚„`boto3`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã«ã‚­ãƒ¼ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã‚€å½¢ã§ã®å®Ÿè¡Œã¯éæ¨å¥¨ãªã®ã§ã™ãŒã€ã“ã®å ´åˆã¯ãã†ã™ã‚‹ã—ã‹ãªã„ã®ã§ã“ã®ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
:::

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å¤‰æ›´ã™ã‚‹ã¨ã“ã‚ã¯åŸºæœ¬çš„ã«ã¯ç„¡ã„ã§ã™ã€‚[å‰å›ã®è¨˜äº‹](https://zenn.dev/gsy0911/articles/5f3290ca3a54ce)ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹å ´åˆã«ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã«`idToken`ã‚’ä»˜ä¸ã—ã¦ãã ã•ã„ã€‚


```diff typescript: ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
import axios from "axios";

const credentials = await getCredentialsFromIdToken(
  idToken,
);
const signedHeaders = await getSignedHeaders(
  credentials,
  new URL(`${process.env.BACKEND_API_ENDPOINT}/v1/user`),
);

const BackendApiClient = axios.create({
  baseURL: `${process.env.BACKEND_API_ENDPOINT}/v1`,
});

const options = {
  method: "GET",
- headers: signedHeaders,
+ headers: {idToken, ...signedHeaders},
  url: "/user",
};
const result = await BackendApiClient(options)
```

:::message
ä¸Šè¨˜ã®ä¾‹ã§`idToken`ã‚’ã‚­ãƒ¼ã¨ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä»˜ä¸ã—ã¦ã„ã‚‹ã®ã¯ã€IAMèªè¨¼ã‚’ä½¿ã£ãŸå ´åˆã«`Authorization`ã‚­ãƒ¼ãŒã™ã§ã«åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚
Cognitoèªè¨¼ã‚„é€šå¸¸ã®Tokenèªè¨¼ã‚’ä½¿ã£ã¦ã„ã¦ã€`Authorization: ${idToken}`ãªã©ã¨ãªã£ã¦ã„ã‚‹å ´åˆã«ã¯ä¸Šè¨˜ã®å‡¦ç†ã¯å¿…è¦ãªã„ã§ã™ã€‚
:::

## å‹•ä½œç¢ºèª

å‹•ä½œç¢ºèªã‚’ã™ã‚‹ãŸã‚ã«ã€S3ãƒã‚±ãƒƒãƒˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®`IdentityId`ã”ã¨ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­ç½®ã—ã¾ã™ã€‚
ä¾‹ã¨ã—ã¦`admin`ã¨`user`ã¨ã„ã†2ã¤ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è€ƒãˆã¾ã™ã€‚
å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®`IdentityId`ã”ã¨ã®ãƒ‘ã‚¹ã«`data.txt`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­ç½®ã—ã¦ãŠãã¾ã™ã€‚

`admin`å´ã®`data.txt`ã«ã¯adminã¨ã„ã†æ–‡å­—åˆ—ã‚’
`user`å´ã®`data.txt`ã«ã¯userã¨ã„ã†æ–‡å­—åˆ—ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚

![](/images/nextjs_nextauthjs_cognito_3/nextjs_nextauthjs_cognito_3_5.png)

ãã‚Œãã‚Œã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ãŒå‹•ã„ã¦ã„ã‚‹ã¨ã“ã‚ã‚’ç¢ºèªã—ã¾ã™ã€‚
Jupyterã§ã€`admin`ã¨`user`ã®`fs`ã¨`path`ã‚’ãã‚Œãã‚Œä½œæˆã—ã¾ã™ã€‚


![](/images/nextjs_nextauthjs_cognito_3/nextjs_nextauthjs_cognito_3_6.png)

`admin_fs`ã‚’ä½¿ã£ã¦`admin_path`ã¨`user_path`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚
`admin_path`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯æˆåŠŸã—ã€`user_path`ã¸ã¯å¤±æ•—ã™ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

![](/images/nextjs_nextauthjs_cognito_3/nextjs_nextauthjs_cognito_3_8.png)


ã»ã¼åŒã˜ã§ã™ãŒã€`user_fs`ã‚’ä½¿ã£ã¦`admin_path`ã¨`user_path`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚
`user_path`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯æˆåŠŸã—ã€`admin_path`ã¸ã¯å¤±æ•—ã™ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

![](/images/nextjs_nextauthjs_cognito_3/nextjs_nextauthjs_cognito_3_7.png)

ä»¥ä¸Šã®çµæœã‹ã‚‰æ­£ã—ãå‹•ã„ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

::::details ä¸Šè¨˜ã®ç¢ºèªã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã«ã‚ã‚Šã¾ã™ã€‚

```python

import jwt
import boto3
import s3fs
client = boto3.client("cognito-identity", region_name="ap-northeast-1")
idp = boto3.client("cognito-idp", region_name="ap-northeast-1")

REGION = "ap-northeast-1"
ACCOUNT_ID = "****"
USER_POOL_ID = "ap-northeast-1_****"
IDENTITY_POOL_ID = "ap-northeast-1:****"
S3_BUCKET = "****"
user_id_token = "****"
admin_id_token = "****"

def get_credentials_from_id_token(id_token: str) -> dict:
    logins = {f"cognito-idp.{REGION}.amazonaws.com/{USER_POOL_ID}": id_token}
    # decode_jwt = JwtPayload.of(id_token)
    decode_jwt = jwt.decode(id_token, options={"verify_signature": False})
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ã®ç¢ºèª
    # å­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã€APIã‚’çµ‚äº†ã•ã›ã‚‹
    user_info = idp.admin_get_user(UserPoolId=USER_POOL_ID, Username=decode_jwt["cognito:username"])
    # print(f"{user_info=}")

    # identity-poolã‹ã‚‰idã‚’å–å¾—ã™ã‚‹
    cognito_identity_id = client.get_id(
        AccountId=ACCOUNT_ID, IdentityPoolId=IDENTITY_POOL_ID, Logins=logins
    )
    # get sessionToken, etc.
    credentials = client.get_credentials_for_identity(
        IdentityId=cognito_identity_id["IdentityId"], Logins=logins
    )
    return credentials


user_credentials = get_credentials_from_id_token(user_id_token)
admin_credentials = get_credentials_from_id_token(admin_id_token)

user_fs = s3fs.S3FileSystem(
    anon=False, 
    key=user_credentials["Credentials"]["AccessKeyId"], 
    secret=user_credentials["Credentials"]["SecretKey"], 
    token=user_credentials["Credentials"]["SessionToken"]
)
admin_fs = s3fs.S3FileSystem(
    anon=False, 
    key=admin_credentials["Credentials"]["AccessKeyId"], 
    secret=admin_credentials["Credentials"]["SecretKey"], 
    token=admin_credentials["Credentials"]["SessionToken"]
)

user_path = f"s3://{S3_BUCKET}/cognito-test/{user_credentials['IdentityId']}/data.txt"
admin_path = f"s3://{S3_BUCKET}/cognito-test/{admin_credentials['IdentityId']}/data.txt"

with user_fs.open(user_path, "r") as f:
    print(f.readline())
try:
    with user_fs.open(admin_path, "r") as f:
        print(f.readline())
except Exception as e:
    print(e)
with admin_fs.open(admin_path, "r") as f:
    print(f.readline())
try:
    with admin_fs.open(user_path, "r") as f:
        print(f.readline())
except Exception as e:
    print(e)
```

::::

# ãŠã‚ã‚Šã«

IdTokenã‚’ä½¿ã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªS3ã®ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¾ã—ãŸã€‚
èª°ã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
