---
title: "ã€NextAuth.js/èªè¨¼ã€‘Cognitoã®ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—çŠ¶æ…‹é·ç§»ã‚’XStateã§æ¥½ã«ç®¡ç†ã™ã‚‹"
emoji: "ğŸ²"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextauth", "nextjs", "cognito", "awscdk"]
published: false
---

# ã¯ã˜ã‚ã«

Next.jsã§NextAuth.jsï¼ˆauth.jsï¼‰ã‚’ä½¿ã£ã¦ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ç”»é¢ã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚
Next.jsã¯SSRï¼ˆServer-side Rendering, or Dynamic Renderingï¼‰ãŒåŸºæœ¬ã ã¨æ€ã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ‰±ã†å ´åˆã«ã¯CSRï¼ˆClient-side Renderingï¼‰ã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
Next.jsã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªæ“ä½œã‚’ä¼´ã†å ´åˆã€ã©ã†ã—ã¦ã‚‚ã‚µãƒ¼ãƒãƒ¼å´ã§ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ã¯ãªãã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒå¿…è¦ãªãŸã‚ã§ã™ã€‚

Cognitoã§ãƒ¡ãƒ¼ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã‚’æ‰±ã†å ´åˆã€ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ç”»é¢ãƒ»ãƒ¡ãƒ¼ãƒ«ã‚’èªè¨¼ã™ã‚‹ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ç”»é¢ãƒ»ç™»éŒ²å®Œäº†ç”»é¢ãƒ»ã‚¨ãƒ©ãƒ¼ç”»é¢ãªã©æ‰±ã†ã¹ãçŠ¶æ…‹ãŒã‚ã‚Šã¾ã™ã€‚
useContextã‚„jotaiã€Reduxã§ã‚‚çŠ¶æ…‹ãã®ã‚‚ã®ã®ç®¡ç†ã¯ã§ãã‚‹ã®ã§ã™ãŒã€çŠ¶æ…‹é·ç§»ã‚’å«ã‚ãŸç®¡ç†ã¯çµå±€ã®ã¨ã“ã‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚†ã ã­ã‚‰ã‚Œã‚‹ã®ã§é›£ã—ãã‚³ãƒ¼ãƒ‰ãŒç…©é›‘ã«ãªã‚ŠãŒã¡ã ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

ãã“ã§ã€çŠ¶æ…‹é·ç§»ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹`XState`ã‚’ä½¿ã£ã¦æ¥½ã«ç®¡ç†ã—ã¦ã„ãã¾ã™ã€‚
https://zenn.dev/aldagram_tech/articles/59407d4546301d


## ã‚„ã‚ŠãŸã„ã“ã¨

XStateã‚’ä½¿ã£ã¦çŠ¶æ…‹é·ç§»ã‚’ç®¡ç†ã™ã‚‹éƒ¨åˆ†ã‚’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«å‰‡ã£ã¦ã€ç‹¬è‡ªå®Ÿè£…ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚

UIéƒ¨åˆ†ã«ã¯Mantineã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚`@mantine/form`ã®`useForm`ã¯XStateã®contextã‚’ä½¿ã£ãŸã‚‰ä¸è¦ãªæ°—ã‚‚ã™ã‚‹ã®ã§ã™ãŒã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¾¿åˆ©ãªã®ã§ä½¿ã£ã¦ã„ã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã®å‡¦ç†ã«[@aws-sdk/client-cognito-identity-provider](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/client/cognito-identity-provider/)ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ãŒã€ä»¥ä¸‹ã®è¨˜äº‹ã®ã‚ˆã†ã«Amplifyã‚’åˆ©ç”¨ã—ã¦ã‚‚è‰¯ã„ã‹ã¨æ€ã„ã¾ã™ã€‚

https://zenn.dev/gsy0911/articles/aceb830e4c1e6e

ã¡ãªã¿ã«ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã¯ä»¥ä¸‹ã®æ‹™ä½œã‚’ã”è¦§ãã ã•ã„ï¼ˆã»ã¼åŒã˜æ§‹æˆã§ä½œæˆã§ãã¾ã™ï¼‰ã€‚

https://zenn.dev/gsy0911/articles/0e271401b8e5c2

## ã©ã†ã—ã¦å˜ä¸€ã®CSRã§ç®¡ç†ã™ã‚‹ã®ã‹

Next.jsã ã¨SSRã‚’å¤šãä½¿ã„ã€å˜ä¸€è²¬ä»»ã®åŸå‰‡ã‹ã‚‰ã‚‚1ãƒšãƒ¼ã‚¸1è¦ç´ ã®æ–¹ãŒè‰¯ã„ã‹ã¨æ€ã„ã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯ã€ä»¥ä¸‹ã®2ã¤ã®ç†ç”±ã‹ã‚‰ãã‚Œã«åã—ã¦ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ã«é–¢ã—ã¦ã¯1ã¤ã®ãƒšãƒ¼ã‚¸ã§CSRã£ã½ãç”»é¢ã‚’å‹•ã‹ã™ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

1. å‰ã®ãƒšãƒ¼ã‚¸ã«æ„å›³ã›ãšã«æˆ»ã‚Œã¦ã—ã¾ã†ã“ã¨ï¼ˆrewriteãªã©ã™ã‚Œã°å›é¿ã¯ã§ãã¾ã™ãŒã€ãƒšãƒ¼ã‚¸ã¸ã®ç›´ã‚¢ã‚¯ã‚»ã‚¹ã¯è¨±ã—ã¦ã—ã¾ã„ã¾ã™ï¼‰ã€‚
2. ãƒšãƒ¼ã‚¸ã®çŠ¶æ…‹ã‚’å¼•ãç¶™ãã®ãŒé›£ã—ã„ãŸã‚ã€‚åˆ¥ã®ãƒšãƒ¼ã‚¸ã«é£›ã¶ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿æŒã™ã‚‹ã“ã¨ã¯ã§ããªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚åŸºæœ¬çš„ã«å›°ã‚‹ã“ã¨ã¯ãªã„ã®ã§ã™ãŒã€ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã®å‡¦ç†ã«ãŠã„ã¦confirmã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚Cookieã‚„LocalStorageã«ä¿å­˜ã—ã¦ã‚‚ã„ã„ã®ã§ã™ãŒã€æ°¸ç¶šåŒ–ã¯ã‚ã¾ã‚Šã—ãŸããªã„ã®ã§JavaScriptã®å¤‰æ•°ã¨ã—ã¦æŒãŸã›ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

# XStateã¨ã¯

# Cognitoã®ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã®çŠ¶æ…‹é·ç§»

Cognitoã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¢ºèªã®çŠ¶æ…‹é·ç§»ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

> ![](/images/nextjs_nextauthjs_cognito_6/amazon-cognito-sign-in-confirm-user.png)
> *Cognitoã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªãƒ—ãƒ­ã‚»ã‚¹ï¼ˆ[å…¬å¼ã‚µã‚¤ãƒˆ](https://docs.aws.amazon.com/cognito/latest/developerguide/signing-up-users-in-your-app.html)ã‚ˆã‚Šï¼‰*

ãã®ã†ã¡ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã¯å·¦å´ã®ä¸€éƒ¨ã®ã¿ãªã®ã§ã€æœ¬è¨˜äº‹ã§ã¯ä»¥ä¸‹ã®é·ç§»ã®ã¿è€ƒãˆã¾ã™ã€‚çŠ¶æ…‹ã‚’ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã«ã€ç™»éŒ²ä¸­ï¼ˆRegisteringï¼‰ãƒ»ç¢ºèªä¸­ï¼ˆConfirmingï¼‰ã®çŠ¶æ…‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

çŠ¶æ…‹é·ç§»å›³ã®æ–‡å­—ãŒå¤šãã¦ã‚ã‹ã‚Šã¥ã‚‰ã„ã§ã™ãŒã€ã€Œ`SignUpEvent: onClick`ã¯ãƒœã‚¿ãƒ³ãªã©ã‚’æŠ¼ã—ãŸæ™‚ã«SignUpEventãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€ã€ã€Œ`PostSignUpEvent: useEffect`ã¯useEffectã§ç›£è¦–ã—ã¦ã„ã‚‹ServerActionsã§ã®çµæœã‚’å…ƒã«é–¢æ•°ã‚’å®Ÿè¡Œã€ã¨ã„ã†æ„å‘³ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚

```mermaid
graph TB
  S1[Initial]
  C1{Registering}
  S2[Registered]
  C2{Confirming}
  S3[Confirmed]
  S1 -->|SignUpEvent: onClick| C1
  C1 -->|PostSignUpEvent: useEffect\nGuard: context==Success| S2
  C1 -->|PostSignUpEvent: useEffect\nGuard: none| S1
  S2 -->|ConfirmViaEmailEvent: onClick| C2
  C2 -->|PostConfirmViaEmailEvent: useEffect\nGuard: context==Success| S3
  C2 -->|PostConfirmViaEmailEvent: useEffect\nGuard: none| S2
```

ã“ã®çŠ¶æ…‹é·ç§»å›³ã‚’å…ƒã«XStateã€ãŠã‚ˆã³ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã®å‡¦ç†ã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚

# ã‚³ãƒ¼ãƒ‰

å…¨ä½“å«ã‚ãŸã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã„ã¦ã‚ã‚Šã¾ã™ã€‚é©å®œç¢ºèªã—ã¦ãã ã•ã„ã€‚

https://github.com/gsy0911/zenn-nextjs-authjs-cognito/tree/v6.0

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ğŸ‘ˆãŒã¤ã„ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒä»Šå›ã®ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã§é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã£ã¦ã„ã¾ã™ã€‚ãªãŠä»Šå›èª¬æ˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã®è¡¨ç¤ºã¨ãªã£ã¦ã„ã‚‹ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

```
frontend/zenn-app-router
â”œâ”€â”€ app
â”‚  â”œâ”€â”€ _common
â”‚  â”‚  â””â”€â”€ api
â”‚  â”‚     â””â”€â”€ cognito
â”‚  â”‚        â”œâ”€â”€ cognitoConfirmSignUp.ts ğŸ‘ˆCognitoSDKã®`SignUpCommand`ã‚’ãƒ©ãƒƒãƒ—ã—ãŸé–¢æ•°
â”‚  â”‚        â””â”€â”€ cognitoSignUp.ts ğŸ‘ˆCognitoSDKã®`ConfirmSignUpCommand`ã‚’ãƒ©ãƒƒãƒ—ã—ãŸé–¢æ•°
â”‚  â””â”€â”€ sign-up
â”‚     â”œâ”€â”€ actions
â”‚     â”‚  â””â”€â”€ signUpAction.ts ğŸ‘ˆServerActionsã‚’ã¾ã¨ã‚ã¦ã„ã‚‹
â”‚     â”œâ”€â”€ page.tsx ğŸ‘ˆ
â”‚     â”œâ”€â”€ page.xstate.tsx ğŸ‘ˆXStateã‚’åˆ©ç”¨ã—ã¦ã€è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã—ã¦ã„ã‚‹CSRã®ãƒ•ã‚¡ã‚¤ãƒ«
â”‚     â””â”€â”€ stateMachine.ts ğŸ‘ˆXStateã‚’å®šç¾©ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
â””â”€â”€ README.md
```

## æº–å‚™

XStateã‚’æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```shell
$ npm install xstate @xstate/react
```

çŠ¶æ…‹é·ç§»ã‚’ã¿ãŸã„å ´åˆã¯ä»¥ä¸‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```shell
$ npm install -D @statelyai/inspect
```

ãªãŠã€ä»Šå›ã¯UIã®éƒ¨åˆ†ã«Mantineã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚è¨­å®šã¯ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’ã”è¦§ãã ã•ã„ã€‚

https://mantine.dev/getting-started/

## Cognitoã®ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†

Cognitoã¸ã®ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚’2ã¤ã®ãƒ•ã‚©ãƒ«ãƒ€ã«åˆ†ã‘ã¦å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

### `app/_common/api/cognito`ãƒ•ã‚©ãƒ«ãƒ€å†…

SignUpã®å‡¦ç†ã¯ä»¥ä¸‹ã®SDKã‚’åˆ©ç”¨ã—ã¾ã™ã€‚Inputã¨Outputã§å‹ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã®ã§æ¥½ã«å®Ÿè£…ã§ãã¾ã™ã€‚ç‰¹æ®µå¤‰ã‚ã£ãŸå‡¦ç†ãªã©ã¯ã—ã¦ã„ãªã„ã§ã™ã€‚
https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/client/cognito-identity-provider/command/SignUpCommand/


:::details importã¨å‹
```typescript jsx: cognitoConfirmSignUp.ts
"use server";
import {
  CognitoIdentityProviderClient,
  ConfirmSignUpCommand,
  type ConfirmSignUpCommandInput,
  type ConfirmSignUpCommandOutput,
} from "@aws-sdk/client-cognito-identity-provider";
import { genSecretHash } from "./utils";

interface OnAuthConfirmSignUpRequest {
  email: string;
  confirmationCode: string;
}
```
:::

```typescript jsx: cognitoConfirmSignUp.ts
export const cognitoConfirmSignUp = async (props: OnAuthConfirmSignUpRequest): Promise<ConfirmSignUpCommandOutput> => {
  const { email, confirmationCode } = props;
  const { secretHash } = genSecretHash({ email });

  const client = new CognitoIdentityProviderClient({
    region: process.env.COGNITO_REGION,
  });
  const confirmSignUpCommandInput: ConfirmSignUpCommandInput = {
    ClientId: process.env.COGNITO_CLIENT_ID,
    SecretHash: secretHash,
    Username: email,
    ConfirmationCode: confirmationCode,
  };
  const command = new ConfirmSignUpCommand(confirmSignUpCommandInput);
  return await client.send(command);
};
```

Confirmã®å‡¦ç†ã¯ä»¥ä¸‹ã®SDKã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ã“ã¡ã‚‰ã‚‚å¤‰ã‚ã£ãŸå‡¦ç†ã¯ã—ã¦ã„ãªã„ã§ã™ã€‚
https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/client/cognito-identity-provider/command/ConfirmSignUpCommand/

:::details importã¨å‹
```typescript jsx: cognitoSignUp.ts
"use server";

import {
  CognitoIdentityProviderClient,
  SignUpCommand,
  type SignUpCommandInput,
  type SignUpCommandOutput,
} from "@aws-sdk/client-cognito-identity-provider";
import { genSecretHash } from "./utils";

interface CognitoAuthSignUpProps {
  email: string;
  password: string;
}
```
:::

```typescript jsx: cognitoSignUp.ts
export const cognitoSignUp = async (props: CognitoAuthSignUpProps): Promise<SignUpCommandOutput> => {
  const { email, password } = props;
  const { secretHash } = genSecretHash({ email });

  const client = new CognitoIdentityProviderClient({
    region: process.env.COGNITO_REGION,
  });
  const signUpCommandInput: SignUpCommandInput = {
    ClientId: process.env.COGNITO_CLIENT_ID,
    SecretHash: secretHash,
    Username: email,
    Password: password,
    UserAttributes: [
      {
        Name: "email",
        Value: email,
      },
    ],
  };
  const command = new SignUpCommand(signUpCommandInput);
  return await client.send(command);
};
```


### `app/sign-up/actions`ãƒ•ã‚©ãƒ«ãƒ€å†…

Server Actionsã‚’ä½¿ã£ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‹ã‚‰å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ä¸Šã§å®šç¾©ã—ãŸ`app/_common/api/cognito`å†…ã®é–¢æ•°ã‚’åˆ©ç”¨ã—ã¦ã€Server Actionsã¨ã—ã¦åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

å…¨ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§é–‰ã˜ã¦ã„ã‚‹ã“ã¨ã‹ã‚‰å„é–¢æ•°ã§æ–‡å­—åˆ—ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚ã“ã†ã™ã‚‹ã“ã¨ã§ã€useEffectã§çŠ¶æ…‹ã‚’ç›£è¦–ã—ã¦æ¬¡ã®çŠ¶æ…‹ã«ç§»ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§é–‰ã˜ã¦ã„ã‚‹å ´åˆã«ã¯`next/navigation`ã®`redirect`é–¢æ•°ã§é·ç§»ã—ã¦ã‚‚è‰¯ã„ã‹ã¨æ€ã„ã¾ã™ã€‚

:::details importã¨å‹
```typescript jsx: signUpAction.ts
"use server";
import { cognitoSignUp, cognitoConfirmSignUp } from "@/common/api/cognito";
import { UsernameExistsException, CodeMismatchException, ExpiredCodeException, InvalidParameterException } from "@aws-sdk/client-cognito-identity-provider";

interface OnAuthSignUpRequest {
  email: string;
  password: string;
}

interface OnAuthConfirmSignUpRequest {
  email: string;
  confirmationCode: string;
}
```
:::

```typescript jsx: signUpAction.ts
export const onCognitoSignUp = async (_: string | null, formData: OnAuthSignUpRequest) => {
  const { email, password } = formData;

  try {
    await cognitoSignUp({ email, password });
  } catch (err) {
    if (err instanceof UsernameExistsException) {
      return "UsernameExistsException";
    }
    return "Unknown";
  }

  return "Success";
};

export const onCognitoConfirmSignUp = async (_: string | null, formData: OnAuthConfirmSignUpRequest) => {
  const { email, confirmationCode } = formData;

  try {
    await cognitoConfirmSignUp({ email, confirmationCode });
  } catch (err) {
    if (err instanceof ExpiredCodeException) {
      return "ExpiredCodeException";
    } else if (err instanceof CodeMismatchException) {
      return "CodeMismatchException";
    } else if (err instanceof InvalidParameterException) {
      return "InvalidParameterException";
    }
    return "Unknown";
  }

  return "Success";
};
```

## ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³

ä¸Šè¿°ã®ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã®çŠ¶æ…‹ã‚’XStateã«ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦èµ·ã“ã—ã¦ã„ãã¾ã™ã€‚

ã¾ãšã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®šç¾©ã—ã¾ã™ã€‚ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã®`SignUpEvent`ãƒ»`ConfirmViaEmailEvent`ãªã©ã§ã™ã€‚

```typescript jsx: stateMachine.tsï¼ˆä¸€éƒ¨ï¼‰
import { setup, assign } from "xstate";

type SignUpEvent = { type: "signUp" };
type PostSignUpEvent = { type: "postSignUp"; signUpState: string | null };
type ConfirmViaEmailEvent = { type: "confirmViaEmail" };
type PostConfirmViaEmailEvent = { type: "postConfirmViaEmail"; confirmState: string | null };

type SignUpFlowEvent = SignUpEvent | PostSignUpEvent | ConfirmViaEmailEvent | PostConfirmViaEmailEvent;
```

æ¬¡ã«ã€çŠ¶æ…‹é·ç§»å›³ã§å…±æœ‰ã™ã‚‹çŠ¶æ…‹ã‚’Contextã¨ã—ã¦å®šç¾©ã—ã¾ã™ã€‚åŠ ãˆã¦ã€EventãŒç™ºç«ã—ãŸæ™‚ã«æ›´æ–°ã™ã‚‹`signUpAction`ã‚„`confirmAction`ã®Actionã‚’å®šç¾©ã—ã¾ã™ã€‚

```typescript jsx: stateMachine.tsï¼ˆä¸€éƒ¨ï¼‰
type SignUpFlowContext = {
  signUpState: string | null;
  confirmState: string | null;
};

// ç¾çŠ¶ã¯ assign é–¢æ•°ã®ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã«å‹å¼•æ•°ã‚’5ã¤æ¸¡ã•ãªã„ã¨ã¡ã‚ƒã‚“ã¨å‹è£œå®ŒãŒåŠ¹ã‹ãªã•ãã†ã§ã™ã€‚
const signUpAction = assign<SignUpFlowContext, SignUpEvent, any, SignUpFlowEvent, any>({
  signUpState: ({ event }) => event.signUpState,
});

const confirmAction = assign<SignUpFlowContext, ConfirmViaEmailEvent, any, SignUpFlowEvent, any>({
  confirmState: ({ event }) => event.confirmState,
});
```

æœ€å¾Œã«ã€`initial`ã‚„`registering`ã‚„`registered`ãªã©çŠ¶æ…‹ã‚’å®šç¾©ã—ã¾ã™ã€‚ãã—ã¦çŠ¶æ…‹ã‹ã‚‰æ¬¡ã®çŠ¶æ…‹ã«é·ç§»ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’`on`ã§å®šç¾©ã—ã¾ã™ã€‚ã“ã®æ™‚ã€`type="signUp"`ã§ä¸Šã§å®šç¾©ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’å‚ç…§ã§ãã¾ã™ã€‚

```typescript jsx: stateMachine.tsï¼ˆä¸€éƒ¨ï¼‰
export const signUpFlowMachine = setup({
  types: {
    context: {} as SignUpFlowContext,
    events: {} as SignUpFlowEvent,
  },
}).createMachine({
  id: "signUpMachine",
  initial: "initial",
  context: {
    signUpState: null,
    confirmState: null,
  },
  states: {
    /**
     * ä¾‹ãˆã° initial(åˆæœŸè¡¨ç¤º) çŠ¶æ…‹ã®ã¨ãã«
     * signUp(=SignUpEventã§å®šç¾©ã—ã¦ã„ã‚‹`type`) ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸå ´åˆã€
     * registered çŠ¶æ…‹ã«é·ç§»ã™ã‚‹
     **/
    initial: {
      on: {
        signUp: {
          target: "registering",
        },
      },
    },
    registering: {
      on: {
        postSignUp: [
          {
            target: "registered",
            guard: ({ event }) => event.signUpState === "Success",
          },
          {
            target: "initial",
            actions: [signUpAction],
          },
        ],
      },
    },
    registered: {
      on: {
        confirmViaEmail: {
          target: "confirming",
        },
      },
    },
    confirming: {
      on: {
        postConfirmViaEmail: [
          {
            target: "confirmed",
            guard: ({ event }) => event.confirmState === "Success",
          },
          {
            target: "registered",
            actions: [confirmAction],
          },
        ],
      },
    },
    confirmed: {},
  },
});
```

ä¸Šè¨˜ã®çŠ¶æ…‹é·ç§»ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ï¼ˆCSRï¼‰ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

:::details importãªã©
```typescript jsx: page.xstate.tsx
"use client";
import { useEffect } from "react";
import {
  Center,
  TextInput,
  PasswordInput,
  Checkbox,
  Paper,
  Title,
  Text,
  Container,
  Group,
  Button,
  Anchor,
} from "@mantine/core";
import { useFormState } from "react-dom";
import { useForm } from "@mantine/form";
import { onCognitoSignUp, onCognitoConfirmSignUp } from "./actions";
import { useMachine } from "@xstate/react";
import { createBrowserInspector } from "@statelyai/inspect";
import { signUpFlowMachine } from "./stateMachine";
const { inspect } = createBrowserInspector();
// see: https://ui.mantine.dev/category/authentication
```
:::

```typescript jsx: page.xstate.tsxï¼ˆä¸€éƒ¨ï¼‰
export const SignUpXState = () => {
  // ç¬¬äºŒå¼•æ•°ã« inspect é–¢æ•°ã‚’æ¸¡ã™ã“ã¨ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ¼ãƒ³ã‚’ GUI ã§è¡¨ç¤ºã§ãã¾ã™ã€‚
  const [current, send] = useMachine(signUpFlowMachine, { inspect });
  const [signUpState, signUpAction] = useFormState(onCognitoSignUp, null);
  const [confirmState, confirmAction] = useFormState(onCognitoConfirmSignUp, null);

  const form = useForm({
    initialValues: {
      email: "",
      password: "",
      check: false,
      confirmationCode: "",
    },
    // validateInputOnChange: true,
    validateInputOnBlur: true,
    validate: (values) => {
      if (current.matches("initial")) {
        return {
          email: /^\S+@\S+$/.test(values.email) ? null : "ä¸æ­£ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ã€‚",
          password:
            values.password.length < 8
              ? "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
              : !values.password.match(/[0-9]/)
                ? "æ•°å­—ã‚’å«ã‚ã¦ãã ã•ã„"
                : !values.password.match(/[a-z]/)
                  ? "è‹±èªã®å°æ–‡å­—ã‚’å«ã‚ã¦ãã ã•ã„"
                  : !values.password.match(/[A-Z]/)
                    ? "è‹±èªã®å¤§æ–‡å­—ã‚’å«ã‚ã¦ãã ã•ã„"
                    : !values.password.match(/[$&+,:;=?@#|'<>.^*()%!-]/)
                      ? "è¨˜å·ã‚’å«ã‚ã¦ãã ã•ã„"
                      : null,
          check: !values.check ? "åŒæ„ãŒå¿…è¦ã§ã™" : null,
        };
      } else if (current.matches("registered")) {
        return {
          confirmationCode:
            values.confirmationCode === ""
              ? "å…¥åŠ›ã¯å¿…é ˆã§ã™"
              : values.confirmationCode.length !== 6
                ? "ã‚³ãƒ¼ãƒ‰ã®é•·ã•ãŒé•ã„ã¾ã™ã€‚"
                : null,
        };
      }

      return {};
    },
  });
```
  
```typescript jsx: page.xstate.tsxï¼ˆä¸€éƒ¨ï¼‰
  useEffect(() => {
    const updateSignUpState = () => {
      if (signUpState) {
        send({ type: "signUp", signUpState });
      }
    };
    updateSignUpState();
  }, [signUpState]);

  useEffect(() => {
    const updateConfirmationState = () => {
      if (confirmState) {
        send({ type: "confirmViaEmail", confirmState });
      }
    };
    updateConfirmationState();
  }, [confirmState]);

  const onSignUp = () => {
    signUpAction({
      email: form.values.email,
      password: form.values.password,
    });
  };

  const onConfirmViaEmail = () => {
    confirmAction({
      email: form.values.email,
      confirmationCode: form.values.confirmationCode,
    });
    form.setValues({ confirmationCode: "" });
  };

```
  
```typescript jsx: page.xstate.tsxï¼ˆä¸€éƒ¨ï¼‰
  return (
    <Container size={420} my={40}>
      {current.matches("initial") && (
        <>
          <Center>
            <Title c={"#333"}>Welcome!</Title>
          </Center>
          <Center>
            <Text c={"dimmed"} size={"sm"} mt={5}>
              You are to create an account, or{" "}
              <Anchor size="sm" href={"/"}>
                Already have an account
              </Anchor>
            </Text>
          </Center>

          <Paper withBorder shadow="md" p={30} mt={30} radius="md">
            <TextInput label="Email" placeholder="you@mantine.dev" required {...form.getInputProps("email")} />
            <PasswordInput
              label="Password"
              placeholder="Your password"
              required
              mt="md"
              {...form.getInputProps("password")}
            />
            <Group justify={"space-between"} mt="lg">
              <Checkbox label="åˆ©ç”¨è¦ç´„ã«åŒæ„ã™ã‚‹" {...form.getInputProps("check")} />
            </Group>
            <Button fullWidth mt="xl" onClick={onSignUp} disabled={!form.isValid()}>
              Sign up
            </Button>
          </Paper>
        </>
      )}
```
  
```typescript jsx: page.xstate.tsxï¼ˆä¸€éƒ¨ï¼‰
      {current.matches("signUpError") && (
        <>
          <Center>
            <Title c={"#333"}>SignUp Error!</Title>
          </Center>
          <Center>
            <Text c={"dimmed"} size={"sm"} mt={5}>
              {current.context.signUpState}.{" "}
              <Anchor size="sm" href={"/"}>
                try again.
              </Anchor>
            </Text>
          </Center>
        </>
      )}
```
  
```typescript jsx: page.xstate.tsxï¼ˆä¸€éƒ¨ï¼‰
      {current.matches("registered") && (
        <>
          <Center>
            <Title c={"#333"}>Confirm now!</Title>
          </Center>
          <Center>
            <Text c={"dimmed"} size={"sm"} mt={5}>
              Set up is almost complete
            </Text>
          </Center>

          <Paper withBorder shadow="md" p={30} mt={30} radius="md">
            <TextInput
              label="Confirmation code"
              placeholder="000111"
              required
              {...form.getInputProps("confirmationCode")}
            />
            <Text c={"red"} size={"xs"}>
              {current.context.confirmState === "CodeMismatchException" && form.values.confirmationCode === "" && (
                <>ã‚³ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“</>
              )}
            </Text>

            <Button fullWidth mt="xl" onClick={onConfirmViaEmail} disabled={!form.isValid()}>
              Confirm
            </Button>
          </Paper>
        </>
      )}
```
  
```typescript jsx: page.xstate.tsxï¼ˆä¸€éƒ¨ï¼‰
      {current.matches("confirmed") && (
        <>
          <Center>
            <Title c={"#333"}>Sign Up Complete!</Title>
          </Center>
          <Center>
            <Text c={"dimmed"} size={"sm"} mt={5}>
              Welcome to our Site.
            </Text>
          </Center>
          <Button fullWidth mt="xl" component={"a"} href={"/"}>
            Back home to Sign-in
          </Button>
        </>
      )}
    </Container>
  );
};
```


## å‹•ä½œç¢ºèª

## ã‚„ã£ã¦ã„ãªã„ã“ã¨

### ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²

ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã‚’ã‚‚ã†å°‘ã—ã—ãŸã‹ã£ãŸã®ã§ã™ãŒã€XStateã‚’useContextãªã©ã§æ‰±ã†æ–¹æ³•ãŒã‚ã‹ã‚‰ãªã‹ã£ãŸã®ã¨ã€XStateã®Actoråˆ©ç”¨ã—ãŸå ´åˆã«inspectã‚’ã©ã†æ‰±ã†ã®ã‹ãŒè¦‹ãˆãªã‹ã£ãŸã®ã§ä¸€æ—¦å˜ä¸€ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§æ‰±ã†ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ã®å‘½åè¦å‰‡ãªã©ã‚‚æ‚©ã¿ãã†ãªã®ã§ã“ã®å½¢ã§ã‚‚ã„ã„ã‹ãªã¨æ€ã„ã¾ã™ã€‚

Mantineã®æ–¹ã¯ã€`createFormContext`ã‚’åˆ©ç”¨ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã‚’ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚

https://mantine.dev/form/create-form-context/

### useActionStateã®åˆ©ç”¨

æœ¬è¨˜äº‹ã§ã¯`useFormState`ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚ãŸã ä»Šå¾Œã¯ã€ã‚‚ã†ã™ããƒªãƒªãƒ¼ã‚¹ã•ã‚Œã‚‹React 19ã«å«ã¾ã‚Œã‚‹æ–°æ©Ÿèƒ½ã®`useActionState`ã‚’ä½¿ã£ãŸã»ã†ãŒè‰¯ã„ã‹ã¨æ€ã„ã¾ã™ã€‚

https://ja.react.dev/reference/react/useActionState

# ãŠã‚ã‚Šã«

æœ¬è¨˜äº‹ã§ã¯ã€ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ç”»é¢ã‚’XStateã‚’åˆ©ç”¨ã—ã¦çŠ¶æ…‹é·ç§»ã‚’æ„è­˜ã—ã¦ä½œæˆã—ã¾ã—ãŸã€‚Next.jsã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹å ´åˆã ã¨URLã”ã¨ã«ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ãŸæ–¹ãŒã„ã„ã‹ã¨æ€ã†ã®ã§ã™ãŒã€Pages Routerã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã¿ãŸã„ã«CSRå´ã§å…¨ã¦ã¾ã¨ã‚ã¾ã—ãŸã€‚

ã¨ã‚Šã‚ãˆãšã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ç”»é¢ã ã‘ãªã®ã§ã€ä»–ã®ç”»é¢ã‚‚åˆã‚ã›ã¦ä½œæˆã—ã¦ã„ããŸã„ã‹ãªã¨æ€ã„ã¾ã™ã€‚

# å‚è€ƒè¨˜äº‹

https://docs.aws.amazon.com/cognito/latest/developerguide/signing-up-users-in-your-app.html
