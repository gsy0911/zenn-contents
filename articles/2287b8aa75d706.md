---
title: "Dockerã§MySQLã®Master/Slaveæ§‹æˆ"
emoji: "ğŸŒ²"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["mysql", "docker"]
published: true
---

# ã¯ã˜ã‚ã«

MySQLã§Master/Slaveã‚’æ§‹æˆã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚
Master/Slaveã‚’æ§‹æˆã™ã‚‹ãŸã‚ã«ã¯å¤§åˆ¥ã—ã¦`ãƒã‚¤ãƒŠãƒªãƒ­ã‚°`ã¨`GTID`ã®2ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

ä»Šå›ã¯`GTID`ã‚’ç”¨ã„ã¦Master/Slaveæ§‹æˆã‚’Dockerã§æ§‹ç¯‰ã—ã¾ã™ã€‚
`GTID`ã®è©³ã—ã„èª¬æ˜ã¯ä»¥ä¸‹ã®è¨˜äº‹ãªã©ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

https://qiita.com/boro1234/items/797b97fc06e7c688b7b2

## ç’°å¢ƒ

å®Ÿè¡Œã—ãŸç’°å¢ƒã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- macOS: 13.5
- MySQL: 8.0

# ã‚³ãƒ¼ãƒ‰

æœ¬è¨˜äº‹ã®ã‚³ãƒ¼ãƒ‰ã¯[GitHub](https://github.com/gsy0911/zenn-php-symfony/tree/article2)ã«ã‚ã‚Šã¾ã™ã®ã§ã€é©å®œç¢ºèªãã ã•ã„ã€‚
ï¼ˆæœ¬è¨˜äº‹ã«ã¯è¼‰ã£ã¦ã„ãªã„PHPé–¢é€£ã®ã‚³ãƒ¼ãƒ‰ã‚‚ã‚ã‚Šã¾ã™ï¼‰ã€‚

## å…±é€š

ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
Masterã¨Slaveã®MySQLã«é–¢ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã‚Œãã‚Œä½œæˆã—ã¦ã„ãã¾ã™ã€‚

```text
.
â”œâ”€â”€ docker
â”‚  â””â”€â”€ mysql
â”‚     â”œâ”€â”€ init_master.sql
â”‚     â”œâ”€â”€ init_slave.sql
â”‚     â”œâ”€â”€ master
â”‚     â”‚  â””â”€â”€ my.cnf
â”‚     â”œâ”€â”€ master.Dockerfile
â”‚     â”œâ”€â”€ slave
â”‚     â”‚  â””â”€â”€ my.cnf
â”‚     â””â”€â”€ slave.Dockerfile
â””â”€â”€ docker-compose.yaml
```


```yaml: docker-compose.yaml
  mysql_master:
    container_name: mysql_master
    build:
      context: ./docker/mysql
      dockerfile: master.Dockerfile
    volumes:
      - ./volumes/mysql/master:/var/lib/mysql/
    tty: true
    ports:
      - "3306:3306"
    privileged: true
    platform: linux/amd64
    environment:
      TZ: 'Asia/Tokyo'
    logging:
      driver: json-file
      options:
        max-file: '1'
        max-size: 3m

  mysql_slave:
    container_name: mysql_slave
    build:
      context: ./docker/mysql
      dockerfile: slave.Dockerfile
    volumes:
      - ./volumes/mysql/slave:/var/lib/mysql/
    tty: true
    ports:
      - "3307:3306"
    platform: linux/amd64
    depends_on:
      - mysql_master
    environment:
      TZ: 'Asia/Tokyo'
    logging:
      driver: json-file
      options:
        max-file: '1'
        max-size: 3m
```


## masterå´


```Dockerfile: docker/mysql/master.Dockerfile
FROM mysql/mysql-server:8.0.28

RUN touch /var/log/mysql-general.log
RUN chown mysql:mysql /var/log/mysql-general.log
RUN touch /var/log/mysql-error.log
RUN chown mysql:mysql /var/log/mysql-error.log
RUN touch /var/log/mysql-slow.log
RUN chown mysql:mysql /var/log/mysql-slow.log

COPY ./master/ /etc/mysql/
COPY init_master.sql /docker-entrypoint-initdb.d/initialize.sql
```

```text: docker/mysql/master/my.cnf
[client]
default-character-set=utf8mb4

[mysqld]
character-set-server=utf8mb4
collation-server=utf8mb4_general_ci
innodb-use-native-aio=0
log_error=/var/log/mysql-error.log
general_log_file=/var/log/mysql-general.log
general_log=1
slow_query_log_file=/var/log/mysql-slow.log
slow_query_log=1
long_query_time=2

# master/slave
server-id=1
# binary-log
log-bin
binlog-format=row
gtid_mode=ON
enforce_gtid_consistency=ON
```

```sql: docker/mysql/init_master.sql
CREATE USER 'zenn_master'@'%' IDENTIFIED WITH mysql_native_password BY 'zenn_master';
GRANT ALL PRIVILEGES ON *.* TO 'zenn_master'@'%';
GRANT REPLICATION SLAVE ON *.* TO 'zenn_master'@'%';
FLUSH PRIVILEGES;
```

## slaveå´

```Dockerfile: docker/mysql/master.Dockerfile
FROM mysql/mysql-server:8.0.28

RUN touch /var/log/mysql-general.log
RUN chown mysql:mysql /var/log/mysql-general.log
RUN touch /var/log/mysql-error.log
RUN chown mysql:mysql /var/log/mysql-error.log
RUN touch /var/log/mysql-slow.log
RUN chown mysql:mysql /var/log/mysql-slow.log

COPY ./slave/ /etc/mysql/
COPY init_slave.sql /docker-entrypoint-initdb.d/initialize.sql
```

```text: docker/mysql/slave/my.cnf
[client]
default-character-set=utf8mb4

[mysqld]
character-set-server=utf8mb4
collation-server=utf8mb4_general_ci
innodb-use-native-aio=0
log_error=/var/log/mysql-error.log
general_log_file=/var/log/mysql-general.log
general_log=1
slow_query_log_file=/var/log/mysql-slow.log
slow_query_log=1
long_query_time=2

# master/slave
server-id=2
# binary-log
log-bin
binlog-format=row
gtid_mode=ON
enforce_gtid_consistency=ON
relay-log-index=slave-relay-bin.index
relay-log=slave-relay-bin
read_only
```

```sql: docker/mysql/init_slave.sql
CREATE USER 'zenn_slave'@'%' IDENTIFIED WITH mysql_native_password BY 'zenn_slave';
GRANT ALL PRIVILEGES ON *.* TO 'zenn_slave'@'%';
```

# å®Ÿè¡Œã¨åˆæœŸè¨­å®š

MySQLã‚’ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç«‹ã¡ä¸Šã’ã¾ã™ã€‚

```shell
$ docker compose up --build
(...å‰ç•¥)
mysql_slave   | [Entrypoint] MySQL init process done. Ready for start up.
mysql_slave   |
mysql_master  |
mysql_master  | [Entrypoint] MySQL init process done. Ready for start up.
mysql_master  |
mysql_slave   | [Entrypoint] Starting MySQL 8.0.28-1.2.7-server
mysql_master  | [Entrypoint] Starting MySQL 8.0.28-1.2.7-server
```

ç«‹ã¡ä¸ŠãŒã£ãŸã“ã¨ã‚’ç¢ºèªã—ãŸã‚‰ã€Slaveå´ã«å…¥ã£ã¦è¨­å®šã‚’ã—ã¦ã„ãã¾ã™ã€‚

```shell
$ docker exec -it mysql_slave mysql -uzenn_slave -pzenn_slave
mysql> CHANGE MASTER TO MASTER_HOST='mysql_master', MASTER_USER='zenn_master', MASTER_PASSWORD='zenn_master', MASTER_AUTO_POSITION=1;
Query OK, 0 rows affected, 7 warnings (0.09 sec)
mysql> START SLAVE;
Query OK, 0 rows affected, 1 warning (0.07 sec)

# Master/Slaveè¨­å®šã®çŠ¶æ…‹ç¢ºèª
mysql> SHOW SLAVE STATUS\G
*************************** 1. row ***************************
               Slave_IO_State: Waiting for source to send event # ã“ã“
                  Master_Host: mysql_master
                  Master_User: zenn_master
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: 0001e1a2cb18-bin.000003
          Read_Master_Log_Pos: 362
               Relay_Log_File: slave-relay-bin.000002
                Relay_Log_Pos: 592
        Relay_Master_Log_File: 0001e1a2cb18-bin.000003
             Slave_IO_Running: Yes # ã“ã“
            Slave_SQL_Running: Yes # ã“ã“
            (...å¾Œç•¥)
            
# ä½œæˆç›´å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
```

`Slave_IO_State`ã‚’ç¢ºèªã—ã¦`Waiting for master to send event`ã¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ã€
ã¾ãŸ`Slave_IO_Running`ã¨`Slave_SQL_Running`ã®ä¸¡æ–¹ãŒ `Yes` ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

ã“ã‚Œã§Master/Slaveæ§‹æˆãã®ã‚‚ã®ã¯å®Œäº†ã—ã¦ã„ã¾ã™ã€‚
Masterå´ã«å…¥ã£ã¦æ­£ã—ãå‹•ãã‹ç¢ºã‹ã‚ã¦ã¿ã¾ã™ã€‚

```shell
$ docker exec -it mysql_master mysql -uzenn_master -pzenn_master
# Masterå´ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹
mysql> CREATE DATABASE zenn_db CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;

# Masterå´ã§æ“ä½œå¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª
# Slaveå´ã«åæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹
# ä»¥ä¸‹ã®ã‚ˆã†ã«åæ˜ ã•ã‚Œã¦ã„ãŸã‚‰OKã§ã™ã€‚
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| zenn_db            |
+--------------------+
```

# ãŠã‚ã‚Šã«

ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯`ãƒã‚¤ãƒŠãƒªãƒ­ã‚°`ã§ã¯ãªã`GTID`ã¨ã„ã†æ–¹æ³•ã‚‚ã‚ã‚‹ã“ã¨ã‚’åˆã‚ã¦çŸ¥ã‚Šã¾ã—ãŸã€‚
èª°ã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

# å‚è€ƒ

https://qiita.com/wf-yamaday/items/47434b8312737da25521
