---
title: "CDKを使ってNext.jsをS3+CloudFrontの構成にデプロイする"
emoji: "🧀"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Next.js", "AWSCDK", "CloudFront"]
published: true
---

# はじめに

CloudFrontを使ってNext.jsなどでビルドされてコンテンツを配信するときに、
S3のアクセス設定を「公開」にしたくない時はないでしょうか？
（公開設定の図を添付）
加えて、CDKでAWSの構成を管理している場合に、上記のような内容を書きたいときはないでしょうか？
そういった場合の時に、役立ちます。

いくつかの記事でも言及されているように、CloudFront + S3でNext.jsなどのコンテンツを配信する際にはいくつかの方法があります。

1. S3を「静的Webサーバー・全世界に公開」に設定して、CloudFront側では特に気にせずにルーティングするだけ
2. S3の設定は特に変えずに、CloudFrontの前にLambda@Edgeなどでコンテンツへのアクセス部分を変更する

今回は2の方法を採用しつつ、それをCDKで記述できるようにします。
加えて、CloudFrontの`responseHeadersPolicy`に関しても記述を少し加えて、最低限のセキュリティをかけておきます。

# やりたいこと・対象読者・構成・料金

## やりたいこと

前述の通りやりたいことは、「CloudFront経由でNext.jsのコンテンツを配信すること」です。
加えて、セキュリティにも最低限意識しつつ配信されるようにします。

## 対象読者

以下の内容を実行したい人におすすめです。

- CDKを使ってCloudFront + Next.jsの構成を作りたい
- セキュリティを意識しつつCloudFrontでの配信を実施したい

## 構成

- 構成図1: Lambda@Edgeの挙動

この構成の理由。

- 構成図2:ResponseHeadersの挙動
  - Overrideとかも気になるので挙動をみてみる

## 料金

今回利用するAWSのサービスは、以下のようになっています。

- Lambda@Edge
- CloudFront
- S3
- Route53
- ACM

# コード

[このリポジトリ](https://github.com/gsy0911/zenn-cloudfront-oai)にコードを載せています。
実際にデプロイする場合は、細かいコードなどはそちらで確認をしてください。
また、本記事でもCloudFrontの部分とLambda@Edgeの挙動に関して少し解説します。

## Lambda@EdgeのコードをJavaScriptで実装する

簡単にJavaScriptで作成する場合は、以下のコードのLambda@Edgeを作成すれば実現できます。

```javascript
exports.handler = (event, context, callback) => {
  const request = event.Records[0].cf.request;
  const uri = request.uri;
  // ファイル名 ("/" で区切られたパスの最後) を取得
  const filename = request.uri.split("/").pop();

  if (uri.endsWith("/")) {
    request.uri = request.uri.concat("index.html");
  } else if (filename) {
    if (!filename.includes(".")) {
      // ファイル名に拡張子がついていない場合、 "/index.html" をつける
      request.uri = request.uri.concat("/index.html");
    }
  }
  console.log(`uri: ${uri} -> ${request.uri}`)
  callback(null, request);
}
```

JavaScriptの場合は、以下のCDKのコードでLambda@Edgeを作成することができます。

```typescript:CloudFrontOaiStack.ts
// ~~前略~~

    const dir = path.resolve(__dirname, 'lambda', 'js_edge', 'rewrite-trailing-slash')
    const rewriteTrailingSlashVersion = new aws_cloudfront.experimental.EdgeFunction(this, "edge-origin-request", {
      code: aws_lambda.Code.fromAsset(dir),
      functionName: "origin-request",
      handler: `index.handler`,
      runtime: aws_lambda.Runtime.NODEJS_16_X,
      memorySize: 512,
      timeout: Duration.seconds(5),
      architecture: aws_lambda.Architecture.X86_64,
    })

// ~~後略~~
```

## Lambda@EdgeのコードをTypeScriptで実装する

一方でTypeScriptで作成したい場合は、以下のコードで実現できます。
（当然ながらコードそのものは、JavaScriptとほとんど差はないです。）
ただ、この場合は事前準備が必要なため事前のデプロイが必要になります。
準備の詳細は[この記事](https://zenn.dev/gsy0911/articles/820313c08a545922733f)をご覧ください。


```typescript
import {CloudFrontRequestHandler} from "aws-lambda";

export const handler: CloudFrontRequestHandler = async (event) => {
  const request = event.Records[0].cf.request;
  const uri = request.uri;
  // ファイル名 ("/" で区切られたパスの最後) を取得
  const filename = uri.split("/").pop();

  if (uri.endsWith("/")) {
    request.uri = request.uri.concat("index.html");
  } else if (filename) {
    if (!filename.includes(".")) {
      // ファイル名に拡張子がついていない場合、 "/index.html" をつける
      request.uri = request.uri.concat("/index.html");
    }
  }
  return request
}
```

TypeScriptの場合は、以下のCDKのコードでLambda@Edgeを作成することができます。
一見、JavaScriptの場合と比べると短そうに見えますが、
事前に別Stackでデプロイをして、SSMからLambdaのARNを読み取るという準備が必要となっています。

```typescript:CloudFrontOaiStack.ts
// ~~前略~~

    // Lambda@Edge
    const rewriteTrailingSlashParam = aws_ssm.StringParameter.fromStringParameterAttributes(this, 'rewriteTrailingSlashParam', {
      parameterName: `/${prefix}/${params.environment}/${params.lambdaEdgeStackId}/rewriteTrailingSlash`,
    }).stringValue;
    const rewriteTrailingSlashVersion = aws_lambda.Version.fromVersionArn(this, "rewriteTrailingSlashVersion", rewriteTrailingSlashParam)

// ~~後略~~
```

# デプロイ

コードの説明が終わったので、実際にデプロイしてみて挙動を確認してみます。
JavaScriptとTypeScriptとでデプロイの手順が少し異なります。
ここでは、簡単なJavaScriptのみデプロイしてみます。

Nextをビルド
S3にコンテンツをアップロード
Route53など事前準備
CDKをデプロイ

# 挙動の確認

実際にアクセスして確認する。

mdnのサイトにて安全性を確認することを実施する

# おわりに

CDKを使ってNext.jsをS3+CloudFrontの構成にデプロイしました。
この構成を利用する方の参考になれば嬉しいです。

# 参考

