---
title: "Next.jsã§axiosã¸ã®å‹ä»˜ã‘ã¨è£œå®Œ"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "axios"]
published: false
---

# ã¯ã˜ã‚ã«

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹æ™‚ã«å‹ã‚„è£œå®ŒãŒãªãã¦è¾›ã„ãªã¨æ€ã„ã¾ã—ãŸã€‚
è‰¯ã•ã’ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯è¦‹ã¤ã‘ã‚‰ã‚Œãªã‹ã£ãŸã®ã§ã€
ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãªã©å‹ã‚’ä»˜ã‘ã¤ã¤ã„ã„æ„Ÿã˜ã«å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

https://zenn.dev/takepepe/articles/nextjs-typesafe-api-routes

https://zenn.dev/sum0/articles/8e903ed05ba681

## å‰æ

- APIã®ã‚³ãƒ¼ãƒ«ã«ã¯`fetch`ã§ã¯ãªã`axois`ã‚’ä½¿ã†
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIã‚µãƒ¼ãƒãƒ¼ã¯`TypeScript`ä»¥å¤–
- `OpenAPI`ã‚’ä½¿ã£ã¦ã„ãªã„

## ç’°å¢ƒ

- macOS: 13.5
- Next.js: 13.4

# å‹•ä½œã‚µãƒ³ãƒ—ãƒ«

ä»¥ä¸‹ã¯PyCharmã§å‹•ã‹ã—ãŸæ™‚ã®è£œå®Œã®æŒ™å‹•ã®ä¾‹ã§ã™ã€‚
ãƒ‘ã‚¹ã«é–¢ã™ã‚‹è£œå®ŒãŒåŠ¹ã„ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

![](/images/nextjs_routes_types_1/nextjs_routes_types_1_1.png =600x)

ã¾ãŸã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«é–¢ã—ã¦ã‚‚åŒæ§˜ã«è£œå®ŒãŒåŠ¹ãã¾ã™ã€‚

![](/images/nextjs_routes_types_1/nextjs_routes_types_1_2.png =600x)

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã«ã¯ã‚¨ãƒ©ãƒ¼ã‚‚å‡ºã—ã¦ãã‚Œã¾ã™ã€‚

![](/images/nextjs_routes_types_1/nextjs_routes_types_1_3.png =600x)

# ã‚³ãƒ¼ãƒ‰

ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã„ã¦ã‚ã‚Šã¾ã™ã€‚é©å®œå‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

https://github.com/gsy0911/zenn-nextjs-routes-types

## æº–å‚™

ç‰¹ã«æ„å‘³ã¯ãªã„ã§ã™ãŒã‚¢ãƒ—ãƒªã®ä½œæˆã‹ã‚‰è¡Œã„ã¾ã™ã€‚
`AppRouter`ã¯åˆ©ç”¨ã›ãšã«ã€`PagesRouter`ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

```shell
$ npx create-next-app@latest
Need to install the following packages:
  create-next-app@13.4.19
Ok to proceed? (y) y
âœ” What is your project named? â€¦ zenn-app
âœ” Would you like to use TypeScript? â€¦ No / Yes
âœ” Would you like to use ESLint? â€¦ No / Yes
âœ” Would you like to use Tailwind CSS? â€¦ No / Yes
âœ” Would you like to use `src/` directory? â€¦ No / Yes
âœ” Would you like to use App Router? (recommended) â€¦ No / Yes
âœ” Would you like to customize the default import alias? â€¦ No / Yes
```

ã‚¢ãƒ—ãƒªã®ä½œæˆãŒçµ‚ã‚ã£ãŸã‚‰å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```shell
# ãã‚Œãã‚Œå¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ npm install type-fest axios swr query-string
$ npm install prettier -D
```

ç’°å¢ƒå¤‰æ•°ã«å‹ã‚’ã¤ã‘ã‚‹ãŸã‚ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç›´ä¸‹ã«ä½œæˆã—ã¾ã™ã€‚
ã“ã†ã™ã‚‹ã“ã¨ã§ã€ç’°å¢ƒå¤‰æ•°ã‚’å‚ç…§ã™ã‚‹ã¨ãã«`null`ã‹ã©ã†ã‹ã‚’è€ƒæ…®ã—ãªãã¦ã‚ˆããªã‚Šã¾ã™ã€‚

```typescript: globals.d.ts
declare namespace NodeJS {
  // ç’°å¢ƒå¤‰æ•°åã®å®šç¾©
  interface ProcessEnv {
    readonly NEXT_PUBLIC_BACKEND_API_ENDPOINT: string;
  }
}
```

ãã—ã¦ã€ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```text: .env.local
NEXT_PUBLIC_BACKEND_API_ENDPOINT=http://localhost:3000
```

æœ€å¾Œã«ã€API Routesã‚’åˆ©ç”¨ã—ã¦ã‚ã‚‰ã‹ã˜ã‚å¯¾å¿œã™ã‚‹æ¤œè¨¼ç”¨ã®APIã‚’ä½œæˆã—ã¾ã™ã€‚
`pages/api`ä»¥ä¸‹ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã™ã‚‹ã¨ã€ç°¡æ˜“çš„ãªAPIã‚µãƒ¼ãƒãƒ¼ãŒä½œã‚Œã¾ã™ã€‚

```typescript: pages/api/user.ts
import type { NextApiRequest, NextApiResponse } from "next";

type Data = {
  status: string; 
  id: string;
  name: string;
};

export default function handler(
  req: NextApiRequest,
  res: NextApiResponse<Data>,
) {
  if (req.method === "GET") {
    res.status(200).json({ status: "success", id: "1", name: "Alice" });
  } else if (req.method === "POST") {
    res.status(200).json({ status: "success", id: "2", name: "Bob" });
  } else if (req.method === "PUT") {
    res.status(200).json({ status: "success", id: "3", name: "Eve" });
  } else if (req.method === "DELETE") {
    res.status(200).json({ status: "success", id: "4", name: "Mallory" });
  }
}
```

ã“ã‚Œã§ã¨ã‚Šã‚ãˆãšã®æº–å‚™ã¯å®Œäº†ã§ã™ã€‚ã“ã‚Œã‹ã‚‰å‹ã‚’å®šç¾©ã—ã¦ã„ãã¾ã™ã€‚

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIã®å‹å®šç¾©

ã¾ãšãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIã®å‹ã®å®šç¾©ã‚’ã—ã¾ã™ã€‚
äºŒåº¦æ‰‹é–“æ„Ÿã¯ã‚ã‚‹ã®ã§ã™ãŒã€ã“ã‚Œã‚’ã—ãªã„ã¨å‹ã®è£œå®ŒãŒåŠ¹ã‹ã›ã‚‰ã‚Œãªã„ãŸã‚ã§ã™ã€‚
OpenAPIãªã©ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã«ã¯ã€[ã“ã®è¨˜äº‹ï¼ˆå†æ²ï¼‰](https://zenn.dev/sum0/articles/8e903ed05ba681)ã‚’èª­ã‚“ã æ–¹ãŒå¹¸ã›ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

ä»¥ä¸‹ã®APIã®å‹ã‚’å®šç¾©ã™ã‚‹ãŸã‚ã®typeã‚„interfaceã‚’ä½œæˆã—ã¾ã™ã€‚

```typescript: common/types/api.ts
import type { NextApiRequest, NextApiResponse } from "next";

export interface Data<T> {
  data: T;
}
export interface Error {
  error: {
    httpStatus: number;
    message: string;
  };
}
export type ApiParams<Q = unknown, B = any, R = unknown> = (
  req: Omit<NextApiRequest, "body" | "query"> & {
    query: Partial<Q>;
    body?: B;
  },
  res: NextApiResponse<Data<R> | Error>,
) => void | Promise<void>;

export type ExtractReqQuery<T> = T extends ApiParams<infer I, any, unknown>
  ? I
  : never;
export type ExtractReqData<T> = T extends ApiParams<unknown, infer I, unknown>
  ? I
  : never;
export type ExtractResData<T> = T extends ApiParams<unknown, any, infer I> ? I : never;
```

ã“ã“ã§å…±é€šã®å‹ã‚’å®šç¾©ã—ã€

```typescript
export interface Data<T> {
  data: T;
}
export interface Error {
  error: {
    httpStatus: number;
    message: string;
  };
}
```

ã“ã“ã§APIã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãã‚Œãã‚Œå®šç¾©ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®å‹ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

```typescript
export type ApiParams<Q = unknown, B = any, R = unknown> = (
  req: Omit<NextApiRequest, "body" | "query"> & {
    query: Partial<Q>;
    body?: B;
  },
  res: NextApiResponse<Data<R> | Error>,
) => void | Promise<void>;

// å¾Œè¿°ã—ã¾ã™ãŒä»¥ä¸‹ã®ã‚ˆã†ãªåˆ©ç”¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
// export type GetUserHandler = ApiParams<
//   { id: string },  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆquery
//   {},  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆbody
//   { status: string; name: string }  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹body
// >;
```

æ¬¡ã«ã€ä¸Šã§å®šç¾©ã—ãŸ`ApiParams`ã‚’ä½¿ã£ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIã®å‹å®šç¾©ã‚’æ›¸ãã¾ã™ã€‚
ä¾‹ã¨ã—ã¦ã€`GET`, `POST`, `PUT`, `DELETE`ã®å®šç¾©ã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚

```typescript: lib/api/types.ts
import { ApiParams } from "@/common/types/api";

type GetUserHandler = ApiParams<
  { id: string },
  {},
  { status: string; id: string; name: string }
>;

type PostUserHandler = ApiParams<
  {},
  { name: string },
  { status: string; id: string; name: string }
>;

type PutUserHandler = ApiParams<
  {},
  { id: string; name: string },
  { status: string; id: string; name: string }
>;

type DeleteUserHandler = ApiParams<
  {},
  { id: string; name: string },
  { status: string; id: string; name: string }
>;

// ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€`/user`ã¨ã„ã†ãƒ‘ã‚¹ã«å¯¾å¿œã—ã¦ã„ã‚‹ã¨ã„ã†æƒ³å®š
export interface paths {
  "/user": {
    GET: GetUserHandler;
    POST: PostUserHandler;
    PUT: PutUserHandler;
    DELETE: DeleteUserHandler;
  };
  // è£œå®Œã®ä¾‹ã¨ã—ã¦é©å½“ãªãƒ‘ã‚¹ã‚’è¿½åŠ ï¼ˆã‚³ãƒ¼ãƒ‰ã«ã¯å­˜åœ¨ã—ãªã„ï¼‰
  "/user/book": {
    GET: GetUserHandler;
  };
  "/user/payment": {
    GET: GetUserHandler;
  };
  "/user/balance": {
    GET: GetUserHandler;
  };
}
```

## axiosã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ

https://zenn.dev/sutamac/articles/27246dfe1b5a8e

ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹axiosã®`ApiClient`ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

```typescript: lib/api/clients.ts
import axios from "axios";
// å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼
const headers = {
  "Content-Type": "application/json",
};
// axiosã®åˆæœŸè¨­å®š
export const BackendApiClient = axios.create({
  baseURL: `${process.env.NEXT_PUBLIC_BACKEND_API_ENDPOINT}/api`,
  headers,
});

// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¨ãƒ©ãƒ¼åˆ¤å®šå‡¦ç†
BackendApiClient.interceptors.response.use(
  (response) => {
    return response;
  },
  (error) => {
    console.log(error);
    switch (error?.response?.status) {
      case 401:
        break;
      case 404:
        break;
      default:
        console.log("== internal server error");
    }

    const errorMessage = (error.response?.data?.message || "").split(",");
    throw new Error(errorMessage);
  },
);
```

åˆæœŸè¨­å®šã®URLã¯æº–å‚™ã®ã¨ã“ã‚ã§è¨­å®šã—ãŸç’°å¢ƒå¤‰æ•°ã‚’ç”¨ã„ã¾ã™ã€‚
ã“ã®`ApiClient`ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§æ¯å›è¨­å®šã™ã‚‹`URL`ã‚„`headers`ã®å®šç¾©ãŒ1å›ã§æ¸ˆã¿ã¾ã™ã€‚

```typescript
// axiosã®åˆæœŸè¨­å®š
export const BackendApiClient = axios.create({
  baseURL: `${process.env.NEXT_PUBLIC_BACKEND_API_ENDPOINT}/api`,
  headers,
});
```

## APIã®å‹è£œå®Œã‚’åŠ¹ã‹ã›ã‚‹

ãƒ•ãƒ­ãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã™ã‚‹éš›ã®è£œå®Œã‚’åŠ¹ã‹ã›ã¦è¡Œãã¾ã™ã€‚
[ã“ã®è¨˜äº‹ï¼ˆå†æ²ï¼‰](https://zenn.dev/sum0/articles/8e903ed05ba681)ã®å†…å®¹ãŒã»ã¨ã‚“ã©ãã®ã¾ã¾å‡ºã¦ãã¾ã™ã€‚

ã¾ãšã¯ã€APIã‚’å‘¼ã¶é–¢æ•°ã®è£œå®Œã‚’åŠ¹ã‹ã›ã‚‹ãŸã‚ã®å‹ã‚’å®šç¾©ã—ã¾ã™ã€‚


```typescript: lib/api/schemaHelper.ts
import { paths } from "./types";
import { UnionToIntersection, Get } from "type-fest";
import { ExtractReqQuery, ExtractReqData, ExtractResData } from "@/common/types/api";

export type UrlPaths = keyof paths;
export type HttpMethods = keyof UnionToIntersection<paths[keyof paths]>;
export type HttpMethodsFilteredByPath<Path extends UrlPaths> = HttpMethods &
  keyof UnionToIntersection<paths[Path]>;

export type RequestParameters<
  Path extends UrlPaths,
  Method extends HttpMethods,
> = ExtractReqQuery<Get<paths, `${Path}.${Method}`>>;

export type RequestData<
  Path extends UrlPaths,
  Method extends HttpMethods,
> = ExtractReqData<Get<paths, `${Path}.${Method}`>>;

export type ResponseData<
  Path extends UrlPaths,
  Method extends HttpMethods,
> = ExtractResData<Get<paths, `${Path}.${Method}`>>;
```

ä»¥ä¸‹ã®ç®‡æ‰€ã§`paths`ã®ã‚­ãƒ¼ã§ã‚ã‚‹APIã®ãƒ‘ã‚¹ã¨ã€ãƒ¡ã‚½ãƒƒãƒ‰ã®å¯¾å¿œé–¢ä¿‚ã‚’å–å¾—ã—ã¾ã™ã€‚

```typescript
export type UrlPaths = keyof paths;
export type HttpMethods = keyof UnionToIntersection<paths[keyof paths]>;
export type HttpMethodsFilteredByPath<Path extends UrlPaths> = HttpMethods &
  keyof UnionToIntersection<paths[Path]>;
```

ãã—ã¦ã€`Path`ã¨`Method`ã‚’ã‚­ãƒ¼ã«æŒ‡å®šã—ã¦`paths`ã‹ã‚‰`Get<>`ã§å¯¾å¿œã™ã‚‹APIã‚’å–å¾—ã—ã€
ã•ã‚‰ã«ãã®APIã®`interface`ã‹ã‚‰`ExtractReqQuery<>`ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‹ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚
`Get<>`ã¯`type-fest`ã§ã€`ExtractReqQuery<>`ã¯ä¸Šã§å®šç¾©ã—ãŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã§ã™ã€‚

```typescript
export type RequestParameters<
  Path extends UrlPaths,
  Method extends HttpMethods,
> = ExtractReqQuery<Get<paths, `${Path}.${Method}`>>;
```

æœ€å¾Œã«`axios`ã‚„`swr`ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®é–¢æ•°ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
ã»ã¨ã‚“ã©å‚è€ƒè¨˜äº‹ã¨åŒã˜ãªã®ã§ç‰¹ã«èª¬æ˜ã¯ã—ãªã„ã§ã™ã€‚

```typescript: lib/api/hooks.ts
import { AxiosError, AxiosResponse } from "axios";
import useSWR from "swr";
import {
  HttpMethods,
  HttpMethodsFilteredByPath,
  RequestData,
  RequestParameters,
  ResponseData,
  UrlPaths,
} from "@/lib/api/schemaHelper";
import { BackendApiClient } from "./clients";

export type AxiosConfigWrapper<
  Path extends UrlPaths,
  Method extends HttpMethods,
> = {
  url: Path;
  method: Method & HttpMethodsFilteredByPath<Path>;
  params?: RequestParameters<Path, Method>;
  data?: RequestData<Path, Method>;
};

export function request<Path extends UrlPaths, Method extends HttpMethods>(
  config: AxiosConfigWrapper<Path, Method>,
) {
  return BackendApiClient.request<
    ResponseData<Path, Method>,
    AxiosResponse<ResponseData<Path, Method>>,
    AxiosConfigWrapper<Path, Method>["data"]
  >(config);
}

const fetcher = <Path extends UrlPaths, Method extends HttpMethods>(
  config: AxiosConfigWrapper<Path, Method>,
) => {
  return request<Path, Method>(config).then((res) => res.data);
};

export const useAppSWR = <Path extends UrlPaths, Method extends HttpMethods>(
  config: AxiosConfigWrapper<Path, Method>,
) => useSWR<ResponseData<Path, Method>, AxiosError>(config, fetcher);
```

ã“ã‚Œã§å®Œæˆã—ã¾ã—ãŸã€‚
ãŸã ã€`request`ã®æ–¹ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã«ã¯ãªã£ã¦ã„ãªã„ã®ã§ã€
ä»¥ä¸‹ã®è¨˜äº‹ãªã©ã‚’å‚è€ƒã«å¿…è¦ã«å¿œã˜ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã«ã™ã‚‹ã¨è‰¯ã„ã‹ã¨æ€ã„ã¾ã™ã€‚

https://qiita.com/mamimami0709/items/603c6ea9f9bfa68461f9

# ãŠã‚ã‚Šã«

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹éš›ã«ã€å‹ã‚’ä»˜ä¸ã—ã¦å®‰å¿ƒã§ãã¾ã—ãŸã€‚


# ãã®ã»ã‹ã®å‚è€ƒè¨˜äº‹

https://omkz.net/nextjs-swr-post/
