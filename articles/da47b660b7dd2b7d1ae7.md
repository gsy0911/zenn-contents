---
title: "cognitoã‚’åˆ©ç”¨ã—ã¦streamlitã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ç¯„å›²ã‚’é™å®šã™ã‚‹"
emoji: "ğŸ—‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS", "CDK", "Cognito", "streamlit"]
published: true
---

# ã¯ã˜ã‚ã«

ã¿ãªã•ã‚“ã€streamlitã¯åˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿã€€pandasã‚„matplotlibãªã©ã‚’åˆ©ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã™ã‚‹éš›ã«ã¯ä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«ã§ã™ã‚ˆã­ã€‚

ãã®éš›ã«ã€ã€Œãƒãƒƒãƒˆã«å…¬é–‹ã¯ã—ãŸã„ã‘ã‚Œã©ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ã‚‚ã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã«å…¬é–‹ã—ãŸã„ãªã€ã¨è€ƒãˆã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿã€€streamlitãã®ã‚‚ã®ã«ã¯èªè¨¼ãªã©ã®æ©Ÿèƒ½ã¯ãªã„ãŸã‚ã€ç‹¬è‡ªã«å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãã“ã§ä»Šå›ã¯AWSã‚µãƒ¼ãƒ“ã‚¹ã®Cognitoã‚’åˆ©ç”¨ã—ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ãŒã‚ã‚‹streamlitã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚å„ãƒªã‚½ãƒ¼ã‚¹ã¯CDKã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€ä½œæˆã¨å‰Šé™¤ã‚’ç°¡å˜ã«ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

# æ–™é‡‘ãƒ»æ§‹æˆ

## æ§‹æˆ

ä»Šå›ã€AWSã®ãƒªã‚½ãƒ¼ã‚¹ã¯CDKã§ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ä½œæˆã—ã¾ã™ã€‚
ï¼ˆãŸã ã—ã€æ‰‹å‹•ã§ã®äº‹å‰ã®æº–å‚™ã¯å¤šå°‘å¿…è¦ã§ã™ï¼‰

Application LoadBalancerã§Cognitoã®èªè¨¼ã‚’ã—ã¦ã„ã¾ã™ã€‚
Developerã¯ã‚ã‚‰ã‹ã˜ã‚ã€Cognitoã§ãƒ­ã‚°ã‚¤ãƒ³ç”¨ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãŠãã€
ãã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ãŸã„Userã«é…å¸ƒã—ã¾ã™ã€‚
é…å¸ƒã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿ã§Cognitoã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã®ã§ã€
å®‰å…¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/5690cf0cc3d71831b54a0993.png)


## æ–™é‡‘


æ–™é‡‘ã¯åˆ©ç”¨é‡ã«ã‚‚ã‚ˆã£ã¦å¤‰ã‚ã‚‹ã®ã§ã™ãŒã€åˆè¨ˆã§4,000[å††ï¼æœˆ]ç¨‹åº¦ã‹ã‹ã‚‹è¨ˆç®—ã§ã™ã€‚
ã€Œã‚¢ã‚¯ã‚»ã‚¹ã®é »åº¦ã¯ä½ã„ã€ãƒ»ã€ŒFargateã®ãƒªã‚½ãƒ¼ã‚¹ã¯`0.5vCPU, 256MiB`ã€ã®æƒ³å®šã§è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚
ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ã‹ã‹ã‚‹æ–™é‡‘ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

| AWSã‚µãƒ¼ãƒ“ã‚¹ | æ–™é‡‘[å††ï¼æœˆ] |
|:---|---:|
| Application LoadBalancer | 2,500 |
| Fargate | 1,100 |
| Cognito | ï¼ˆç„¡æ–™ï¼‰ |

# æº–å‚™

äº‹å‰ã«æº–å‚™ãŒå¿…è¦ãªç‰©ã¨ã—ã¦ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨è¨¼æ˜æ›¸ã§ã™ã€‚
ï¼ˆä»Šå›ã¯èª¬æ˜ã—ã¾ã›ã‚“ãŒã€ç’°å¢ƒã«CDKã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æº–å‚™ã‚‚å¿…è¦ã§ã™ï¼‰

## Route53

ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯Route53ã§æº–å‚™ã—ã¾ã™ã€‚
Route53ã«åˆ©ç”¨ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç™»éŒ²ã—ã¦ã€ã™ãã«åˆ©ç”¨ã§ãã‚‹çŠ¶æ…‹ã«ã—ã¾ã™ã€‚

ç”»åƒã®ã‚ˆã†ã«ã€NSã‚¿ã‚¤ãƒ—ã¨SOAã‚¿ã‚¤ãƒ—ãŒç™»éŒ²ã•ã‚Œã¦ã„ãŸã‚‰å¤§ä¸ˆå¤«ã§ã™ã€‚
CDKã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ALBã¸ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¨ã—ã¦Aã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ ã—ã¦ã€
ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã£ãŸéš›ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/4744945960113a78bfc5dacb.png)

ä»Šå›ã¯ä¾‹ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

- å–å¾—ã—ãŸãƒ«ãƒ¼ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³ï¼š `your.domain.com`
- ä»Šå›ä½œæˆã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è¨­å®šã™ã‚‹ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼š `streamlit.your.domain.com`

ä¸Šã®ç”»åƒã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã¯ã€`streamlit.your.domain.com`ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

:::message
ä»Šå›ã¯æ–°è¦ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã‚’ä½œæˆã—ã¦ã„ã¾ã™ãŒã€`your.domain.com`ã«Aãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ã‚‚è‰¯ã„ã§ã™ã€‚åˆ†ã‘ãŸç†ç”±ã¯ACMãªã©ã®è¨¼æ˜æ›¸ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚åŒã˜ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã«å…¥ã‚Œã¦ç®¡ç†ã‚’å®¹æ˜“ã«ã—ãŸã„ãŸã‚ã§ã™ã€‚
:::

## è¨¼æ˜æ›¸ï¼ˆACMï¼‰

ä½œæˆã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã«httpsã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¯¾ã—ã¦ACMã§è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ã¾ã™ã€‚
è¨¼æ˜æ›¸ã®ç™ºè¡Œã¯ã€å…¨ã¦ã®ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã«é©ç”¨ã§ãã‚‹`*.your.domain.com`ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
ï¼ˆä¸‹ã®ç”»åƒã®2ã¤ã®é …ç›®ã®ã†ã¡ã€ä¸Šã®`*.`ã‹ã‚‰å§‹ã¾ã£ã¦ã„ã‚‹æ–¹ï¼‰

Route53ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€`your.domain.com`ã‚’ç®¡ç†ã—ã¦ã„ã‚‹ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã«å¯¾ã—ã¦
CNAMEã‚¿ã‚¤ãƒ—ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¿½åŠ ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/c280b887c1f408530813fa8d.png)

# ãƒ—ãƒ­ã‚°ãƒ©ãƒ 

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯é©å®œè¼‰ã›ã¾ã™ãŒã€è©³ç´°ã¯ãƒªãƒã‚¸ãƒˆãƒªã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- [zenn-streamlit-cognito](https://github.com/gsy0911/zenn-streamlit-cognito)

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

`infra/`ãƒ•ã‚©ãƒ«ãƒ€ã«ã¦ã€CDKã®ã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚
`streamlit/`ãƒ•ã‚©ãƒ«ãƒ€ã«ã¦ã€Fargateä¸Šã§ç¨¼åƒã•ã›ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Dockerã§è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚

```shell
root
â”œâ”€â”€ infra/
â”‚  â”œâ”€â”€ cdk.context.json
â”‚  â”œâ”€â”€ cdk.json
â”‚  â”œâ”€â”€ cdk.out
â”‚  â”œâ”€â”€ index.ts
â”‚  â”œâ”€â”€ params.ts
â”‚  â”œâ”€â”€ paramsExample.ts
â”‚  â””â”€â”€ StreamlitEcsFargateStack.ts
â”œâ”€â”€ streamlit/
â”‚  â”œâ”€â”€ app.py
â”‚  â”œâ”€â”€ config.toml
â”‚  â”œâ”€â”€ Dockerfile
â”‚  â””â”€â”€ Makefile
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â””â”€â”€ tsconfig.json
```

## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

streamlitã®ã‚³ãƒ¼ãƒ‰è§£èª¬ã¯ã—ãªã„ã§ã™ã€‚
CDKã§ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã«ã¤ã„ã¦ã®ã¿ã¡ã‚‡ã£ã¨è¦‹ã¦ã„ãã¾ã™ã€‚

### Cognitoãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆ

Cognitoã®è¨­å®šã‚’ã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è©³ã—ã„å†…å®¹ã¯[CDKãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/cdk/api/latest/docs/@aws-cdk_aws-cognito.UserPool.html)ã‚’ã”è¦§ãã ã•ã„ã€‚
ã¾ãŸåˆ©ç”¨ã™ã‚‹ç’°å¢ƒã«å¿œã˜ã¦ã€é©å®œä¿®æ­£ã‚’ã—ã¦ãã ã•ã„ã€‚

ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®2ç‚¹ã§ã™ã€‚

- `selfSignUpEnabled=false`
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªå·±ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚’é˜²ã„ã§ã„ã‚‹
- `removalPolicy=cdk.RemovalPolicy.DESTROY`
    - ã“ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‰Šé™¤ã—ãŸéš›ã«ç™»éŒ²å†…å®¹ã”ã¨Cognitoã‚’å‰Šé™¤ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹

```typescript:StreamlitEcsFargateStack.ts
/* ~~å‰ç•¥~~ */

const userPool = new cognito.UserPool(this, "userPool", {
    userPoolName: "streamlit-user-pool-test",
    // self signUp disabled
    selfSignUpEnabled: false,
    userVerification: {
        emailSubject: "Verify email message",
        emailBody: "Thanks for signing up! Your verification code is {####}",
        emailStyle: cognito.VerificationEmailStyle.CODE,
        smsMessage: "Thanks for signing up! Your verification code is {####}"
    },
    // sign in
    signInAliases: {
        username: true,
        email: true
    },
    // user attributes
    standardAttributes: {
        nickname: {
            required: true,
            // `mutable` means changeable
            mutable: true
        }
    },
    // role, specify if you want
    mfa: cognito.Mfa.OPTIONAL,
    mfaSecondFactor: {
        sms: true,
        otp: true
    },
    passwordPolicy: {
        minLength: 8,
        requireLowercase: true,
        requireUppercase: true,
        requireDigits: true,
        requireSymbols: true,
        tempPasswordValidity: cdk.Duration.days(3)
    },
    accountRecovery: cognito.AccountRecovery.EMAIL_ONLY,
    removalPolicy: cdk.RemovalPolicy.DESTROY,
    // emails, by default `no-reply@verificationemail.com` used
})

/* ~~å¾Œç•¥~~ */

```

### ALBã«Cognitoèªè¨¼ã®ä»˜ä¸

ALBã«Cognitoèªè¨¼ã‚’è¿½åŠ ã—ãŸè¨­å®šãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- Fargateã¨ALBã«è¨­å®šã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ã‚ãˆã¦ä½œæˆãƒ»è¨­å®šã—ã¦ã„ã‚‹
    - ALBã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã«443ã®egressã‚’è¨±å¯ã™ã‚‹ãŸã‚
    - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç”Ÿæˆã•ã‚Œã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¯ä»˜ä¸ã•ã‚Œãªã„
- ALBã®listenerã«Cognitoã®èªè¨¼ã‚’åŠ ãˆã¦ã„ã‚‹

```typescript:StreamlitEcsFargateStack.ts
/* ~~å‰ç•¥~~ */

const ecsServiceSecurityGroup = new ec2.SecurityGroup(this, "ecs-service-sg", {
    vpc,
    securityGroupName: "streamlit-service-sg",
    description: "security group to allow IdP",
})

const service = new ecs.FargateService(this, "StreamlitService", {
    cluster: cluster,
    taskDefinition: taskDef,
    deploymentController: {
        type: ecs.DeploymentControllerType.CODE_DEPLOY
    },
    healthCheckGracePeriod: cdk.Duration.seconds(5),
    assignPublicIp: true,
    securityGroups: [ecsServiceSecurityGroup],
})

// https://<alb-domain>/oauth2/idpresponse
// requires allowing HTTPS egress-rule
const albSecurityGroup = new ec2.SecurityGroup(this, "alb-sg", {
    vpc,
    securityGroupName: "streamlit-alb-sg",
    description: "security group to allow IdP",
    allowAllOutbound: false
})
albSecurityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(80), "allow HTTP")
albSecurityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(8080), "allow alt HTTP")
albSecurityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(443), "allow HTTPS")
albSecurityGroup.addEgressRule(ecsServiceSecurityGroup, ec2.Port.tcp(80), "allow HTTP")
albSecurityGroup.addEgressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(443), "allow HTTPS")
ecsServiceSecurityGroup.addIngressRule(albSecurityGroup, ec2.Port.tcp(80), "allow from alb-HTTP")

const alb = new elb.ApplicationLoadBalancer(this, "ApplicationLoadBalancer", {
    loadBalancerName: "StreamlitALB",
    vpc: vpc,
    idleTimeout: cdk.Duration.seconds(30),
    // scheme: true to access from external internet
    internetFacing: true,
    securityGroup: albSecurityGroup
})

const listenerHttp1 = alb.addListener("listener-https", {
    protocol: elb.ApplicationProtocol.HTTPS,
    certificates: [elb.ListenerCertificate.fromArn(params.alb.certificate)]
})

const targetGroupBlue = listenerHttp1.addTargets("http-blue-target", {
    targetGroupName: "http-blue-target",
    protocol: elb.ApplicationProtocol.HTTP,
    deregistrationDelay: cdk.Duration.seconds(30),
    targets: [service],
    healthCheck: {
        healthyThresholdCount: 2,
        interval: cdk.Duration.seconds(10)
    },
})
listenerHttp1.addAction("cognito-auth-elb-1", {
    action: new elbActions.AuthenticateCognitoAction({
        userPool: userPool,
        userPoolClient: app1,
        userPoolDomain: userPoolDomain,
        scope: "openid",
        onUnauthenticatedRequest: elb.UnauthenticatedAction.AUTHENTICATE,
        next: elb.ListenerAction.forward([targetGroupBlue])
    }),
    conditions: [elb.ListenerCondition.pathPatterns(["*"])],
    priority: 1
})

/* ~~å¾Œç•¥~~ */
```


## ãƒ‡ãƒ—ãƒ­ã‚¤

### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã„ã¾ã™ã€‚

```shell
$ npm install
```

### ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä»˜ä¸

ãƒ‡ãƒ—ãƒ­ã‚¤ã®å‰ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã™ã€‚
`infra/`ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹`paramsExample.ts`ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦`params.ts`ã‚’ä½œæˆã—ã¾ã™ã€‚

```shell
$ cd infra
$ cp paramsExample.ts params.ts
```

`params.ts`ã«`vpcId`ã‚„ä½œæˆã—ãŸãƒªã‚½ãƒ¼ã‚¹ã®`ARN`ã‚’è¨­å®šã—ã¾ã™ã€‚æ³¨æ„ç‚¹ã¨ã—ã¦ã€`domainPrefix`ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€å…¥åŠ›å€¤ã«ã‚ˆã£ã¦ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã™ã€‚

```diff typescript:params.ts
import { IStreamlitEcsFargateCognito } from './StreamlitEcsFargateStack';


export const params: IStreamlitEcsFargateCognito = {
+	vpcId: "{your-aws-vpcId}",
-	vpcId: "vpc-xxxxxxxx",
	env: {
+		account: "{your-aws-accountId}",
-		account: "123456789012",
		region: "ap-northeast-1"
	},
	alb: {
+		certificate: "{your-acm-arn}",
+		route53DomainName: "streamlit.your.domain.com"
-		certificate: "arn:aws:acm:ap-northeast-1:123456789012:certificate/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
-		route53DomainName: "your.domain.com"
	},
	cognito: {
+		domainPrefix: "streamlit", # ã“ã“ã®å€¤ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§æ³¨æ„
+		callbackUrls: ["https://streamlit.your.domain.com/oauth2/idpresponse"],
+		logoutUrls: ["https://streamlit.your.domain.com"]
-		domainPrefix: "as-you-like",
-		logoutUrls: ["httptps://your.domain.com/oauth2/idpresponse"],
-		logoutUrls: ["https://your.domain.com"]
	},
}
```

### ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ

ä¸Šè¨˜ã®æº–å‚™ãŒçµ‚ã‚ã£ãŸã‚‰ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã—ã¾ã™ã€‚

`infra/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•å¾Œã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã—ã¾ã™ã€‚

```shell
$ cd infra
$ cdk deploy
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€IAMã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã«é–¢ã™ã‚‹è¨­å®šãŒè¡¨ç¤ºã•ã‚ŒãŸã®ã¡ã€
`y`ã‚’å…¥åŠ›ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/a08f0d267a658c340bad8a06.png)

`params.ts`ãªã©ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãŸã‚‰ã€
10åˆ†ç¨‹åº¦ã§ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã™ã€‚

## ç¢ºèª

### Cognitoã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹

AWSã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã€CDKã§ä½œæˆã—ãŸCognitoã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/4ddaf511ec1ba877ad725dbd.png)

ãƒ­ã‚°ã‚¤ãƒ³ç”¨ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã€
ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã€â†’ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã€ã®é †ã«æŠ¼ä¸‹ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/48c2d788b61192d73e85651c.png)

é©å½“ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/43d261b67ed6e7fcd0835566.png)

ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã€Œæœ‰åŠ¹ã€ã«ãªã‚Šã€
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€ŒFORCE_CHANGE_PASSWORDã€ã«ãªã£ãŸã‚‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æº–å‚™å®Œäº†ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/4608b53402cf7e2a0a426a4e.png)

### ä½œæˆã—ãŸãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‰ãƒ¡ã‚¤ãƒ³`streamlit.your.domain.com`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚
ã™ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ãŒæ±‚ã‚ã‚‰ã‚Œã€åˆå›ã®ã¿ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã‚‚æ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/1f7d929fff49c3b478cce64c.png)

æœ‰åŠ¹ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã€ŒSendã€ã‚’æŠ¼ä¸‹ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/b90b0fc1d0e547ab755fa1e1.png)

ã™ã‚‹ã¨ã€ä½œæˆã—ãŸstreamlitã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”»é¢ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/f6609c5ed2b620f12b0dbd1a.png)


## ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤

ãƒ†ã‚¹ãƒˆãªã©ã§ä½œæˆã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
å‰Šé™¤ã‚’å¿˜ã‚ŒãŸå ´åˆã¯4,000[å††ï¼æœˆ]ã»ã©ã‹ã‹ã‚Šã¾ã™ã€‚

```shell
$ cdk destroy
```

# ãŠã‚ã‚Šã«

ä»Šå›ã‚‚CDKã‚’åˆ©ç”¨ã—ã¦ã€streamlitã«ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’æŒãŸã›ã¦ã‚¢ã‚¯ã‚»ã‚¹ç¯„å›²ã‚’é™å®šã—ã¦ã¿ã¾ã—ãŸã€‚

ã€Œé•·æœŸçš„ãªé‹ç”¨ã€ã¨ã„ã†ã‚ˆã‚Šã¯ã€Œã™ãã«ä½œã£ã¦ã€ã™ãå‰Šé™¤ã™ã‚‹ã€ã‚ˆã†ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
ï¼ˆã®å‰²ã«ã¯Cognitoã¯ã‚ªãƒ¼ãƒãƒ¼ã‚¹ãƒšãƒƒã‚¯ã‹ã‚‚ã§ã™ã­â€¦ï¼‰ã€‚

ãã£ã‹ã‘ã¯ã€ALBã«Cognitoèªè¨¼ã‚’ä»˜ä¸ã§ãã‚‹ã¨ã„ã†ã“ã¨ã‚’æœ€è¿‘çŸ¥ã£ã¦ã€ä½•ã‹ç°¡å˜ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹ã‚’ä½œã£ã¦ã¿ãŸã„ãªã¨æ€ã£ãŸã“ã¨ã§ã—ãŸã€‚

ã¾ãŸã€AWS CDK 2.0ã®rcãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã€IaCé–¢é€£ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®æ¥½ã—ã¿ãŒæ­¢ã¾ã‚Šã¾ã›ã‚“ã­ï¼

# å‚è€ƒ

https://dev.classmethod.jp/articles/http-headers-added-by-alb-and-cognito-are-explained/
https://dev.classmethod.jp/articles/alb-cognito-user-pool/
https://heart-shaped-chocolate.hatenablog.jp/entry/2019/01/30/141159
