---
title: "CDKã‚’ä½¿ã£ã¦Next.jsã‚’S3+CloudFrontã®æ§‹æˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹"
emoji: "ğŸ§€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Nextjs", "AWSCDK", "CloudFront"]
published: true
---

# ã¯ã˜ã‚ã«

CloudFrontã‚’ä½¿ã£ã¦Next.jsãªã©ã§ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ä¿¡ã™ã‚‹ã¨ãã«ã€
S3ã®ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šã‚’ã€Œå…¬é–‹ã€ã«ã—ãŸããªã„æ™‚ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
ï¼ˆâ†“ S3ã®ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šãŒå…¬é–‹ã«ãªã£ã¦ã„ã‚‹çŠ¶æ…‹ï¼‰

![](https://storage.googleapis.com/zenn-user-upload/2f41bd94d240-20230115.png =600x)

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯é…ä¿¡ã•ã‚Œã‚‹ã“ã¨ãŒç›®çš„ã®ãŸã‚ã€
S3ã®ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šãŒã€Œå…¬é–‹ã€ã®ã¾ã¾ã§ã‚‚æ„å›³ã•ã‚ŒãŸã‚‚ã®ã§ã‚ã‚Œã°å•é¡Œã¯ãªã„ã§ã™ã€‚
ãŸã ã€S3ã®ãƒã‚±ãƒƒãƒˆãŒã€Œå…¬é–‹ã€ã«ãªã£ã¦ã„ã‚‹ã®ã¯ç²¾ç¥è¡›ç”Ÿä¸Šã‚ˆããªã„ã¨æ€ã„ã¾ã™ã€‚

ã„ãã¤ã‹ã®è¨˜äº‹ã§ã‚‚è¨€åŠã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€
CloudFront + S3ã§Next.jsã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ä¿¡ã™ã‚‹éš›ã«ã¯ä»¥ä¸‹ã®2ã¤ã®æ–¹æ³•ãŒä¸»æµã‹ã¨æ€ã„ã¾ã™ã€‚

1. S3ã‚’ã€Œé™çš„Webã‚µãƒ¼ãƒãƒ¼ï¼å…¬é–‹ã€ã«è¨­å®šã—ã¦ã€CloudFrontã‹ã‚‰é…ä¿¡ã™ã‚‹
2. S3ã¯ã€Œéå…¬é–‹ã€è¨­å®šã®ã¾ã¾ã€Lambda@Edgeã‚’åˆ©ç”¨ã—ã¦CloudFrontã‹ã‚‰é…ä¿¡ã™ã‚‹

ä»Šå›ã¯2ã®æ–¹æ³•ã‚’æ¡ç”¨ã—ã¤ã¤ã€ãã‚Œã‚’CDKã§å®Ÿè£…ã—ã¾ã™ã€‚
åŠ ãˆã¦ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚‚å°‘ã—æ„è­˜ã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ä¿¡ã—ã¾ã™ã€‚

# ã‚„ã‚ŠãŸã„ã“ã¨ãƒ»å¯¾è±¡èª­è€…ãƒ»æ§‹æˆãƒ»æ–™é‡‘

## ã‚„ã‚ŠãŸã„ã“ã¨

ã‚„ã‚ŠãŸã„ã“ã¨ã¯ã€
ã€ŒS3ã¯éå…¬é–‹è¨­å®šã®ã¾ã¾CloudFrontçµŒç”±ã§Next.jsã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ä¿¡ã™ã‚‹ã“ã¨ã€ã§ã™ã€‚
åŠ ãˆã¦ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚‚é«˜ã‚ã¤ã¤é…ä¿¡ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

## å¯¾è±¡èª­è€…

ä»¥ä¸‹ã®å†…å®¹ã‚’å®Ÿè¡Œã—ãŸã„äººã«ãŠã™ã™ã‚ã§ã™ã€‚

- CDKã‚’ä½¿ã£ã¦CloudFront + Next.jsã®æ§‹æˆã‚’ä½œã‚ŠãŸã„
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚‚é«˜ã‚ã¤ã¤CloudFrontã§ã®é…ä¿¡ã‚’å®Ÿæ–½ã—ãŸã„

## æ§‹æˆ


Lambda@Edgeã‚’åˆ©ç”¨ã—ãŸæ§‹æˆã¨æŒ™å‹•ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ä»¥ä¸‹ã®å›³ã®é€šã‚Šã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/551680add959-20230115.png =600x)

Lambda@Edgeã§æœ«å°¾ã«`index.html`ã‚’ä»˜ä¸ã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã—ã«è¡Œãã“ã¨ã§ã€
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒNext.jsã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ä¸€æ–¹ã§ã€Lambda@Edgeã‚’æŒŸã¾ãªã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/63f5a62e5ea5-20230115.png)

S3ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‚ç…§ã™ã‚‹éš›ã«ã€å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã‚’å‚ç…§ã—ã¦ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€S3ã‚’å‚ç…§ã™ã‚‹å‰ã«Lambda@Edgeã§ã®å‡¦ç†ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚


## æ–™é‡‘

ä»Šå›ã¯ã€ä»¥ä¸‹ã®AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã—ã¦æ§‹ç¯‰ã—ã¾ã™ã€‚

- Lambda@Edge
- CloudFront
- S3
- Route53
- ACM

ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚µã‚¤ã‚ºãŒå°ã•ãã‚¢ã‚¯ã‚»ã‚¹é »åº¦ã‚‚ä½ã„å ´åˆã¯ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é…ä¿¡ã¯ã»ã¼ç„¡æ–™ã§ã™ã€‚
Route53ã®ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³å–å¾—ã®ã¿æ–™é‡‘ãŒã‹ã‹ã‚Šã¾ã™ã€‚

## ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ

- macOS: 13.1
- Node.js: 16.15
- AWS CDK: 2.60.0


# ã‚³ãƒ¼ãƒ‰

[ã“ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/gsy0911/zenn-cloudfront-oai)ã«ã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¦ã„ã¾ã™ã€‚
å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆã®ç´°ã‹ã„ã‚³ãƒ¼ãƒ‰ãªã©ã¯ãƒªãƒã‚¸ãƒˆãƒªã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
ã¾ãŸã€æœ¬è¨˜äº‹ã§ã‚‚CloudFrontã®éƒ¨åˆ†ã¨Lambda@Edgeã®æŒ™å‹•ã«é–¢ã—ã¦å°‘ã—è§£èª¬ã—ã¾ã™ã€‚

Lambda@Edgeã‚’JavaScriptã¨TypeScriptã®2é€šã‚Šã®å®Ÿè£…æ–¹æ³•ã‚’è¼‰ã›ã¦ã„ã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰ã®å·®ç•°ã¯ã»ã¼ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒ‡ãƒ—ãƒ­ã‚¤ã®æº–å‚™ãªã©ãŒç•°ãªã‚Šã¾ã™ã€‚
ã©ã¡ã‚‰ã§ã‚‚è‰¯ã„å ´åˆã¯ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®æ‰‹é–“ãªå°‘ãªã„JavaScriptã§ã®å®Ÿè£…ãŒãŠå‹§ã‚ã§ã™ã€‚
ä¸€æ–¹ã§ã€Lambda@Edgeã‚’ä½¿ã„å›ã™å ´åˆã‚„ã€ç®¡ç†ã‚’ã—ãŸã„å ´åˆã¯TypeScriptç‰ˆã®æ–¹ãŒãŠå‹§ã‚ã§ã™ã€‚

## Lambda@Edgeã®ã‚³ãƒ¼ãƒ‰ã‚’JavaScriptã§å®Ÿè£…ã™ã‚‹

JavaScriptã§ä½œæˆã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã®Lambda@Edgeã‚’ä½œæˆã™ã‚Œã°å®Ÿç¾ã§ãã¾ã™ã€‚
å‡¦ç†å†…å®¹ã¨ã—ã¦ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆURIã®æœ«å°¾ã«`index.html`ã‚’ä»˜ä¸ã™ã‚‹ã ã‘ã«ãªã‚Šã¾ã™ã€‚

```javascript:infrastructure/lib/lambda/js_edge/rewrite-trailing-slash/index.js
exports.handler = (event, context, callback) => {
  const request = event.Records[0].cf.request;
  const uri = request.uri;
  // ãƒ•ã‚¡ã‚¤ãƒ«å ("/" ã§åŒºåˆ‡ã‚‰ã‚ŒãŸãƒ‘ã‚¹ã®æœ€å¾Œ) ã‚’å–å¾—
  const filename = request.uri.split("/").pop();

  if (uri.endsWith("/")) {
    request.uri = request.uri.concat("index.html");
  } else if (filename) {
    if (!filename.includes(".")) {
      // ãƒ•ã‚¡ã‚¤ãƒ«åã«æ‹¡å¼µå­ãŒã¤ã„ã¦ã„ãªã„å ´åˆã€ "/index.html" ã‚’ã¤ã‘ã‚‹
      request.uri = request.uri.concat("/index.html");
    }
  }
  console.log(`uri: ${uri} -> ${request.uri}`)
  callback(null, request);
}
```

JavaScriptã®å ´åˆã¯ã€ä»¥ä¸‹ã®CDKã®ã‚³ãƒ¼ãƒ‰ã§Lambda@Edgeã‚’ä½œæˆã§ãã¾ã™ã€‚

```typescript:infrastructure/lib/CloudFrontOaiStack.ts
// ~~å‰ç•¥~~

    const dir = path.resolve(__dirname, 'lambda', 'js_edge', 'rewrite-trailing-slash')
    const rewriteTrailingSlashVersion = new aws_cloudfront.experimental.EdgeFunction(this, "edge-origin-request", {
      code: aws_lambda.Code.fromAsset(dir),
      functionName: "origin-request",
      handler: `index.handler`,
      runtime: aws_lambda.Runtime.NODEJS_16_X,
      memorySize: 512,
      timeout: Duration.seconds(5),
      architecture: aws_lambda.Architecture.X86_64,
    })

// ~~å¾Œç•¥~~
```

## Lambda@Edgeã®ã‚³ãƒ¼ãƒ‰ã‚’TypeScriptã§å®Ÿè£…ã™ã‚‹

ä¸€æ–¹ã€TypeScriptã‚’ç”¨ã„ã¦ä½œæˆã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§å®Ÿç¾ã§ãã¾ã™ï¼ˆå½“ç„¶ãªãŒã‚‰ã‚³ãƒ¼ãƒ‰ãã®ã‚‚ã®ã¯ã€JavaScriptã¨ã»ã¨ã‚“ã©å·®ã¯ãªã„ã§ã™ï¼‰ã€‚
ãŸã ã€ã“ã®å ´åˆã¯äº‹å‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã«ãªã‚Šã¾ã™ï¼ˆè©³ç´°ã¯[ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/gsy0911/zenn-cloudfront-oai)ã‚’å‚ç…§ã®ã“ã¨ï¼‰ã€‚


```typescript:infrastructure/lib/lambda/ts_edge/rewrite-trailing-slash/index.ts
import {CloudFrontRequestHandler} from "aws-lambda";

export const handler: CloudFrontRequestHandler = async (event) => {
  const request = event.Records[0].cf.request;
  const uri = request.uri;
  // ãƒ•ã‚¡ã‚¤ãƒ«å ("/" ã§åŒºåˆ‡ã‚‰ã‚ŒãŸãƒ‘ã‚¹ã®æœ€å¾Œ) ã‚’å–å¾—
  const filename = uri.split("/").pop();

  if (uri.endsWith("/")) {
    request.uri = request.uri.concat("index.html");
  } else if (filename) {
    if (!filename.includes(".")) {
      // ãƒ•ã‚¡ã‚¤ãƒ«åã«æ‹¡å¼µå­ãŒã¤ã„ã¦ã„ãªã„å ´åˆã€ "/index.html" ã‚’ã¤ã‘ã‚‹
      request.uri = request.uri.concat("/index.html");
    }
  }
  return request
}
```

TypeScriptã®å ´åˆã¯ã€ä»¥ä¸‹ã®CDKã®ã‚³ãƒ¼ãƒ‰ã§Lambda@Edgeã‚’å‚ç…§ã—ã¦ã„ã¾ã™ã€‚
ä¸€è¦‹ã€JavaScriptã®å ´åˆã¨æ¯”ã¹ã‚‹ã¨çŸ­ãæ¥½ã«è¦‹ãˆã¾ã™ãŒã€
SSMã‹ã‚‰Lambdaã®ARNã‚’èª­ã¿å–ã‚‹ãŸã‚ã«ã€äº‹å‰ã«åˆ¥Stackã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹åˆ¥Stackã®è©³ç´°ã¯[ã“ã®è¨˜äº‹](https://zenn.dev/gsy0911/articles/820313c08a545922733f)ã‚’ã”è¦§ãã ã•ã„ã€‚

```typescript:infrastructure/lib/CloudFrontOaiStack.ts
// ~~å‰ç•¥~~

    // Lambda@Edge
    const rewriteTrailingSlashParam = aws_ssm.StringParameter.fromStringParameterAttributes(this, 'rewriteTrailingSlashParam', {
      parameterName: `/${prefix}/${params.environment}/${params.lambdaEdgeStackId}/rewriteTrailingSlash`,
    }).stringValue;
    const rewriteTrailingSlashVersion = aws_lambda.Version.fromVersionArn(this, "rewriteTrailingSlashVersion", rewriteTrailingSlashParam)

// ~~å¾Œç•¥~~
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’é«˜ã‚ã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ã®ä»˜ä¸

CloudFrontã‹ã‚‰é…ä¿¡ã™ã‚‹éš›ã«ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§
ã‚ã‚‹ç¨‹åº¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’é«˜ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
AmazonãŒæä¾›ã—ã¦ã„ã‚‹æ—¢å­˜ã®ã‚‚ã®ã‚‚ã‚ã‚Šã€ãã¡ã‚‰ã‚’ä½¿ã†ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ãŸã ã€SCPã‚’è‡ªåˆ†ã§è¨­å®šã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã«å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```typescript:infrastructure/lib/CloudFrontOaiStack.ts
// ~~å‰ç•¥~~
    const responseHeadersPolicy = new aws_cloudfront.ResponseHeadersPolicy(this, "custom-rhp", {
      responseHeadersPolicyName: "custom-rhp",
      securityHeadersBehavior: {
        contentSecurityPolicy: {
          contentSecurityPolicy: `object-src 'self'; img-src 'self'; script-src 'self' 'nonce-${params.next.nonce}'; base-uri 'self'; form-action 'none'; frame-ancestors 'none'`,
          override: true
        },
        contentTypeOptions: {override: true},
        frameOptions: {
          frameOption: aws_cloudfront.HeadersFrameOption.SAMEORIGIN,
          override: true
        },
        referrerPolicy: {
          referrerPolicy: aws_cloudfront.HeadersReferrerPolicy.STRICT_ORIGIN_WHEN_CROSS_ORIGIN,
          override: true
        },
        strictTransportSecurity: {
          accessControlMaxAge: Duration.seconds(15768000),
          override: true
        },
        xssProtection: {
          protection: true,
          modeBlock: true,
          override: true
        }
      }
    })
// ~~å¾Œç•¥~~
```

:::message alert
SCPã‚’å¼·ã„è¨­å®šã«ã™ã‚‹ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®JavaScriptã‚„CSSãªã©ãŒã†ã¾ãæŒ™å‹•ã—ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚é©å®œç¢ºèªã—ã¦ã€é©åˆ‡ãªSCPã‚’è¨­å®šã™ã‚‹ã‚ˆã†ã«å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚
ï¼ˆã†ã¾ãæŒ™å‹•ã—ãªããªã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã¯ã€SCPã§åˆ¶é™ã™ã‚‹ã‹ã‚‰ã§ã™ãŒâ€¦ï¼‰ã€‚
:::

# ãƒ‡ãƒ—ãƒ­ã‚¤

å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¦æŒ™å‹•ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚
JavaScriptã¨TypeScriptã¨ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã®æ‰‹é †ãŒå°‘ã—ç•°ãªã‚Šã¾ã™ã€‚
æœ¬è¨˜äº‹ã§ã¯ã€ç°¡å˜ãªJavaScriptç‰ˆã®ã¿ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## 1. Nextã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

ã¾ãšã¯ã€Nextã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚
ãƒ“ãƒ«ãƒ‰ã™ã‚‹å‰ã«ã€ä»¥ä¸‹ã®2ã¤ã®è¨­å®šã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```diff javascript:next.config.js
const nextConfig = {
  reactStrictMode: true,
  swcMinify: true,
+ trailingSlash: true,
+ images: {unoptimized: true}
}

module.exports = nextConfig
```

`package.json`ã«ä»¥ä¸‹ã®å¤‰æ›´ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```diff json:package.json
{
  "name": "frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
+   "export": "NODE_ENV=production next build && next export -o build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@types/node": "18.11.9",
    "@types/react": "18.0.25",
    "@types/react-dom": "18.0.9",
    "eslint": "8.28.0",
    "eslint-config-next": "13.0.5",
    "next": "13.0.5",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "typescript": "4.9.3"
  }
}
```

ãã‚ŒãŒçµ‚ã‚ã£ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦`build`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```shell
# `frontend/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
$ npm run export
```

nextã®ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›å¾Œã«ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§S3ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

```shell
# `frontend/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
$ aws s3 sync build s3://{YOUR_BUCKET_NAME}
```

## 2. Route53ãªã©ã®è¨­å®š

Route53ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã—ã¦ã€ACMã§è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ã¦ãŠãã¾ã™ã€‚
å¿…è¦ãªã®ã¯ã€Route53ã®ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã¨ã€CloudFrontã«è¨­å®šã—ãŸã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¯¾ã™ã‚‹è¨¼æ˜æ›¸ã§ã™ã€‚
è©³ç´°ã¯[ã“ã®è¨˜äº‹](https://zenn.dev/gsy0911/articles/da47b660b7dd2b7d1ae7#%E6%BA%96%E5%82%99)ã‚’ã”è¦§ãã ã•ã„ã€‚


## 3. CDKã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã«ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

```shell
# `infrastructure/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
$ cp lib/params.example.ts lib/params.ts
```

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã‚’åæ˜ ã—ã¦ã„ãã¾ã™ã€‚

```diff typescript:infrastructure/lib/params.ts
import {ICloudFrontOaiStack} from './CloudFrontOaiStack';
import {ILambdaEdgeStack} from './LambdaEdgeStack';
import {
  Environment
} from 'aws-cdk-lib';

- const newlyGenerateS3BucketBaseName: string = "newly-generate-s3-bucket-base-name"
+ const newlyGenerateS3BucketBaseName: string = "YOUR_BUCKET_NAME"
- const accountId: string = "00001111222"
+ const accountId: string = "YOUR_AWS_aacount"
- const domain: string = "your.domain.com"
+ const domain: string = "YOUR_DOMAIN_COM"
const subDomain: string = `app.${domain}`
const subDomain: string = `app.${domain}`

export const paramsCloudFrontOaiStack: ICloudFrontOaiStack = {
  s3: {
    bucketName: newlyGenerateS3BucketBaseName,
  },
  cloudfront: {
-   certificate: `arn:aws:acm:us-east-1:${accountId}:certificate/{unique-id}`,
+   certificate: "YOUR_ACM_ARN",
    route53DomainName: domain,
    route53RecordName: subDomain
  },
  next: {
    // fronteond/pages/_document.tsxã®nonceã¨ä¸€è‡´ã•ã›ã‚‹
    nonce: "aGVsbG93b3JsZAo="
  },
  environment: "prod",
  lambdaEdgeStackId: "example-lambda-edge"
}
```

Lambda@EdgeãŒJavaScriptã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹Stackã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚

```shell
# `infrastructure/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
$ cdk deploy example-cloudfront-oai-js
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰1ã¤ã§`us-east-1`ã¨`ap-northeast-1`ã®2ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚
ãã®ãŸã‚ã€2å›ãƒ‡ãƒ—ãƒ­ã‚¤æ‰¿èªãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚

CloudFrontã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã¯20åˆ†ã»ã©æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

:::message
ã¾ãŸã€ä»¥ä¸‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æ‰¿èªãªã—ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚
`$ cdk deploy example-cloudfront-oai-js --require-approval never`
:::

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

```text
 => ERROR [internal] load metadata for public.ecr.aws/sam/build-nodejs16.x:latest                                                                                                                                1.8s
 => [auth] aws:: sam/build-nodejs16.x:pull token for public.ecr.aws                                                                                                                                              0.0s
------
 > [internal] load metadata for public.ecr.aws/sam/build-nodejs16.x:latest:
------
failed to solve with frontend dockerfile.v0: failed to create LLB definition: unexpected status code [manifests latest]: 403 Forbidden
```

ãã®å ´åˆã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€ECRã¸ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚

```shell
$ aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws
```

## 4. OAIã‚’S3ãƒã‚±ãƒƒãƒˆã«è¨­å®š

S3ã®ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã«CloudFrontã®OriginAccessIdentityã‚’å—ã‘å…¥ã‚Œã‚‹è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚
ï¼ˆã“ã“ã¯æ‰‹å‹•ã§è¡Œã„ã¾ã™ã€‚ï¼‰
ä»Šå›æ–°è¦ä½œæˆã—ãŸCloudFrontã®è¨­å®šã‹ã‚‰ã€ã€Œã‚ªãƒªã‚¸ãƒ³ã€â†’ã€Œç·¨é›†ã€ã‚’æŠ¼ä¸‹ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/3f9146d6f32c-20230115.png =600x)

ãã®ç·¨é›†ç”»é¢ã§ã€Œã¯ã„ã€ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã‚’è‡ªå‹•ã§æ›´æ–°ã—ã¾ã™ã€ã‚’é¸æŠã—ã¦ã€
ã€Œå¤‰æ›´ã‚’ä¿å­˜ã€ã‚’æŠ¼ä¸‹ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/205b56231221-20230115.png =600x)

Next.jsã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç½®ã„ãŸS3ã®ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ãŒã€
ä»¥ä¸‹ã®ã‚ˆã†ã«æ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/6d097b405161-20230115.png =600x)
![](https://storage.googleapis.com/zenn-user-upload/070c962c568d-20230115.png =600x)


# æŒ™å‹•ã®ç¢ºèª

## CloudFrontã®å‹•ä½œç¢ºèª

å®Ÿéš›ã«ä»Šå›ä½œæˆã—ãŸã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ã¡ã‚ƒã‚“ã¨å‹•ä½œã—ã¦ã„ã‚Œã°OKã§ã™ã€‚
ã¡ãªã¿ã«ã€ã‚µãƒ³ãƒ—ãƒ«ã«ã¯`/example`ã®ãƒšãƒ¼ã‚¸ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã®ã§ã€
`https://{your.domain.com}/example`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€
ã¡ã‚ƒã‚“ã¨ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

:::message
Lambda@Edgeï¼ˆã‚ªãƒªã‚¸ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰ãŒãªãã¦ã‚‚ã€
`https://{your.domain.com}`ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
ãã®ãŸã‚ã€ã‚ãˆã¦`/example`ã®ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦Lambda@EdgeãŒå¿…è¦ãªã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
:::



## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ç¢ºèª

[ã“ã®ã‚µã‚¤ãƒˆ](https://observatory.mozilla.org/)ã«ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é…ä¿¡æ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é …ç›®ã®ç¢ºèªãŒã§ãã¾ã™ã€‚

ä»Šå›ä½œæˆã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã®å…¥åŠ›ã—ã¦ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã™ã‚‹ã¨5åˆ†ã»ã©ã§çµæœãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚
ã‚¹ã‚³ã‚¢ã¯`A+`ã«ã§ãã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/5461e5d01f8b-20230115.png)

ãƒ†ã‚¹ãƒˆã‚¹ã‚³ã‚¢ã®å„é …ç›®ã®è©³ç´°ã«é–¢ã—ã¦ã¯ã€MDNã®ã‚µã‚¤ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

# ãŠã‚ã‚Šã«

CDKã‚’ä½¿ã£ã¦Next.jsã‚’S3+CloudFrontã®æ§‹æˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã—ãŸã€‚
ã“ã®æ§‹æˆã‚’åˆ©ç”¨ã™ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¬‰ã—ã„ã§ã™ã€‚

# å‚è€ƒ

- [Next.jsã§Strict CSPã‚’å®Ÿç¾ã™ã‚‹](https://kotamat.com/post/nextjs-strict-csp/)
- [Next.js ã‚’ S3 + CloudFront ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹](https://zenn.dev/hamo/articles/0a96c4d27097bd)
- [ã‚ªãƒªã‚¸ãƒ³ã‚¢ã‚¯ã‚»ã‚¹ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ (OAI) ã‚’ä½¿ç”¨ã—ã¦ Amazon S3 ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã™ã‚‹](https://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/private-content-restricting-access-to-s3.html)
- [index.html ã‚’è¿½åŠ ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å«ã¾ãªã„ URL ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹](https://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/example-function-add-index.html)
- [S3ã¨CloudFrontã§webã‚µã‚¤ãƒˆã‚’å…¬é–‹ã™ã‚‹éš›ã®ãƒã‚±ãƒƒãƒˆè¨­å®šã¯ã©ã†ã™ã¹ãã‹ï¼Ÿ](https://horizoon.jp/post/2021/09/05/s3_website_hosting/)
- [[AWS CDK]S3 CloudFront OAI Route53 æ§‹æˆ ã§ NextJSã®SSGé…ä¿¡ç’°å¢ƒæ§‹ç¯‰](https://tech-blog.s-yoshiki.com/entry/274)
