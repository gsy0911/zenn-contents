---
title: "SAM CLIを試してみた"
emoji: "💨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["AWS", "CDK"]
published: false
---

:::message alert
本内容はパブリックプレビュー版です。今後の更新で変更があるかもしれません。
:::


# はじめに

ある日、TLをぼんやり眺めているとこんな記事が流れて来ました。

https://twitter.com/_kensh/status/1387972711855525892?s=20

初めてみたときは、`AWS SAM`に目がいってあまり気にしていませんでした。
よくみてみると、これからAWSを触っていくにあたってすごく気になることが書かれていました。

# アツい内容

何がすごいのかは、[元記事](https://aws.amazon.com/jp/blogs/compute/better-together-aws-sam-and-aws-cdk/) のこの文に詰まっています。

>  Before today, you could use the AWS SAM CLI to build locally, test, and package serverless applications defined using AWS CloudFormation or AWS SAM templates. With this preview release, you can use AWS SAM CLI to build, test, and in the future, package applications defined using the AWS CDK.

AWS CDKで構築したAWSのサーバーレスサービス群を、AWS SAMを利用してローカルで色々できるみたいです！

私は今まで、AWS CDKを利用していたのですが、AWS側にデプロイする用途でしか利用できず、ローカルでのテストや実行ができていませんでした。
そのほかの有名なパッケージ、`terraform`ならローカルでのテストも確かできたと思うのですが、yaml形式で記述しなければならず、私は苦手でした。
加えて公式ではないため、（公式に匹敵するくらい有名・利用されているのは知っていますが）あまり利用に気が進みませんでした。

# 試してみる

:::message alert
（再掲）本内容はパブリックプレビュー版です。今後の更新で変更があるかもしれません。
:::

上記のページにもサンプルはありますが、自力でもろもろやってみようかと思います。

## 準備・インストール・環境設定

[このページ](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-cdk.html) を参考に必要なパッケージを入れていきます。

必要なツールは以下の3つです。

- [AWS CLI](https://aws.amazon.com/cli/)
- [AWS CDK](https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html)
- [AWS SAM CLI - beta](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-cdk.html)

私の環境・バージョンは次の通りです。

- OS: macOS Big Sur (11.3), intel
- AWS CLI: aws-cli/2.2.3 Python/3.9.5 Darwin/20.4.0 source/x86_64 prompt/off
- AWS CDK: 1.102.0 (build a75d52f)
- AWS SAM: SAM CLI, version 1.23.0

CLIとCDKはあらかじめ入っていたので、`AWS SAM CLI - beta`のみbrewにて入れていきます。
また、その前にSAMも必要なので[ここ](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install-mac.html) を参考に入れていきます。


```shell
$ brew install aws-sam-cli-beta-cdk
######################################################################## 100.0%
==> Pouring aws-sam-cli-beta-cdk-202104291816.sierra.bottle.tar.gz
🍺  /usr/local/Cellar/aws-sam-cli-beta-cdk/202104291816: 3,951 files, 82.4MB

$ sam-beta-cdk --version
SAM CLI, version 1.22.0.dev202104291816
```

これで全ての準備が整いました。

## CDK Stackの作成

`sam-beta-cdk`のインストールが終わったら、CDKのStackを作成します。

ファイル構成は以下の通りです。
主なファイルのみこの記事には載せますので詳細は以下に載せるリポジトリを参考にしてください。

```shell
.
├── sam-example  # コマンド実行場所
│   ├── README.md
│   ├── cdk.json
│   └── index.ts
└── stacks
    ├── SamExample.ts # CDKでLambdaを記述
    ├── index.ts
    └── lambda
        └── sam_example # lambda functionを保持
            ├── lambda_function.py
            ├── requirements.txt
            └── utils.py

```

リポジトリです。

https://github.com/gsy0911/aws-cdk-ts-small-examples

### SamExample.ts

今回は、LambdaとAPI Gatewayのサービスを利用するようにしました。

- Lambda関数名：LambdaFunction
- API Gateway: GET /sample

```typescript
import * as cdk from "@aws-cdk/core";
import * as iam from '@aws-cdk/aws-iam';
import * as lambda from '@aws-cdk/aws-lambda';
import * as apigw from "@aws-cdk/aws-apigateway";
import { PythonFunction } from '@aws-cdk/aws-lambda-python';

export interface ISamExample {
  S3Path: string
}


export class SamExample extends cdk.Stack {
  constructor(scope: cdk.Construct, id: string, params: ISamExample, props?: cdk.StackProps) {
    super(scope, id, props);

    /** lambda role */
    const role = new iam.Role(this, 'lambdaRole', {
      assumedBy: new iam.ServicePrincipal('lambda.amazonaws.com')
    })
    role.addManagedPolicy(iam.ManagedPolicy.fromManagedPolicyArn(this, 'CloudWatchLogsAccess', 'arn:aws:iam::aws:policy/CloudWatchFullAccess'))

    /** note: when you use the stack, configure the entry path */
    const lambdaSimpleResponse = new PythonFunction(this, 'LambdaFunction', {
      functionName: "simple_response",
      entry: '../stacks/lambda/sam_example',
      index: 'lambda_function.py',
      handler: 'handler',
      runtime: lambda.Runtime.PYTHON_3_8,
      role: role,
      environment: {
        S3_PATH: params.S3Path
      }
    })

    const api = new apigw.LambdaRestApi(this, 'sample_api', {
      handler: lambdaSimpleResponse,
      proxy: false
    });

    const items = api.root.addResource('sample');
    items.addMethod('GET');
  }
}

```

## ローカル実行

```shell
$ sam-beta-cdk local invoke --project-type CDK SamExampleStack/LambdaFunction
Synthesizing CDK App
Invoking lambda_function.handler (python3.8)
Failed to download a new amazon/aws-sam-cli-emulation-image-python3.8:rapid-1.22.0.dev202104291816 image. Invoking with the already downloaded image.
Mounting /Users/yoshiki/Development/Projects/aws-cdk-ts-small-examples/typescript/sam-example/.aws-sam/.cdk-out/asset.fd201469c9cd087ed2f5e86224bde9c4be5383f4ce718a425a0aa8b98db0f36a as /var/task:ro,delegated inside runtime container
END RequestId: 106b4af6-94a2-496a-906c-2632efe22f6d
REPORT RequestId: 106b4af6-94a2-496a-906c-2632efe22f6d  Init Duration: 0.14 ms	Duration: 96.61 ms	Billed Duration: 100 ms	Memory Size: 128 MB	Max Memory Used: 128 MB
{"statusCode": 200, "body": "{\"status\": \"success\", \"from\": \"SAM CLI\", \"s3\": \"s3://sam-example/lambda/...\"}"}

```


## AWSへのデプロイ

今回は、CDKを利用しているので、わざわざSAMを介する必要はないのですが
一応できるみたいなのでやってみました。

```shell
# SAMプロジェクトとしてビルド
$ sam-beta-cdk build --project-type CDK

# SAMでビルドしたものをデプロイ
$ cdk deploy -a .aws-sam/build

# SAMでビルドしたものをデストロイ
$ cdk destroy -a .aws-sam/build

```