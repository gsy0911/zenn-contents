---
title: "Caddyã®å‹•ä½œç¢ºèªã¨CORSï¼ˆFastAPIã¨Next.jsã‚’æ·»ãˆã¦ï¼‰"
emoji: "ğŸ·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["caddy", "fastapi", "nextjs", "sse"]
published: false
---

# ã¯ã˜ã‚ã«

https://caddyserver.com/

https://developer.mozilla.org/ja/docs/Web/HTTP/CORS

# ç’°å¢ƒ

ä»Šå›ã®ç’°å¢ƒã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- macOS: 14.5
- Python: 3.12.4
- Node.js: v20.15.1
- Next.js: 14.2.5
- Docker Desktop: 4.32.0 (157355)

# äº‹å‰æº–å‚™

Caddyã®å‹•ä½œç¢ºèªã‚’ã™ã‚‹ãŸã‚ã«ã€ç°¡å˜ãªãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒå¿…è¦ãªã®ã§ãã‚Œãã‚ŒNext.jsã¨FastAPIã§æº–å‚™ã—ã¦ã„ãã¾ã™ã€‚

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆFastAPIï¼‰ã®æº–å‚™

ä»Šå›ã¯poetryã§ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚ä»¥ä¸‹ã®`pyproject.toml`ã¨`Dockerfile`ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```toml: pyproject.toml
[tool.poetry]
name = "caddy-fastapi-nextjs"
version = "0.1.0"
description = ""
authors = [""]

[tool.poetry.dependencies]
python = ">=3.10,<3.13"
mangum = "^0.17.0"
fastapi = "^0.111.1"
uvicorn = {extras = ["standard"], version = "^0.30.3"}
gunicorn = "^22.0.0"
sse-starlette = "^2.1.2"
```

Dockerfileã¯`poetry`ã‹ã‚‰`requirements.txt`ã‚’ç”Ÿæˆã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚srcãªã©ã¯

```Dockerfile: /backend/Dockerfile
FROM python:3.12 as local

WORKDIR /opt/app/src
RUN pip install -U pip poetry==1.8.3
COPY pyproject.toml .
COPY poetry.lock .

RUN poetry export --without-hashes --only main --output requirements.txt
RUN pip install -r requirements.txt

CMD ["uvicorn", "main:app", "--reload", "--host=0.0.0.0", "--port=8080"]
```

æ¬¡ã«ã€GETã¨POSTã ã‘ã§ãã‚‹ã‚ˆã†ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚æœ€å¾Œã®è¡Œã§`prefix="/api/v1"`ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã®ã¯ã€å¾Œè¿°ã™ã‚‹caddyã§ã®ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã§æŒ‡å®šã™ã‚‹ãŸã‚ã«`/api`ã‚’ä»˜ä¸ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```python: /backend/src/main.py
from logging import INFO, getLogger
import os

from fastapi import APIRouter, FastAPI, Header
from sse_starlette.sse import EventSourceResponse

app = FastAPI()
api_router = APIRouter()

logger = getLogger()
logger.setLevel(INFO)

__all__ = ["app"]


@api_router.get("/user")
def get_user():
    return {"status": "success"}


@api_router.post("/user")
def post_user():
    return {"status": "success"}


@api_router.patch("/user")
def patch_user():
    return {"status": "success"}
    

app.include_router(router=api_router, prefix="/api/v1")
```

æœ€å¾Œã«`compose.yaml`ã‚’ä½œæˆã—ã¾ã™ã€‚FastAPIã§ã€ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ãŒåŠ¹ãã‚ˆã†ã«volumesã‚’`"./backend/src:/opt/app/src"`ã§ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚åŠ ãˆã¦ã€ä»Šå›ã¯M1 Macã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ã€`platform: linux/amd64`ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚`ports`ã¯ç‰¹ã«ç†ç”±ã¯ãªã„ã§ã™ãŒã€next.jsãŒ3000ç•ªã§å‹•ãã®ã§ã€`3080`ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

```yaml: /compose.yaml
services:

  backend:
    build:
      context: .
      dockerfile: ./backend/Dockerfile
      target: local
    container_name: backend
    platform: linux/amd64
    tty: true
    ports:
      - "3080:8080"
    volumes:
      - "./backend/src:/opt/app/src"

```

ä½œæˆã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å©ã„ã¦ã€ä»¥ä¸‹ã®çµæœãŒè¿”ã£ã¦ããŸã‚‰ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æº–å‚™ã¯å®Œäº†ã§ã™ã€‚

```shell: ç¢ºèª
$ curl -X GET http://localhost:3080/api/v1/user
{"status":"success"}

$ curl -X POST http://localhost:3080/api/v1/user
{"status":"success"}

$ curl -X PATCH http://localhost:3080/api/v1/user
{"status":"success"}
```

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆNext.jsï¼‰ã®æº–å‚™

ãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹ã«ã¦ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å©ã„ã¦`frontend`ã¨ã„ã†ã‚¢ãƒ—ãƒªåã§åˆæœŸåŒ–ã‚’é€²ã‚ã¾ã™ã€‚

```shell
$ npx create-next-app@latest
What is your project named? frontend
ï¼ˆçœç•¥ï¼‰
```

ã¾ãšæœ€åˆã«ã€`/frontend/app/globals.css`ã®ä¸­èº«ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã€‚
æ¬¡ã«`/frontend/app/page.tsx`ã‚’æ¬¡ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```typescript jsx: /frontend/app/page.tsx
import { ClientComponent } from "./client-component";

export default function Home() {
  return (
    <main>
      <h1>test</h1>
      <ClientComponent/>
    </main>
  );
}
```

ãã—ã¦ã€`/frontend/app/client-component.tsx`ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®æ“ä½œã‚’å—ã‘ä»˜ã‘ã‚‹ãƒœã‚¿ãƒ³ãªã©ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ä¸€æ—¦è¡¨ç¤ºç¢ºèªã ã‘ãŒã§ããŸã‚‰ã„ã„ã®ã§ã€`button`ã¨å®Ÿè¡Œã™ã‚‹é–¢æ•°ã®ã¿ç©ºã§å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

```typescript jsx: /frontend/app/client-component.tsx
"use client"

export const ClientComponent = () => {
  const getHandler = async () => {
    const response = await fetch("http://localhost:3080/api/v1/user", {
      method: "GET",
    })
    console.log(response)
  }
  const postHandler = async () => {
    const response = await fetch("http://localhost:3080/api/v1/user", {
      method: "POST",
    })
    console.log(response)
  }
  return (
    <>
      <button onClick={getHandler}>GET</button>
      <button onClick={postHandler}>POST</button>
    </>
  )
}
```

httpsã§èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«`package.json`ã‚’ä¸€éƒ¨ä¿®æ­£ã—ã¾ã™ã€‚


```diff json: package.json
{
  "name": "frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
-   "dev": "next dev",
+   "dev": "next dev --experimental-https",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  ï¼ˆå¾Œç•¥ï¼‰
}
```

`/frontend`ã«ã¦ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‚‰ã€`https://localhost:3000/` ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

```shell: ç¢ºèª
$ npm run dev
```

ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æº–å‚™ã¯å®Œäº†ã—ã¾ã—ãŸã€‚

![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_01.png =600x)
*ä½œæˆã—ãŸãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ç”»é¢*

æ¬¡ã«ä½œæˆã—ãŸãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã¦æŒ™å‹•ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚æœ€åˆã«GETãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœã«ãªã‚Šã¾ã™ã€‚

![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_02.png =600x)
*GETãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*

GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚‚CORSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«`Same Origin Policy`ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€`Preflight`ã¯ç™ºç”Ÿã›ãšã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚

https://zenn.dev/tm35/articles/ad05d8605588bd
https://developer.mozilla.org/ja/docs/Web/HTTP/CORS
https://developer.mozilla.org/ja/docs/Web/Security/Same-origin_policy

ã¾ãŸã€POSTã§ã‚‚åŒæ§˜ã®ã“ã¨ãŒèµ·ãã¾ã™ã€‚

![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_03.png =600x)
*POSTãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*

Caddyã‚’è¨­å®šã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼å´ã«CORSã®å¯¾å¿œã‚’å®Ÿæ–½ã—ã¦ã„ãã¾ã™ã€‚

# Caddyã®è¨­å®š


`/caddy`ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ–°è¦ã«ä½œæˆã—ã¦ã€ãã“ã§Caddyã®è¨­å®šã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚

https://dev.classmethod.jp/articles/tried-https-access-with-mkcert-x-nextjs/

```shell: è¨¼æ˜æ›¸ã®ä½œæˆ
$ mkcert "localhost"
```

`{$CADDY_HOSTING_SITE_ADDRESS}`ã¯CaddyãŒç¨¼åƒã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®šã—ã€`${API_SERVER_ADDRESS}`ã¯ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã§é€šã™å…ˆã‚’æŒ‡å®šã—ã¾ã™ã€‚ãƒ‘ã‚¹åãŒ`/api/*`ä»¥ä¸‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’FastAPIå´ã«æµã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ä»Šå›ã¯ãã‚Œãã‚Œä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

* `CADDY_HOSTING_SITE_ADDRESS=https://localhost:3443`: ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹
* `API_SERVER_ADDRESS=backend:8080`: `compose.yaml`ã§ã®FastAPIã®ã‚³ãƒ³ãƒ†ãƒŠåã¨ãƒãƒ¼ãƒˆ


```txt: /caddy/Caddifile
{$CADDY_HOSTING_SITE_ADDRESS} {
    tls ./localhost.pem ./localhost-key.pem
    reverse_proxy /api/* {$API_SERVER_ADDRESS}
}
```

æ¬¡ã«Caddyã®Dockerfileã‚’ä½œæˆã—ã¾ã™ã€‚

```Dockerfile: /caddy/Dockerfile
FROM caddy:latest

COPY localhost.pem .
COPY localhost-key.pem .
CMD ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--watch"]
```

ä¸Šè¨˜ã®Dockerfileã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã«ã€`compose.yaml`ã‚’æ¬¡ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚environmentã«ä¸Šè¨˜ã§`Caddyfile`ã§æŒ‡å®šã—ãŸç’°å¢ƒå¤‰æ•°ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€`Caddyfile`ã¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã“ã¨ã§ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ãŒåŠ¹ãã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```diff yaml: compose.yaml
services:

+ caddy:
+   container_name: caddy
+   build:
+     context: ./caddy
+   restart: unless-stopped
+   environment:
+     CADDY_HOSTING_SITE_ADDRESS: "https://localhost:3443"
+     API_SERVER_ADDRESS: "backend:8080"
+   volumes:
+     - "./caddy/Caddyfile:/etc/caddy/Caddyfile:ro"
+   ports:
+     - "3443:3443"
  backend:
    build:
      context: .
      dockerfile: ./backend/Dockerfile
      target: local
    container_name: backend
    platform: linux/amd64
    tty: true
    ports:
      - "3080:8080"
    volumes:
      - "./backend/src:/opt/app/src"
```

ä¸Šè¨˜ã®è¨­å®šãŒçµ‚ã‚ã£ãŸã‚‰ã€å†ã³Dockerã‚’èµ·å‹•ã—ã¦ç–é€šç¢ºèªã‚’ã—ã¾ã™ã€‚caddyã§è¨­å®šã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹`https://localhost:3443/` ã‚’æŒ‡å®šã—ã€`/api/*`ä»¥ä¸‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãŸã‚FastAPIå´ã«æµã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚FastAPIã§ã¯`/api/v1/user`ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¦ã„ã‚‹ãŸã‚ã€å‡¦ç†ãŒå®Ÿè¡Œã§ãã¾ã™ã€‚

```shell: ç¢ºèª
$ curl -X GET https://localhost:3443/api/v1/user
{"status":"success"}

$ curl -X POST https://localhost:3443/api/v1/user
{"status":"success"}
```

curlã§ã®ç–é€šç¢ºèªãŒçµ‚ã‚ã£ãŸã‚‰ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«URLã‚’æ›¸ãæ›ãˆã¦å®Ÿè¡Œã™ã‚‹ã¨å†ã³CORSã‚¨ãƒ©ãƒ¼ã§æ€’ã‚‰ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

```diff typescript jsx: /frontend/app/client-component.tsx
"use client"

export const ClientComponent = () => {
  const getHandler = async () => {
-   const response = await fetch("http://localhost:3080/api/v1/user", { 
+   const response = await fetch("https://localhost:3443/api/v1/user", {
      method: "GET",
    })
    console.log(response)
  }
  const postHandler = async () => {
-   const response = await fetch("http://localhost:3080/api/v1/user", {
+   const response = await fetch("https://localhost:3443/api/v1/user", {
      method: "POST",
    })
    console.log(response)
  }
  return (
    <>
      <button onClick={getHandler}>GET</button>
      <button onClick={postHandler}>POST</button>
    </>
  )
}
```

![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_04.png =600x)
*å¤‰æ›´å¾Œã®GETãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*


![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_05.png =600x)
*å¤‰æ›´å¾Œã®POSTãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*


# Caddyã§CORSã®è¨­å®š

ä»¥ä¸‹ã®Gistã«ä¾‹ãŒã‚ã‚Šã¾ã™ãŒã€æœ€æ–°ã®Caddyã ã¨å‹•ã‹ãªã„ã®ã§ä¿®æ­£ã—ã¾ã™ã€‚

https://gist.github.com/ryanburnette/d13575c9ced201e73f8169d3a793c1a3

```diff txt: Caddyfile
+(cors) {
+       @cors_preflight{args[0]} method OPTIONS
+       @cors{args[0]} header Origin {args[0]}
+
+       handle @cors_preflight{args[0]} {
+               header {
+                       Access-Control-Allow-Credentials "true"
+                       Access-Control-Allow-Origin "{args[0]}"
+                       Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
+                       Access-Control-Allow-Headers "Origin, Referer, User-Agent, Authorization, Accept, Content-Type, Access-Control-Request-Methods, Access-Control-Request-Origin"
+                       Access-Control-Max-Age "1800"
+                       defer
+               }
+               respond "" 204
+       }
+
+       handle @cors{args[0]} {
+               header {
+                       Access-Control-Allow-Credentials "true"
+                       Access-Control-Allow-Origin "{args[0]}"
+                       Access-Control-Allow-Headers "Origin, Referer, User-Agent, Authorization, Accept, Content-Type, Access-Control-Request-Methods, Access-Control-Request-Origin"
+                       defer
+               }
+       }
+}

{$CADDY_HOSTING_SITE_ADDRESS} {
    tls ./localhost.pem ./localhost-key.pem
+   import cors https://localhost:3000
    reverse_proxy /api/* {$API_SERVER_SITE_ADDRESS}
}
```

![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_06.png =600x)
*CORSè¨­å®šå¾Œã«GETãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*


![](/images/caddy_fastapi_nextjs/caddy_fastapi_nextjs_07.png =600x)
*CORSè¨­å®šå¾Œã«POSTãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*


# ãã®ä»–ã®å‚è€ƒ

https://medium.com/@devahmedshendy/traditional-setup-run-local-development-over-https-using-caddy-964884e75232


