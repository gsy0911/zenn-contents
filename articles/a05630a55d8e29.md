---
title: "【NextAuth.js】cognitoで複数のサードパーティプロバイダを使った時にsignInで直接ソーシャルログイン画面に遷移する"
emoji: "🤖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["nextauth", "nextjs", "cognito"]
published: false
---

# はじめに



```typescript: somefile.tsx
import { signIn } from "next-auth/react";

(...省略)

<Button
  onClick={() => signIn("cognito")}
>
  Google
</Button>
```


![](/images/nextauth_cognito/nextauth_cognito_03.png =600x)

:::message
NextAuth.jsは現在Auth.jsに変わろうとしています。
これから利用する場合には`Auth.js`の方を選んだ方が良いかもしれないです。
:::

# 解決方法①

**前提**: Cognitoの単一のアプリケーションクライアントに、複数のサードパーティプロバイダを登録している場合

![](/images/nextauth_cognito/nextauth_cognito_01.png =600x)


以下のように、`signIn`の第三引数に以下のように設定すればいけます。

```typescript: somefile.tsx
import { signIn } from "next-auth/react";

(...省略)

<Button
  onClick={() => signIn("cognito", {}, { identity_provider: "Google" })}
>
  Google
</Button>
```

# 解決方法②

**前提**: Cognitoの単一のアプリケーションクライアントに、単一のサードパーティプロバイダを登録して、複数のアプリケーションクライアントを運用している場合

![](/images/nextauth_cognito/nextauth_cognito_02.png =600x)


以下のように`[...nextauth].ts`ファイルに複数の`CognitoProvider`を登録し、
引数の`id`の部分がそれぞれユニークになるように設定します。

```typescript: /pages/api/auth/[...nextauth].ts
import CognitoProvider from "next-auth/providers/cognito";

const defaultCognitoProvider = CognitoProvider({
  id: "cognito",
  clientId: process.env.COGNITO_CLIENT_ID,
  clientSecret: process.env.COGNITO_CLIENT_SECRET,
  issuer: process.env.COGNITO_ISSUER,
  checks: "nonce",
});

const googleCcognitoProvider = CognitoProvider({
  id: "cognito-google",
  clientId: process.env.COGNITO_GOOGLE_CLIENT_ID,
  clientSecret: process.env.COGNITO_GOOGLE_CLIENT_SECRET,
  issuer: process.env.COGNITO_ISSUER,
  checks: "nonce",
});

```

その上で、`signIn`関数の引数に上で設定した`id`を指定すると対応するクライアントが実行されます。

```typescript: somefile.tsx
import { signIn } from "next-auth/react";

(...省略)

<Button
  onClick={() => signIn("cognito")}
>
  default
</Button>

(...中略)

<Button
  onClick={() => signIn("cognito-google")}
>
  default
</Button>
```


# ①と②とで選んだ方がいい方

どちらでも同じことが実現できるのですが、おすすめなのは①の方法です。
理由としてはアプリケーションクライアントが1つになりシンプルになるためです。
単一のアプリケーションのみを動かす場合には①が良いと思います。

②がおすすめとなる場合としては、同じCognitoのユーザープールを使いつつ、
複数のアプリケーションを運用する場合などですかね・・・？
あまり思いつかないです。

本題とは関係ないですが、アクセストークンの更新やサインアウトを実装することも考えると
①の方が良いかなとは思います。それぞれ以下の記事が参考になります。

- アクセストークンの更新

https://mseeeen.msen.jp/nextauth-cognito-token-refresh/

- サインアウトの挙動

https://mseeeen.msen.jp/logout-cognito-session-with-nextauth/

# おわりに

複数のアプリケーションクライアントを指定した時の
CognitoProvider周りのドキュメントが存在せず（調べた限りですが・・・）
結構苦労したので誰かのお役に立てれば幸いです。


# 結局うまくいかなかったが実施したこと

::: details cognitoのClientへのURLを直接実行する

以下のようなURLをボタンに設定して遷移するなど試したのですが、
NextAuth側のトークン取得などがうまくいかずに断念しました。
（あまりガッツリ試していないので、URLの設定とかが間違っているかもですが・・・。）

```typescript
const googleLoginUrl = `${process.env.NEXT_PUBLIC_COGNITO_ENDPOINT}/oauth2/authorize?identity_provider=Google&redirect_uri=${host}/api/auth/callback/cognito&response_type=CODE&client_id=${clientId}&scope=${scope}`;
```

参考

https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/logout-endpoint.html
:::