---
title: "【NextAuth.js】Next.jsのPages RouterをCloudFrontとAPI Gatewayで稼働させる"
emoji: "💨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["nextauth", "nextjs", "cloudfront", "apigateway", "awscdk"]
published: false
---

## はじめに / やりたいこと

Next.js(Pages Router)でNextAuth.jsを使ってログインができるアプリを、
CloudFrontとAPI Gateway上へデプロイします。

Pages Routerでは、動的処理を提供するAPI Routesは`/api`以下で動くようになっています。
`/api`以外のページや、`SSR`をしない場合は、静的コンテンツとして出力することが可能です。

そのため静的コンテンツをCloudFrontで配信して、
動的部分の`/api`以下をAPI Gateway + Lambdaを使って稼働させることを目指します。

参考にしたのは以下の記事です。
参考記事中では、動的部分をAppRunnerを使っていますがやりたいことは同じです。

https://dev.classmethod.jp/articles/nextjs-static-cache/

:::message
記事を書いておいてなんですが、ここまでゴニョゴニョするなら、
Amplifyとかを使ったほうが幸せになれる気もします・・・！
:::

:::message
なおApp Routerでも同じことを試したのですが現時点では動作確認とれてないです。
:::

## 対象読者

- Next.jsのPages Routerを使ってフロントエンドを構築している
- VercelやNetfilyではなくAWSのCloudFrontなどへデプロイを検討している
- NextAuth.jsや、`/pages/api`以下の領域を利用している

## 構成

以下が今回作成するサービスの構成図です。

![](/images/nextjs_nextauthjs_cognito_4/nextjs_nextauthjs_cognito_4_1.png =600x)

上述のように、動的処理をする`/api/*`以下はAPI Gatewayに処理を流して、
それ以外の静的なコンテンツはS3からCloudFrontを経由して配信するようにしています。

## デプロイ環境

- macOS: 14.1
- Next.js: 13.4
- Node.js: 18.16
- AWS CDK: 2.105.0
- Mantine: 6.0.20

# コード

コードは以下のリポジトリにおいてあります。
本記事では紹介できない箇所もあるので、デプロイする際にはぜひご覧ください。

https://github.com/gsy0911/zenn-nextjs-authjs-cognito/tree/v4.0

## フロントエンドの準備

動的処理と静的コンテンツをビルドできるように、ファイルを以下のようにしておきます。

```json: package.json
  "scripts": {
    "build:standalone": "ENV=production OUTPUT=standalone next build",
    "build:export": "ENV=production OUTPUT=export next build",
  },
```

```js: next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  trailingSlash: true,
  output: process.env.OUTPUT
}

module.exports = nextConfig
```

こうしておくことで、以下のコマンドで動的処理に対応したビルドを、

```shell
$ npm run build:standalone
```

以下のコマンドで静的コンテンツを出力するビルドを実行できます。

```shell
$ npm run build:export
```


### 動的処理のためのDocker作成

まずはAPI Gateway + Lambdaで動かすためにDockerfileを作成します。
以下のサイトを参考にLambdaで動くようにします。

https://qiita.com/Nozomuts/items/b3a4fd57d0413d5d3437

```Dockerfile
# ref: https://qiita.com/Nozomuts/items/b3a4fd57d0413d5d3437
FROM node:18 AS builder

WORKDIR /app

COPY ./frontend/zenn/package.json ./
COPY ./frontend/zenn/package-lock.json ./
RUN npm ci
COPY ./frontend/zenn ./
RUN npm run build:standalone

FROM node:18-slim AS runner
# これを挟むことでLambdaで動かせるようになる。
COPY --from=public.ecr.aws/awsguru/aws-lambda-adapter:0.7.1 /lambda-adapter /opt/extensions/lambda-adapter
# この値はDockerなら必須のためここで固定
ENV PORT=3000
WORKDIR /app

# public と .next/static は nextjs の standalone を使う場合に含まれないため、コピーする必要がある
# https://nextjs.org/docs/advanced-features/output-file-tracing#automatically-copying-traced-files
# builderから必要なファイルだけコピーする
COPY --from=builder /app/next.config.js ./
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/.next/standalone ./

# `next start` の代わりに `node server.js` を使用
# https://nextjs.org/docs/advanced-features/output-file-tracing#automatically-copying-traced-files
CMD ["node", "server.js"]
```

このファイルを元に、Dockerイメージを作成してECRへpushしておきます。

### 静的コンテンツのビルドとデプロイ

静的コンテンツはビルド後にS3に以下のコマンドでアップロードします。

```shell
# ディレクトリは/frontend/zenn以下
$ aws s3 sync out s3://{S3_BUCKET_NAME}
```

これで前準備は完了です。

## インフラの構築

今回もCDKを使ってインフラを構築します。


# おわりに

