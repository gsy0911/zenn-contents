---
title: "ã€NextAuth.jsã€‘Next.jsã®Pages Routerã‚’CloudFrontã¨API Gatewayã§ç¨¼åƒã•ã›ã‚‹"
emoji: "ğŸ’¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextauth", "nextjs", "cloudfront", "apigateway", "awscdk"]
published: false
---

## ã¯ã˜ã‚ã« / ã‚„ã‚ŠãŸã„ã“ã¨

Next.js(Pages Router)ã§NextAuth.jsã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ãŒã§ãã‚‹ã‚¢ãƒ—ãƒªã‚’ã€
CloudFrontã¨API Gatewayä¸Šã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
NextAuth.jsã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã‚¢ãƒ—ãƒªã¯ã€ä»¥ä¸‹ã®æ‹™ä½œã®è¨˜äº‹ã®ã‚‚ã®ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

https://zenn.dev/gsy0911/articles/0e271401b8e5c2

Pages Routerã§ã¯ã€å‹•çš„å‡¦ç†ã‚’æä¾›ã™ã‚‹API Routesã¯`/api`ä»¥ä¸‹ã§å‹•ãã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
`/api`ä»¥å¤–ã®ãƒšãƒ¼ã‚¸ã‚„ã€`SSR`ã‚’ã—ãªã„å ´åˆã¯ã€é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

ãã®ãŸã‚é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’CloudFrontã§é…ä¿¡ã—ã¦ã€
å‹•çš„éƒ¨åˆ†ã®`/api`ä»¥ä¸‹ã‚’API Gateway + Lambdaã‚’ä½¿ã£ã¦ç¨¼åƒã•ã›ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

å‚è€ƒã«ã—ãŸã®ã¯ä»¥ä¸‹ã®è¨˜äº‹ã§ã™ã€‚
å‚è€ƒè¨˜äº‹ä¸­ã§ã¯ã€å‹•çš„éƒ¨åˆ†ã‚’AppRunnerã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒã‚„ã‚ŠãŸã„ã“ã¨ã¯åŒã˜ã§ã™ã€‚

https://dev.classmethod.jp/articles/nextjs-static-cache/

:::message
è¨˜äº‹ã‚’æ›¸ã„ã¦ãŠã„ã¦ãªã‚“ã§ã™ãŒã€ã“ã“ã¾ã§ã‚´ãƒ‹ãƒ§ã‚´ãƒ‹ãƒ§ã™ã‚‹ãªã‚‰ã€
Amplifyã¨ã‹ã‚’ä½¿ã£ãŸã»ã†ãŒå¹¸ã›ã«ãªã‚Œã‚‹æ°—ã‚‚ã—ã¾ã™ãƒ»ãƒ»ãƒ»ï¼
:::

:::message
ãªãŠApp Routerã§ã‚‚åŒã˜ã“ã¨ã‚’è©¦ã—ãŸã®ã§ã™ãŒç¾æ™‚ç‚¹ã§ã¯å‹•ä½œç¢ºèªã¨ã‚Œã¦ãªã„ã§ã™ã€‚
:::

## å¯¾è±¡èª­è€…

- Next.jsã®Pages Routerã‚’ä½¿ã£ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’æ§‹ç¯‰ã—ã¦ã„ã‚‹
- Vercelã‚„Netfilyã§ã¯ãªãAWSã®CloudFrontãªã©ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ¤œè¨ã—ã¦ã„ã‚‹
- NextAuth.jsã‚„ã€`/pages/api`ä»¥ä¸‹ã®é ˜åŸŸã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹

## æ§‹æˆ

ä»¥ä¸‹ãŒä»Šå›ä½œæˆã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®æ§‹æˆå›³ã§ã™ã€‚

![](/images/nextjs_nextauthjs_cognito_4/nextjs_nextauthjs_cognito_4_1.png =600x)

ä¸Šè¿°ã®ã‚ˆã†ã«ã€å‹•çš„å‡¦ç†ã‚’ã™ã‚‹`/api/*`ä»¥ä¸‹ã¯API Gatewayã«å‡¦ç†ã‚’æµã—ã¦ã€
ãã‚Œä»¥å¤–ã®é™çš„ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯S3ã‹ã‚‰CloudFrontã‚’çµŒç”±ã—ã¦é…ä¿¡ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

## ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ

- macOS: 14.1
- Next.js: 13.4
- Node.js: 18.16
- AWS CDK: 2.105.0
- Mantine: 6.0.20

# ã‚³ãƒ¼ãƒ‰

ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ãŠã„ã¦ã‚ã‚Šã¾ã™ã€‚
æœ¬è¨˜äº‹ã§ã¯ç´¹ä»‹ã§ããªã„ç®‡æ‰€ã‚‚ã‚ã‚‹ã®ã§ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã«ã¯ãœã²ã”è¦§ãã ã•ã„ã€‚

https://github.com/gsy0911/zenn-nextjs-authjs-cognito/tree/v4.0

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æº–å‚™

å‹•çš„å‡¦ç†ã¨é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ“ãƒ«ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

```json: package.json
  "scripts": {
    "build:standalone": "ENV=production OUTPUT=standalone next build",
    "build:export": "ENV=production OUTPUT=export next build",
  },
```

```js: next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  trailingSlash: true,
  output: process.env.OUTPUT
}

module.exports = nextConfig
```

ã“ã†ã—ã¦ãŠãã“ã¨ã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å‹•çš„å‡¦ç†ã«å¯¾å¿œã—ãŸãƒ“ãƒ«ãƒ‰ã‚’ã€

```shell
$ npm run build:standalone
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å‡ºåŠ›ã™ã‚‹ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

```shell
$ npm run build:export
```


### å‹•çš„å‡¦ç†ã®ãŸã‚ã®Dockerä½œæˆ

ã¾ãšã¯API Gateway + Lambdaã§å‹•ã‹ã™ãŸã‚ã«Dockerfileã‚’ä½œæˆã—ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆã‚’å‚è€ƒã—ãŸDockerfileã‚’ç·¨é›†ã—ã¦Lambdaã§å‹•ãã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

https://qiita.com/Nozomuts/items/b3a4fd57d0413d5d3437

```Dockerfile
# ref: https://qiita.com/Nozomuts/items/b3a4fd57d0413d5d3437
FROM node:18 AS builder

WORKDIR /app

COPY ./frontend/zenn/package.json ./
COPY ./frontend/zenn/package-lock.json ./
RUN npm ci
COPY ./frontend/zenn ./
RUN npm run build:standalone

FROM node:18-slim AS runner
# ã“ã‚Œã‚’æŒŸã‚€ã“ã¨ã§Lambdaã§å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
COPY --from=public.ecr.aws/awsguru/aws-lambda-adapter:0.7.1 /lambda-adapter /opt/extensions/lambda-adapter
# ã“ã®å€¤ã¯Dockerãªã‚‰å¿…é ˆã®ãŸã‚ã“ã“ã§å›ºå®š
ENV PORT=3000
WORKDIR /app

# public ã¨ .next/static ã¯ nextjs ã® standalone ã‚’ä½¿ã†å ´åˆã«å«ã¾ã‚Œãªã„ãŸã‚ã€ã‚³ãƒ”ãƒ¼ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
# https://nextjs.org/docs/advanced-features/output-file-tracing#automatically-copying-traced-files
# builderã‹ã‚‰å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã‚³ãƒ”ãƒ¼ã™ã‚‹
COPY --from=builder /app/next.config.js ./
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/.next/standalone ./

# `next start` ã®ä»£ã‚ã‚Šã« `node server.js` ã‚’ä½¿ç”¨
# https://nextjs.org/docs/advanced-features/output-file-tracing#automatically-copying-traced-files
CMD ["node", "server.js"]
```

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ƒã«ã€Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ECRã¸pushã—ã¦ãŠãã¾ã™ã€‚

### é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤

é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ãƒ“ãƒ«ãƒ‰å¾Œã«S3ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

```shell
# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯/frontend/zennã§å®Ÿè¡Œã™ã‚‹
$ aws s3 sync out s3://{S3_BUCKET_NAME}
```

ã“ã‚Œã§å‰æº–å‚™ã¯å®Œäº†ã§ã™ã€‚

## ã‚¤ãƒ³ãƒ•ãƒ©ã®æ§‹ç¯‰

ä»Šå›ã‚‚CDKã‚’ä½¿ã£ã¦ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

1ã¤ã®Stackã§CloudFrontã¨API Gatewayã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚
API Gatewayã®ä½œæˆã¨ã€CloudFrontã®ã‚ªãƒªã‚¸ãƒ³ã¸ã®ç™»éŒ²ã‚’åŒæ™‚ã«ã—ã¦è¦‹é€šã—ã‚’ã‚ˆãã™ã‚‹ãŸã‚ã§ã™ã€‚

ãƒã‚¤ãƒ³ãƒˆã¨ãªã‚‹ç®‡æ‰€ã‚’æŠœãå‡ºã—ã¦èª¬æ˜ã—ã¾ã™ã€‚

::::details Frontend.tsã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’è¦‹ãŸã„å ´åˆã¯ã“ã¡ã‚‰ã‚’é–‹ã„ã¦ãã ã•ã„

ãã®ã»ã‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãŸã„å ´åˆã¯ã€ãƒªãƒã‚¸ãƒˆãƒªã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

```typescript: Frontend.ts
import {
  aws_certificatemanager as acm,
  aws_cloudfront,
  aws_cloudfront_origins,
  aws_ecr,
  aws_iam,
  aws_lambda,
  aws_route53,
  aws_route53_targets,
  aws_s3,
  aws_ssm,
  Duration,
  Stack,
  StackProps,
} from "aws-cdk-lib";
import { Construct } from "constructs";
import { HttpLambdaIntegration } from "@aws-cdk/aws-apigatewayv2-integrations-alpha";
import {
  DomainName,
  EndpointType,
  HttpApi,
} from "@aws-cdk/aws-apigatewayv2-alpha";
import {
  IFrontendEnvironment,
  prefix,
  ssmParameterEdgeName,
} from "./constants";

export interface IFrontend {
  ecr: {
    repositoryArn: `arn:aws:ecr:ap-northeast-1:${string}:repository/${string}`;
  };
  apigw: {
    certificate: `arn:aws:acm:ap-northeast-1:${string}:certificate/${string}`;
    route53DomainName: string;
    route53RecordName: string;
  };
  lambda: {
    environment: { [key: string]: string } & IFrontendEnvironment;
  };
  s3: {
    bucketName: string;
  };
  cloudfront: {
    certificate: `arn:aws:acm:us-east-1:${string}:certificate/${string}`;
    route53DomainName: string;
    route53RecordName: string;
    cachePolicyIdForApigw: `${string}-${string}-${string}-${string}-${string}`
  };
}

export class Frontend extends Stack {
  constructor(
    scope: Construct,
    id: string,
    params: IFrontend,
    props: StackProps,
  ) {
    super(scope, id, props);

    const ecrRepositoryFrontend = aws_ecr.Repository.fromRepositoryArn(
      this,
      "frontend",
      params.ecr.repositoryArn,
    );
    const role = new aws_iam.Role(this, "lambdaRole", {
      roleName: `${prefix}-lambda-frontend-role`,
      assumedBy: new aws_iam.ServicePrincipal("lambda.amazonaws.com"),
      managedPolicies: [
        aws_iam.ManagedPolicy.fromManagedPolicyArn(
          this,
          "lambdaRoleCwFullAccess",
          "arn:aws:iam::aws:policy/CloudWatchFullAccessV2",
        ),
        aws_iam.ManagedPolicy.fromManagedPolicyArn(
          this,
          "lambdaRoleCognitoPowerAccess",
          "arn:aws:iam::aws:policy/AmazonCognitoPowerUser",
        ),
      ],
    });

    // Next.js standaloneã‚’å‹•ã‹ã™Lambdaã®å®šç¾©
    const handler = new aws_lambda.DockerImageFunction(this, "Handler", {
      functionName: `${prefix}-frontend-endpoint`,
      code: aws_lambda.DockerImageCode.fromEcr(ecrRepositoryFrontend),
      memorySize: 1024,
      timeout: Duration.seconds(30),
      environment: params.lambda.environment,
      architecture: aws_lambda.Architecture.ARM_64,
      retryAttempts: 0,
      role,
    });

    // ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã®è¨­å®š
    const apigwCustomDomainName = new DomainName(this, "CustomDomain", {
      certificate: acm.Certificate.fromCertificateArn(
        this,
        "Certificate",
        params.apigw.certificate,
      ),
      domainName: params.apigw.route53RecordName,
      endpointType: EndpointType.REGIONAL,
    });
    // Route 53 for api-gw
    const hostedZone = aws_route53.HostedZone.fromLookup(
      this,
      "apigw-hosted-zone",
      {
        domainName: params.apigw.route53DomainName,
      },
    );
    new aws_route53.ARecord(this, "SampleARecord", {
      zone: hostedZone,
      recordName: params.apigw.route53RecordName,
      target: aws_route53.RecordTarget.fromAlias(
        new aws_route53_targets.ApiGatewayv2DomainProperties(
          apigwCustomDomainName.regionalDomainName,
          apigwCustomDomainName.regionalHostedZoneId,
        ),
      ),
    });

    // Amazon API Gateway HTTP APIã®å®šç¾©
    new HttpApi(this, "Api", {
      apiName: `${prefix}-frontend`,
      defaultIntegration: new HttpLambdaIntegration("Integration", handler),
      defaultDomainMapping: {
        domainName: apigwCustomDomainName,
      },
      disableExecuteApiEndpoint: true,
    });

    const s3Bucket = aws_s3.Bucket.fromBucketName(
      this,
      "sourceS3",
      params.s3.bucketName,
    );

    const s3Origin = new aws_cloudfront_origins.S3Origin(s3Bucket);
    const nextCompatibilitySsm = ssmParameterEdgeName({
      cfType: "origin-request",
      id: "nextCompatibility",
    });
    const nextCompatibilityParam =
      aws_ssm.StringParameter.fromStringParameterAttributes(
        this,
        "nextCompatibilitySsmParam",
        {
          parameterName: nextCompatibilitySsm,
        },
      ).stringValue;
    const nextCompatibilityVersion = aws_lambda.Version.fromVersionArn(
      this,
      "nextCompatibilityVersion",
      nextCompatibilityParam,
    );

    const distribution = new aws_cloudfront.Distribution(
      this,
      "frontend-distribution",
      {
        defaultBehavior: {
          origin: s3Origin,
          edgeLambdas: [
            {
              functionVersion: nextCompatibilityVersion,
              eventType: aws_cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
            },
          ],
          viewerProtocolPolicy:
            aws_cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
        },
        additionalBehaviors: {
          "/api/*": {
            origin: new aws_cloudfront_origins.HttpOrigin(
              params.apigw.route53RecordName,
            ),
            allowedMethods: aws_cloudfront.AllowedMethods.ALLOW_ALL,
            viewerProtocolPolicy:
              aws_cloudfront.ViewerProtocolPolicy.HTTPS_ONLY,
            // ãƒã‚¤ãƒ³ãƒˆï¼šç‰¹å®šã®Headerã®ã¿è¨±å¯ã—ãªã„ã¨ã€ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
            // see: https://oji-cloud.net/2020/12/07/post-5752/
            originRequestPolicy: new aws_cloudfront.OriginRequestPolicy(
              this,
              "apigw-orp",
              {
                originRequestPolicyName: `${prefix}-apigw-orp`,
                headerBehavior:
                  aws_cloudfront.OriginRequestHeaderBehavior.allowList(
                    "Accept",
                    "Accept-Language",
                  ),
                cookieBehavior:
                  aws_cloudfront.OriginRequestCookieBehavior.all(),
                queryStringBehavior:
                  aws_cloudfront.OriginRequestQueryStringBehavior.all(),
              },
            ),
            // ãƒã‚¤ãƒ³ãƒˆï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ãªã„ã¨ã€ç•°ãªã‚‹ç«¯æœ«ã‹ã‚‰ã‚‚å˜ä¸€ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã—ã¾ã†
            cachePolicy: aws_cloudfront.CachePolicy.fromCachePolicyId(
              this,
              "apigw-cp",
              params.cloudfront.cachePolicyIdForApigw,
            ),
          },
        },
        defaultRootObject: "index.html",
        certificate: acm.Certificate.fromCertificateArn(
          this,
          "certificate-cloudfront",
          params.cloudfront.certificate,
        ),
        domainNames: [params.cloudfront.route53RecordName],
        sslSupportMethod: aws_cloudfront.SSLMethod.SNI,
        minimumProtocolVersion:
          aws_cloudfront.SecurityPolicyProtocol.TLS_V1_2_2021,
      },
    );
    // Route 53 for cloudfront
    const cloudfrontHostedZone = aws_route53.HostedZone.fromLookup(
      this,
      "cloudfront-hosted-zone",
      {
        domainName: params.cloudfront.route53DomainName,
      },
    );
    new aws_route53.ARecord(this, "cloudfront-a-record", {
      zone: cloudfrontHostedZone,
      recordName: params.cloudfront.route53RecordName,
      target: aws_route53.RecordTarget.fromAlias(
        new aws_route53_targets.CloudFrontTarget(distribution),
      ),
    });
  }
}
```
::::


standaloneãƒ¢ãƒ¼ãƒ‰ã§Next.jsã‚’å‹•ã‹ã™Lambdaã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
Lambdaã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ARMã«ã—ã¦ã„ã‚‹ã®ã¯ã€M1 Macã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚
åŠ ãˆã¦Cognitoã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ãªã®ã§æ¨©é™ã‚’ä»˜ä¸ã—ã¦ã„ã¾ã™ã€‚
ï¼ˆå®Ÿéš›ã«åˆ©ç”¨ã™ã‚‹éš›ã«ã¯Cognitoã¸ã®æ¨©é™ã¯çµã£ãŸæ–¹ãŒå®‰å…¨ã§ã™ã€‚ï¼‰

```typescript: Frontend.tsï¼ˆä¸€éƒ¨ï¼‰
ï¼ˆå‰ç•¥ï¼‰
    const ecrRepositoryFrontend = aws_ecr.Repository.fromRepositoryArn(
      this,
      "frontend",
      params.ecr.repositoryArn,
    );
    const role = new aws_iam.Role(this, "lambdaRole", {
      roleName: `${prefix}-lambda-frontend-role`,
      assumedBy: new aws_iam.ServicePrincipal("lambda.amazonaws.com"),
      managedPolicies: [
        aws_iam.ManagedPolicy.fromManagedPolicyArn(
          this,
          "lambdaRoleCwFullAccess",
          "arn:aws:iam::aws:policy/CloudWatchFullAccessV2",
        ),
        aws_iam.ManagedPolicy.fromManagedPolicyArn(
          this,
          "lambdaRoleCognitoPowerAccess",
          "arn:aws:iam::aws:policy/AmazonCognitoPowerUser",
        ),
      ],
    });

    // Next.js standaloneã‚’å‹•ã‹ã™Lambdaã®å®šç¾©
    const handler = new aws_lambda.DockerImageFunction(this, "Handler", {
      functionName: `${prefix}-frontend-endpoint`,
      code: aws_lambda.DockerImageCode.fromEcr(ecrRepositoryFrontend),
      memorySize: 1024,
      timeout: Duration.seconds(30),
      environment: params.lambda.environment,
      architecture: aws_lambda.Architecture.ARM_64,
      retryAttempts: 0,
      role,
    });
ï¼ˆå¾Œç•¥ï¼‰
```

æ¬¡ã«ã€CloudFrontã®è¨­å®šã§ã™ã€‚
`additionalBehaviors`ã«è¨­å®šã—ã¦ã„ã‚‹å†…å®¹ãŒå¤§äº‹ãªã®ã§ãã‚Œä»¥å¤–ã®ã‚³ãƒ¼ãƒ‰ã¯çœç•¥ã—ã¦ã„ã¾ã™ã€‚

`originRequestPolicy`ã§ç‰¹å®šã®Headerã®ã¿ã‚’é€šã™ã‚ˆã†ã«ã—ã¦ã€cookieã¯å…¨ã¦é€šã™ã‚ˆã†ã«ã—ã¾ã™ã€‚
ã“ã®è¨­å®šã‚’ã—ãªã„ã¨ã€API Gatewayã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¸æ­£ãªã‚‚ã®ã¨è¦‹ãªã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚
åŠ ãˆã¦ã€AWSãŒã‚ã‚‰ã‹ã˜ã‚ç”¨æ„ã—ã¦ã„ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å…¨ã¦ã—ãªã„`cachePolicy`ã‚’ä»˜ä¸ã—ã¾ã™ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã ã¨APIãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã—ã¾ã„ã€ç•°ãªã‚‹ç«¯æœ«ã‹ã‚‰ã§ã‚‚å˜ä¸€ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã—ã¾ã†ãŸã‚ã§ã™ã€‚

```typescript: Frontend.tsï¼ˆä¸€éƒ¨ï¼‰
ï¼ˆå‰ç•¥ï¼‰
    const distribution = new aws_cloudfront.Distribution(
      this,
      "frontend-distribution",
      {
        defaultBehavior: {
          ï¼ˆçœç•¥ï¼‰
        },
        additionalBehaviors: {
          "/api/*": {
            origin: new aws_cloudfront_origins.HttpOrigin(
              params.apigw.route53RecordName,
            ),
            allowedMethods: aws_cloudfront.AllowedMethods.ALLOW_ALL,
            viewerProtocolPolicy:
              aws_cloudfront.ViewerProtocolPolicy.HTTPS_ONLY,
            // ãƒã‚¤ãƒ³ãƒˆï¼šç‰¹å®šã®Headerã®ã¿è¨±å¯ã—ãªã„ã¨ã€ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
            // see: https://oji-cloud.net/2020/12/07/post-5752/
            originRequestPolicy: new aws_cloudfront.OriginRequestPolicy(
              this,
              "apigw-orp",
              {
                originRequestPolicyName: `${prefix}-apigw-orp`,
                headerBehavior:
                  aws_cloudfront.OriginRequestHeaderBehavior.allowList(
                    "Accept",
                    "Accept-Language",
                  ),
                cookieBehavior:
                  aws_cloudfront.OriginRequestCookieBehavior.all(),
                queryStringBehavior:
                  aws_cloudfront.OriginRequestQueryStringBehavior.all(),
              },
            ),
            // ãƒã‚¤ãƒ³ãƒˆï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ãªã„ã¨ã€ç•°ãªã‚‹ç«¯æœ«ã‹ã‚‰ã‚‚å˜ä¸€ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã—ã¾ã†
            cachePolicy: aws_cloudfront.CachePolicy.fromCachePolicyId(
              this,
              "apigw-cp",
              params.cloudfront.cachePolicyIdForApigw,
            ),
          },
        },
        ï¼ˆçœç•¥ï¼‰
      },
    );
  }
}
```

ã“ã®å†…å®¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚Œã°Next.jsã®Pages Routerã‚’
CloudFront + API Gatewayã§å‹•ã‹ã™ã“ã¨ãŒã§ãã¾ã™ï¼

# ãŠã‚ã‚Šã«

å®Ÿéš›ã«å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ãªã‚‹ã¾ã§ã«ã¯ã€æ„å¤–ã¨è‹¦åŠ´ã—ã¾ã—ãŸã€‚
ãŸã ã€`originRequestPolicy`ã¨`cachePolicy`ã•ãˆè¨­å®šã™ã‚Œã°ã‚ã£ã•ã‚Šå‹•ãã¾ã—ãŸã€‚

App RouterãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã€
Pages Routerã§ã®ã“ã®ä»•çµ„ã¿ã¯ä»Šå¾Œä½¿ãˆã‚‹ã‹ã‚ã‹ã‚Šã¾ã›ã‚“ãŒã€èª°ã‹ã®å‚è€ƒã«ãªã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

