---
title: "Cognitoã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆ"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["cognito", "python", "boto3"]
published: false
---

# ã¯ã˜ã‚ã«

Cognitoã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’ã¾ã¨ã‚ã¦å–å¾—ã—ãŸã„ã¨ãã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿãƒãƒƒãƒˆã§æ¤œç´¢ã™ã‚‹ã¨ã¡ã‚‰ã»ã‚‰ã¨å‡ºã¦ãã¾ã™ãŒã€Generatorã§å®Ÿè£…ã—ãŸã‚‚ã®ãŒãªã‹ã£ãŸã®ã§å‚™å¿˜éŒ²çš„ã«æ®‹ã—ã¦ãŠãã¾ã™ã€‚

# ã‚³ãƒ¼ãƒ‰

ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ã€`PagenationToken`ãŒ1å›ç›®ã®ãªã„å ´åˆã¨2å›ç›®ä»¥é™ã®ã‚ã‚‹å ´åˆã¨ã§åˆ†ã‘ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ãã—ã¦ã€å¾—ã‚‰ã‚ŒãŸCognitoã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çµæœã‚’`yield`ã—ã¦ã„ã¾ã™ã€‚ä¸€å¿œã®æ³¨æ„ç‚¹ã¨ã—ã¦ã€Python3.8ã‹ã‚‰å°å…¥ã•ã‚ŒãŸã‚»ã‚¤ã‚¦ãƒæ¼”ç®—å­`:=`ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

```python
from typing import Generator, List
import boto3

client = boto3.client('cognito-idp')


def cognito_list_all_users(user_pool_id: str) -> Generator[List[dict], None, None]:
    # 1å›ç›®ã®å–å¾—
    # å¿…ãšPaginationTokenãŒç„¡ã„ãŸã‚
    res = client.list_users(
        UserPoolId=user_pool_id
    )
    yield res["Users"]
    
    while pagination_token := res.get("PaginationToken"):
        # 2å›ç›®ä»¥é™ã®å–å¾—
        res = client.list_users(
            UserPoolId=user_pool_id,
            PaginationToken=pagination_token
        )
        yield res["Users"]
```

ä¸Šè¨˜ã®é–¢æ•°ã‚’åˆ©ç”¨ã™ã‚‹ã¨ãã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```python
for u in cognito_list_all_users("ap-northeast-1_..."):
    print(len(u))
```

# ãŠã‚ã‚Šã«

ãŸã¾ã€œã«ã€Cognitoã«å­˜åœ¨ã™ã‚‹å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ãŒå¿…è¦ã«ãªã‚Šéƒ½åº¦ä½œæˆã¨ã‹ã—ã¦ã„ã¾ã—ãŸã€‚ãã‚ŒãŒåœ°å‘³ã«é¢å€’ãªã®ã§è¨˜äº‹ã¨ã—ã¦ã¾ã¨ã‚ã¾ã—ãŸã€‚

å‚™å¿˜éŒ²çš„ãªå´é¢ãŒå¼·ã„ã§ã™ãŒèª°ã‹ã®å½¹ã«ç«‹ã¦ã°å¬‰ã—ã„ã§ã™ã€‚

# è£œè¶³

ChatGPT4ã‚’ä½¿ã£ã¦ã€ä»¥ä¸‹ã®é †åºã§ã‚³ãƒ¼ãƒ‰ã®ä½œæˆã‚’ãŠé¡˜ã„ã—ã¦ã¿ã¾ã—ãŸã€‚

1. ã€ŒAWSã®cognitoã®ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¸€è¦§ã™ã‚‹é–¢æ•°ã‚’Pythonã§boto3ã‚’ä½¿ã£ã¦å‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã€ 
2. ã€Œå…¨ä»¶ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã‚‚æ›¸ã„ã¦ã€
3. ã€ŒPythonã®ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ã£ãŸé–¢æ•°ã«å¤‰æ›´ã—ã¦ã€
4. ã€Œä¸Šè¨˜ã®å†…å®¹ã«ã•ã‚‰ã«ã€whileæ–‡ã®ã¨ã“ã‚ã§ã‚»ã‚¤ã‚¦ãƒæ¼”ç®—å­ã‚’ä½¿ã£ã¦æ›¸ãç›´ã—ã¦ã€

:::: details 1å›ç›®ã®çµæœ

å…¨ä»¶ã®å–å¾—ã‚’è€ƒæ…®ã§ãã¦ãªã„

```python
import boto3

# Cognitoã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
client = boto3.client('cognito-idp')

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã®IDã‚’è¨­å®š
user_pool_id = 'your-user-pool-id'

def list_users():
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§ã‚’å–å¾—
    try:
        response = client.list_users(UserPoolId=user_pool_id)
        return response['Users']
    except client.exceptions.ClientError as e:
        print(f"An error occurred: {e}")
        return None

# é–¢æ•°ã‚’å®Ÿè¡Œã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§ã‚’å–å¾—
users = list_users()
if users is not None:
    for user in users:
        print(user)
```
::::


:::: details 2å›ç›®ã®çµæœ

ã“ã‚Œã ã‘ã§ã‚‚ã»ã¨ã‚“ã©ä½¿ãˆã‚‹ã‘ã‚Œã©ã€é–¢æ•°ã®æœ€å¾Œã«ã¾ã¨ã‚ã¦çµæœãŒè¿”ã£ã¦ãã‚‹ã®ã§ä»¶æ•°ãŒå¤šããªã‚‹ã¨ã¡ã‚‡ã£ã¨å¤§å¤‰ãªã“ã¨ã«ãªã‚Šãã†ã€‚ãƒãƒƒãƒˆã§æ¤œç´¢ã™ã‚‹ã¨ã“ã®ã‚¿ã‚¤ãƒ—ã®å–å¾—æ–¹æ³•ãŒå‡ºã¦ãã‚‹ã€‚

```python
import boto3

# Cognitoã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
client = boto3.client('cognito-idp')

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã®IDã‚’è¨­å®š
user_pool_id = 'your-user-pool-id'

def list_all_users():
    # å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆ
    all_users = []

    # æœ€åˆã®ãƒšãƒ¼ã‚¸ã‚’å–å¾—
    try:
        response = client.list_users(UserPoolId=user_pool_id)
        all_users.extend(response['Users'])

        # æ®‹ã‚Šã®ãƒšãƒ¼ã‚¸ã‚’å–å¾—
        while 'PaginationToken' in response:
            response = client.list_users(UserPoolId=user_pool_id, PaginationToken=response['PaginationToken'])
            all_users.extend(response['Users'])
    except client.exceptions.ClientError as e:
        print(f"An error occurred: {e}")
        return None

    return all_users

# é–¢æ•°ã‚’å®Ÿè¡Œã—ã¦å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
users = list_all_users()
if users is not None:
    for user in users:
        print(user)
```
::::

:::: details 3å›ç›®ã®çµæœ

`client.list_users()`ã®å‡¦ç†ãŒä¸­ã§åˆ†å²ã•ã‚Œã¦ãŠã‚Šã€whileæ–‡ã®ä¸­ã§æ¯å›è©•ä¾¡ã™ã‚‹ã®ãŒä½™åˆ†ã€‚

```python
import boto3

# Cognitoã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
client = boto3.client('cognito-idp')

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã®IDã‚’è¨­å®š
user_pool_id = 'your-user-pool-id'

def list_users_generator():
    # ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã®åˆæœŸåŒ–
    pagination_token = None

    while True:
        # ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
        if pagination_token:
            response = client.list_users(UserPoolId=user_pool_id, PaginationToken=pagination_token)
        else:
            response = client.list_users(UserPoolId=user_pool_id)

        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’yieldã§è¿”ã™
        for user in response.get('Users', []):
            yield user

        # æ¬¡ã®ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        pagination_token = response.get('PaginationToken')
        if not pagination_token:
            break

# ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
for user in list_users_generator():
    print(user)
```
::::

```python
# 4å›ç›®ã®çµæœ
import boto3

# Cognitoã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
client = boto3.client('cognito-idp')

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã®IDã‚’è¨­å®š
user_pool_id = 'your-user-pool-id'

def list_users_generator():
    pagination_token = None

    while True:
        # ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã—ã€æ¬¡ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°æ›´æ–°
        response = client.list_users(UserPoolId=user_pool_id, PaginationToken=pagination_token) if pagination_token else client.list_users(UserPoolId=user_pool_id)

        for user in response.get('Users', []):
            yield user

        # ã‚»ã‚¤ã‚¦ãƒæ¼”ç®—å­ã‚’ä½¿ç”¨ã—ã¦ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æ›´æ–°
        if not (pagination_token := response.get('PaginationToken')):
            break
```

4å›ç›®ã®çµæœã ã¨ã€è¡Œæ•°ãŒé•·ããªã£ã¦ã—ã¾ã£ã¦ã„ã‚‹ãŸã‚ã€ãƒ‘ãƒƒã¨è¦‹ã§ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹ã‚ã‹ã‚Šã¥ã‚‰ããªã£ã¦ã„ã‚‹æ°—ãŒã—ã¾ã—ãŸã€‚ãŸã ã€ã‚„ã£ã±ã‚Šãƒ¢ãƒƒã‚¯çš„ãªåˆ©ç”¨ã«ã¯æœ€é©ã ãªã¨æ€ã„ã¾ã—ãŸã€‚ï¼ˆä»Šå›è¼‰ã›ãŸã‚³ãƒ¼ãƒ‰ä½œæˆæ™‚ã«ã¯åˆ©ç”¨ã—ã¦ã„ãªã„ã§ã™ãŒãƒ»ãƒ»ãƒ»ã€‚ï¼‰

ä¸€ç™ºã§è¼‰ã›ãŸã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒå‡ºã¦ãã‚Œã‚‹ã¨ã€å¬‰ã—ã„ãªã¨ã„ã†æ€ã„ã‚‚ã‚ã£ã¦è¨˜äº‹ã«ã—ã¦ãŠãã¾ã™ã€‚
