---
title: "streamlitã«cognitoã‚’åˆ©ç”¨ã—ã¦ç°¡å˜ãªãƒ­ã‚°ã‚¤ãƒ³ã‚’ä½œæˆã—ã¦ã¿ã‚‹"
emoji: "ğŸ—‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS", "CDK", "cognito"]
published: false
---

# ã¯ã˜ã‚ã«

ã¿ãªã•ã‚“ã€`streamlit`ã¯åˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ
`pandas`ã‚„`matplotlib`ãªã©ã‚’åˆ©ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã™ã‚‹éš›ã«ã¯ä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«ã§ã™ã‚ˆã­ã€‚

ãã®éš›ã«ã€
ã€Œåºƒãå…¬é–‹ã¯ã—ãŸã„ã‘ã‚Œã©ã€ç‰¹å®šã®æ¨©é™ãªã©ã‚’ã‚µã‚¯ãƒƒã¨ä»˜ä¸ã—ãŸã„ãªã€ã¨æ€ã†ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ

`streamlit`ãã®ã‚‚ã®ã«ã¯èªè¨¼ãªã©ã®æ©Ÿèƒ½ã¯ãªã„ãŸã‚ã€ç‹¬è‡ªã«å®Ÿè£…ã—ãŸã‚Šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãã“ã§ä»Šå›ã¯AWSã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’çµ„ã‚€ã“ã¨ã‚’æƒ³å®šã—ã¦ã€`Cognito`ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒ»èªè¨¼ã®æ©Ÿèƒ½ã‚’æŒãŸã›ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚
ã¾ãŸã€å„ãƒªã‚½ãƒ¼ã‚¹ã¯CDKã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€ä½œæˆã¨å‰Šé™¤ã‚’ç°¡å˜ã«ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

# æ–™é‡‘ãƒ»æ§‹æˆ

## æ§‹æˆ

äº‹å‰ã®æº–å‚™ã¯å¤šå°‘å¿…è¦ã§ã™ãŒã€
ä»Šå›åˆ©ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¯CDKã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã¾ã™ã€‚

Application LoadBalancerã§Cognitoã®èªè¨¼ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
Developerã¯ã‚ã‚‰ã‹ã˜ã‚ã€Cognitoã§ãƒ­ã‚°ã‚¤ãƒ³ç”¨ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãŠãã€
ãã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ãŸã„Userã«é…å¸ƒã—ã¾ã™ã€‚
é…å¸ƒã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿ã§Cognitoã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã®ã§ã€
å®‰å…¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã›ã¤ã¤ãªã©ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/5690cf0cc3d71831b54a0993.png)


## æ–™é‡‘


æ–™é‡‘ã¯ã€åˆ©ç”¨é‡ã«ã‚‚ã‚ˆã£ã¦å¤‰ã‚ã‚‹ã®ã§ã™ãŒã€åˆè¨ˆã§4,000[å††ï¼æœˆ]ç¨‹åº¦ã‹ã‹ã‚‹è¨ˆç®—ã§ã™ã€‚
åŸºæœ¬çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã®é »åº¦ã¯ä½ãã€Fargateã®æ–™é‡‘ã¯`0.5vCPU, 256MiB`ã§è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚
ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ã‹ã‹ã‚‹æ–™é‡‘ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

| AWSã‚µãƒ¼ãƒ“ã‚¹ | æ–™é‡‘[å††ï¼æœˆ] |
|:---:|---:|
| Application LoadBalancer | 2,500 |
| Fargate | 1,100 |
| Cognito | ï¼ˆç„¡æ–™ï¼‰ |

# æº–å‚™


## Route53

äº‹å‰ã«æº–å‚™ãŒå¿…è¦ãªç‰©ã¨ã—ã¦ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿ã§ã™ã€‚
`Route53`ã«åˆ©ç”¨ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç™»éŒ²ã—ã¦ã€ã™ãã«åˆ©ç”¨ã§ãã‚‹çŠ¶æ…‹ã«ã—ã¾ã™ã€‚

ç”»åƒã®ã‚ˆã†ã«ã€NSã‚¿ã‚¤ãƒ—ã¨SOAã‚¿ã‚¤ãƒ—ãŒç™»éŒ²ã•ã‚Œã¦ã„ãŸã‚‰å¤§ä¸ˆå¤«ã§ã™ã€‚
ALBã§ã¯Aã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ ã—ã¦ã€ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã£ãŸéš›ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/4744945960113a78bfc5dacb.png)

ä»Šå›ã¯ä¾‹ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

- å–å¾—ã—ãŸãƒ«ãƒ¼ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³ï¼š `your.domain.com`
- ä»Šå›ä½œæˆã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è¨­å®šã™ã‚‹ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼š `streamlit.your.domain.com`

ç”»åƒã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã¯ã€`streamlit.your.domain.com`ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚


## è¨¼æ˜æ›¸

ã‚ã‚ã›ã¦ã€ä¸Šè¨˜ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«httpsã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¯¾ã—ã¦è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ã¾ã™ã€‚
è¨¼æ˜æ›¸ã®ç™ºè¡Œã¯ã€ã©ã®ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚‚é©ç”¨ã§ãã‚‹`*.your.domain.com`ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
ï¼ˆä¸‹ã®ç”»åƒã®2ã¤ã®é …ç›®ã®ã†ã¡ã€ä¸Šã®`*.`ã‹ã‚‰å§‹ã¾ã£ã¦ã„ã‚‹æ–¹ï¼‰

`Route53`ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€`your.domain.com`ã‚’ç®¡ç†ã—ã¦ã„ã‚‹ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã«å¯¾ã—ã¦
CNAMEã‚¿ã‚¤ãƒ—ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¿½åŠ ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/c280b887c1f408530813fa8d.png)

# ãƒ—ãƒ­ã‚°ãƒ©ãƒ 

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯é©å®œè¼‰ã›ã¾ã™ãŒã€è©³ç´°ã¯ãƒªãƒã‚¸ãƒˆãƒªã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- [zenn-streamlit-cognito](https://github.com/gsy0911/zenn-streamlit-cognito)

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

`infra/`ãƒ•ã‚©ãƒ«ãƒ€ã«ã¦ã€CDKã®ã‚½ãƒ¼ã‚¹ç®¡ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
`streamlit/`ãƒ•ã‚©ãƒ«ãƒ€ã«ã¦ã€Fargateä¸Šã§ç¨¼åƒã•ã›ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Dockerã§è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚

```shell
root
â”œâ”€â”€ infra/
â”‚  â”œâ”€â”€ cdk.context.json
â”‚  â”œâ”€â”€ cdk.json
â”‚  â”œâ”€â”€ cdk.out
â”‚  â”œâ”€â”€ index.ts
â”‚  â”œâ”€â”€ params.ts
â”‚  â”œâ”€â”€ paramsExample.ts
â”‚  â”œâ”€â”€ README.md
â”‚  â””â”€â”€ StreamlitEcsFargateStack.ts
â”œâ”€â”€ streamlit/
â”‚  â”œâ”€â”€ app.py
â”‚  â”œâ”€â”€ config.toml
â”‚  â”œâ”€â”€ Dockerfile
â”‚  â””â”€â”€ Makefile
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â””â”€â”€ tsconfig.json
```

## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

streamlitã®ã‚³ãƒ¼ãƒ‰è§£èª¬ã¯ã—ãªã„ã§ã™ã€‚
CDKã§ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã«ã¤ã„ã¦ã®ã¿ã¡ã‚‡ã£ã¨è¦‹ã¦ã„ãã¾ã™ã€‚

### Cognitoãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆ

Cognitoã®è¨­å®šã‚’ã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è©³ã—ã„å†…å®¹ã¯[CDKãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/cdk/api/latest/docs/@aws-cdk_aws-cognito.UserPool.html)ã‚’ã”è¦§ãã ã•ã„ã€‚

ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®2ç‚¹ã§ã™ã€‚

- `selfSignUpEnabled=false`
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™»éŒ²ã‚’é˜²ã„ã§ã„ã‚‹
- `removalPolicy=cdk.RemovalPolicy.DESTROY`
    - ã“ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‰Šé™¤ã—ãŸéš›ã«ç™»éŒ²å†…å®¹ã”ã¨Cognitoã‚’å‰Šé™¤ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹

```typescript:StreamlitEcsFargateStack.ts
/* ~~å‰ç•¥~~ */

const userPool = new cognito.UserPool(this, "userPool", {
    userPoolName: "streamlit-user-pool-test",
    // self signUp disabled
    selfSignUpEnabled: false,
    userVerification: {
        emailSubject: "Verify email message",
        emailBody: "Thanks for signing up! Your verification code is {####}",
        emailStyle: cognito.VerificationEmailStyle.CODE,
        smsMessage: "Thanks for signing up! Your verification code is {####}"
    },
    // sign in
    signInAliases: {
        username: true,
        email: true
    },
    // user attributes
    standardAttributes: {
        nickname: {
            required: true,
            // `mutable` means changeable
            mutable: true
        }
    },
    // role, specify if you want
    mfa: cognito.Mfa.OPTIONAL,
    mfaSecondFactor: {
        sms: true,
        otp: true
    },
    passwordPolicy: {
        minLength: 8,
        requireLowercase: true,
        requireUppercase: true,
        requireDigits: true,
        requireSymbols: true,
        tempPasswordValidity: cdk.Duration.days(3)
    },
    accountRecovery: cognito.AccountRecovery.EMAIL_ONLY,
    removalPolicy: cdk.RemovalPolicy.DESTROY,
    // emails, by default `no-reply@verificationemail.com` used
})

/* ~~å¾Œç•¥~~ */

```

### ALBã«Cognitoèªè¨¼ã®ä»˜ä¸

ã“ã“ã§ã¯ã€ALBã«Cognitoèªè¨¼ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚
ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- Fargateã¨ALBã«è¨­å®šã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ã‚ãˆã¦ä½œæˆãƒ»è¨­å®šã—ã¦ã„ã‚‹
    - ALBã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã«443ã®egressã‚’è¨±å¯ã™ã‚‹ãŸã‚
- ALBã®listenerã«Cognitoã®èªè¨¼ã‚’åŠ ãˆã¦ã„ã‚‹
    - å…¨ã¦ã®PathPatternã«å¯¾ã—ã¦èªè¨¼ã‚’åŠ ãˆã¦ã„ã‚‹

```typescript:StreamlitEcsFargateStack.ts
/* ~~å‰ç•¥~~ */

const ecsServiceSecurityGroup = new ec2.SecurityGroup(this, "ecs-service-sg", {
    vpc,
    securityGroupName: "streamlit-service-sg",
    description: "security group to allow IdP",
})

const service = new ecs.FargateService(this, "StreamlitService", {
    cluster: cluster,
    taskDefinition: taskDef,
    deploymentController: {
        type: ecs.DeploymentControllerType.CODE_DEPLOY
    },
    healthCheckGracePeriod: cdk.Duration.seconds(5),
    assignPublicIp: true,
    securityGroups: [ecsServiceSecurityGroup],
})

// https://<alb-domain>/oauth2/idpresponse
// requires allowing HTTPS egress-rule
const albSecurityGroup = new ec2.SecurityGroup(this, "alb-sg", {
    vpc,
    securityGroupName: "streamlit-alb-sg",
    description: "security group to allow IdP",
    allowAllOutbound: false
})
albSecurityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(80), "allow HTTP")
albSecurityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(8080), "allow alt HTTP")
albSecurityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(443), "allow HTTPS")
albSecurityGroup.addEgressRule(ecsServiceSecurityGroup, ec2.Port.tcp(80), "allow HTTP")
albSecurityGroup.addEgressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(443), "allow HTTPS")
ecsServiceSecurityGroup.addIngressRule(albSecurityGroup, ec2.Port.tcp(80), "allow from alb-HTTP")

const alb = new elb.ApplicationLoadBalancer(this, "ApplicationLoadBalancer", {
    loadBalancerName: "StreamlitALB",
    vpc: vpc,
    idleTimeout: cdk.Duration.seconds(30),
    // scheme: true to access from external internet
    internetFacing: true,
    securityGroup: albSecurityGroup
})

const listenerHttp1 = alb.addListener("listener-https", {
    protocol: elb.ApplicationProtocol.HTTPS,
    certificates: [elb.ListenerCertificate.fromArn(params.alb.certificate)]
})

const targetGroupBlue = listenerHttp1.addTargets("http-blue-target", {
    targetGroupName: "http-blue-target",
    protocol: elb.ApplicationProtocol.HTTP,
    deregistrationDelay: cdk.Duration.seconds(30),
    targets: [service],
    healthCheck: {
        healthyThresholdCount: 2,
        interval: cdk.Duration.seconds(10)
    },
})
listenerHttp1.addAction("cognito-auth-elb-1", {
    action: new elbActions.AuthenticateCognitoAction({
        userPool: userPool,
        userPoolClient: app1,
        userPoolDomain: userPoolDomain,
        scope: "openid",
        onUnauthenticatedRequest: elb.UnauthenticatedAction.AUTHENTICATE,
        next: elb.ListenerAction.forward([targetGroupBlue])
    }),
    conditions: [elb.ListenerCondition.pathPatterns(["*"])],
    priority: 1
})

/* ~~å¾Œç•¥~~ */
```


## ãƒ‡ãƒ—ãƒ­ã‚¤


# ãŠã‚ã‚Šã«

