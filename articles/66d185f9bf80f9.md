---
title: "Doctrineã§MySQLã®Master/Slaveã‚’æ§‹ç¯‰ã™ã‚‹"
emoji: "ğŸŒ½"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["php", "doctrine", "mysql"]
published: true
---

# ã¯ã˜ã‚ã«

`PHP + Symfony + Doctrine`ç’°å¢ƒã§MySQLã®Master/Slaveæ§‹æˆã‚’å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚
`PHP + Symfony + Doctrine`ç’°å¢ƒã¯ä»¥ä¸‹ã®è¨˜äº‹ã§è§£èª¬ã—ãŸç’°å¢ƒã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

https://zenn.dev/gsy0911/articles/ab193f6eba39dc

ã¾ãŸã€Master/Slaveã®è¨­å®šã«é–¢ã—ã¦ã‚‚ä»¥ä¸‹ã®è¨­å®šã‚’ç”¨ã„ã¦ã„ã¾ã™ã€‚

https://zenn.dev/gsy0911/articles/2287b8aa75d706



## ç’°å¢ƒ

- macOS: 13.5
- MySQL: 8.0
- doctrine/orm: ^2.15

# ã‚³ãƒ¼ãƒ‰

æœ¬è¨˜äº‹ã®ã‚³ãƒ¼ãƒ‰ã¯[GitHub](https://github.com/gsy0911/zenn-php-symfony/tree/article3.1)ã«ã‚ã‚Šã¾ã™ã®ã§ã€é©å®œç¢ºèªãã ã•ã„ã€‚


## doctrineã®è¨­å®š

https://www.doctrine-project.org/projects/doctrine-bundle/en/latest/configuration.html

ã‚’å‚è€ƒã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```yaml: backend/src/config/packages/doctrine.yaml
doctrine:
    dbal:
        default_connection: default
        connections:
            default:
                driver: 'pdo_mysql'
                charset: utf8mb4
                default_table_options:
                    charset: utf8mb4
                    collate: utf8mb4_unicode_ci
                url: '%env(resolve:DATABASE_URL)%'
                # Master/Slave configuration
                replicas:
                    slave1:
                        url: '%env(resolve:SLAVE_DATABASE_URL)%'
                        charset: utf8mb4
```

:::message
æ³¨æ„ç‚¹ã¨ã—ã¦ã€ä»¥å‰ã®doctrineã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¨­å®šæ–¹æ³•ã¯`slaves`ã§ã™ãŒã€
å°‘ãªãã¨ã‚‚`doctrine/orm`ãŒ`2.15`ã‚ˆã‚Šã‚‚æ–°ã—ã„å ´åˆã«ã¯ã€`replicas`ã«å¤‰ã‚ã£ã¦ã„ã¾ã™ã€‚
:::

ç’°å¢ƒå¤‰æ•°ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¦ãã ã•ã„

```text: backend/src/env.local
DATABASE_URL="mysql://zenn_master:zenn_master@mysql_master:3306/zenn_db?serverVersion=8"
SLAVE_DATABASE_URL="mysql://zenn_slave:zenn_slave@mysql_slave:3306/zenn_db?serverVersion=8"
```


# å‹•ä½œç¢ºèª

æ–°ã—ãDBã‚’ä½œã‚Šç›´ã—ã¦ã„ã‚‹ã®ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰å®Ÿè¡Œã—ã¾ã™ã€‚

```shell
# phpã®dockerã«å…¥ã£ã¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿæ–½
$ docker compose exec -it php /bin/bash
> symfony console doctrine:migrations:migrate
```

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œäº†ã—ãŸã‚‰API Platformã§bookã®æŒ¿å…¥ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

![](/images/php_symfony_2/php_symfony_2_1.png =600x)

master/slaveã®DBã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```shell
# masterå´ã«å¤‰æ›´ãŒã‚ã£ãŸã‹ç¢ºèª
$ docker exec -it mysql_master mysql -uzenn_master -pzenn_master

mysql> use zenn_db
mysql> select * from book;
Empty set (0.01 sec)

# ã“ã“ã§POSTãªã©ã§æŒ¿å…¥å‡¦ç†ã‚’å®Ÿè¡Œ

mysql> select * from book;
+----+-------+--------+
| id | title | author |
+----+-------+--------+
|  1 | test  | author |
+----+-------+--------+
1 row in set (0.01 sec)

# slaveå´ã§ã‚‚åŒæ§˜ã«å¤‰æ›´ãŒã‚ã£ãŸã‹ç¢ºèªã—ã¾ã™ã€‚
$ docker exec -it mysql_slave mysql -uzenn_slave -pzenn_slave
# ï¼ˆåŒã˜çµæœã®ãŸã‚çœç•¥ï¼‰
```

ã“ã‚Œã§Master/Slaveã®æ§‹ç¯‰ãŒã§ãã¾ã—ãŸã€‚

## Master/Slaveã®æŒ™å‹•ã«ã¤ã„ã¦

è¦‹ã¤ã‘ã‚Œã¦ãªã„ã ã‘ã‹ã‚‚ã§ã™ãŒã€ã‚ã¾ã‚Šå‹•ä½œã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ç„¡ãã€
ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã—ã‹è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚

https://github.com/doctrine/dbal/blob/1d6b35150713ec32021443456b825366297a9cb1/src/Connections/PrimaryReadReplicaConnection.php#L24-L36


> 1. Replica if primary was never picked before and ONLY if 'getWrappedConnection'
 or 'executeQuery' is used.
> 2. Primary picked when 'executeStatement', 'insert', 'delete', 'update', 'createSavepoint',
 'releaseSavepoint', 'beginTransaction', 'rollback', 'commit' or 'prepare' is called.
> 3. If Primary was picked once during the lifetime of the connection it will always get picked afterwards.
> 4. One replica connection is randomly picked ONCE during a request.

å‹•ä½œã¨ã—ã¦ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã¿ãŸã„ã§ã™ã€‚

1. ãƒ¬ãƒ—ãƒªã‚«ï¼ˆSlaveï¼‰ãŒé¸ã°ã‚Œã‚‹ã®ã¯ã€ãƒ—ãƒ©ã‚¤ãƒãƒªï¼ˆMasterï¼‰ãŒç›´å‰ã«é¸æŠã•ã‚Œã¦ãŠã‚‰ãšã€ã‹ã¤`getWrappedConnection`ã‹`executeQuery`ã‚’å®Ÿè¡Œã—ãŸå ´åˆã€‚
2. ãƒ—ãƒ©ã‚¤ãƒãƒªã¯æ›´æ–°ç³»ã®å‡¦ç†ãŒèµ°ã‚‹ã¨é¸æŠã•ã‚Œã‚‹
3. ä¸€åº¦ãƒ—ãƒ©ã‚¤ãƒãƒªãŒé¸æŠã•ã‚Œã‚‹ã¨ã€ä»¥é™ã®æ¥ç¶šã§ã¯å¸¸ã«ãƒ—ãƒ©ã‚¤ãƒãƒªãŒé¸æŠã•ã‚Œã‚‹ã€‚
4. ãƒ¬ãƒ—ãƒªã‚«ã¸ã®æ¥ç¶šã¯ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚Œã‚‹

## replicaã«Masterã‚’è¿½åŠ ã™ã‚‹

ç¾çŠ¶ã®ã¾ã¾ã ã¨ã€SELECTç³»ã®ã‚¯ã‚¨ãƒªã®ã»ã¨ã‚“ã©ã¯Slaveã®DBã«è¡Œã£ã¦ã—ã¾ã„ã¾ã™ã€‚
ãã‚Œã ã¨ã€è² è·åˆ†æ•£ãŒã‚ã¾ã‚Šã§ãã¦ã„ãªã„ãŸã‚Masterã‚’replicaã¨ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
ä»¥ä¸‹ã®3è¡Œã‚’è¿½è¨˜ã™ã‚‹ã“ã¨ã§ã§ãã¾ã™ã€‚


```diff yaml:backend/src/config/packages/doctrine.yaml
doctrine:
    dbal:
        default_connection: default
        connections:
            default:
                driver: 'pdo_mysql'
                charset: utf8mb4
                default_table_options:
                    charset: utf8mb4
                    collate: utf8mb4_unicode_ci
                url: '%env(resolve:DATABASE_URL)%'
                # Master/Slave configuration
                replicas:
                    slave1:
                        url: '%env(resolve:SLAVE_DATABASE_URL)%'
                        charset: utf8mb4
+                   slave2:
+                       url: '%env(resolve:DATABASE_URL)%'
+                       charset: utf8mb4
```

:::message
ã“ã®å ´åˆã€ãƒ©ãƒ³ãƒ€ãƒ ã«slave1ã‹slave2ãŒé¸ã°ã‚Œã€SELECTã®ã‚¯ã‚¨ãƒªãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
:::


## SELECTãŒSlaveã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‹ã®ç¢ºèª

ä¸€å¿œã€SELECTãªã©ã®ã‚¯ã‚¨ãƒªãŒã¡ã‚ƒã‚“ã¨Slaveã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç›´ä¸‹ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã£ã¦`mysql_slave`ã®ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚Šã¾ã™ã€‚

```shell
$ docker compose exec -it mysql_slave /bin/bash
```

API Platformã§bookã®ä¸€è¦§ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
![](/images/php_symfony_2/php_symfony_2_2.png =600x)


Slaveã®ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹ã¨ã€ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚

```shell
# ã‚³ãƒ³ãƒ†ãƒŠå†…ã«ã¦ä»¥ä¸‹ã®ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹
$ cat var/log/mysql-general.log
ï¼ˆå‰ç•¥ï¼‰
2023-08-22T13:57:34.607613Z	  114 Connect	zenn_slave@172.18.0.3 on zenn_db using TCP/IP
2023-08-22T13:57:34.608335Z	  114 Query	SELECT count(b0_.id) AS sclr_0 FROM book b0_
2023-08-22T13:57:34.612539Z	  114 Query	SELECT b0_.id AS id_0, b0_.title AS title_1, b0_.author AS author_2 FROM book b0_ ORDER BY b0_.id ASC LIMIT 30
2023-08-22T13:57:34.615568Z	  114 Quit
```


# ãŠã‚ã‚Šã«

Master/Slaveæ§‹æˆã‚’doctrineã§å®Ÿç¾ã—ã¦ã¿ã¾ã—ãŸã€‚
èª°ã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ï¼
