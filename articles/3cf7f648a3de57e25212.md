---
title: "SAM CLIã‚’è©¦ã—ã¦ã¿ãŸ"
emoji: "ğŸ’¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS", "CDK"]
published: false
---

:::message alert
æœ¬å†…å®¹ã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç‰ˆã§ã™ã€‚ä»Šå¾Œã®æ›´æ–°ã§å¤‰æ›´ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
:::


# ã¯ã˜ã‚ã«

ã‚ã‚‹æ—¥ã€TLã‚’ã¼ã‚“ã‚„ã‚Šçœºã‚ã¦ã„ã‚‹ã¨ã“ã‚“ãªè¨˜äº‹ãŒæµã‚Œã¦æ¥ã¾ã—ãŸã€‚

https://twitter.com/_kensh/status/1387972711855525892?s=20

åˆã‚ã¦ã¿ãŸã¨ãã¯ã€`AWS SAM`ã«ç›®ãŒã„ã£ã¦ã‚ã¾ã‚Šæ°—ã«ã—ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚
ã‚ˆãã¿ã¦ã¿ã‚‹ã¨ã€ã“ã‚Œã‹ã‚‰AWSã‚’è§¦ã£ã¦ã„ãã«ã‚ãŸã£ã¦ã™ã”ãæ°—ã«ãªã‚‹ã“ã¨ãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã—ãŸã€‚

# ã‚¢ãƒ„ã„å†…å®¹

ä½•ãŒã™ã”ã„ã®ã‹ã¯ã€[å…ƒè¨˜äº‹](https://aws.amazon.com/jp/blogs/compute/better-together-aws-sam-and-aws-cdk/) ã®ã“ã®æ–‡ã«è©°ã¾ã£ã¦ã„ã¾ã™ã€‚

>  Before today, you could use the AWS SAM CLI to build locally, test, and package serverless applications defined using AWS CloudFormation or AWS SAM templates. With this preview release, you can use AWS SAM CLI to build, test, and in the future, package applications defined using the AWS CDK.

AWS CDKã§æ§‹ç¯‰ã—ãŸAWSã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ç¾¤ã‚’ã€AWS SAMã‚’åˆ©ç”¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã§è‰²ã€…ã§ãã‚‹ã¿ãŸã„ã§ã™ï¼

ç§ã¯ä»Šã¾ã§ã€AWS CDKã‚’åˆ©ç”¨ã—ã¦ã„ãŸã®ã§ã™ãŒã€AWSå´ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ç”¨é€”ã§ã—ã‹åˆ©ç”¨ã§ããšã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ãƒ†ã‚¹ãƒˆã‚„å®Ÿè¡ŒãŒã§ãã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚
ãã®ã»ã‹ã®æœ‰åãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€`terraform`ãªã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ãƒ†ã‚¹ãƒˆã‚‚ç¢ºã‹ã§ããŸã¨æ€ã†ã®ã§ã™ãŒã€yamlå½¢å¼ã§è¨˜è¿°ã—ãªã‘ã‚Œã°ãªã‚‰ãšã€ç§ã¯è‹¦æ‰‹ã§ã—ãŸã€‚
åŠ ãˆã¦å…¬å¼ã§ã¯ãªã„ãŸã‚ã€ï¼ˆå…¬å¼ã«åŒ¹æ•µã™ã‚‹ãã‚‰ã„æœ‰åãƒ»åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã®ã¯çŸ¥ã£ã¦ã„ã¾ã™ãŒï¼‰ã‚ã¾ã‚Šåˆ©ç”¨ã«æ°—ãŒé€²ã¿ã¾ã›ã‚“ã§ã—ãŸã€‚

# è©¦ã—ã¦ã¿ã‚‹

:::message alert
ï¼ˆå†æ²ï¼‰æœ¬å†…å®¹ã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç‰ˆã§ã™ã€‚ä»Šå¾Œã®æ›´æ–°ã§å¤‰æ›´ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
:::

ä¸Šè¨˜ã®ãƒšãƒ¼ã‚¸ã«ã‚‚ã‚µãƒ³ãƒ—ãƒ«ã¯ã‚ã‚Šã¾ã™ãŒã€è‡ªåŠ›ã§ã‚‚ã‚ã‚‚ã‚ã‚„ã£ã¦ã¿ã‚ˆã†ã‹ã¨æ€ã„ã¾ã™ã€‚

## æº–å‚™ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»ç’°å¢ƒè¨­å®š

[ã“ã®ãƒšãƒ¼ã‚¸](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-cdk.html) ã‚’å‚è€ƒã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å…¥ã‚Œã¦ã„ãã¾ã™ã€‚

å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã¯ä»¥ä¸‹ã®3ã¤ã§ã™ã€‚

- [AWS CLI](https://aws.amazon.com/cli/)
- [AWS CDK](https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html)
- [AWS SAM CLI - beta](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-cdk.html)

ç§ã®ç’°å¢ƒãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

- OS: macOS Big Sur (11.3), intel
- AWS CLI: aws-cli/2.2.3 Python/3.9.5 Darwin/20.4.0 source/x86_64 prompt/off
- AWS CDK: 1.102.0 (build a75d52f)
- AWS SAM: SAM CLI, version 1.23.0

CLIã¨CDKã¯ã‚ã‚‰ã‹ã˜ã‚å…¥ã£ã¦ã„ãŸã®ã§ã€`AWS SAM CLI - beta`ã®ã¿brewã«ã¦å…¥ã‚Œã¦ã„ãã¾ã™ã€‚
ã¾ãŸã€ãã®å‰ã«SAMã‚‚å¿…è¦ãªã®ã§[ã“ã“](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install-mac.html) ã‚’å‚è€ƒã«å…¥ã‚Œã¦ã„ãã¾ã™ã€‚


```shell
$ brew install aws-sam-cli-beta-cdk
######################################################################## 100.0%
==> Pouring aws-sam-cli-beta-cdk-202104291816.sierra.bottle.tar.gz
ğŸº  /usr/local/Cellar/aws-sam-cli-beta-cdk/202104291816: 3,951 files, 82.4MB

$ sam-beta-cdk --version
SAM CLI, version 1.22.0.dev202104291816
```

ã“ã‚Œã§å…¨ã¦ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚

## CDK Stackã®ä½œæˆ

`sam-beta-cdk`ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒçµ‚ã‚ã£ãŸã‚‰ã€CDKã®Stackã‚’ä½œæˆã—ã¾ã™ã€‚

ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
ä¸»ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã“ã®è¨˜äº‹ã«ã¯è¼‰ã›ã¾ã™ã®ã§è©³ç´°ã¯ä»¥ä¸‹ã«è¼‰ã›ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

```shell
.
â”œâ”€â”€ sam-example  # ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå ´æ‰€
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ cdk.json
â”‚Â Â  â””â”€â”€ index.ts
â””â”€â”€ stacks
 Â Â  â”œâ”€â”€ SamExample.ts # CDKã§Lambdaã‚’è¨˜è¿°
 Â Â  â”œâ”€â”€ index.ts
 Â Â  â””â”€â”€ lambda
 Â Â   Â Â  â””â”€â”€ sam_example # lambda functionã‚’ä¿æŒ
 Â Â   Â Â      â”œâ”€â”€ lambda_function.py
 Â Â   Â Â      â”œâ”€â”€ requirements.txt
 Â Â   Â Â      â””â”€â”€ utils.py

```

ãƒªãƒã‚¸ãƒˆãƒªã§ã™ã€‚

https://github.com/gsy0911/aws-cdk-ts-small-examples

### SamExample.ts

ä»Šå›ã¯ã€Lambdaã¨API Gatewayã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

- Lambdaé–¢æ•°åï¼šLambdaFunction
- API Gateway: GET /sample

```typescript
import * as cdk from "@aws-cdk/core";
import * as iam from '@aws-cdk/aws-iam';
import * as lambda from '@aws-cdk/aws-lambda';
import * as apigw from "@aws-cdk/aws-apigateway";
import { PythonFunction } from '@aws-cdk/aws-lambda-python';

export interface ISamExample {
  S3Path: string
}


export class SamExample extends cdk.Stack {
  constructor(scope: cdk.Construct, id: string, params: ISamExample, props?: cdk.StackProps) {
    super(scope, id, props);

    /** lambda role */
    const role = new iam.Role(this, 'lambdaRole', {
      assumedBy: new iam.ServicePrincipal('lambda.amazonaws.com')
    })
    role.addManagedPolicy(iam.ManagedPolicy.fromManagedPolicyArn(this, 'CloudWatchLogsAccess', 'arn:aws:iam::aws:policy/CloudWatchFullAccess'))

    /** note: when you use the stack, configure the entry path */
    const lambdaSimpleResponse = new PythonFunction(this, 'LambdaFunction', {
      functionName: "simple_response",
      entry: '../stacks/lambda/sam_example',
      index: 'lambda_function.py',
      handler: 'handler',
      runtime: lambda.Runtime.PYTHON_3_8,
      role: role,
      environment: {
        S3_PATH: params.S3Path
      }
    })

    const api = new apigw.LambdaRestApi(this, 'sample_api', {
      handler: lambdaSimpleResponse,
      proxy: false
    });

    const items = api.root.addResource('sample');
    items.addMethod('GET');
  }
}

```

## ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ

```shell
$ sam-beta-cdk local invoke --project-type CDK SamExampleStack/LambdaFunction
Synthesizing CDK App
Invoking lambda_function.handler (python3.8)
Failed to download a new amazon/aws-sam-cli-emulation-image-python3.8:rapid-1.22.0.dev202104291816 image. Invoking with the already downloaded image.
Mounting /Users/yoshiki/Development/Projects/aws-cdk-ts-small-examples/typescript/sam-example/.aws-sam/.cdk-out/asset.fd201469c9cd087ed2f5e86224bde9c4be5383f4ce718a425a0aa8b98db0f36a as /var/task:ro,delegated inside runtime container
END RequestId: 106b4af6-94a2-496a-906c-2632efe22f6d
REPORT RequestId: 106b4af6-94a2-496a-906c-2632efe22f6d  Init Duration: 0.14 ms	Duration: 96.61 ms	Billed Duration: 100 ms	Memory Size: 128 MB	Max Memory Used: 128 MB
{"statusCode": 200, "body": "{\"status\": \"success\", \"from\": \"SAM CLI\", \"s3\": \"s3://sam-example/lambda/...\"}"}

```


## AWSã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

ä»Šå›ã¯ã€CDKã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€ã‚ã–ã‚ã–SAMã‚’ä»‹ã™ã‚‹å¿…è¦ã¯ãªã„ã®ã§ã™ãŒ
ä¸€å¿œã§ãã‚‹ã¿ãŸã„ãªã®ã§ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚

```shell
# SAMãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ãƒ“ãƒ«ãƒ‰
$ sam-beta-cdk build --project-type CDK

# SAMã§ãƒ“ãƒ«ãƒ‰ã—ãŸã‚‚ã®ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
$ cdk deploy -a .aws-sam/build

# SAMã§ãƒ“ãƒ«ãƒ‰ã—ãŸã‚‚ã®ã‚’ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤
$ cdk destroy -a .aws-sam/build

```