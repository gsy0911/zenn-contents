---
title: "cognitoã®å„ç¨®èªè¨¼ç”»é¢ã‚’ç‹¬è‡ªå®Ÿè£…ã™ã‚‹"
emoji: "ğŸ”±"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["cognito", "nextjs", "mui"]
published: true
---

# ã¯ã˜ã‚ã«

æœ¬è¨˜äº‹ã§ã¯ã€Cognitoã®å„ç¨®èªè¨¼ç”»é¢ã‚’ç‹¬è‡ªã«å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚
HostedUIã‚„AmplifyUIã¯ä¾¿åˆ©ã§ã™ãŒã€ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«åˆã‚ãªã‹ã£ãŸã‚Šã™ã‚‹ãŸã‚ã§ã™ã€‚

UIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®MUIã‚’ä½¿ã£ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”»é¢ãªã©ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚
ç”»é¢ã¯`MUI`ã§ä½œã‚‰ã‚Œã¦ã„ã¾ã™ãŒã€èªè¨¼ã¾ã‚ã‚Šã®å‡¦ç†ã¯å˜ä¸€ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦åˆ‡ã‚Šå‡ºã—ã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚`React`ã‚„`Next.js`ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆãªã‚‰ã€ã»ã¼ã»ã¼ã‚³ãƒ”ãƒšã§åˆ©ç”¨ã§ãã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

ä¸»ã«å‚è€ƒã«ã—ãŸã®ã¯ä»¥ä¸‹ã®è¨˜äº‹ã«ãªã£ã¦ã„ã¾ã™ã€‚

https://mseeeen.msen.jp/react-auth-with-ready-made-cognito/

ã“ã®è¨˜äº‹ã®ä¸­ã§ã‚‚è¿°ã¹ã‚‰ã‚Œã¦ã„ã¾ã™ãŒã€
`aws-amplify`ã®ä¸­ã®`Auth`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã—ã¦èªè¨¼ã¾ã‚ã‚Šã®å‡¦ç†ã‚’çµ„ã‚“ã§ã„ãã¾ã™ã€‚
ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯`Amplify`ã¯å˜ç´”ã«èªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦ä¾¿åˆ©ãªãŸã‚åˆ©ç”¨ã—ã¾ã™ã€‚

ãƒ­ã‚°ã‚¤ãƒ³ã®è¦‹ãŸç›®ã¯MUIã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã€ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã®ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚

https://qiita.com/shunnami/items/98a341d2ac20775241ad

# åˆ©ç”¨æ™‚ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ»ã“ã®è¨˜äº‹ã®å¯¾è±¡èª­è€…

åˆ©ç”¨æ™‚ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
æœ€åˆã®ç”»é¢ã¯ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/c0110fa4ebec-20230225.png =600x)
*ã‚µã‚¤ãƒ³ã‚¤ãƒ³å‰ã®çŠ¶æ…‹*

ç”»é¢å³ä¸Šã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã™ã‚‹ã¨ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦èªè¨¼ãŒæˆåŠŸã™ã‚‹ã¨ã€ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«é·ç§»ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/2fd3e250ffbb-20230225.png =600x)
*ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢*

èªè¨¼æ¸ˆã¿ã®å ´åˆã¯ã€èªè¨¼å¾Œã®ç”»é¢ã‚’ç”¨æ„ã™ã‚‹æƒ³å®šã§ã™ã€‚
ï¼ˆä»Šå›ã¯èªè¨¼æ¸ˆã¿ã®å ´åˆã€Œã‚µã‚¤ãƒ³ã‚¤ãƒ³å¾Œã€ã¨ã„ã†æ–‡å­—ã«ãªã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚ï¼‰

![](https://storage.googleapis.com/zenn-user-upload/51b333dfab41-20230225.png =600x)
*ã‚µã‚¤ãƒ³ã‚¤ãƒ³å¾Œã®çŠ¶æ…‹*

ã‚µã‚¤ãƒ³ç”»é¢ã®ä»–ã«ã€æœ¬è¨˜äº‹ã§ã¯ä»¥ä¸‹ã®ç”»é¢ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

- åˆå›ã‚µã‚¤ãƒ³ã‚¤ãƒ³å®Œäº†ç”»é¢
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”»é¢
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¿˜ã‚Œç”»é¢
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”»é¢

## ã“ã®è¨˜äº‹ã®å¯¾è±¡èª­è€…

- `React`ã‹`Next.js`ã‚’åˆ©ç”¨ã™ã‚‹æ–¹
- `cognito`ã®èªè¨¼ã‚’åˆ©ç”¨ã™ã‚‹æ–¹
- `Amplify`ã‚’åˆ©ç”¨ã›ãšã«ã€`CloudFront`ã‚„ãã®ä»–ã®æ–¹æ³•ã§ç‹¬è‡ªã«ã‚µã‚¤ãƒˆã‚’ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹æ–¹

ä»Šå›ã¯ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ç”»é¢ã¯ãªãã€AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®cognitoã®ç”»é¢ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ãŸå¾Œã«ã€
ã“ã®èªè¨¼ç”»é¢ã‚’åˆ©ç”¨ã—ã¦ã‚‚ã‚‰ã†æƒ³å®šã«ãªã£ã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€ã©ã¡ã‚‰ã‹ã¨ã„ã†ã¨ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªã‚µãƒ¼ãƒ“ã‚¹ã®å ´åˆã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
ï¼ˆã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ç”»é¢ã‚’ä½œã‚Œã°èª°ã§ã‚‚ç™»éŒ²ãƒ»åˆ©ç”¨é–‹å§‹ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚‚åˆ©ç”¨å¯èƒ½ã§ã™ã€‚ï¼‰

## ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ

åˆ©ç”¨ã—ãŸãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¸»ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- react: 18.2.0
- Next.js: 13.2.1
- MUI: 5.10.12
- react-hook-form: 7.43.2
- aws-amplify: 5.0.15

# ã‚³ãƒ¼ãƒ‰

ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã¯[ã“ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/gsy0911/zenn-cognito-frontend-auth)ã«è¼‰ã›ã¦ã‚ã‚Šã¾ã™ã®ã§é©å®œå‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
ã“ã‚Œã‹ã‚‰ç°¡å˜ã«å†…å®¹ã‚’ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ğŸ‘ˆãŒã¤ã„ã¦ã„ã‚‹éƒ¨åˆ†ãŒä¸»ã«è¿½åŠ ãƒ»ä¿®æ­£ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã£ã¦ã„ã¾ã™ã€‚

```text
frontend/
â”œâ”€â”€ components
â”‚  â”œâ”€â”€ model
â”‚  â”‚  â””â”€â”€ Header
â”‚  â”‚     â”œâ”€â”€ Header.tsx ğŸ‘ˆ è¦‹ãŸç›®ã‚’å°‘ã—ã‚ˆãã™ã‚‹ãŸã‚ã«ç”¨æ„ã—ãŸãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆç‰¹ã«é–¢ä¿‚ã¯ãªã„ã§ã™ï¼‰
â”‚  â”‚     â””â”€â”€ index.ts
â”‚  â””â”€â”€ page
â”‚     â”œâ”€â”€ Auth
â”‚     â”‚  â”œâ”€â”€ AuthBasePage.tsx ğŸ‘ˆ èªè¨¼ã¾ã‚ã‚Šã®ç”»é¢ã®ã‚¬ãƒ¯
â”‚     â”‚  â”œâ”€â”€ PasswordChange.form.tsx ğŸ‘ˆ ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã€ã®ãƒ•ã‚©ãƒ¼ãƒ 
â”‚     â”‚  â”œâ”€â”€ PasswordForget.form.tsx ğŸ‘ˆ ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¿˜ã‚Œã€ã®ãƒ•ã‚©ãƒ¼ãƒ 
â”‚     â”‚  â”œâ”€â”€ PasswordReset.form.tsx ğŸ‘ˆ ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šã€ã®ãƒ•ã‚©ãƒ¼ãƒ 
â”‚     â”‚  â”œâ”€â”€ SignIn.form.tsx ğŸ‘ˆ ã€Œã‚µã‚¤ãƒ³ã‚¤ãƒ³ã€ã®ãƒ•ã‚©ãƒ¼ãƒ 
â”‚     â”‚  â””â”€â”€ SignInComplete.form.tsx ğŸ‘ˆ ã€Œåˆå›ã‚µã‚¤ãƒ³ã‚¤ãƒ³å®Œäº†ã€ã®ãƒ•ã‚©ãƒ¼ãƒ 
â”‚     â””â”€â”€ index.ts
â”œâ”€â”€ lib
â”‚  â””â”€â”€ cognito-auth.tsx ğŸ‘ˆ èªè¨¼ã¾ã‚ã‚Šã®å‡¦ç†ã‚’ã¾ã¨ã‚ãŸãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ next.config.js
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ pages
â”‚  â”œâ”€â”€ _app.tsx
â”‚  â”œâ”€â”€ _document.tsx
â”‚  â”œâ”€â”€ index.tsx
â”‚  â”œâ”€â”€ password-change
â”‚  â”‚  â””â”€â”€ index.tsx ğŸ‘ˆ ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã€ã‚’è¡¨ç¤º
â”‚  â”œâ”€â”€ password-forget
â”‚  â”‚  â””â”€â”€ index.tsx ğŸ‘ˆ ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¿˜ã‚Œã€ã¨ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šã€ã‚’è¡¨ç¤º
â”‚  â””â”€â”€ signin
â”‚     â””â”€â”€ index.tsx ğŸ‘ˆ ã€Œã‚µã‚¤ãƒ³ã‚¤ãƒ³ã€ã¨ã€Œåˆå›ã‚µã‚¤ãƒ³ã‚¤ãƒ³å®Œäº†ã€ã‚’è¡¨ç¤º
â””â”€â”€ tsconfig.json
```

[//]: # (ä»Šå›ã¯ ğŸ‘ˆ ã§ãƒãƒ¼ã‚¯ã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ãƒ»è¿½åŠ ã—ã¾ã™ã€‚)

## cognitoã®è¨­å®š


ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ãŒãªã„å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã‚’æ–°è¦ä½œæˆã—ãŸä¸Šã§ã€
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
cognitoã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨­å®šã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

- ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ç™ºè¡Œã—ãªã„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰
- èªè¨¼ãƒ•ãƒ­ãƒ¼ã¯`ALLOW_REFRESH_TOKEN_AUTH`ã¨`ALLOW_USER_SRP_AUTH`ã®ã¿

## èªè¨¼ç”¨ãƒ•ãƒƒã‚¯ã®æº–å‚™

ä»Šå›ã®å¤§äº‹ãªã‚³ãƒ¼ãƒ‰ã®1ã¤ã§ã‚ã‚‹`cognito-auth.tsx`ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯èªè¨¼ã®å„ç¨®é–¢æ•°ã‚„çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€[å‚è€ƒè¨˜äº‹](https://mseeeen.msen.jp/react-auth-with-ready-made-cognito/)ã®å†…å®¹ã«ã„ãã¤ã‹ã®é–¢æ•°ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

ãƒ•ã‚¡ã‚¤ãƒ«ã¯é•·ã„ã®ã§ã€è¦‹ãŸã„å ´åˆã¯ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚

::::details èªè¨¼ç”¨ãƒ•ãƒƒã‚¯ã®è©³ç´°

```typescript jsx: cognito-auth.tsx
import {Auth, Amplify} from 'aws-amplify';
import React, {createContext, useContext, useEffect, useState} from 'react';

const AwsConfigAuth = {
  region: process.env.NEXT_PUBLIC_COGNITO_REGION,
  userPoolId: process.env.NEXT_PUBLIC_COGNITO_USER_POOL_ID,
  userPoolWebClientId: process.env.NEXT_PUBLIC_COGNITO_WEB_CLIENT_ID,
  authenticationFlowType: 'USER_SRP_AUTH',
}

Amplify.configure({Auth: AwsConfigAuth});

interface UseAuth {
  isLoading: boolean;
  isAuthenticated: boolean;
  username: string;
  currentAuthenticatedUser: () => Promise<any>;
  signUp: (username: string, password: string) => Promise<Result>;
  confirmSignUp: (verificationCode: string) => Promise<Result>;
  signIn: (username: string, password: string) => Promise<Result>;
  signInComplete: (username: string, oldPassword: string, newPassword: string) => Promise<Result>;
  signOut: () => void;
  changePassword: (user: any, oldPassword: string, newPassword: string, newPasswordConfirm: string) => Promise<Result>;
  forgetPassword: (email: string) => Promise<Result>;
  resetPassword: (username: string, code: string, newPassword: string, newPasswordConfirm: string) => Promise<Result>;
}

interface Result {
  success: boolean
  message: string
  hasChallenge?: boolean
  challengeName?: string
}

const authContext = createContext({} as UseAuth);

export const ProvideAuth: React.FC<{ children: React.ReactNode }> = ({children}) => {
  const auth = useProvideAuth();
  return <authContext.Provider value={auth}> {children} </authContext.Provider>;
};

export const useAuth = () => {
  return useContext(authContext);
};

const useProvideAuth = (): UseAuth => {
  const [isLoading, setIsLoading] = useState(true);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');

  useEffect(() => {
    Auth.currentAuthenticatedUser()
      .then((result) => {
        setUsername(result.username);
        setIsAuthenticated(true);
        setIsLoading(false);
      })
      .catch(() => {
        setUsername('');
        setIsAuthenticated(false);
        setIsLoading(false);
      });
  }, []);

  const signUp = async (username: string, password: string) => {
    try {
      await Auth.signUp({username, password});
      setUsername(username);
      setPassword(password);
      return {success: true, message: ''};
    } catch (error) {
      return {
        success: false,
        message: 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
      };
    }
  };

  const confirmSignUp = async (verificationCode: string) => {
    try {
      await Auth.confirmSignUp(username, verificationCode);
      const result = await signIn(username, password);
      setPassword('');
      return result;
    } catch (error) {
      return {
        success: false,
        message: 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
      };
    }
  };

  const signIn = async (username: string, password: string): Promise<Result> => {
    try {
      const result = await Auth.signIn(username, password);
      const hasChallenge = Object.prototype.hasOwnProperty.call(result, 'challengeName')
      setUsername(result.username);
      setIsAuthenticated(true);
      if (hasChallenge) {
        const challengeName = result.challengeName
        return {success: true, message: '', hasChallenge: true, challengeName};
      }
      return {success: true, message: '', hasChallenge: false}
    } catch (error) {
      return {
        success: false,
        message: 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
      };
    }
  };

  const signInComplete = async (username: string, oldPassword: string, newPassword: string) => {
    try {
      const user = await Auth.signIn(username, oldPassword)
      await Auth.completeNewPassword(user, newPassword, user.challengeParam.requiredAttributes)
      return {
        success: true,
        message: ""
      }
    } catch (error) {
      if (error instanceof Error) {
        if (error.name === "InvalidParameterException" || error.name === "InvalidPasswordException") {
          return {
            success: false,
            message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯è‹±å­—/æ•°å­—çµ„ã¿åˆã‚ã›ã®8æ¡ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
          };

        } else if (error.name === "NotAuthorizedException") {
          return {
            success: false,
            message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚',
          };

        } else if (error.name === "ExpiredCodeException") {
          return {
            success: false,
            message: 'ä»®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆã¸ã”é€£çµ¡ãã ã•ã„ã€‚',
          };

        } else if (error.name === "AuthError") {
          return {
            success: false,
            message: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
          };

        } else if (error.name === "UserNotFoundException") {
          return {
            success: false,
            message: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚',
          };

        }
      }
      return {
        success: false,
        message: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚',
      };
    }
  }

  const signOut = async () => {
    try {
      await Auth.signOut();
      setUsername('');
      setIsAuthenticated(false);
      return {success: true, message: ''};
    } catch (error) {
      return {
        success: false,
        message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
      };
    }
  };

  const changePassword = async (user: any, oldPassword: string, newPassword: string, newPasswordConfirm: string) => {
    try {
      if (newPassword === newPasswordConfirm) {
        await Auth.changePassword(user, oldPassword, newPassword);
        return {
          success: true,
          message: '',
        };
      } else {
        return {
          success: false,
          message: 'å…¥åŠ›ã—ãŸæ–°è¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
        };
      }
    } catch (error) {
      if (error instanceof Error) {
        if (error.name === "NotAuthorizedException") {
          return {
            success: false,
            message: 'ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚',
          };
        } else if (error.name === "LimitExceededException") {
          return {
            success: false,
            message: 'ã—ã°ã‚‰ãæ™‚é–“ã‚’ç½®ã„ã¦å†åº¦è©¦ã—ã¦ãã ã•ã„ã€‚',
          };
        } else if (error.name === "InvalidPasswordException") {
          return {
            success: false,
            message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯è‹±å­—ï¼ˆå°æ–‡å­—å¿…é ˆï¼‰/æ•°å­—çµ„ã¿åˆã‚ã›ã®8æ¡ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
          };
        } else if (error.name === "InvalidParameterException") {
          return {
            success: false,
            message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
          };
        }
      }
      return {
        success: false,
        message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
      };
    }
  }

  const forgetPassword = async (email: string) => {
    const regex = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    if (regex.test(email)) {

      try {
        await Auth.forgotPassword(email)
        return {
          success: true,
          message: '',
        }

      } catch (error) {
        return {
          success: false,
          message: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
        }

      }
    } else {
      return {
        success: false,
        message: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„',
      };
    }
  }

  const resetPassword = async (username: string, code: string, newPassword: string, newPasswordConfirm: string) => {
    if (newPassword !== newPasswordConfirm) {
      return {
        success: false,
        message: 'å…¥åŠ›ã—ãŸæ–°è¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
      }
    }
    try {
      await Auth.forgotPasswordSubmit(username, code, newPassword);
      return {
        success: true,
        message: ""
      }

    } catch (error) {
      if (error instanceof Error) {
        if (error.name === "InvalidParameterException" || error.name === "InvalidPasswordException") {
          return {
            success: false,
            message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯è‹±å­—ï¼ˆå°æ–‡å­—å¿…é ˆï¼‰/æ•°å­—çµ„ã¿åˆã‚ã›ã®8æ¡ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
          };
        } else if (error.name === "AuthError" || error.name === "ExpiredCodeException" || error.name === "LimitExceededException") {
          if (error.message === "Confirmation code cannot be empty") {
            return {
              success: false,
              message: 'ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
            };
          } else {
            return {
              success: false,
              message: 'ã‚³ãƒ¼ãƒ‰ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚å†åº¦ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ã‹ã‚‰ã€Œç·¨é›†ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚',
            };
          }
        } else if (error.name === "CodeMismatchException") {
          return {
            success: false,
            message: 'ã‚³ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚',
          };
        }
      }
      return {
        success: false,
        message: "äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
      }
    }
  }

  return {
    isLoading,
    isAuthenticated,
    username,
    currentAuthenticatedUser: () => Auth.currentAuthenticatedUser(),
    signUp,
    confirmSignUp,
    signIn,
    signInComplete,
    signOut,
    changePassword,
    forgetPassword,
    resetPassword
  };
};

```
::::

å¤‰æ›´ç‚¹ã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- `signInComplete`, `changePassword`, `forgetPassword`, `resetPassword`ã®é–¢æ•°ã®è¿½åŠ 
  - ã“ã‚Œã«ã‚ˆã£ã¦ã€å¿…è¦ãªå‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹
- `currentAuthenticatedUser`ã®è¿½åŠ 
  - `changePassword`ã®å®Ÿè¡Œæ™‚ã«å¿…è¦ãª`user`ã‚’å–å¾—ã™ã‚‹

## å„ç¨®èªè¨¼ç”»é¢ã®ä½œæˆ

å„ç¨®ç”»é¢ã¯ã€`AuthBasePage.tsx`ã¨å„ç¨®`*.form.tsx`ã‚’ãã‚Œãã‚Œçµ„ã¿åˆã‚ã›ã¦ä½œæˆã—ã¾ã™ã€‚

`AuthBasePage.tsx`ã ã‘ã§ã¯ã€ä»¥ä¸‹ã®å†…å®¹ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€
å„ç¨®`*.form.tsx`ãŒãã‚Œãã‚Œã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«ãªã£ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/a63c2667ad40-20230225.png =600x)
*`AuthBasePage.tsx`ã®ã¿ã§è¡¨ç¤ºã•ã‚Œã‚‹å†…å®¹*


ä¸Šã®ç”»é¢ã¯ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚
ï¼ˆã»ã¨ã‚“ã©ã“ã®[å‚è€ƒè¨˜äº‹](https://qiita.com/shunnami/items/98a341d2ac20775241ad)ã®å†…å®¹ãŒãƒ™ãƒ¼ã‚¹ã«ãªã£ã¦ã„ã¾ã™ã€‚ï¼‰


```typescript jsx: AuthBasePage.tsx
import React, {createContext, useContext, useState} from 'react';
import {Alert, Avatar, Grid, Paper, Snackbar, Typography} from "@mui/material";
import {teal} from "@mui/material/colors";
import LockOutlinedIcon from "@mui/icons-material/LockOutlined";

interface UseAuthPage {
  setIsError: (state: boolean) => void
  setErrorMessage: (state: string) => void
}

const authPageContext = createContext({} as UseAuthPage);

export const useAuthPage = () => {
  return useContext(authPageContext);
};

export const AuthBasePage: React.FC<{ title: string, children: React.ReactNode }> = ({title, children}) => {
  const [isError, setIsError] = useState(false);
  const [errorMessage, setErrorMessage] = useState('');

  const value = {
    setIsError,
    setErrorMessage
  }

  return (
    <>
      <Grid>
        <Paper
          elevation={3}
          sx={{
            p: 4,
            height: "70vh",
            width: "280px",
            m: "20px auto"
          }}
        >
          <Grid
            container
            direction="column"
            justifyContent="flex-start" //å¤šåˆ†ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆflex-startãªã®ã§çœç•¥ã§ãã‚‹ã€‚
            alignItems="center"
          >
            <Avatar sx={{bgcolor: teal[400]}}>
              <LockOutlinedIcon/>
            </Avatar>
            <Typography variant={"h6"} sx={{m: "30px"}}>
              {title}
            </Typography>
          </Grid>
          <authPageContext.Provider value={value}>
            {children}
          </authPageContext.Provider>

        </Paper>
      </Grid>
      {/*ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸*/}
      <Snackbar open={isError} autoHideDuration={null}>
        <Alert onClose={() => setIsError(false)} severity="error" sx={{width: '100%'}}>
          {errorMessage}
        </Alert>
      </Snackbar>
    </>
  )
}
```

èªè¨¼ã¾ã‚ã‚Šã®ç”»é¢ã«å…±é€šæ„Ÿã‚’æŒãŸã›ã‚‹ãŸã‚ã«ã€ã‚¬ãƒ¯ã ã‘ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦ä½œæˆã—ã¦ã„ã¾ã™ã€‚
ãã—ã¦ã€ãã®ä¸­ã«`children`ã¨ã—ã¦å„ç¨®ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’çµ„ã¿è¾¼ã‚ã‚‹å½¢ã«ã—ã¦ã„ã¾ã™ã€‚

`useContext`ã¯å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ç”Ÿã˜ãŸãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã€
ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ä¼æ’­ã•ã›ã‚‹ãŸã‚ã«åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
ã©ã®ã‚ˆã†ã«ç”»é¢ã«è¡¨ç¤ºã•ã›ã‚‹ã‹æ¬¡ç¬¬ã§ã™ãŒã€
`react-hook-form`ã®ã‚¨ãƒ©ãƒ¼æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ãŸã‚‰ã€ä¸è¦ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ã€‚
æœ¬ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã€ç”»é¢å·¦ä¸‹ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/e9353726a969-20230226.png =600x)
*ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºä¾‹ï¼ˆã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ï¼‰*

### ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ã®ä½œæˆ

ä¸€ä¾‹ã¨ã—ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ã®æ§‹æˆã«ã¤ã„ã¦è¦‹ã¦ã„ãã¾ã™ã€‚
åˆ©ç”¨ã™ã‚‹ã®ã¯ã€`SignIn.form.tsx`ã§ã™ã€‚
ã“ã®tsxãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã€ãƒ•ã‚©ãƒ¼ãƒ ã®ã¿ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/2fd3e250ffbb-20230225.png =600x)
*ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ï¼ˆå†æ²ï¼‰*


```typescript jsx: SignIn.form.tsx
import React, {useState} from 'react';
import {useAuth} from '@/lib/cognito-auth';
import {useRouter} from 'next/router';
import {
  Box,
  Button,
  Link,
  TextField,
  Typography,
} from "@mui/material";
import {useForm, Controller} from "react-hook-form";
import {useAuthPage} from './AuthBasePage';

export const SignInForm: React.FC<{setSignInCompleteRequired: (state: boolean) => void}> = ({setSignInCompleteRequired}) => {
  const auth = useAuth();
  const authPage = useAuthPage()
  const router = useRouter();
  const [buttonDisabled, setButtonDisabled] = useState(false)
  const {control, handleSubmit, getValues} = useForm({
    defaultValues: {
      username: "",
      password: ""
    }
  });

  const executeSignIn = async () => {
    const username = getValues("username")
    const password = getValues("password")
    const result = await auth.signIn(username, password);
    if (result.hasChallenge) {
      if (result.challengeName === "NEW_PASSWORD_REQUIRED") {
        setSignInCompleteRequired(true)
      }
    } else if (result.success) {
      await router.push({
        pathname: '/'
      });
    } else {
      setButtonDisabled(false)
      authPage.setIsError(true)
      authPage.setErrorMessage(result.message)
    }
  };

  const onSubmit = async () => {
    setButtonDisabled(true)
    authPage.setIsError(false)
    await executeSignIn();
  };
  return (
    <>
      <form onSubmit={handleSubmit(onSubmit)}>
        <Controller
          name="username"
          control={control}
          render={({field}) => <TextField
            {...field}
            label="Username"
            variant="standard"
            fullWidth
            required
          />}
        />
        <Controller
          name="password"
          control={control}
          render={({field}) => <TextField
            {...field}
            type="password"
            label="Password"
            variant="standard"
            fullWidth
            required
          />}
        />
        <Box mt={3}>
          <Button
            type="submit"
            color="primary"
            variant="contained"
            fullWidth
            disabled={buttonDisabled}
          >
            ã‚µã‚¤ãƒ³ã‚¤ãƒ³
          </Button>
        </Box>
      </form>
      <Box mt={3}>
        <Typography variant="caption">
          <Link href="/password-forget">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚Œã¾ã—ãŸã‹ï¼Ÿ</Link>
        </Typography>
      </Box>
    </>
  )
}
```

`SignIn.form.tsx`ãŒã§ããŸã‚‰ã€`AuthBasePage.tsx`ã¨çµ„ã¿åˆã‚ã›ã¾ã™ã€‚
ãã†ã™ã‚‹ã“ã¨ã§ã€ä¸Šã®ã‚ˆã†ãªç”»é¢ã«ãªã‚Šã¾ã™ã€‚
ã¾ãŸã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ã¯`SignInComplete.form.tsx`ã®å†…å®¹ã‚‚çµ„ã¿åˆã‚ã›ã¦ã€
åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´è¦æ±‚ã«ã‚‚å¿œãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```typescript jsx: pages/signin/index.tsx
import type {NextPage} from 'next'
import React, {useState} from 'react';
import {SignInForm, AuthBasePage, SignInCompleteForm} from '@/page';

const Home: NextPage = () => {
  const [signInCompleteRequired, setSignInCompleteRequired] = useState(false)
  return (
    <>
      <AuthBasePage title={"ã‚µã‚¤ãƒ³ã‚¤ãƒ³"}>
        {
          signInCompleteRequired
            ? <SignInCompleteForm/>
            : <SignInForm setSignInCompleteRequired={setSignInCompleteRequired}/>
        }

      </AuthBasePage>
    </>
  )
}

export default Home
```

### ãã®ä»–ã®ç”»é¢ã«ã¤ã„ã¦

æ§‹æˆã¨ã—ã¦ã¯ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ã¨åŒã˜ãªã®ã§è©³ç´°ã¯çœãã¾ã™ã€‚
è©³ã—ãã¯ãƒªãƒã‚¸ãƒˆãƒªã®æ–¹ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
ä»¥ä¸‹ã«ä½œæˆã§ãã‚‹ç”»é¢ã‚’ä¹—ã›ã¦ãŠãã¾ã™ã€‚

`AuthBasePage.tsx`ã¨`PasswordForget.form.tsx`ã‚’çµ„ã¿åˆã‚ã›ãŸç”»é¢ã€‚
`/password-forget`ã«é·ç§»ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/99f9a9e63896-20230225.png =600x)
*ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¿˜ã‚Œç”»é¢*

`AuthBasePage.tsx`ã¨`PasswordReset.form.tsx`ã‚’çµ„ã¿åˆã‚ã›ãŸç”»é¢ã€‚
ï¼ˆ`/password-forget`ã«é·ç§»å¾Œã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã™ã‚‹ã¨é·ç§»ã—ã¾ã™ã€‚ï¼‰

![](https://storage.googleapis.com/zenn-user-upload/ffb6b2886b5d-20230225.png =600x)
*ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šç”»é¢*

`AuthBasePage.tsx`ã¨`PasswordChange.form.tsx`ã‚’çµ„ã¿åˆã‚ã›ãŸç”»é¢ã€‚
`/password-change`ã«é·ç§»ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/6d972248aa69-20230225.png =600x)
*ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”»é¢*

# CloudFrontã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ã‚‚ã‚‰ã†ã¨CloudFrontãªã©ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«ã‚‚æ¯”è¼ƒçš„é«˜ããƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã®ã§ãŠã™ã™ã‚ã§ã™ï¼


https://zenn.dev/gsy0911/articles/69017f1ed7c3cc

# ãŠã‚ã‚Šã«

ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ã‚„ãã®ã»ã‹ã®èªè¨¼ã¾ã‚ã‚Šã«å¿…è¦ãªå‡¦ç†ã¨ç”»é¢ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚
èª°ã‹ã®åŠ©ã‘ã«ãªã‚Œã°å¬‰ã—ã„ã§ã™ï¼

ã¾ãŸã€å‚è€ƒã«è¼‰ã›ã¦ã‚ã‚‹è¨˜äº‹ã‚‚å¤§å¤‰æœ‰ç”¨ãªã®ã§ã€æ˜¯éåˆã‚ã›ã¦ã”è¦§ãã ã•ã„ï¼

# å‚è€ƒ

- ä¸€ç•ªå‚è€ƒã«ã—ãŸè¨˜äº‹ï¼š[Amplify ã‚’ä½¿ã‚ãš React ã§ AWS Cognito èªè¨¼ã‚’ä½¿ã†](https://mseeeen.msen.jp/react-auth-with-ready-made-cognito/)
- [ã€MUIã€‘ã‚³ãƒ”ãƒšã§ä½¿ãˆã‚‹ï¼šãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸](https://qiita.com/shunnami/items/98a341d2ac20775241ad)
- [React åˆå¿ƒè€…ãŒ Material-UI ã§ä»Šã©ãã® Web ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œã£ã¦ã¿ãŸï¼ˆreact-hook-formç·¨ï¼‰](https://dev.classmethod.jp/articles/react-beginners-tried-to-create-a-modern-web-form-with-material-ui-and-react-hook-form/)
- [react-hook-formã®ä½¿ã„æ–¹ã¾ã¨ã‚](https://qiita.com/NozomuTsuruta/items/60d15d97eeef71993f06#seterror)