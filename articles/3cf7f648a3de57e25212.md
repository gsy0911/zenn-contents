---
title: "sam-cli-beta-cdkã‚’è©¦ã—ã¦ã¿ãŸ"
emoji: "ğŸš‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS", "CDK", "SAM"]
published: true
---

:::message alert
æœ¬å†…å®¹ã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç‰ˆã§ã™ã€‚ä»Šå¾Œã®æ›´æ–°ã§å¤‰æ›´ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
:::


# ã¯ã˜ã‚ã«

ã‚ã‚‹æ—¥ã€TLã‚’ã¼ã‚“ã‚„ã‚Šçœºã‚ã¦ã„ã‚‹ã¨ã“ã‚“ãªè¨˜äº‹ãŒæµã‚Œã¦æ¥ã¾ã—ãŸã€‚

https://twitter.com/_kensh/status/1387972711855525892?s=20

åˆã‚ã¦ã¿ãŸã¨ãã¯ã€`AWS SAM`ã«ç›®ãŒã„ã£ã¦ã‚ã¾ã‚Šæ°—ã«ã—ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚
ã‚ˆãã¿ã¦ã¿ã‚‹ã¨ã€ã“ã‚Œã‹ã‚‰AWSã‚’è§¦ã£ã¦ã„ãã«ã‚ãŸã£ã¦æ°—ã«ãªã‚‹ã“ã¨ãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã—ãŸã€‚

# ã‚¢ãƒ„ã„å†…å®¹

ä½•ãŒã™ã”ã„ã®ã‹ã¯ã€[å…ƒè¨˜äº‹](https://aws.amazon.com/jp/blogs/compute/better-together-aws-sam-and-aws-cdk/) ã®ã“ã®æ–‡ã«è©°ã¾ã£ã¦ã„ã¾ã™ã€‚

>  Before today, you could use the AWS SAM CLI to build locally, test, and package serverless applications defined using AWS CloudFormation or AWS SAM templates. With this preview release, you can use AWS SAM CLI to build, test, and in the future, package applications defined using the AWS CDK.

ã–ã£ãã‚Šã„ã†ã¨AWS CDKã§æ§‹ç¯‰ã—ãŸAWSã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ç¾¤ã‚’ã€AWS SAMã‚’åˆ©ç”¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã§è‰²ã€…ã§ãã‚‹ã¿ãŸã„ã§ã™ï¼
ã‚ã¨å°†æ¥çš„ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã§ãã‚‹ã¿ãŸã„ã§ã™ã€‚

ç§ã¯ä»Šã¾ã§ã€AWS CDKã‚’åˆ©ç”¨ã—ã¦ã„ãŸã®ã§ã™ãŒã€AWSå´ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ç”¨é€”ã§ã—ã‹åˆ©ç”¨ã§ããšã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ãƒ†ã‚¹ãƒˆã‚„å®Ÿè¡ŒãŒã§ãã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚
ãã®ã»ã‹ã®æœ‰åãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€`terraform`ãªã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ãƒ†ã‚¹ãƒˆã‚‚ç¢ºã‹ã§ããŸã¨æ€ã†ã®ã§ã™ãŒã€yamlå½¢å¼ã§è¨˜è¿°ã—ãªã‘ã‚Œã°ãªã‚‰ãšã€ç§ã¯è‹¦æ‰‹ã§ã—ãŸã€‚
åŠ ãˆã¦å…¬å¼ã§ã¯ãªã„ãŸã‚ã€ï¼ˆå…¬å¼ã«åŒ¹æ•µã™ã‚‹ãã‚‰ã„æœ‰åãƒ»åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã®ã¯çŸ¥ã£ã¦ã„ã¾ã™ãŒï¼‰ã‚ã¾ã‚Šåˆ©ç”¨ã«æ°—ãŒé€²ã¿ã¾ã›ã‚“ã§ã—ãŸã€‚

ãã‚“ãªæ™‚ã«ã€CDKã§ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ç¾¤ã‚’SAMã‚’åˆ©ç”¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡ŒãŒã§ãã‚‹ï¼ã“ã‚Œã¯ã‚¢ãƒ„ã„ã§ã™ï¼

# è©¦ã—ã¦ã¿ã‚‹

:::message alert
ï¼ˆå†æ²ï¼‰æœ¬å†…å®¹ã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç‰ˆã§ã™ã€‚ä»Šå¾Œã®æ›´æ–°ã§å¤‰æ›´ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
:::

ä¸Šè¨˜ã®ãƒšãƒ¼ã‚¸ã«ã‚‚ã‚µãƒ³ãƒ—ãƒ«ã¯ã‚ã‚Šã¾ã™ãŒã€è‡ªåŠ›ã§ã‚‚ã‚ã‚‚ã‚ã‚„ã£ã¦ã¿ã‚ˆã†ã‹ã¨æ€ã„ã¾ã™ã€‚

Lambdaã¨API Gatewayã‚’CDKã§ä½œæˆã—ã¦ã€SAMã‚’é€šã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚


![](https://storage.googleapis.com/zenn-user-upload/g2cp9cj5sn37erfm3thws5h9140f)


## æº–å‚™ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»ç’°å¢ƒè¨­å®š

[ã“ã®ãƒšãƒ¼ã‚¸](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-cdk.html) ã‚’å‚è€ƒã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å…¥ã‚Œã¦ã„ãã¾ã™ã€‚

å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã¯ä»¥ä¸‹ã®3ã¤ã§ã™ã€‚

- [AWS CLI](https://aws.amazon.com/cli/)
- [AWS CDK](https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html)
- [AWS SAM CLI - beta](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-cdk.html)

ç§ã®ç’°å¢ƒãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

- OS: macOS Big Sur (11.3), intel
- AWS CLI: aws-cli/2.2.3 Python/3.9.5 Darwin/20.4.0 source/x86_64 prompt/off
- AWS CDK: 1.102.0 (build a75d52f)

AWS CLIã¨CDKã¯æ—¢ã«å…¥ã£ã¦ã„ãŸã®ã§ã€`AWS SAM CLI - beta`ã®ã¿brewã«ã¦å…¥ã‚Œã¦ã„ãã¾ã™ã€‚

```shell
$ brew install aws-sam-cli-beta-cdk
######################################################################## 100.0%
==> Pouring aws-sam-cli-beta-cdk-202104291816.sierra.bottle.tar.gz
ğŸº  /usr/local/Cellar/aws-sam-cli-beta-cdk/202104291816: 3,951 files, 82.4MB

$ sam-beta-cdk --version
SAM CLI, version 1.22.0.dev202104291816
```

ã“ã‚Œã§å…¨ã¦ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚

## CDK Stackã®ä½œæˆ

`sam-beta-cdk`ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒçµ‚ã‚ã£ãŸã‚‰ã€CDKã®Stackã‚’ä½œæˆã—ã¾ã™ã€‚

ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã“ã®è¨˜äº‹ã«ã¯è¼‰ã›ãªã„ã®ã§ã€è©³ç´°ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

```shell
.
â”œâ”€â”€ sam-example  # ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå ´æ‰€
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ cdk.json
â”‚Â Â  â””â”€â”€ index.ts
â””â”€â”€ stacks
 Â Â  â”œâ”€â”€ SamExample.ts # CDKã§Lambdaã‚’è¨˜è¿°
 Â Â  â”œâ”€â”€ index.ts
 Â Â  â””â”€â”€ lambda
 Â Â   Â Â  â””â”€â”€ sam_example # lambda functionã‚’ä¿æŒ
 Â Â   Â Â      â”œâ”€â”€ lambda_function.py
 Â Â   Â Â      â”œâ”€â”€ requirements.txt
 Â Â   Â Â      â””â”€â”€ utils.py

```


https://github.com/gsy0911/aws-cdk-ts-small-examples

### å®Ÿè¡Œã™ã‚‹Stack

ä»Šå›ã¯ã€Lambdaã¨API Gatewayã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚

- Lambdaé–¢æ•°åï¼šLambdaFunction
- API Gateway: GET /sample

ç‰¹ã«ç†ç”±ã¯ãªã„ã§ã™ãŒã€Lambdaé–¢æ•°ã«S3ãƒ‘ã‚¹ã‚’ç’°å¢ƒå¤‰æ•°ã§æŒãŸã›ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```typescript:SamExample.ts
import * as cdk from "@aws-cdk/core";
import * as iam from '@aws-cdk/aws-iam';
import * as lambda from '@aws-cdk/aws-lambda';
import * as apigw from "@aws-cdk/aws-apigateway";
import { PythonFunction } from '@aws-cdk/aws-lambda-python';

export interface ISamExample {
  S3Path: string
}


export class SamExample extends cdk.Stack {
  constructor(scope: cdk.Construct, id: string, params: ISamExample, props?: cdk.StackProps) {
    super(scope, id, props);

    /** lambda role */
    const role = new iam.Role(this, 'lambdaRole', {
      assumedBy: new iam.ServicePrincipal('lambda.amazonaws.com')
    })
    role.addManagedPolicy(iam.ManagedPolicy.fromManagedPolicyArn(this, 'CloudWatchLogsAccess', 'arn:aws:iam::aws:policy/CloudWatchFullAccess'))

    /** note: when you use the stack, configure the entry path */
    const lambdaSimpleResponse = new PythonFunction(this, 'LambdaFunction', {
      functionName: "simple_response",
      entry: '../stacks/lambda/sam_example',
      index: 'lambda_function.py',
      handler: 'handler',
      runtime: lambda.Runtime.PYTHON_3_8,
      role: role,
      environment: {
        S3_PATH: params.S3Path
      }
    })

    /** API Gateway*/
    const api = new apigw.LambdaRestApi(this, 'sample_api', {
      handler: lambdaSimpleResponse,
      proxy: false
    });

    /** add GET method*/
    const items = api.root.addResource('sample');
    items.addMethod('GET');
  }
}

```


### Lambdaé–¢æ•°

S3ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ“ä½œã—ã¦ä½•ã‹ã—ã‚‰ã®çµæœã‚’è¿”ã™Lambdaã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€Stackä½œæˆæ™‚ã«Lambdaé–¢æ•°ã¸ä»˜ä¸ã—ãŸç’°å¢ƒå¤‰æ•°ï¼ˆS3ã®ãƒ‘ã‚¹ï¼‰ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
`response_wrapper()`ã¯API Gatewayã§å®Ÿè¡Œã™ã‚‹éš›ã«ã€è¿”ã‚Šå€¤ã‚’æ•´å½¢ã™ã‚‹ç”¨é€”ã§åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

```python:lambda_function.py
from utils import response_wrapper
import os


@response_wrapper()
def handler(event, _):
    return 200, {
        "status": "success", 
        "from": "SAM CLI", 
        "s3": f"{os.environ.get('S3_PATH')}/lambda/..."
    }
```

### CDKã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ

ä¸Šã§ä½œæˆã—ãŸ`SamExample.ts`ã‚’`index.ts`ã«ã¦ã‚¹ã‚¿ãƒƒã‚¯ã¨ã—ã¦ä½œæˆã—ã¾ã™ã€‚
ï¼ˆåŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚‹ã€`cdk.json`ã«ã¦CDKã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦æŒ‡å®šã—ã¦ã‚ã‚Šã¾ã™ï¼‰ã€‚

```typescript:index.ts
import * as cdk from "@aws-cdk/core";
import {SamExample} from '../stacks';

const app = new cdk.App();
new SamExample(app, "SamExampleStack", {S3Path: "s3://sam-example"}, {description: "ts-example: for AWS SAM"});

app.synth();
```

ã“ã‚Œã§ã€æº–å‚™ã¯æ•´ã„ã¾ã—ãŸï¼å®Ÿéš›ã«å®Ÿè¡Œã—ã¦ã„ãã¾ã™ï¼

## ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œï¼ˆLambdaï¼‰

ã¾ãšã¯ã€Lambdaã®ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã§ã™ã€‚
Lambdaã‚’å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```shell
# Invoke the function FUNCTION_IDENTIFIER declared in the stack STACK_NAME
$ sam-beta-cdk local invoke [OPTIONS] [STACK_NAME/FUNCTION_IDENTIFIER]
```

ãã‚Œã§ã¯ã€`SamExampleStack`ã«ä½œæˆã—ãŸ`LambdaFunction`ã‚’å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¡ã¾ã™ã€‚
ã¾ãŸã€`[OPTION]`ã§`project-type`ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```shell
$ sam-beta-cdk local invoke --project-type CDK SamExampleStack/LambdaFunction
Synthesizing CDK App
Invoking lambda_function.handler (python3.8)
Failed to download a new amazon/aws-sam-cli-emulation-image-python3.8:rapid-1.22.0.dev202104291816 image. Invoking with the already downloaded image.
Mounting /Users/yoshiki/Development/Projects/aws-cdk-ts-small-examples/typescript/sam-example/.aws-sam/.cdk-out/asset.fd201469c9cd087ed2f5e86224bde9c4be5383f4ce718a425a0aa8b98db0f36a as /var/task:ro,delegated inside runtime container
END RequestId: 106b4af6-94a2-496a-906c-2632efe22f6d
REPORT RequestId: 106b4af6-94a2-496a-906c-2632efe22f6d  Init Duration: 0.14 ms	Duration: 96.61 ms	Billed Duration: 100 ms	Memory Size: 128 MB	Max Memory Used: 128 MB
{"statusCode": 200, "body": "{\"status\": \"success\", \"from\": \"SAM CLI\", \"s3\": \"s3://sam-example/lambda/...\"}"}
```

æ­£ã—ãå®Ÿè¡Œã§ãã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã­ï¼

## ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œï¼ˆAPI Gatewayï¼‰

æ¬¡ã«ã€API Gatewayã®ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã§ã™ã€‚
APIã‚’å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ä¾‹ã¯æ¬¡ã§ã™ã€‚
```shell
# Start all APIs declared in the AWS CDK application
$ sam-beta-cdk local start-api [OPTIONS]
```

`[OPTION]`ã®`--project-type CDK`ã®ã¿åŠ ãˆã¦å®Ÿè¡Œã—ã¾ã™ã€‚

```shell
$ sam-beta-cdk local start-api --project-type CDK
Mounting simple_response at http://127.0.0.1:3000/sample [GET]
You can now browse to the above endpoints to invoke your functions. You do not need to restart/reload SAM CLI while working on your functions, changes will be reflected instantly/automatically. You only need to restart SAM CLI if you update your AWS SAM template
2021-05-09 14:32:02  * Running on http://127.0.0.1:3000/ (Press CTRL+C to quit)
```

3000ç•ªãƒãƒ¼ãƒˆã§å®Ÿè¡Œã•ã‚Œã‚‹ã¿ãŸã„ã§ã™ã€‚
ä½œæˆã—ãŸAPIã¯`GET /sample`ãªã®ã§åˆ¥ã‚·ã‚§ãƒ«ã‹ã‚‰curlã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```shell
$ curl localhost:3000/sample
{"status": "success", "from": "SAM CLI", "s3": "s3://sam-example/lambda/..."}
```

ã“ã¡ã‚‰ã‚‚ã€å•é¡Œãªãã„ã‘ã¾ã—ãŸã€‚

## AWSã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

æœ€å¾Œã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è©¦ã—ã¦ã¿ã¾ã™ã€‚
ä»Šå›ã¯ã€CDKã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€ã‚ã–ã‚ã–SAMã‚’ä»‹ã™ã‚‹å¿…è¦ã¯ãªã„ã®ã§ã™ãŒä¸€å¿œã§ãã‚‹ã¿ãŸã„ãªã®ã§ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚
ã“ã®æ©Ÿèƒ½ã¯ã€ãŠãã‚‰ãä»Šã¾ã§SAMã‚’åˆ©ç”¨ã—ã¦ã„ãŸäººå‘ã‘ãªã®ã‹ãªã¨æ€ã„ã¾ã—ãŸã€‚

```shell
# SAMãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ãƒ“ãƒ«ãƒ‰
$ sam-beta-cdk build --project-type CDK

# SAMã§ãƒ“ãƒ«ãƒ‰ã—ãŸã‚‚ã®ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
$ cdk deploy -a .aws-sam/build

# SAMã§ãƒ“ãƒ«ãƒ‰ã—ãŸã‚‚ã®ã‚’ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤
$ cdk destroy -a .aws-sam/build
```

# ãŠã‚ã‚Šã«

`AWS CDK` + `AWS SAM`ã®çµ„ã¿åˆã‚ã›ã§ã€ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã®æ¤œè¨¼ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã¯é¸æŠè‚¢ãŒå¢—ãˆã¾ã—ãŸã­ï¼
ã“ã“ã‚‰ä»˜è¿‘ã¯ã€`terraform`ã¨ã‹å¾“æ¥ã®`SAM`ã§ã‚‚ååˆ†ã ã£ãŸã¨æ€ã†ã®ã§ã™ãŒã€ä½•ã‚ˆã‚Šãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§`IaC`ã§ãã‚‹ã®ãŒå¼·ã¿ã‹ãªã¨æ€ã„ã¾ã™ã€‚
åŠ ãˆã¦ã€CDKã¨SAMã¯AWSãŒå…¬å¼ã«æä¾›ã—ã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ãªã®ã§ãã“ã‚‚å®‰å¿ƒã§ãã‚‹ç‚¹ã§ã™ã€‚

å°†æ¥çš„ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã§ãã‚‹ã¨ã„ã†ç‚¹ã‚‚é¢ç™½ãã†ã§ã™ï¼
ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’è²·ã„åˆ‡ã‚Šã§é…å¸ƒãªã©ã‚‚ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã‚‰ã€Dockerã¨ã¯åˆ¥ã®é¸æŠè‚¢ã«ã‚‚ãªã‚Šãˆã‚‹ã®ã‹ãªã¨æ€ã„ã¾ã—ãŸã€‚

æ­£å¼ãƒªãƒªãƒ¼ã‚¹ãŒå¾…ã¡é ã—ã„ã§ã™ã­ï¼

è„±ç·šã—ã¾ã™ãŒ`AWS CDK`ã¯ã€ãã‚ãã‚v2.0ç³»ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œãã†ãªã®ã§ãã¡ã‚‰ã‚‚æ¥½ã—ã¿ã§ã™ã­ã€‚
