---
title: "【NextAuth.js/認証】XStateとMantineでCognitoのカスタムサインアップページを作成する"
emoji: "🎲"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["nextauth", "nextjs", "cognito", "awscdk"]
published: false
---

# はじめに

Next.jsでauth.js（NextAuth.js）を使ってサインアップ画面を作っていきます。
Next.jsはSSR（Server-side Rendering, or Dynamic Rendering）が基本だと思っているのですが、フォームを扱う場合にはCSRで行う必要があります。
Next.jsでユーザーのインタラクティブな操作を伴う場合、どうしてもサーバー側でのレンダリングではなく、クライアントサイドでのレンダリングが必要。

Cognitoでメールログインを扱う場合、メールとパスワードを入力する画面、メールを認証する確認コードを入力する画面、登録完了画面、エラー画面など扱うべき状態が地味に多いです。
useContextやjotai、Reduxでも状態そのものの管理はできるが、状態遷移を含めた管理は結局のところユーザーに委ねられるので難しくコードが煩雑になりがちだと思っています。

そこで、状態繊維をシンプルにする`XState`が便利です。
https://zenn.dev/aldagram_tech/articles/59407d4546301d



## やりたいこと

XStateを使って状態管理をしっかりしつつ、サインアップの状態を遷移する。
UI部分にはMantineを使っています。
`@mantine/form`の`useForm`はXStateのcontextを使ったら不要な気もするのですが、バリデーションとして便利なので使っています。

XStateのcontextは状態遷移に必要な値のみ付与するようにしています。

# Cognitoのサインアップの状態遷移

Cognitoのサインアップの状態遷移は以下のようになります。

> ![](/images/nextjs_nextauthjs_cognito_6/amazon-cognito-sign-in-confirm-user.png)
> *Cognitoのユーザー確認プロセス（[公式サイト](https://docs.aws.amazon.com/cognito/latest/developerguide/signing-up-users-in-your-app.html)より）*


# コード


## 準備

XStateをインストールします。

```shell
$ npm install xstate @xstate/react @statelyai/inspect
```


## Cognitoのサインアップ処理

Cognitoへのサインアップを2つのフォルダに分けて実装していきます。

### `app/_common/api/cognito`フォルダ内

### `app/sign-up/actions`フォルダ内

Server Actionsを使ってクライアントサイドから実行できるようにします。

## ステートマシン

上述のサインアップを状態遷移図としてコードに起こしていきます。

```typescript jsx: stateMachine.ts
a
```

上記の状態遷移のコードを使って、CSRのコードを書いていきます。

```typescript jsx: page.xstate.tsx
a
```


## 動作確認

## 注意点・その他

## やっていないこと

### ファイル分割

ファイル分割をもう少ししたかったのですが、XStateをuseContextなどで扱う方法がわからなかったのと、XStateのActor利用した場合にinspectをどう扱うねん、というのが見えなかったので一旦単一のファイルで扱うようにしています。
ファイルの命名規則なども悩みそうなのでこの形でもいいかなと思います。

Mantineの方は、`createFormContext`を利用するとファイル分割をしやすくなります。

https://mantine.dev/form/create-form-context/

# おわりに

# 参考記事

https://docs.aws.amazon.com/cognito/latest/developerguide/signing-up-users-in-your-app.html
