---
title: "Switchbotã®APIã‚’ä½¿ã£ã¦æ“ä½œã™ã‚‹"
emoji: "ğŸ•Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["switchbot"]
published: false
---

# ã¯ã˜ã‚ã«

ã¿ãªã•ã‚“ã€ã‚¹ãƒãƒ¼ãƒˆãƒ›ãƒ¼ãƒ åŒ–ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ
æœ¬è¨˜äº‹ã§ã¯Swtichbotã‚’ä½¿ã£ã¦ãŠå®¶ã®å®¶é›»ã‚’è‡ªå‹•åŒ–ã™ã‚‹ä»•çµ„ã¿ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

# Switchbotã¨ã¯

# ç’°å¢ƒãƒ»æ§‹æˆ

SwitchbotãŒæä¾›ã™ã‚‹ã‚¢ãƒ—ãƒªã§å®Œçµã‚‚ã§ãã‚‹ã®ã§ã™ãŒã€ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨æ“ä½œã®è‡ªå‹•åŒ–ã‚’ä¸€å…ƒç®¡ç†ã—ãŸã‹ã£ãŸã®ã§AWSä¸Šã«ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚

## æ¸©åº¦ãƒ»æ¹¿åº¦ãƒ»ç…§åº¦

`Switchbot HUB2`ã¨æ¸©åº¦ãƒ»æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼ã‚’2ã¤æŒã£ã¦ãŠã‚Šã€åˆè¨ˆ3ã¤ã®ç’°å¢ƒã‚’æ¸¬å®šã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚’å°å…¥ã—ã¦ã„ã¾ã™ã€‚
ä¸Šè¨˜ã®è¨˜äº‹ã‚’å‚è€ƒã«ã€AWSã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ã‚’5åˆ†é–“éš”ã§å–å¾—ã—ã¦ã„ã¾ã™ã€‚

ã¾ã ã€æ¸©åº¦ã¨æ¹¿åº¦ã‹ã‚‰ä¸å¿«æŒ‡æ•°ã‚’ç®—å‡ºã—ã¦éƒ¨å±‹ã®çŠ¶æ…‹ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

## å®¶é›»æ“ä½œ

`Switchbot HUB2`ã¨`ãƒãƒ–ãƒŸãƒ‹`ã®2å°ã‚’ã€2ã¤ã®éƒ¨å±‹ã«ç½®ã„ã¦ãã‚Œãã‚Œã®éƒ¨å±‹ã«ã‚ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚’æ“ä½œã—ã¦ã„ã¾ã™ã€‚
æ“ä½œã—ã¦ã„ã‚‹ã®ã¯ä»¥ä¸‹ã®4ç¨®é¡ï¼ˆåˆè¨ˆ5å°ï¼‰ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã™ã€‚

- ã‚¨ã‚¢ã‚³ãƒ³ï¼ˆ2å°ï¼‰
- ãƒ†ãƒ¬ãƒ“
- ãƒãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ
- å¤©äº•ç…§æ˜

## Switchbotã®ãƒ‡ãƒã‚¤ã‚¹

ä¸Šè¨˜ã®ãƒ‡ãƒã‚¤ã‚¹ã«åŠ ãˆã¦ã€Switchbotã®ãƒ†ãƒ¼ãƒ—ãƒ©ã‚¤ãƒˆã‚’å°å…¥ã—ã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã®YouTubeå‹•ç”»ãªã©ã‚’å‚è€ƒã«ã€ãƒ†ãƒ¬ãƒ“å°ã®å¾Œã‚ã«è²¼ã£ã¦ãƒãƒƒã‚¯ãƒ©ã‚¤ãƒˆã¨ã—ã¦æ´»ç”¨ã—ã¦ã„ã¾ã™ã€‚ç™ºç†±å‘¨ã‚ŠãŒå¿ƒé…ãªã®ã§å¸¸æ™‚ç‚¹ç¯ãªã©ã¯ã—ã¦ã„ãªã„ã§ã™ã€‚

# è‡ªå‹•åŒ–

## ãƒ‡ãƒã‚¤ã‚¹ã®çŠ¶æ…‹å–å¾—

APIã‚’è‡ªå‹•æ“ä½œã™ã‚‹ãŸã‚ã«ã€å…¬å¼ãŒæä¾›ã—ã¦ã„ã‚‹API v1.1ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

::: message
v1.0ã‚‚ã‚ã‚‹ã®ã§ã™ãŒã€ã“ã¡ã‚‰ã¯éæ¨å¥¨ãªã®ã§åˆ©ç”¨ã—ãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚
:::

æœ€åˆã«ç™»éŒ²ã—ãŸãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—ã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€Switchbotã¨ç™»éŒ²ã—ãŸãƒªãƒ¢ã‚³ãƒ³ãªã©ã®`deviceId`ã‚’å–å¾—ã—ã¾ã™ã€‚

```python: jupyter.ipynb
import base64
import hashlib
import hmac
import time
import uuid
import httpx

# ã‚¢ãƒ—ãƒªã‹ã‚‰TOKENã¨SECRETã‚’å–å¾—ã™ã‚‹
TOKEN = "................................................................................................"
SECRET = "................................"

# APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’
def _gen_headers() -> dict:
    nonce = uuid.uuid4()
    t = int(round(time.time() * 1000))
    string_to_sign = f"{TOKEN}{t}{nonce}"
    string_to_sign = bytes(string_to_sign, "utf-8")
    secret = bytes(SECRET, "utf-8")
    sign = base64.b64encode(hmac.new(secret, msg=string_to_sign, digestmod=hashlib.sha256).digest())

    headers = {
        "Authorization": TOKEN,
        "Content-Type": "application/json",
        "charset": "utf8",
        "t": str(t),
        "sign": str(sign, "utf-8"),
        "nonce": str(nonce),
    }
    return headers

device_url = "https://api.switch-bot.com/v1.1/devices"
res = httpx.get(url=device_url, headers=_gen_headers())
res.json()
```

ä¸Šè¨˜ã®å†…å®¹ã‚’å®Ÿè¡Œã—ã¦ã€æˆåŠŸã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœã‚’å¾—ã¾ã™ã€‚Switchbotã®ãƒ‡ãƒã‚¤ã‚¹ã¯`deviceList`ã«ã€ç™»éŒ²ã—ãŸãƒªãƒ¢ã‚³ãƒ³ãªã©ã¯`infraredRemoteList`ã®ä¸­ã«è¿”ã•ã‚Œã¾ã™ã€‚ãã‚Œãã‚Œã‹ã‚‰`deviceId`ã‚’å–å¾—ã—ã¾ã™ã€‚


```json
{
  "statusCode": 100,
  "body": 
    {
      "deviceList": [
        {
          "deviceId": "............",
          "deviceName": ".....",
          "deviceType": "(Meter | Hub 2 | Strip Light | Hub Mini)",
          "enableCloudService": true,
          "hubDeviceId": "....."
        }
      ],
      "infraredRemoteList": [
        {
          "deviceId": "..-............-........",
          "deviceName": ".....",
          "remoteType": "{Air Conditioner | Light | DIY TV}",
          "hubDeviceId": "....."
        }
      ]
    },
  "message": "success"
}
```

æ¬¡ã«ã€ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æ¥½ã«çŠ¶æ…‹ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«æ¬¡ã®ã‚¯ãƒ©ã‚¹ã¨ä¸å¿«æŒ‡æ•°ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚

```python: device.py (1)
import base64
import hashlib
import hmac
import os
import time
import uuid
from enum import Enum
from typing import Optional

import httpx
from pydantic import BaseModel


def _discomfort_index(temperature: float, humidity: float) -> float:
    """
    See Also:
        https://ja.wikipedia.org/wiki/%E4%B8%8D%E5%BF%AB%E6%8C%87%E6%95%B0
    """
    return 0.81 * temperature + 0.01 * humidity * (0.99 * temperature - 14.3) + 46.3


class DeviceRecord(BaseModel):
    device: Device
    temperature: float
    humidity: float
    discomfort_index: float
    light_level: float
    battery_level: float

```

ãã—ã¦ã€å„ç¨®ãƒ‡ãƒã‚¤ã‚¹ã®`deviceId`ãªã©ã‚’å«ã‚ã¦ç®¡ç†ã™ã‚‹`Enum`ã‚’æ¬¡ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã™ã€‚ã“ã®æ™‚ã«å¿…é ˆãªã®ã¯`deviceId`ã®ã¿ã§ã™ã€‚ãã‚Œä»¥å¤–ã¯ãªãã¦ã‚‚æœ€æ‚ªå‹•ãã¾ã™ãŒç°¡ä¾¿ã®ãŸã‚ã«ä»˜ä¸ã—ã¦ã„ã¾ã™ã€‚

```python: device.py (2)
ï¼ˆç¶šãï¼‰

class Device(Enum):
    SWITCH_BOT_HUB_2 = ("HUB2", "...", "Hub 2")
    SWITCH_BOT_HUB_MINI = ("HUB_MINI", "...", "Hub Mini")

    def __init__(self, device_name: str, device_id: str, device_type: str):
        self.device_name = device_name
        self.device_id = device_id
        self.device_type = device_type
```

ä¸Šè¨˜ã®Enumã«ç¶šãå½¢ã§ã€å„ç¨®é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚APIã‚’é€šã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹éš›ã«ã‚‚ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå¿…è¦ãªã®ã§ã€staticmethodã§`_generate_switchbot_headers()`ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

```python: device.py (3)
ï¼ˆç¶šãï¼‰
    @staticmethod
    def _generate_switchbot_headers() -> dict:
        # see: https://github.com/OpenWonderLabs/SwitchBotAPI?tab=readme-ov-file#python-3-example-code
        nonce = uuid.uuid4()
        t = int(round(time.time() * 1000))
        string_to_sign = f"{TOKEN}{t}{nonce}"
        string_to_sign = bytes(string_to_sign, "utf-8")
        secret = bytes(SECRET, "utf-8")
        sign = base64.b64encode(hmac.new(secret, msg=string_to_sign, digestmod=hashlib.sha256).digest())

        headers = {
            "Authorization": TOKEN,
            "Content-Type": "application/json",
            "charset": "utf8",
            "t": str(t),
            "sign": str(sign, "utf-8"),
            "nonce": str(nonce),
        }
        return headers
```

ãã—ã¦ã€HUB2ã‚„æ¸©åº¦ãƒ»æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼ã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã—ã¦ã€DeviceRecordã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦è¿”ã™é–¢æ•°ã§ã™ã€‚

```python: device.py (4)
ï¼ˆç¶šãï¼‰
    def get_data(self) -> Optional["DeviceRecord"]:
        if self.device_type == "Hub 2" or self.device_type == "Meter":
            url = f"https://api.switch-bot.com/v1.1/devices/{self.device_id}/status"
            response = httpx.get(url, headers=self._generate_switchbot_headers())
            response_body = response.json()["body"]

            temperature = response_body["temperature"]
            humidity = response_body["humidity"]
            device_record = DeviceRecord(
                device=self,
                temperature=temperature,
                humidity=humidity,
                discomfort_index=_discomfort_index(temperature=temperature, humidity=humidity),
                light_level=response_body.get("lightLevel", 0),
                battery_level=response_body.get("battery", 0),
            )
            return device_record
        else:
            return None
```

æœ€å¾Œã«ã€ãƒªãƒ¢ã‚³ãƒ³æ“ä½œã‚’è‡ªå‹•åŒ–ã™ã‚‹ãŸã‚ã®å„ç¨®é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ã‚¨ã‚¢ã‚³ãƒ³ã®é›»æºON/OFFã¨ã€å„ç¨®å®¶é›»ã®é›»æ°—ã®ON/OFFãã—ã¦ã€ãƒ†ãƒ¬ãƒ“ã®ãƒãƒ£ãƒ³ãƒãƒ«è¨­å®šã§ã™ã€‚

```python: device.py (5)
ï¼ˆç¶šãï¼‰
    def turn_off_air_conditioner(self):
        if self.device_type == "Air Conditioner":
            url = f"https://api.switch-bot.com/v1.1/devices/{self.device_id}/commands"
            data = {"command": "turnOff"}
            res = httpx.post(url, headers=self._generate_switchbot_headers(), json=data)
            return res
        return None

    def turn_on_cool_air_conditioner(self, temperature: int = 28):
        if self.device_type == "Air Conditioner":
            url = f"https://api.switch-bot.com/v1.1/devices/{self.device_id}/commands"
            data = {"commandType": "command", "command": "setAll", "parameter": f"{temperature},2,1,on"}
            res = httpx.post(url, headers=self._generate_switchbot_headers(), json=data)
            return res
        return None

    def turn_on(self):
        if self.device_type in ["Light", "Strip Light", "DIY TV", "TV"]:
            url = f"https://api.switch-bot.com/v1.1/devices/{self.device_id}/commands"
            data = {"command": "turnOn"}
            res = httpx.post(url, headers=self._generate_switchbot_headers(), json=data)
            return res
        return None

    def turn_off(self):
        if self.device_type in ["Light", "Strip Light", "DIY TV", "TV"]:
            url = f"https://api.switch-bot.com/v1.1/devices/{self.device_id}/commands"
            data = {"command": "turnOff"}
            res = httpx.post(url, headers=self._generate_switchbot_headers(), json=data)
            return res
        return None

    def switch_tv_channel_to(self, channel: str = "4"):
        if self.device_type == "DIY TV" or self.device_type == "TV":
            url = f"https://api.switch-bot.com/v1.1/devices/{self.device_id}/commands"
            data = {"commandType": "command", "command": "SetChannel", "parameter": channel}
            res = httpx.post(url, headers=self._generate_switchbot_headers(), json=data)
            return res
        return None
```


# ãŠã‚ã‚Šã«



