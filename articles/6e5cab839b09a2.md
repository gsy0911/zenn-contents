---
title: "Next.jsã§axiosã¸ã®å‹ä»˜ã‘ã¨ã‚¨ãƒ‡ã‚£ã‚¿è£œå®Œã‚’ã™ã‚‹"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "axios"]
published: true
---

# ã¯ã˜ã‚ã«

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰APIã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹æ™‚ã«ã€å‹ã‚„ã‚¨ãƒ‡ã‚£ã‚¿ã§ã®è£œå®ŒãŒãªãã¦è¾›ã„ãªã¨æ€ã„ã¾ã—ãŸã€‚
è‰¯ã•ã’ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯è¦‹ã¤ã‘ã‚‰ã‚Œãªã‹ã£ãŸã®ã§ã€
ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«è£œå®Œã‚’åŠ¹ã‹ã›ã¤ã¤ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã©ã«å‹ãŒä»˜ãã‚ˆã†ã«ã—ã¾ã™ã€‚

https://zenn.dev/takepepe/articles/nextjs-typesafe-api-routes

https://zenn.dev/sum0/articles/8e903ed05ba681

::: message
æœ¬è¨˜äº‹ã¯PagesRouterãªã©ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
App Routerã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã€Server Actionsã‚’åˆ©ç”¨ã—ãŸæ–¹ãŒã„ã„ã¨æ€ã„ã¾ã™ã€‚
:::

::: message
ç‹¬è‡ªã®ä»•çµ„ã¿ã‚’å°å…¥ã™ã‚‹ã¨ã€ç®¡ç†ã—ã¦ã„ãã“ã¨ã®ã»ã†ãŒå¤§å¤‰ã«ãªã£ã¦ã—ã¾ã†ãŸã‚ã§ã™ã€‚
:::

## å‰æ

- APIã®ã‚³ãƒ¼ãƒ«ã«ã¯`fetch`ã§ã¯ãªã`axois`ã‚’ä½¿ã†
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIã‚µãƒ¼ãƒãƒ¼ã¯`TypeScript`ä»¥å¤–
- `OpenAPI`ã‚’ä½¿ã£ã¦ã„ãªã„

## ç’°å¢ƒ

- macOS: 13.5
- Next.js: 13.4

# å‹•ä½œã‚µãƒ³ãƒ—ãƒ«

ä»¥ä¸‹ã¯PyCharmã§å‹•ã‹ã—ãŸæ™‚ã®è£œå®Œã®æŒ™å‹•ã®ä¾‹ã§ã™ã€‚
ãƒ‘ã‚¹ã«é–¢ã™ã‚‹è£œå®ŒãŒåŠ¹ã„ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

![](/images/nextjs_routes_types_1/nextjs_routes_types_1_1.png =600x)

ã¾ãŸã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«é–¢ã—ã¦ã‚‚åŒæ§˜ã«è£œå®ŒãŒåŠ¹ãã¾ã™ã€‚

![](/images/nextjs_routes_types_1/nextjs_routes_types_1_2.png =600x)

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã«ã¯ã‚¨ãƒ©ãƒ¼ã‚‚å‡ºã—ã¦ãã‚Œã¾ã™ã€‚

![](/images/nextjs_routes_types_1/nextjs_routes_types_1_3.png =600x)

# ã‚³ãƒ¼ãƒ‰

ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã„ã¦ã‚ã‚Šã¾ã™ã€‚é©å®œå‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

https://github.com/gsy0911/zenn-nextjs-routes-types

## æº–å‚™

ç‰¹ã«æ„å‘³ã¯ãªã„ã§ã™ãŒã‚¢ãƒ—ãƒªã®ä½œæˆã‹ã‚‰è¡Œã„ã¾ã™ã€‚
`AppRouter`ã¯åˆ©ç”¨ã›ãšã«ã€`PagesRouter`ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

```shell
$ npx create-next-app@latest
Need to install the following packages:
  create-next-app@13.4.19
Ok to proceed? (y) y
âœ” What is your project named? â€¦ zenn-app
âœ” Would you like to use TypeScript? â€¦ No / Yes
âœ” Would you like to use ESLint? â€¦ No / Yes
âœ” Would you like to use Tailwind CSS? â€¦ No / Yes
âœ” Would you like to use `src/` directory? â€¦ No / Yes
âœ” Would you like to use App Router? (recommended) â€¦ No / Yes
âœ” Would you like to customize the default import alias? â€¦ No / Yes
```

ã‚¢ãƒ—ãƒªã®ä½œæˆãŒçµ‚ã‚ã£ãŸã‚‰å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```shell
# ãã‚Œãã‚Œå¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ npm install type-fest axios swr query-string
$ npm install prettier -D
```

ç’°å¢ƒå¤‰æ•°ã«å‹ã‚’ã¤ã‘ã‚‹ãŸã‚ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç›´ä¸‹ã«ä½œæˆã—ã¾ã™ã€‚
ã“ã†ã™ã‚‹ã“ã¨ã§ã€ç’°å¢ƒå¤‰æ•°ã‚’å‚ç…§ã™ã‚‹ã¨ãã«`null`ã‹ã©ã†ã‹ã‚’è€ƒæ…®ã—ãªãã¦ã‚ˆããªã‚Šã¾ã™ã€‚

```typescript: globals.d.ts
declare namespace NodeJS {
  // ç’°å¢ƒå¤‰æ•°åã®å®šç¾©
  interface ProcessEnv {
    readonly NEXT_PUBLIC_BACKEND_API_ENDPOINT: string;
  }
}
```

ãã—ã¦ã€ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```text: .env.local
NEXT_PUBLIC_BACKEND_API_ENDPOINT=http://localhost:3000
```

æœ€å¾Œã«ã€`API Routes`ã‚’åˆ©ç”¨ã—ã¦ã‚ã‚‰ã‹ã˜ã‚å¯¾å¿œã™ã‚‹æ¤œè¨¼ç”¨ã®APIã‚’ä½œæˆã—ã¾ã™ã€‚
`pages/api`ä»¥ä¸‹ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã™ã‚‹ã¨ã€ç°¡æ˜“çš„ãªAPIã‚µãƒ¼ãƒãƒ¼ãŒä½œã‚Œã¾ã™ã€‚
ã“ã®ä¾‹ã§ã¯ã€`http://localhost:3000/api/user` ã«ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€
`{ status: "success", id: "1", name: "Alice" }`ã®çµæœã‚’å–å¾—ã§ãã¾ã™ã€‚

```typescript: pages/api/user.ts
import type { NextApiRequest, NextApiResponse } from "next";

type Data = {
  status: string; 
  id: string;
  name: string;
};

export default function handler(
  req: NextApiRequest,
  res: NextApiResponse<Data>,
) {
  if (req.method === "GET") {
    res.status(200).json({ status: "success", id: "1", name: "Alice" });
  } else if (req.method === "POST") {
    res.status(200).json({ status: "success", id: "2", name: "Bob" });
  } else if (req.method === "PUT") {
    res.status(200).json({ status: "success", id: "3", name: "Eve" });
  } else if (req.method === "DELETE") {
    res.status(200).json({ status: "success", id: "4", name: "Mallory" });
  }
}
```

ãƒ†ã‚¹ãƒˆç”¨ã®æ§˜ã€…ãªãƒ‘ã‚¹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
ã“ã®ä¾‹ã§ã¯ã€
`http://localhost:3000/api/v1/a/b/c` ã‚„
`http://localhost:3000/api/v1/abc/def` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€
`{ status: "success", id: "1", name: "Alice" }`ã®çµæœã‚’å–å¾—ã§ãã¾ã™ã€‚

è©³ã—ãã¯ä»¥ä¸‹ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
https://nextjs.org/docs/pages/building-your-application/routing/api-routes#catch-all-api-routes

```typescript: pages/api/v1/[...slug].ts
import type { NextApiRequest, NextApiResponse } from "next";

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse,
) {
  const slugs = req.query.slug || ["/"];
  const url: string =
    typeof slugs === "string" ? `/${slugs}` : `/${slugs.join("/")}`;
  console.log(
    `method: ${req.method}, query: ${JSON.stringify(req.query)}, url: ${url}`,
  );
  if (req.method === "GET") {
    res.status(200).json({ status: "success", id: "1", name: "Alice" });
  } else if (req.method === "POST") {
    res.status(200).json({ status: "success", id: "2", name: "Bob" });
  } else if (req.method === "PUT") {
    res.status(200).json({ status: "success", id: "3", name: "Eve" });
  } else if (req.method === "DELETE") {
    res.status(200).json({ status: "success", id: "4", name: "Mallory" });
  }
}
```

ã“ã‚Œã§æº–å‚™ã¯å®Œäº†ã§ã™ã€‚ã“ã‚Œã‹ã‚‰å‹ã‚’å®šç¾©ã—ã¦ã„ãã¾ã™ã€‚

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIã®å‹å®šç¾©

ã¾ãšãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIã®å‹ã®å®šç¾©ã‚’ã—ã¾ã™ã€‚
äºŒåº¦æ‰‹é–“æ„Ÿã¯ã‚ã‚‹ã®ã§ã™ãŒã€ã“ã‚Œã‚’ã—ãªã„ã¨å‹ã®è£œå®ŒãŒåŠ¹ã‹ã›ã‚‰ã‚Œãªã„ãŸã‚ã§ã™ã€‚
OpenAPIãªã©ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã«ã¯ã€[ã“ã®è¨˜äº‹ï¼ˆå†æ²ï¼‰](https://zenn.dev/sum0/articles/8e903ed05ba681)ã‚’èª­ã‚“ã æ–¹ãŒå¹¸ã›ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

ä»¥ä¸‹ã®APIã®å‹ã‚’å®šç¾©ã™ã‚‹ãŸã‚ã®typeã‚„interfaceã‚’ä½œæˆã—ã¾ã™ã€‚

```typescript: common/types/api.ts
import type { NextApiRequest, NextApiResponse } from "next";
export interface Data<T> {
  data: T;
}

export interface Error {
  error: {
    httpStatus: number;
    message: string;
  };
}

export type ApiParams<P = any, Q = any, B = any, R = any> = (
  // æ­£ç¢ºã«ã¯`path`ã‚’Omitã™ã‚‹å¿…è¦ã¯ãªã„ã§ã™ãŒã€ä»Šå¾Œã®ã“ã¨ã‚‚è€ƒãˆã¦ã“ã†ã—ã¦ã„ã¾ã™ã€‚
  req: Omit<NextApiRequest, "body" | "query" | "path"> & {
    query: Partial<Q>;
    body?: B;
    path?: P;
  },
  res: NextApiResponse<Data<R> | Error>,
) => void | Promise<void>;

export type ExtractReqQuery<T> = T extends ApiParams<any, infer I, any, any>
  ? I
  : never;
export type ExtractReqData<T> = T extends ApiParams<any, any, infer I, any>
  ? I
  : never;
export type ExtractResData<T> = T extends ApiParams<any, any, any, infer I>
  ? I
  : never;
export type ExtractPathParams<T> = T extends ApiParams<infer I, any, any, any>
  ? I
  : never;
```

ã“ã“ã§å…±é€šã®å‹ã‚’å®šç¾©ã—ã€

```typescript
export interface Data<T> {
  data: T;
}
export interface Error {
  error: {
    httpStatus: number;
    message: string;
  };
}
```

ã“ã“ã§APIã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãã‚Œãã‚Œå®šç¾©ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®å‹ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

```typescript
export type ApiParams<P = any, Q = any, B = any, R = any> = (
  req: Omit<NextApiRequest, "body" | "query" | "path"> & {
    query: Partial<Q>;
    body?: B;
    path?: P;
  },
  res: NextApiResponse<Data<R> | Error>,
) => void | Promise<void>;

// å¾Œè¿°ã—ã¾ã™ãŒä»¥ä¸‹ã®ã‚ˆã†ãªåˆ©ç”¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
// export type GetUserHandler = ApiParams<
//   {},  // ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
//   { id: string },  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆquery
//   {},  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆbody
//   { status: string; name: string }  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹body
// >;
```

æ¬¡ã«ã€ä¸Šã§å®šç¾©ã—ãŸ`ApiParams`ã‚’ä½¿ã£ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIã®å‹å®šç¾©ã‚’æ›¸ãã¾ã™ã€‚
ä¾‹ã¨ã—ã¦ã€`GET`, `POST`, `PUT`, `DELETE`ã®å®šç¾©ã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚

```typescript: lib/api/types.ts
import { ApiParams } from "@/common/types/api";

type GetUserHandler = ApiParams<
  {},
  { id: string },
  {},
  { status: string; id: string; name: string }
>;

type PostUserHandler = ApiParams<
  {},
  {},
  { name: string },
  { status: string; id: string; name: string }
>;

type PutUserHandler = ApiParams<
  {},
  {},
  { id: string; name: string },
  { status: string; id: string; name: string }
>;

type DeleteUserHandler = ApiParams<
  {},
  {},
  { id: string },
  { status: string; id: string; name: string }
>;

type GetUserPathParamHandler = ApiParams<
  { userId: string },
  { id: string },
  {},
  { status: string; id: string; name: string }
>;

export interface paths {
  // ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€`/user`ã¨ã„ã†ãƒ‘ã‚¹ã«å¯¾å¿œã—ã¦ã„ã‚‹ã¨ã„ã†æƒ³å®š
  "/user": {
    GET: GetUserHandler;
    POST: PostUserHandler;
    PUT: PutUserHandler;
    DELETE: DeleteUserHandler;
  };
  // è£œå®Œã®ä¾‹ã¨ã—ã¦é©å½“ãªãƒ‘ã‚¹ã‚’è¿½åŠ ï¼ˆ/v1/[...slug].tsã§å—ã‘ã‚‹ï¼‰
  "/v1/user/book": {
    GET: GetUserHandler;
  };
  "/v1/user/payment": {
    GET: GetUserHandler;
  };
  "/v1/user/balance": {
    GET: GetUserHandler;
  };
  "/v1/user/{userId}/balance": {
    GET: GetUserPathParamHandler;
  };
}
```

## axiosã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ

https://zenn.dev/sutamac/articles/27246dfe1b5a8e

ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹axiosã®`ApiClient`ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

```typescript: lib/api/clients.ts
import axios from "axios";
// å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼
const headers = {
  "Content-Type": "application/json",
};
// axiosã®åˆæœŸè¨­å®š
export const BackendApiClient = axios.create({
  baseURL: `${process.env.NEXT_PUBLIC_BACKEND_API_ENDPOINT}/api`,
  headers,
});

// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¨ãƒ©ãƒ¼åˆ¤å®šå‡¦ç†
BackendApiClient.interceptors.response.use(
  (response) => {
    return response;
  },
  (error) => {
    console.log(error);
    switch (error?.response?.status) {
      case 401:
        break;
      case 404:
        break;
      default:
        console.log("== internal server error");
    }

    const errorMessage = (error.response?.data?.message || "").split(",");
    throw new Error(errorMessage);
  },
);
```

åˆæœŸè¨­å®šã®URLã¯æº–å‚™ã®ã¨ã“ã‚ã§è¨­å®šã—ãŸç’°å¢ƒå¤‰æ•°ã‚’ç”¨ã„ã¾ã™ã€‚
ã“ã®`ApiClient`ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§æ¯å›è¨­å®šã™ã‚‹`URL`ã‚„`headers`ã®å®šç¾©ãŒ1å›ã§æ¸ˆã¿ã¾ã™ã€‚

```typescript
// axiosã®åˆæœŸè¨­å®š
export const BackendApiClient = axios.create({
  baseURL: `${process.env.NEXT_PUBLIC_BACKEND_API_ENDPOINT}/api`,
  headers,
});
```

## APIã®å‹è£œå®Œã‚’åŠ¹ã‹ã›ã‚‹

ãƒ•ãƒ­ãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã™ã‚‹éš›ã®è£œå®Œã‚’åŠ¹ã‹ã›ã¦è¡Œãã¾ã™ã€‚
[ã“ã®è¨˜äº‹ï¼ˆå†æ²ï¼‰](https://zenn.dev/sum0/articles/8e903ed05ba681)ã®å†…å®¹ãŒã»ã¨ã‚“ã©ãã®ã¾ã¾å‡ºã¦ãã¾ã™ã€‚

ã¾ãšã¯ã€APIã‚’å‘¼ã¶é–¢æ•°ã®è£œå®Œã‚’åŠ¹ã‹ã›ã‚‹ãŸã‚ã®å‹ã‚’å®šç¾©ã—ã¾ã™ã€‚


```typescript: lib/api/schemaHelper.ts
import { paths } from "./types";
import { UnionToIntersection, Get } from "type-fest";
import {
  ExtractPathParams,
  ExtractReqQuery,
  ExtractReqData,
  ExtractResData,
} from "@/common/types/api";

export type UrlPaths = keyof paths;
export type HttpMethods = keyof UnionToIntersection<paths[keyof paths]>;
export type HttpMethodsFilteredByPath<Path extends UrlPaths> = HttpMethods &
  keyof UnionToIntersection<paths[Path]>;

export type RequestPathParameters<
  Path extends UrlPaths,
  Method extends HttpMethods,
> = ExtractPathParams<Get<paths, `${Path}.${Method}`>>;

export type RequestParameters<
  Path extends UrlPaths,
  Method extends HttpMethods,
> = ExtractReqQuery<Get<paths, `${Path}.${Method}`>>;

export type RequestData<
  Path extends UrlPaths,
  Method extends HttpMethods,
> = ExtractReqData<Get<paths, `${Path}.${Method}`>>;

export type ResponseData<
  Path extends UrlPaths,
  Method extends HttpMethods,
> = ExtractResData<Get<paths, `${Path}.${Method}`>>;
```

ä»¥ä¸‹ã®ç®‡æ‰€ã§`paths`ã®ã‚­ãƒ¼ã§ã‚ã‚‹APIã®ãƒ‘ã‚¹ã¨ã€ãƒ¡ã‚½ãƒƒãƒ‰ã®å¯¾å¿œé–¢ä¿‚ã‚’å–å¾—ã—ã¾ã™ã€‚

```typescript
export type UrlPaths = keyof paths;
export type HttpMethods = keyof UnionToIntersection<paths[keyof paths]>;
export type HttpMethodsFilteredByPath<Path extends UrlPaths> = HttpMethods &
  keyof UnionToIntersection<paths[Path]>;
```

ãã—ã¦ã€`Path`ã¨`Method`ã‚’ã‚­ãƒ¼ã«æŒ‡å®šã—ã¦`paths`ã‹ã‚‰`Get<>`ã§å¯¾å¿œã™ã‚‹APIã‚’å–å¾—ã—ã€
ã•ã‚‰ã«ãã®APIã®`interface`ã‹ã‚‰`ExtractReqQuery<>`ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‹ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚
`Get<>`ã¯`type-fest`ã§ã€`ExtractReqQuery<>`ã¯ä¸Šã§å®šç¾©ã—ãŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã§ã™ã€‚

```typescript
export type RequestParameters<
  Path extends UrlPaths,
  Method extends HttpMethods,
> = ExtractReqQuery<Get<paths, `${Path}.${Method}`>>;
```

æœ€å¾Œã«`axios`ã‚„`swr`ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®é–¢æ•°ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```typescript: lib/api/hooks.ts
import { AxiosError, AxiosResponse, AxiosRequestConfig } from "axios";
import useSWR from "swr";
import {
  HttpMethods,
  HttpMethodsFilteredByPath,
  RequestPathParameters,
  RequestData,
  RequestParameters,
  ResponseData,
  UrlPaths,
} from "@/lib/api/schemaHelper";
import { BackendApiClient } from "./clients";

export type AxiosConfigWrapper<
  Path extends UrlPaths,
  Method extends HttpMethods,
> = {
  url: Path;
  method: Method & HttpMethodsFilteredByPath<Path>;
  paths: RequestPathParameters<Path, Method>;
  params?: RequestParameters<Path, Method>;
  data?: RequestData<Path, Method>;
};

export function request<Path extends UrlPaths, Method extends HttpMethods>(
  config: AxiosConfigWrapper<Path, Method>,
) {
  const { url, paths, ...baseConfig } = config;
  const requestConfig: AxiosRequestConfig = {
    ...baseConfig,
    url: Object.entries(paths ?? {}).reduce(
      (previous, [key, value]) =>
        previous.replace(new RegExp(`\\{${key}\\}`), String(value)),
      url as string,
    ),
  };
  return BackendApiClient.request<
    ResponseData<Path, Method>,
    AxiosResponse<ResponseData<Path, Method>>,
    AxiosConfigWrapper<Path, Method>["data"]
  >(requestConfig);
}

const fetcher = <Path extends UrlPaths, Method extends HttpMethods>(
  config: AxiosConfigWrapper<Path, Method>,
) => {
  return request<Path, Method>(config).then((res) => res.data);
};

export const useAppSWR = <Path extends UrlPaths, Method extends HttpMethods>(
  config: AxiosConfigWrapper<Path, Method>,
) => useSWR<ResponseData<Path, Method>, AxiosError>(config, fetcher);
```

ã“ã‚Œã§å®Œæˆã—ã¾ã—ãŸã€‚
ãŸã ã€`request`ã®æ–¹ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã«ã¯ãªã£ã¦ã„ãªã„ã®ã§ã€
ä»¥ä¸‹ã®è¨˜äº‹ãªã©ã‚’å‚è€ƒã«å¿…è¦ã«å¿œã˜ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã«ã™ã‚‹ã¨è‰¯ã„ã‹ã¨æ€ã„ã¾ã™ã€‚

https://qiita.com/mamimami0709/items/603c6ea9f9bfa68461f9

## å‹•ä½œç¢ºèª

ä½œæˆã—ãŸSWRã®ãƒ•ãƒƒã‚¯ã‚’ä½¿ã£ã¦`GET`ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã£ã¦ã¿ã¾ã™ã€‚
ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®`{userId}`ã‚‚å¼•æ•°ã¨å¯¾å¿œã•ã›ãŸURLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ã€‚

```typescript: pages/index.tsx
// (...å‰ç•¥)
export default function Home() {
  const { data, mutate: reFetch } = useAppSWR({
    url: "/v1/user/{userId}/balance",
    method: "GET",
    params: { id: "any" },
    paths: { userId: "1" },
  });
// (...å¾Œç•¥)
```

![](/images/nextjs_routes_types_1/nextjs_routes_types_1_4.png =600x)

ãã®ã»ã‹ã®`POST`ãªã©ã®ãƒªã‚¯ã‚¹ãƒˆã‚‚åŒã˜ã‚ˆã†ãªçµæœã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript jsx: pages/index.tsx
// (...å‰ç•¥)
        <button
          className="(çœç•¥)"
          rel="noopener noreferrer"
          onClick={() => {
            request({
              url: "/user",
              method: "POST",
              data: {
                name: "new-name",
              },
              paths: {},
            }).then((res) => console.log(res.data.name));
          }}
        >
// (...å¾Œç•¥)
```

# ãŠã‚ã‚Šã«

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIã‚’å®Ÿè£…ã™ã‚‹éš›ã«ã€
å‹ã‚’ä»˜ã‘ãŸã‚Šã‚¨ãƒ‡ã‚£ã‚¿è£œå®ŒãŒåŠ¹ãã‚ˆã†ã«ãªã£ã¦å®‰å¿ƒã§ãã¾ã—ãŸã€‚

ã“ã®è¨˜äº‹ã¯ã€æœ€åˆã«æŒ™ã’ãŸè¨˜äº‹ã«ã‹ãªã‚Šå½±éŸ¿ã‚’å—ã‘ã¦ã„ã¾ã™ã€‚
æ”¹ã‚ã¦å‚è€ƒã«ã—ãŸè¨˜äº‹ã«æ„Ÿè¬ã—ã¦ã„ã¾ã™ã€‚

# ãã®ã»ã‹ã®å‚è€ƒè¨˜äº‹

https://omkz.net/nextjs-swr-post/
